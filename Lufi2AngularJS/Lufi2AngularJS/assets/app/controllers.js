
﻿angular.module('coupons',['ui.bootstrap']).controller('couponsCtrl',['$scope','$location','$modal','$log',function($scope,$location,$modal,$log){$scope.orderlines=[{imageSrc:"assets/images/count.jpg",title:"Sesame Street&reg; - The Count Adult CostumeWeb exclusive!",price:"68.00",unitPrice:"136.00",yellowDot:false,brand:"Emerald Sundae",color:"Emerald",size:"Small",available:500,upc:98400222,itemId:445301268573,imageId:11235,webIds:[1089772,23156,15648,12346],vendorStyle:"CHK1023093",unitOfMeasure:"Each",longDesc:"Featured in black Adjustable straps Padded bust Glitter accents all over Ruched sides Side slit Lined Polyester / spandex Imported",storePickup:true,shipToCust:false,giftregistry:'FSK8A34',quantity:1,ispriceoverride:true,priceoverride:"59.00",isorderlinechecked:false},{imageSrc:"assets/images/mixer.jpg",title:"KitchenAid&reg; Artisan&reg; Design 5-Qt. Glass Bowl Stand Mixer + Free Food Grinder Attachment",price:"239.00",unitPrice:"239.00",yellowDot:false,brand:"Emerald Sundae",color:"Emerald",size:"Small",available:500,upc:700154422,itemId:445301268573,imageId:11235,webIds:[7154422,23156,15648,12346],vendorStyle:"CHK1023093",unitOfMeasure:"Each",longDesc:"Featured in black Adjustable straps Padded bust Glitter accents all over Ruched sides Side slit Lined Polyester / spandex Imported",storePickup:true,shipToCust:false,giftregistry:'FSK8A34',quantity:1,ispriceoverride:false,priceoverride:"",isorderlinechecked:false},{imageSrc:"assets/images/count.jpg",title:"Sesame Street&reg; - The Count Adult CostumeWeb exclusive!",price:"68.00",unitPrice:"136.00",yellowDot:false,brand:"Emerald Sundae",color:"Emerald",size:"Small",available:500,upc:98400222,itemId:445301268573,imageId:11235,webIds:[1089772,23156,15648,12346],vendorStyle:"CHK1023093",unitOfMeasure:"Each",longDesc:"Featured in black Adjustable straps Padded bust Glitter accents all over Ruched sides Side slit Lined Polyester / spandex Imported",storePickup:true,shipToCust:false,giftregistry:'FSK8A34',quantity:1,ispriceoverride:true,priceoverride:"59.00",isorderlinechecked:false}];$scope.customerInfo=function(){$location.path('/customerInfo');};$scope.deleteOrderLine=function(line){var index=$scope.orderlines.indexOf(line);$scope.orderlines.splice(index,1);};$scope.removePriceOverride=function(){angular.forEach($scope.orderlines,function(orderline){if(orderline.isorderlinechecked&&orderline.ispriceoverride){orderline.priceoverride="";orderline.ispriceoverride=false;}});};$scope.incrementItems=function(orderline){if(angular.isObject(orderline)){++orderline.quantity;}
return false;};$scope.decrementItems=function(orderline){if(angular.isObject(orderline)){--orderline.quantity;if(orderline.quantity<0){orderline.quantity=0;}}
return false;};$scope.getIsPriceDiscounted=function(orderline){if(orderline.ispriceoverride){return true;}else{return false;}};$scope.checkButtonFont='fa-square-o';var checkButtonIsChecked=false;$scope.priceoverrideDisable=true;$scope.updateGiftRegistryDisable=true;var changeMasterCheckboxDisplay=function(isCheckIt){if(isCheckIt){$scope.checkButtonFont='fa-check-square-o';checkButtonIsChecked=true;}else{$scope.checkButtonFont='fa-square-o';checkButtonIsChecked=false;}};$scope.toggleCheckAll=function(){if(checkButtonIsChecked){changeMasterCheckboxDisplay(false);angular.forEach($scope.orderlines,function(orderline){orderline.isorderlinechecked=false;});$scope.priceoverrideDisable=true;$scope.updateGiftRegistryDisable=true;}else{changeMasterCheckboxDisplay(true);var _isPriceOverriden=false;angular.forEach($scope.orderlines,function(orderline){orderline.isorderlinechecked=true;if(orderline.ispriceoverride){_isPriceOverriden=true;}});$scope.priceoverrideDisable=!_isPriceOverriden;$scope.updateGiftRegistryDisable=false;}};$scope.updateMasterCheckbox=function(){var isPriceoverriden=false;var isChecked=false;var isAllChecked=true;angular.forEach($scope.orderlines,function(orderline){if(orderline.isorderlinechecked){isChecked=true;if(orderline.ispriceoverride){isPriceoverriden=true;}}else{isAllChecked=false;}});if(isAllChecked){changeMasterCheckboxDisplay(true);}else{changeMasterCheckboxDisplay(false);}
if(isChecked&&isPriceoverriden){$scope.priceoverrideDisable=false;}else{$scope.priceoverrideDisable=true;}
if(isChecked){$scope.updateGiftRegistryDisable=false;}else{$scope.updateGiftRegistryDisable=true;}};$scope.open=function(size){var modalInstance=$modal.open({templateUrl:'giftRegTpl.html',controller:'ModalGiftRegCtrl',size:size});modalInstance.result.then(function(regNo){angular.forEach($scope.orderlines,function(orderline){if(orderline.isorderlinechecked){orderline.giftregistry=regNo;}});},function(){$log.info('Modal dismissed at: '+new Date());});};$scope.openDetailModal=function(size){var modalInstance2=$modal.open({templateUrl:'orderLineContent.html',controller:'ModalOrderLineCtrl',size:size});modalInstance2.result.then(function(registryNo){$scope.selected=selectedItem;},function(){$log.info('Modal dismissed at: '+new Date());});};}]).controller('ModalGiftRegCtrl',['$scope','$modalInstance',function($scope,$modalInstance){$scope.registryNo="";$scope.ok=function(){$modalInstance.close($scope.registryNo);};$scope.cancel=function(){$modalInstance.dismiss('cancel');};}]).controller('ModalOrderLineCtrl',['$scope','$modalInstance','items',function($scope,$modalInstance,items){$scope.items=items;$scope.selected={item:$scope.items[0]};$scope.ok=function(){$modalInstance.close($scope.selected.item);};$scope.cancel=function(){$modalInstance.dismiss('cancel');};}]);
﻿angular.module('coupons',['ui.bootstrap']).controller('couponCtrl',['$scope','$location','$modal','$rootScope','orderCart','order','repriceService','loggerService',function($scope,$location,$modal,$rootScope,$orderCart,$order,repriceService,$loggerService){$scope.cart=$orderCart.order.getLiveOrderCart();$scope.orderLinesArray=$scope.cart.OrderLines.OrderLine;$scope.txtCouponInput="";$scope.deleteCoupon=function(rowIndex){$scope.cart.Promotions.Promotion.splice(rowIndex,1)
$scope.UpdateCart($scope.cart)}
var deregister=$rootScope.$on('Scanner_Event',function(event,data){if(data){$scope.txtCouponInput=data;$scope.addCoupon($scope.txtCouponInput);}});$scope.$on("$destroy",function(){deregister();});$scope.addCoupon=function(CouponID){$scope.txtCouponInput="";if($scope.cart.Promotions.Promotion!=undefined){var i=$scope.cart.Promotions.Promotion.length;$scope.cart.Promotions.Promotion[i]={_PromotionId:CouponID,_PromotionType:"PROMO",}}else{$scope.cart.Promotions={Promotion:[{_PromotionId:CouponID,_PromotionType:"PROMO",}]}}
$scope.UpdateCart($scope.cart)};$scope.getLineDiscTotal=function(line){var total=0.00;$scope.total=parseFloat(total);for(var i=0,len=line.LineCharges.LineCharge.length;i<len;i++){var name=line.LineCharges.LineCharge[i]._ChargeCategory
if(name=="BTN_CPN_DISC"){$scope.chargeamount=parseFloat(line.LineCharges.LineCharge[i]._ChargeAmount)
$scope.total+=$scope.chargeamount;}else{}}
return $scope.total;}
$scope.openCouponChargeDetail=function(orderLine){var modalInstance=$modal.open({templateUrl:'html/coupons/couponChargeDesc.html',controller:'couponChargeDescCtrl',resolve:{orderLine:function(){return orderLine;},}})}
$scope.UpdateCart=function(cart){repriceService.reprice(cart).then(function(response){cart=response.data;$scope.orderLinesArray=cart.OrderLines.OrderLine;$scope.orderPromotionArray=cart.Promotions.Promotion;$scope.TotalSavings=cart._CouponDiscTotal;$loggerService.log(response.data);$orderCart.order.setOrderCart(cart);})}
if($scope.cart.Promotions.Promotion!=undefined){$scope.UpdateCart($scope.cart)}
$scope.close=function(){$location.path('/paymentSummary')};$scope.showPaperless=function(){var modalInstance=$modal.open({templateUrl:'html/coupons/paperless.html',controller:'paperlessCtrl'});modalInstance.result.then(function(){},function(){});};}]).controller('couponChargeDescCtrl',['$scope','$modalInstance','$location','orderLine',function($scope,$modalInstance,$location,orderLine){$scope.orderLine=orderLine
$scope.lineChargeArray=orderLine.LineCharges.LineCharge;$scope.refreshIScroll=function(){setTimeout(function(){myScroll.refresh();},500);};$scope.close=function(){$modalInstance.dismiss('closed');};}]).controller('paperlessCtrl',['$scope','$modalInstance','$modal',function($scope,$modalInstance,$modal){$scope.ok=function(){$modalInstance.close();};$scope.cancel=function(){$modalInstance.dismiss('cancel');};}]);
﻿angular.module('index',['ui.bootstrap']).controller('indexCtrl',['$scope','$modal','$location','customer','scannerService','POSService','$state','orderCart','payment','authenticateUser','loggerService','securityService',function($scope,$modal,$location,$customer,$scannerService,POSService,$state,$orderCart,$payment,$authenticateUser,$loggerService,securityService)
{$scope.headerWarningText="QA Environment";if((/test.bonton.com/).test(window.location.hostname)){$scope.headerWarningText="TEST Lufi Env";}
if((/scint.bonton.com/).test(window.location.hostname)){$scope.headerWarningText="SCINT Lufi Env";}
$scope.customerDetail=function(){if($customer.isCustomerSelected()){$location.path('/customerDetail')}else{$location.path('/customerSearch')}}
$scope.goToState=function(stateName){$scope.isShowCustomerPopup=false;$scope.isShowCartPopup=false;$state.go(stateName);};$scope.isCustomerSet=function(){return $orderCart.customer.isCartCustomerSet();};$scope.deleteCart=function(){$scope.orderCart=$orderCart.order.deleteCart();$scope.removeCustomer();$scope.goToState('home');};$scope.removeCustomer=function(){$customer.clearSelectedCustomer();$scope.orderCart=$orderCart.customer.deleteCustomer();$payment.clearPaymentData();$scope.goToState('home');};$scope.isShowCustomerPopup=false;$scope.toggleCustomerPopup=function(){$scope.isShowCustomerPopup=!$scope.isShowCustomerPopup;$scope.refreshIScroll();};$scope.isShowCartPopup=false;$scope.toggleCartPopup=function(){if(!$scope.isShowCartPopup){$scope.orderCart=$orderCart.order.getLiveOrderCart();}
$scope.isShowCartPopup=!$scope.isShowCartPopup;$scope.refreshIScroll();};$scope.goToCustomer=function(){if($scope.isCustomerSet()){$scope.goToState('customerDetail');}else{$scope.goToState('customerSearch');}};$scope.hideIndexPopups=function(){$scope.isShowCartPopup=false;$scope.isShowCustomerPopup=false;};$scope.$on('$stateChangeSuccess',function(event,toState,toParams,fromState,fromParams){$scope.isShowCartPopup=false;$scope.isShowCustomerPopup=false;});$scope.$on('orderCartReset',function(){$scope.orderCart=$orderCart.order.getLiveOrderCart();$scope.itemCount=function(){return $orderCart.order.getItemCount();};});$scope.itemCount=function(){return $orderCart.order.getItemCount();};$scope.selectedCustomer=$customer.getSelectedCustomer();$scope.orderCart=$orderCart.order.getLiveOrderCart();$scope.$on('AddCustomerToCartCalled',function(event,customer){$scope.selectedCustomer=$customer.getSelectedCustomer();});$scope.exit=function(){var modalInstance=$modal.open({templateUrl:'exitLufi.html',controller:'exitLufiCtrl'});modalInstance.result.then(function(exitCause){if((/discardOrder/i).test(exitCause)){$scope.deleteCart();}},function(){});};$scope.managerLogin=function(){var modalInstance=$modal.open({templateUrl:'managerLogin.html',controller:'managerLoginCtrl'});modalInstance.result.then(function(){$scope.authSuccess=true;$scope.posParam=POSService.getPOSParameters();},function(){});};$scope.managerLogout=function(){POSService.managerLogout();$scope.posParam=POSService.getPOSParameters();loginWithPOSParams();};$scope.login=function(){var modalInstance=$modal.open({templateUrl:'html/login.html',controller:'loginCtrl',backdrop:'static'});modalInstance.result.then(function(){$scope.authSuccess=true;$scope.posParam=POSService.getPOSParameters();$scope.isCsr=securityService.isCsr();if($scope.isCsr){$scope.headerWarningText+=" CSR";}},function(){$('#loadDIV').show();$scannerService.stopServer();setTimeout(function(){modalInstance.close('exit');location.href='http://saphere-solutions.com/?exit';},2000);});};var loginWithPOSParams=function(){var authCheckingModal=$modal.open({templateUrl:'html/modalTemplates/authModal.html',controller:'authModalCtrl',backdrop:'static',animation:false,resolve:{'idPass':function(){return{ldapId:$scope.posParam.ldapId,ldapPassword:$scope.posParam.ldapPassword};}}});authCheckingModal.result.then(function(tokenObj){if(tokenObj.token){$scope.posParam=POSService.getPOSParameters();xAuth=tokenObj.token;$scope.authSuccess=true;$scope.isCsr=securityService.isCsr();if($scope.isCsr){$scope.headerWarningText+=" CSR";}}else{$scope.login();}},function(data){swal({title:"Alert!",text:"Authentication Failed \n <span style='word-wrap:break-word'>"+window.location.href+"</span>",showConfirmButton:true,html:true});$loggerService.error(data);$scope.login();});}
$scope.authSuccess=false;POSService.setPOSTParametersFromURL(window.location.href);$scope.posParam=POSService.getPOSParameters();var headeriScroll;$scope.refreshIScroll=function(){if(!headeriScroll){headeriScroll=new IScroll('#HeaderiScrollWrapper',{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip'})}
setTimeout(function(){headeriScroll.refresh();},500);};console.log('CloseSplashScreen');if(!($scope.posParam.ldapId&&$scope.posParam.ldapId.length>0&&$scope.posParam.ldapPassword&&$scope.posParam.ldapPassword.length>0)){$scope.login();}else{loginWithPOSParams();}}]).controller('authModalCtrl',['$scope','$modalInstance','scannerService','$location','loggerService','authenticateUser','idPass','$timeout','btProp','POSService',function($scope,$modalInstance,$scannerService,$location,$loggerService,$authenticateUser,$idPass,$timeout,btProp,$POSService){$scope.isShowModal=false;$timeout(function(){$scope.isShowModal=true;},1000);$authenticateUser($idPass.ldapId,$idPass.ldapPassword).then(function(resp){var response=angular.fromJson(resp.data);if(angular.isObject(response.Authresp)&&angular.isDefined(response.Authresp.ReturnCode)&&response.Authresp.ReturnCode==0){var isCsr=false;var roles=null;if(angular.isObject(response.Authresp)&&angular.isObject(response.Authresp.Control)){roles=response.Authresp.Control;if(angular.isString(response.Authresp.Control.CREATE_ORDER_CALLCENTER)&&(/^true$/i).test(response.Authresp.Control.CREATE_ORDER_CALLCENTER)){storeNumber=btProp.getProp("csrStoreNode");$POSService.setPOSTParameters(null,storeNumber,null,roles);}else{$POSService.setPOSTParameters(null,null,null,roles);}}
$modalInstance.close({token:response.Authresp.Token});}else{$modalInstance.dismiss(resp.data);}},function(resp){$modalInstance.dismiss(resp.data);});$scope.switchUser=function(){$modalInstance.close({token:null});};$scope.exit=function(){$('#loadDIV').show();$scannerService.stopServer();setTimeout(function(){location.href='http://saphere-solutions.com/?exit'},2000);};}]).controller('exitLufiCtrl',['$scope','$modalInstance','scannerService','$location','order','orderCart','loggerService','securityService',function($scope,$modalInstance,$scannerService,$location,$order,$orderCart,$loggerService,$securityService){$scope.noDraftOrderPrompt="Do you want to close Let Us Find It and return to the POS application?";$scope.noDraftOrderExitButtonText="No";$scope.withDraftOrderSaveButtonText="Save Order & Close";$scope.isCsr=function(){return $securityService.isCsr();};if($securityService.isCsr()){$scope.noDraftOrderPrompt="To close Let Us Find It, please use browser's exit button.";$scope.noDraftOrderExitButtonText="Cancel";$scope.withDraftOrderSaveButtonText="Save Order";}
$scope.exit=function(){$('#loadDIV').show();$scannerService.stopServer();setTimeout(function(){$modalInstance.close('exit');location.href='http://saphere-solutions.com/?exit'},2000);};$scope.noPrompt=false
$scope.cart=$orderCart.order.getLiveOrderCart();$scope.orderLinesArray=$scope.cart.OrderLines.OrderLine;if(!$scope.cart||!$scope.cart.PersonInfoBillTo._PersonInfoKey||$scope.orderLinesArray.length==0){$scope.noPrompt=true;}
$scope.discard=function(){if($scope.isCsr()){$modalInstance.close('discardOrder');}else{$scope.exit();}}
$scope.cancel=function(){$modalInstance.close('Cancel');}
$scope.save=function(){$scope.cart._DraftOrderFlag='Y';delete $scope.cart.PaymentMethods;$order.createOrder($scope.cart,function(response){if($scope.isCsr()){var orderNumber=(response&&angular.isString(response._OrderNumber))?response._OrderNumber:"";swal({title:'',text:'<div class="savedDraftExitText">Draft Order Saved.</div><div class="savedDraftExitText">Order Number: '+orderNumber+'</div>',html:true});$scope.discard();}else{swal({title:'',text:'<span class="savedDraftExitText">Draft Order Saved</span>',html:true,timer:3000,showConfirmButton:false,showCancelButton:false},function(){$scope.exit();});}},function(error){$loggerService.log(error);});}}]).controller('loginCtrl',['$scope','$modalInstance','authenticateUser','POSService','loggerService','numberOnlyKeyPressValidator','$rootScope','btProp',function($scope,$modalInstance,$authenticateUser,$POSService,$loggerService,$numberOnlyKeyPressValidator,$rootScope,btProp)
{$scope.numberValidator=$numberOnlyKeyPressValidator;$scope.storePattern="\\d{1,3}";$scope.login=function(){$authenticateUser($scope.associateId,$scope.password).success(function(data){var response=angular.fromJson(data);if(data===undefined||(data.Authresp&&data.Authresp.ReturnCode&&(data.Authresp.ReturnCode)!==0)){swal({title:"Alert!",text:"Authentication Failed",showConfirmButton:true});$loggerService.log(data);return;}
var storeNumber=$scope.storeNumber;if(!(storeNumber&&storeNumber.length>0)){var posParams=$POSService.getPOSParameters();storeNumber=posParams.storeNumber;}
var isCsr=false;var roles=null;if(angular.isObject(response.Authresp)&&angular.isObject(response.Authresp.Control)){roles=response.Authresp.Control;if(angular.isString(response.Authresp.Control.CREATE_ORDER_CALLCENTER)){if((/^true$/i).test(response.Authresp.Control.CREATE_ORDER_CALLCENTER)){isCsr=true;storeNumber=btProp.getProp("csrStoreNode");}}}
var assocNum="";if(response.Authresp.AssociateNum!==undefined&&response.Authresp.AssociateNum!==null){assocNum=response.Authresp.AssociateNum.toString().trim();}
if((/^\d+\.$/).test(assocNum)){assocNum=assocNum.substring(0,assocNum.length-1);if(assocNum.length<6){assocNum="000000"+assocNum;assocNum=assocNum.slice(-6);}}
if((/^\d{1,5}$/).test(assocNum)){assocNum="000000"+assocNum;assocNum=assocNum.slice(-6);}
if(storeNumber.length<3){storeNumber="000"+storeNumber;storeNumber=storeNumber.slice(-3);}
$POSService.setPOSTParameters(assocNum,storeNumber,null,roles);$modalInstance.close('closed');xAuth=response.Authresp.Token;$rootScope.$broadcast('ShowAnnouncement');}).error(function(data){swal({title:"Alert!",text:"Authentication Failed",showConfirmButton:true});$loggerService.log(data);});};$scope.contract=function(){return angular.toJson({"Authreq":{"uid":$scope.associateId,"pwd":$scope.password}})};$scope.cancel=function(){$modalInstance.dismiss('cancel');};}]).controller('managerLoginCtrl',['$scope','$modalInstance','authenticateUser','POSService','loggerService',function($scope,$modalInstance,$authenticateUser,$POSService,$loggerService){$scope.login=function(){$authenticateUser($scope.manager.userName,$scope.manager.password).success(function(data){var response=angular.fromJson(data);var storeNumber=$scope.storeNumber;if(!(storeNumber&&storeNumber.length>0)){var posParams=$POSService.getPOSParameters();storeNumber=posParams.storeNumber;}
var roles=response.Authresp.Control;$POSService.setPOSTParameters(response.Authresp.AssociateNum,storeNumber,null,roles);$modalInstance.close('closed');xAuth=response.Authresp.Token;}).error(function(data){swal({title:"Alert!",text:"Authentication Failed",showConfirmButton:true});$loggerService.log(data);});};$scope.contract=function(){return angular.toJson({"Authreq":{"uid":$scope.associateId,"pwd":$scope.password}})};$scope.cancel=function(){$modalInstance.dismiss('cancel');};}]);
﻿angular.module('home',['ui.bootstrap']).controller('homeCtrl',['$scope','announcements','$modal','itemSearch','numberOnlyKeyPressValidator','defaultUPCScanHandler','$filter','POSService','order','loggerService','$state','securityService','$timeout',function($scope,$announcements,$modal,$itemSearch,$numberOnlyKeyPressValidator,defaultUPCScanHandler,$filter,$POSService,$order,loggerService,$state,securityService,$timeout){$scope.isCsr=function(){return securityService.isCsr();};$scope.refreshIScroll=function(){setTimeout(function(){$scope.$parent.myScroll['AnnouncementWrapper'].refresh();},500);};$scope.upcPaste=function($event){if(typeof $event.originalEvent.clipboardData!=="undefined"){handlePastedUPC($event.originalEvent.clipboardData.getData('text/plain'));}else{$timeout(function(){handlePastedUPC(angular.element($event.currentTarget).val());},2);}};var handlePastedUPC=function(pastedText){var cleansedText="";for(var i=0;i<pastedText.length;i++){if((/\d/).test(pastedText[i])){cleansedText+=pastedText[i];}}
$timeout(function(){$scope.upc=cleansedText;},3);};$scope.orderNumberPaste=function($event){if(typeof $event.originalEvent.clipboardData!=="undefined"){handlePastedOrderNo($event.originalEvent.clipboardData.getData('text/plain'));}else{$timeout(function(){handlePastedOrderNo(angular.element($event.currentTarget).val());},2);}};var handlePastedOrderNo=function(pastedText){var cleansedText="";for(var i=0;i<pastedText.length;i++){if((/\d/).test(pastedText[i])){cleansedText+=pastedText[i];}}
$timeout(function(){$scope.formInput.orderNo=cleansedText;},3);};$scope.queryParameters={};$scope.numberValidator=$numberOnlyKeyPressValidator;$scope.announcements=[];$scope.hideColumns=false;var data=[];var errorData="";var param="";var caller="HOME";var announcements=[];var announcement={key:'',date:'',header:'',detail:'',expDate:'',locations:'',resolutionDate:''}
$scope.formInput={orderNo:""};var success=function(data)
{if(data.length>0){var _sortCompareAnnouncements=function(a,b){var result=0;var bopisRegEx=/^(RESTOCK|PICKUP)$/i;if((a.exceptionType===b.exceptionType)||(bopisRegEx.test(a.exceptionType)&&bopisRegEx.test(b.exceptionType))){result=0;}else if(bopisRegEx.test(a.exceptionType)){result=1;}else{result=-1;}
if(result!==0){return result;}
if(bopisRegEx.test(a.exceptionType)){return a.date-b.date;}
else{return b.date-a.date;}};data.sort(_sortCompareAnnouncements);for(var i=0;i<data.length;i++){announcement.key=data[i].key;announcement.date=data[i].date;announcement.detail=data[i].header;announcement.expDate=data[i].expDate;announcement.locations=data[i].locations;announcements.push(announcement);announcement={key:"",date:"",header:"",detail:"",expDate:"",locations:""};if(data[i].detail!=null&&data[i].detail!=undefined&&data[i].detail!=""){announcement.key=data[i].key;announcement.date="";announcement.detail=data[i].detail;announcement.expDate=data[i].expDate;announcement.locations=data[i].locations;announcements.push(announcement);announcement={key:"",date:"",header:"",detail:"",expDate:"",locations:""};}}}
$scope.announcements=announcements;};var error=function(errorData){};if(angular.isDefined($POSService))
{var posParams=$POSService.getPOSParameters();var storeNum=posParams.storeNumber;var assocId=posParams.associateId;if(storeNum!==""&assocId!=="")
{$announcements.retrieve(storeNum,caller,success,error);}}
$scope.$on('ShowAnnouncement',function()
{var posParams=$POSService.getPOSParameters();storeNumber=posParams.storeNumber;$announcements.retrieve(storeNumber,caller,success,error);});$scope.openAnnouncementDialog=function()
{var modalInstance=$modal.open({templateUrl:'manageAnnouncements.html',controller:'announcementCtrl',size:'lg'});modalInstance.result.then(function()
{},function()
{});};$scope.searchUPC=function(){$itemSearch.searchUPC($scope.upc,function(response){if(response.ngroups==0){jQuery('.not-found-alert').modal('show');}else if(response.isnGroup.length==1){$itemSearch.setSelectedISNGroup(response.isnGroup[0]);$state.go('itemDetail');}else{$state.go('itemResults');}},function(err){alert(err);});};$scope.navigate=function(stateName){$state.go(stateName);};$scope.openOrder=function(){if($scope.formInput.orderNo){param={"GetSterlingOrderListReq":{"_ReadFromHistory":"N","_OrderNo":$scope.formInput.orderNo,"_DraftOrderFlag":""}};if(angular.isDefined($scope.formInput.orderNo)){$order.getOrderList(param,function(result){if(result===undefined){jQuery('.not-found-alert').modal('show');}else{$order.setSelectedOrder({_OrderNo:$scope.formInput.orderNo,_DocumentType:"0001"});$state.go('orderDetail');}},function(error){alert(error);});}}};var handleBarCodeScan=function(event,barcodeData){if(!angular.isString(barcodeData)){barcodeData=(!angular.isDefined(barcodeData)||barcodeData===null)?'':barcodeData.toString().trim();}
if(barcodeData.length==9){$scope.formInput.orderNo=barcodeData.substring(0,9);$scope.openOrder();}else{defaultUPCScanHandler(event,barcodeData);}};var deregisterScanner=$scope.$on('Scanner_Event',handleBarCodeScan);$scope.$on("$destroy",function(){deregisterScanner();});}]).controller('announcementDeleteCtrl',['$scope','$modalInstance',function($scope,$modalInstance)
{$scope.yes=function()
{$modalInstance.close();};$scope.no=function()
{$modalInstance.dismiss('cancel');};}]);
﻿angular.module('swipeCard',[]).controller('swipeCardCtrl',['$scope','$rootScope','$modalInstance','msrService','alertMessages',function($scope,$rootScope,$modalInstance,$msrService,$alertMessages){var cardType;var msrEvent=$rootScope.$on('MSR_Event',function(event,msrData){var returnVar={msrData:msrData,cardType:cardType};$modalInstance.close(returnVar);var card={cardType:cardType,msrData:msrData}
if(cardType=="AssociateDiscountCard"){$msrService.accCard=card;$msrService.lastCard=undefined;}else{$msrService.lastCard=card;$msrService.accCard={};}});var msrErrorEvent=$rootScope.$on('MSR_Event_Error',function(event,msrData){if((/^(MSR_ERR_ENABLE|MSR_ERR_TOKEN|MSR_ERR_STAND_IN)$/i).test(msrData.StatusCode)){$modalInstance.dismiss('msrError');swal({title:$alertMessages.paymentMessages.BANK_CARD_SYSTEM_OFFLINE_TITLE,text:$alertMessages.paymentMessages.BANK_CARD_SYSTEM_OFFLINE_MESSAGE,showConfirmButton:true});}else if((/^MSR_ERR_DECLINE$/i).test(msrData.StatusCode)||(/.*ResponseCode_DeclineHard.*/i).test(msrData.StatusText)){$modalInstance.dismiss('msrError');swal({title:"Card Error",text:msrData.StatusText,showConfirmButton:true});}else if((/^MSR_ERR_NOT_ENABLED$/i).test(msrData.StatusCode)||(/MSR is not enabled/i).test(msrData.StatusText)){}else if((/^(MSR_ERR_NOT_REQUESTED|MSR_ERR_INVALID_TYPE)$/i).test(msrData.StatusCode)||(/Card swiped does not match requested tender type/i).test(msrData.StatusText)){$modalInstance.dismiss('msrError');swal({title:"Card Error",text:$alertMessages.paymentMessages.INVALID_CARD_TYPE,showConfirmButton:true});}else if((/^MSR_ERR_UNKNOWN_TYPE$/i).test(msrData.StatusCode)){$modalInstance.dismiss('msrError');swal({title:"Card Error",text:$alertMessages.paymentMessages.UNKNOWN_CARD_TYPE,showConfirmButton:true});}
else{$modalInstance.dismiss('msrError');swal({title:"MSR Error",text:msrData.StatusText,showConfirmButton:true});}});$scope.$on("$destroy",function(){msrEvent();msrErrorEvent();});$scope.disableSwipeCard=function(isIgnoreEnabled){isIgnoreEnabled=isIgnoreEnabled===true?true:false;$msrService.disableMSR(isIgnoreEnabled).then(function(){$scope.showSwipping=false;cardType=undefined;},function(){$scope.showSwipping=false;cardType=undefined;});};$scope.isProcessingMSREnable=false;$scope.swipeCard=function(swipeCardType){cardType=swipeCardType;$scope.isProcessingMSREnable=true;$msrService.enableMSR(cardType).then(function(){$scope.showSwipping=true;$scope.isProcessingMSREnable=false;},function(){$scope.showSwipping=false;$scope.isProcessingMSREnable=false;});}
$scope.close=function(){if($scope.isProcessingMSREnable||$scope.showSwipping){$scope.disableSwipeCard(true);}
$modalInstance.dismiss('closed');};}]);
﻿angular.module('itemLocate',[]).controller('itemLocateCtrl',['$scope','itemToLocate','itemLocate','POSService','$location',function($scope,$itemToLocate,$itemLocate,POSService,$location){$scope.stores=[];$scope.currentItem=$itemToLocate.get();$scope.posParam=POSService.getPOSParameters();if($scope.currentItem.colorimageid){$scope.ImageURL=serviceURL+"/image/BonTon/"+$scope.currentItem.colorimageid;}else if($scope.currentItem.imageid){$scope.ImageURL=serviceURL+"/image/BonTon/"+$scope.currentItem.imageid;}else{$scope.ImageURL="/assets/images/NotAvailable.jpg";}
var myScroll=new IScroll('#ItemDetailWrapper',{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip'});$scope.refreshIScroll=function(){setTimeout(function(){myScroll.refresh();},500);};if($scope.currentItem.productname===""||$scope.currentItem.productname==undefined){$scope.showProductName=false;}else{$scope.showProductName=true;}
$scope.getZip=function(){$itemLocate.getOrganizationList($scope.posParam.storeNumber).success(function(response){$scope.itemLocateZip=response.GetStoreInfoResp.Stores.Store.Address._ZipCode;$scope.SearchType();$scope.search();}).error(function(data){swal({title:"Error!",text:data,showConfirmButton:true});});}
$scope.SearchType=function(){if($scope.itemLocateZip==""&&($scope.itemLocateCity!=""||$scope.itemLocateState!="")){$scope.notZipSearch=true;$scope.notCityStateSearch=false;}else if($scope.itemLocateZip!=""){$scope.notZipSearch=false;$scope.notCityStateSearch=true;}
else{$scope.notZipSearch=false;$scope.notCityStateSearch=false;}}
$scope.close=function(){$location.path('/itemDetail');}
$scope.search=function(){if($scope.itemLocateZip==undefined){$scope.itemLocateZip=""}
if($scope.itemLocateCity==undefined){$scope.itemLocateCity=""}
if($scope.itemLocateRadius==undefined){$scope.itemLocateRadius=""}
if($scope.itemLocateState==undefined){$scope.itemLocateState=""}
if($scope.posParam.storeNumber==undefined){$scope.posParam.storeNumber=""}
if(($scope.itemLocateCity==""||$scope.itemLocateState=="")&&($scope.itemLocateZip=="")){swal({title:"Error!",text:"Must enter a Zip Code or a combination of City and State",showConfirmButton:true});}else{$itemLocate.locate($scope.itemLocateZip,$scope.itemLocateCity,$scope.itemLocateRadius,$scope.itemLocateState,$scope.currentItem.sku,$scope.posParam.storeNumber).then(function(response){$scope.Stores=response
if(!angular.isArray($scope.Stores)||$scope.Stores.length<1){$scope.noNodesToDisplay=true;}else{$scope.noNodesToDisplay=false;}},function(data){swal({title:"Error!",text:data,showConfirmButton:true});});}}
$scope.radiusOptions=[{name:'25 Miles',radius:'25'},{name:'50 Miles',radius:'50'},{name:'75 Miles',radius:'75'},{name:'100 Miles',radius:'100'}];$scope.stateOptions=[{name:'',state:''},{name:'Alabama',state:'AL'},{name:'Alaska',state:'AK'},{name:'Arizona',state:'AZ'},{name:'Arkansas',state:'AR'},{name:'California',state:'CA'},{name:'Colorado',state:'CO'},{name:'Connecticut',state:'CT'},{name:'Delaware',state:'DE'},{name:'District of Columbia',state:'DC'},{name:'Florida',state:'FL'},{name:'Georgia',state:'GA'},{name:'Hawaii',state:'HI'},{name:'Idaho',state:'ID'},{name:'Illinois',state:'IL'},{name:'Indiana',state:'IN'},{name:'Iowa',state:'IA'},{name:'Kansas',state:'KS'},{name:'Kentucky',state:'KY'},{name:'Louisiana',state:'LA'},{name:'Maine',state:'ME'},{name:'Maryland',state:'MD'},{name:'Massachusetts',state:'MA'},{name:'Michigan',state:'MI'},{name:'Minnesota',state:'MN'},{name:'Mississippi',state:'MS'},{name:'Missouri',state:'MO'},{name:'Montana',state:'MT'},{name:'Nebraska',state:'NE'},{name:'Nevada',state:'NV'},{name:'New Hampshire',state:'NH'},{name:'New Jersey',state:'NJ'},{name:'New Mexico',state:'NM'},{name:'New York',state:'NY'},{name:'North Carolina',state:'NC'},{name:'North Dakota',state:'ND'},{name:'Ohio',state:'OH'},{name:'Oklahoma',state:'OK'},{name:'Oregon',state:'OR'},{name:'Pennsylvania',state:'PA'},{name:'Rhode Island',state:'RI'},{name:'South Carolina',state:'SC'},{name:'South Dakota',state:'SD'},{name:'Tennessee',state:'TN'},{name:'Texas',state:'TX'},{name:'Utah',state:'UT'},{name:'Vermont',state:'VT'},{name:'Virginia',state:'VA'},{name:'Washington',state:'WA'},{name:'West Virginia',state:'WV'},{name:'Wisconsin',state:'WI'},{name:'Wyoming',state:'WY'}];}]);
﻿angular.module('customerSearch',[]).controller('customerSearchCtrl',['$scope','customer','$location','numberOnlyKeyPressValidator','$modal','msrService','$rootScope','$state','loggerService','$http','POSService','$filter','orderCart','securityService',function($scope,$customer,$location,$numberOnlyKeyPressValidator,$modal,$msrService,$rootScope,$state,loggerService,$http,$POSService,$filter,$orderCart,$securityService){$scope.numberValidator=$numberOnlyKeyPressValidator;$scope.isCsr=$securityService.isCsr();var myScroll=new IScroll('#CustomerSearchWrapper',{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip',tap:true});$scope.refreshIScroll=function(){setTimeout(function(){myScroll.refresh();},500);};var _groupCustomers=function(customerArray){if(!angular.isArray(customerArray)){return customerArray;}else{var customerKeyMap={};for(var i=0;i<customerArray.length;i++){if(customerArray[i].CustomerKey.trim()in customerKeyMap){customerKeyMap[customerArray[i].CustomerKey.trim()].push(customerArray[i]);}else{customerKeyMap[customerArray[i].CustomerKey.trim()]=[customerArray[i]];}}
var returnArray=[];for(var prop in customerKeyMap){if(prop.length!==0){returnArray.push(customerKeyMap[prop]);}}
returnArray.sort(function(a,b){var aNum=parseInt(a[0].CustomerKey);var bNum=parseInt(b[0].CustomerKey);if(aNum===Number.NaN&&bNum===Number.NaN){return 0;}
else if(aNum===Number.NaN){return 1;}
else if(bNum===Number.NaN){return-1;}
return bNum-aNum;});if(''in customerKeyMap){for(var p=0;p<customerKeyMap[''].length;p++){returnArray.push([customerKeyMap[''][p]]);}}
return returnArray;}};$scope.getDisplay=function(searchAddress){var standardAddress={};for(var prop in searchAddress){if((/^AddressId$/).test(prop.toString())){standardAddress['_AddressID']=searchAddress[prop];}else if((/^Zipcode$/).test(prop.toString())){standardAddress['_ZipCode']=searchAddress[prop];}else{standardAddress['_'+prop.toString()]=searchAddress[prop];}}
return $filter('oneLineAddress')(standardAddress,'long','name','id');};$scope.addToCart=function(customer){$customer.customerAction(customer,function(customerDetail){$customer.addToCart(customerDetail);if($orderCart.orderLine.util.orderlineCount()>0){$state.go("shippingSelection");}else{$state.go('itemSearch')
return;}},function(error){swal({title:"Error!",text:error,showConfirmButton:true});});};$scope.customerDetail=function(customer){$customer.customerAction(customer,function(data){$location.path("/customerDetail");},function(error){swal({title:"Error!",text:error,showConfirmButton:true});});}
var createSearchContract=function(manualSearch){var contract={};contract.Customer=angular.copy($scope.searchParam);for(key in contract.Customer){if(contract.Customer[key]=='')
delete contract.Customer[key];else if(manualSearch)
contract.Customer[key]=contract.Customer[key];}
if(angular.isString(contract.Customer.PhoneNumber)){contract.Customer.PhoneNumber=$filter('phoneFormatRemove')($scope.searchParam.PhoneNumber);}
return contract;}
$scope.search=function(manualSearch){var searchContract=createSearchContract(manualSearch);if(Object.keys(searchContract.Customer).length>0){$customer.customerSearch(searchContract,function(data){$scope.customers=_groupCustomers(data);if($scope.customers.length==0){jQuery('.not-found-alert').modal('show');}else{swal({title:"",text:'<span style="color:#FF2222">Verify address information with customer before making selection.</span>',html:true,timer:5000,showConfirmButton:false});}},function(err){alert(err);});}else{swal({title:"No Search Input",text:"No search input available for customer search.",timer:4000,showConfirmButton:true});}
$scope.refreshIScroll();};var resetParameters=function(){$scope.searchParam={};$scope.searchParam.FirstName='';$scope.searchParam.LastName='';$scope.searchParam.EmailAddress='';$scope.searchParam.PhoneNumber='';$scope.customers=[];$scope.refreshIScroll();};$scope.clearForm=function(){resetParameters();$customer.clearCachedResult();};$scope.createCustomer=function(){$state.go('addModifyAddress');};var showResults=function(){var cachedResult=$customer.getCachedResult();var cachedQueryParam=$customer.getCachedQueryParam();if(cachedQueryParam!=undefined){$scope.customers=_groupCustomers(cachedResult);$scope.searchParam=cachedQueryParam.Customer;if(angular.isString($scope.searchParam.PhoneNumber)){$scope.searchParam.PhoneNumber=$filter('phoneFormat')($scope.searchParam.PhoneNumber);}}else{resetParameters();}}
$scope.formatPhone=function(){$scope.searchParam.PhoneNumber=$filter('phoneFormat')($scope.searchParam.PhoneNumber);};showResults();$scope.isSearchable=function(){if(($scope.searchParam.FirstName&&$scope.searchParam.LastName&&$scope.searchParam.FirstName.length+$scope.searchParam.LastName.length>3)||($scope.searchParam.EmailAddress&&$scope.searchParam.EmailAddress.length>3)||($scope.searchParam.PhoneNumber&&$filter('phoneFormatRemove')($scope.searchParam.PhoneNumber).length==10)){return true;}
return false;}
$scope.customerData={};$scope.openCustomerScanOptions=function(){var modalInstance=$modal.open({templateUrl:'html/customer/customerSearchSwipeCard.html',controller:'swipeCardCtrl',backdrop:'static',keyboard:false,size:'sm'});modalInstance.result.then(function(response){$scope.msrData=response.msrData;$scope.cardType=response.cardType;if($scope.cardType=="AssociateDiscountCard"){if($scope.msrData.AccountNumber&&$scope.msrData.AccountNumber.trim().length>0){var url=serviceURL+'/CreditService/Lookup';var findCustomerObj={"LookupRequest":{"_AccountNumber":$scope.msrData.AccountNumber,"_OriginStoreNum":$POSService.getPOSParameters().storeNumber,"_SourceApplication":"Sterling","_IsTokenized":"N"}};$http.post(url,findCustomerObj).success(function(result){$scope.searchParam.LastName=result.LookupResponse._LastName;$scope.searchParam.FirstName=result.LookupResponse._FirstName;$scope.search(false);}).error(function(data){loggerService(data);});}}
else{$scope.searchParam.LastName=$scope.msrData.LastName;$scope.searchParam.FirstName=$scope.msrData.FirstName;$scope.search(false);}},function(){});};if($scope.isCsr===undefined||$scope.isCsr===null||!$scope.isCsr){$scope.openCustomerScanOptions();}
$scope.searchFieldEnabled=function(fieldName){switch(fieldName){case'email':return($scope.searchParam.FirstName||$scope.searchParam.LastName||$scope.searchParam.PhoneNumber);case'phone':return($scope.searchParam.FirstName||$scope.searchParam.LastName||$scope.searchParam.EmailAddress);case'name':return($scope.searchParam.PhoneNumber||$scope.searchParam.EmailAddress);}}}]);
﻿angular.module('customerDetail',[]).controller('customerDetailCtrl',['$scope','customer','$rootScope','$state','$location','$filter','ngTableParams','order','$modal','loggerService','orderCart',function($scope,$customer,$rootScope,$state,$location,$filter,ngTableParams,$order,$modal,$loggerService,$orderCart){var customerAddressIScroll={};$scope.refreshIScroll=function(iScrollName){if(!customerAddressIScroll[iScrollName]){customerAddressIScroll[iScrollName]=new IScroll('#'+iScrollName,{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip',scrollX:true});}
setTimeout(function(){customerAddressIScroll[iScrollName].refresh();},500);};$scope.selectedCustomer=$customer.getSelectedCustomer();$scope.selectedContact=$scope.selectedCustomer.CustomerContactList.CustomerContact[0];$scope.draftOrders=[];$scope.confirmOrders=[];$scope.returnOrders=[];var scopeRefresh=function(){$scope.selectedCustomer=$customer.getSelectedCustomer();$scope.selectedContact=$scope.selectedCustomer.CustomerContactList.CustomerContact[0];};$scope.contactClicked=function(contact){$scope.selectedContact=contact;}
$scope.modifyAddress=function(contactID,addressID){$state.go('addModifyAddress',{'customerContactID':contactID,'customerAdditionalAddressID':addressID});};$scope.deleteAddress=function(customerContactID,customerAdditionalAddressID){$customer.deleteAddress($scope.selectedCustomer._CustomerID,customerContactID,customerAdditionalAddressID,function(){scopeRefresh();},function(){});};$loggerService.log($scope.selectedCustomer);$scope.isDraftOrdersQueried=false;$scope.draftOrders=function(){$customer.retrieveDraftOrders(function(data){for(var i=0;i<data.length;i++){data[i]._GrandTotal=parseFloat(data[i]._GrandTotal);}
$scope.draftOrders=data;$scope.draftTableParams.reload();$scope.refreshIScroll('CustomerDraftWrapper');$scope.isDraftOrdersQueried=true;},function(data){$loggerService.log(data);});};$scope.isConfirmedOrdersQueried=false;$scope.confirmedOrders=function(){$customer.retrieveConfirmedOrders(function(data){for(var i=0;i<data.length;i++){data[i]._GrandTotal=parseFloat(data[i]._GrandTotal);}
$scope.confirmOrders=data;$scope.confirmedTableParams.reload();$scope.refreshIScroll('CustomerConfirmedWrapper');$scope.isConfirmedOrdersQueried=true;},function(data){$loggerService.log(data);});};$scope.isReturnOrdersQueried=false;$scope.returnOrders=function(){$customer.retrieveReturnOrders(function(data){for(var i=0;i<data.length;i++){data[i]._GrandTotal=parseFloat(data[i]._GrandTotal);}
$scope.returnOrders=data;$scope.returnTableParams.reload();$scope.refreshIScroll('CustomerReturnsWrapper');$scope.isReturnOrdersQueried=true;},function(data){$loggerService.log(data);});};$scope.addToCart=function(){$customer.addToCart($scope.selectedCustomer);if($orderCart.orderLine.util.orderlineCount()>0){$state.go("shippingSelection");}else{$state.go('itemSearch')
return;}};$scope.goToState=function(stateName,contactID){if(contactID){params={'customerContactID':contactID};}
$state.go(stateName,params);};$scope.draftTableParams=new ngTableParams({page:1,count:100000,sorting:{_OrderDate:'desc'}},{total:$scope.draftOrders.length,counts:[],getData:function($defer,params){var orderedData=params.sorting()?$filter('orderBy')($scope.draftOrders,params.orderBy()):$scope.draftOrders;$defer.resolve(orderedData);}});$scope.confirmedTableParams=new ngTableParams({page:1,count:100000,sorting:{_OrderDate:'desc'}},{total:$scope.confirmOrders.length,counts:[],getData:function($defer,params){var orderedData=params.sorting()?$filter('orderBy')($scope.confirmOrders,params.orderBy()):$scope.confirmOrders;$defer.resolve(orderedData);}});$scope.returnTableParams=new ngTableParams({page:1,count:100000,sorting:{_OrderDate:'desc'}},{total:$scope.returnOrders.length,counts:[],getData:function($defer,params){var orderedData=params.sorting()?$filter('orderBy')($scope.returnOrders,params.orderBy()):$scope.returnOrders;$defer.resolve(orderedData);}});$scope.openOrderDetail=function(selectedOrder){$order.setSelectedOrder(selectedOrder);$location.path("/orderDetail");return;};$scope.updateCustomer=function(){var modalInstance=$modal.open({templateUrl:'html/customer/modifyCustomer.html',controller:'modifyCustomerCtrl',resolve:{contactIdArg:function(){return $scope.selectedContact._CustomerContactID;}},size:'lg'});modalInstance.result.then(function(){scopeRefresh();});};}]);
﻿angular.module('modifyCustomer',['ui.bootstrap']).controller('modifyCustomerCtrl',['$scope','customer','$filter','contactIdArg','$modalInstance','loggerService','customerKeyPressValidator',function($scope,$customer,$filter,contactIdArg,$modalInstance,$loggerService,$customerKeyPressValidator){$scope.contact={};var contactID=contactIdArg;var customer={};$scope.isShowValidationMessages=false;$scope.keyPressValidator=$customerKeyPressValidator;var _locateContact=function(){for(var i=0;i<customer.CustomerContactList.CustomerContact.length;i++){if(customer.CustomerContactList.CustomerContact[i]._CustomerContactID.toString().trim()==contactID){return customer.CustomerContactList.CustomerContact[i];}}
$loggerService.log("No contact found! ");};var _init=function(){customer=angular.copy($customer.getSelectedCustomer());$scope.isValid=angular.copy(initValid);$scope.contact=_locateContact();$scope.formatPhone('_DayPhone');$scope.formatPhone('_EveningPhone');$scope.isShowValidationMessages=false;};$scope.formatPhone=function(contactAttrName){$scope.contact[contactAttrName]=$filter('phoneFormat')($scope.contact[contactAttrName]);};$scope.cancel=function(){$modalInstance.dismiss();};$scope.reset=function(){_init();};var initValid={_FirstName:{isValid:true,errorText:''},_MiddleName:{isValid:true,errorText:''},_LastName:{isValid:true,errorText:''},_EmailID:{isValid:true,errorText:''},_DayPhone:{isValid:true,errorText:''},_EveningPhone:{isValid:true,errorText:''},};$scope.isValid={};var _allValidationIsValid=function(){for(var prop in $scope.isValid){if(!$scope.isValid[prop].isValid){return false;}}
return true;};$scope.validate=function(){$scope.isValid=angular.copy(initValid);if(!$scope.contact._FirstName||!$scope.contact._FirstName.trim()){$scope.isValid._FirstName.isValid=false;$scope.isValid._FirstName.errorText='First Name Required';}
if(!$scope.contact._LastName||!$scope.contact._LastName.trim()){$scope.isValid._LastName.isValid=false;$scope.isValid._LastName.errorText='Last Name Required';}
if(!$scope.contact._DayPhone||!$scope.contact._DayPhone.trim()){$scope.isValid._DayPhone.isValid=false;$scope.isValid._DayPhone.errorText='Primary Phone Number Required';}else{var phoneTemp=$filter('phoneFormatRemove')($scope.contact._DayPhone);if(phoneTemp.length!==10){$scope.isValid._DayPhone.isValid=false;$scope.isValid._DayPhone.errorText='Enter 10 Digit Phone Number';}}
if($scope.contact._EveningPhone&&$scope.contact._EveningPhone.trim()){var phoneTemp=$filter('phoneFormatRemove')($scope.contact._EveningPhone);if(phoneTemp.length!==10){$scope.isValid._EveningPhone.isValid=false;$scope.isValid._EveningPhone.errorText='Enter 10 Digit Phone Number';}}
if(!$scope.contact._EmailID||!$scope.contact._EmailID.trim()){$scope.isValid._EmailID.isValid=false;$scope.isValid._EmailID.errorText='Email Required';}else{if(!(/.+@.+\..+/).test($scope.contact._EmailID)){$scope.isValid._EmailID.isValid=false;$scope.isValid._EmailID.errorText='Invalid Email';}}};$scope.save=function(){$scope.validate();$scope.isShowValidationMessages=true;if(_allValidationIsValid()){$customer.updateCustomerContact(customer,function(){$modalInstance.close();},function(data){$loggerService.log(data);});}};_init();}]);
﻿angular.module('orderSearch',['ngTable']).controller('orderSearchCtrl',['$scope','order','$filter','ngTableParams','$location','numberOnlyKeyPressValidator','loggerService','$timeout',function($scope,$order,$filter,ngTableParams,$location,$numberOnlyKeyPressValidator,$loggerService,$timeout){$scope.numberValidator=$numberOnlyKeyPressValidator;$scope.search=function(){if($scope.validation.form.valid){$scope.orders=angular.copy([],$scope.orders);var param={};if($scope.formInput.orderNumber){param={"GetSterlingOrderListReq":{"_CustomerEmailID":"","_CustomerPhoneNo":"","_CustomerLastName":"","_CustomerLastNameQryType":"FLIKE","_CustomerFirstName":"","_CustomerFirstNameQryType":"FLIKE","_ZipCode":"","_GiftRegistryID":"","_ReadFromHistory":$scope.formInput.showHistoryOrders?"Y":"N","_OrderNo":$scope.formInput.orderNumber,"_DraftOrderFlag":$scope.formInput.showHistoryOrders?"N":""}};}else{param={"GetSterlingOrderListReq":{"_CustomerEmailID":$scope.formInput.email,"_CustomerPhoneNo":$filter('phoneFormatRemove')($scope.formInput.phoneNumber),"_CustomerLastName":$scope.formInput.lastName,"_CustomerLastNameQryType":"FLIKE","_CustomerFirstName":$scope.formInput.firstName,"_CustomerFirstNameQryType":"FLIKE","_ZipCode":$scope.formInput.zipCode,"_GiftRegistryID":$scope.formInput.giftRegistry,"_ReadFromHistory":$scope.formInput.showHistoryOrders?"Y":"N","_OrderNo":$scope.formInput.orderNumber,"_DraftOrderFlag":$scope.formInput.showHistoryOrders?"N":""}};}
$order.getOrderList(param,function(result){if(result===undefined){jQuery('.not-found-alert').modal('show');}else{for(var i=0;i<result.length;i++){result[i]._GrandTotal=parseFloat(result[i]._GrandTotal);if((/^0003$/).test(result[i]._DocumentType)){result[i]._orderType='Return';}else if((/^0001$/).test(result[i]._DocumentType)){if((/^Y$/i).test(result[i]._DraftOrderFlag)){result[i]._orderType='Draft';}else{result[i]._orderType='Order';}}else{result[i]._orderType='';}}
angular.copy(result,$scope.orders);}
$scope.tableParams.reload();$scope.refreshIScroll();if($scope.orders.length===1){$scope.openOrderDetail($scope.orders[0]);}},function(error){alert(error);});}};$scope.clearSearch=function(){$scope.resetForm();$scope.orders=angular.copy([],$scope.orders);$scope.tableParams.reload();}
$scope.checkedButtonFont='fa-check fa-2x';$scope.toggleHistorySearch=function(){if($scope.formInput.showHistoryOrders){$scope.formInput.showHistoryOrders='';}else{$scope.formInput.showHistoryOrders='Y';}};$scope.orders=[];$scope.orderNoPaste=function($event){if(typeof $event.originalEvent.clipboardData!=="undefined"){handlePastedOrderNo($event.originalEvent.clipboardData.getData('text/plain'));}else{$timeout(function(){handlePastedOrderNo(angular.element($event.currentTarget).val());},2);}};var handlePastedOrderNo=function(pastedText){var cleansedText="";for(var i=0;i<pastedText.length;i++){if((/\d/).test(pastedText[i])){cleansedText+=pastedText[i];}}
$timeout(function(){$scope.formInput.orderNumber=cleansedText;},3);};$scope.tableParams=new ngTableParams({page:1,count:100000,sorting:{_OrderDate:'desc'}},{total:$scope.orders.length,counts:[],getData:function($defer,params){var orderedData=params.sorting()?$filter('orderBy')($scope.orders,params.orderBy()):$scope.orders;$defer.resolve(orderedData.slice((params.page()-1)*params.count(),params.page()*params.count()));$scope.refreshIScroll();}});if($scope.orders.length>0){$scope.tableParams.reload();}
$scope.openOrderDetail=function(selectedOrder){$order.setSelectedOrder(selectedOrder);$location.path("/orderDetail");};$scope.data=[];$scope.formInput={orderNumber:'',phoneNumber:'',firstName:'',lastName:'',email:'',zipCode:'',giftRegistry:'',showHistoryOrders:''};$scope.validation={email:{valid:true,isShowError:false,error:''},firstName:{valid:true,isShowError:false,error:''},fullName:{valid:true,isShowError:false,error:''},giftRegistry:{valid:true,isShowError:false,error:''},lastName:{valid:true,isShowError:false,error:''},orderNumber:{valid:true,isShowError:false,error:''},phoneNumber:{valid:true,isShowError:false,error:''},zipCode:{valid:true,isShowError:false,error:''},form:{valid:false,isShowError:false,error:''}};var _resetValidation=function(){for(prop in $scope.validation){$scope.validation[prop].valid=true;$scope.validation[prop].isShowError=false;$scope.validation[prop].error='';}
$scope.validation.form.valid=false;};$scope.resetForm=function(){for(prop in $scope.formInput){$scope.formInput[prop]='';}
_resetValidation();};$scope.formatPhone=function(){$scope.formInput.phoneNumber=$filter('phoneFormat')($scope.formInput.phoneNumber);};$scope.validate=function(){_resetValidation();for(prop in $scope.formInput){$scope.formInput[prop]=$scope.formInput[prop].trim();}
if($scope.formInput.orderNumber){if($scope.formInput.phoneNumber||$scope.formInput.firstName||$scope.formInput.lastName||$scope.formInput.email||$scope.formInput.zipCode||$scope.formInput.giftRegistry){$scope.validation.orderNumber.isShowError=true;$scope.validation.orderNumber.error='Only order number will be searched.';}
$scope.validation.form.valid=true;}
if($scope.formInput.email){if($scope.formInput.email.length<5){$scope.validation.email.valid=false;$scope.validation.email.error='Email requires five characters.';$scope.validation.email.isShowError=true;}
if($scope.validation.email.valid){$scope.validation.form.valid=true;}}
if($scope.formInput.phoneNumber){var testNumbers=$filter('phoneFormatRemove')($scope.formInput.phoneNumber);if(testNumbers.length!=10){$scope.validation.phoneNumber.valid=false;$scope.validation.phoneNumber.error='Phone must be 10 digits.';$scope.validation.phoneNumber.isShowError=true;}
if($scope.validation.phoneNumber.valid){$scope.validation.form.valid=true;}}
if($scope.formInput.firstName||$scope.formInput.lastName){if($scope.formInput.firstName.length<1){$scope.validation.firstName.valid=false;$scope.validation.firstName.error='First Name requires one character.';$scope.validation.firstName.isShowError=true;}
if($scope.formInput.lastName.length<1){$scope.validation.lastName.valid=false;$scope.validation.lastName.error='Last Name requires one character.';$scope.validation.lastName.isShowError=true;}
var tempTotal=$scope.formInput.firstName.length+$scope.formInput.lastName.length;if(tempTotal<4){$scope.validation.fullName.valid=false;$scope.validation.fullName.error='Four character minimum between First and Last Name.';$scope.validation.fullName.isShowError=true;}
if($scope.validation.fullName.valid&&$scope.validation.firstName.valid&&$scope.validation.lastName.valid){$scope.validation.form.valid=true;}}
if($scope.formInput.zipCode){if($scope.formInput.zipCode.length!=5){$scope.validation.zipCode.valid=false;$scope.validation.zipCode.error='Zip must be 5 digits.';$scope.validation.zipCode.isShowError=true;}else{var otherValidInput=false;if($scope.formInput.orderNumber&&$scope.validation.orderNumber.valid){otherValidInput=true;}
if($scope.formInput.email&&$scope.validation.email.valid){otherValidInput=true;}
if($scope.formInput.phoneNumber&&$scope.validation.phoneNumber.valid){otherValidInput=true;}
if($scope.formInput.firstName&&$scope.validation.firstName.valid){otherValidInput=true;}
if($scope.formInput.lastName&&$scope.validation.lastName.valid){otherValidInput=true;}
if($scope.formInput.giftRegistry&&$scope.validation.giftRegistry.valid){otherValidInput=true;}
if(!otherValidInput){$scope.validation.zipCode.valid=false;$scope.validation.zipCode.error='Zip cannot be searched alone. Fill in secondary input.';$scope.validation.zipCode.isShowError=true;}}
if($scope.validation.zipCode.valid){$scope.validation.form.valid=true;}}
if($scope.formInput.giftRegistry&&$scope.validation.giftRegistry.valid){$scope.validation.form.valid=true;}
if(!$scope.formInput.orderNumber&&(!$scope.validation.phoneNumber.valid||!$scope.validation.zipCode.valid)){$scope.validation.form.valid=false;}};$scope.refreshIScroll=function(){setTimeout(function(){$scope.$parent.myScroll['wrapper'].refresh();},500);};var _init=function(){$scope.orders=$order.getPreviousSearchResult();$scope.tableParams.reload();$scope.refreshIScroll();};_init();var handleBarCodeScan=function(event,barcodeData){if(!angular.isString(barcodeData)){barcodeData=(!angular.isDefined(barcodeData)||barcodeData===null)?'':barcodeData.toString().trim();}
$scope.formInput.orderNumber=barcodeData.substring(0,9);$scope.validate();$scope.search(false);};var deregister=$scope.$on('Scanner_Event',handleBarCodeScan);$scope.$on("$destroy",function(){deregister();});}]);
﻿angular.module('orderDetail',['ui.bootstrap']).controller('orderDetailCtrl',['$scope','order','$modal','$location','itemSearch','itemProperty','printerService','$rootScope','ngTableParams','$filter','$q','$state','sendSMTPErrorEmail','btProp','POSService','securityService',function($scope,$order,$modal,$location,$itemSearch,$itemProperty,$printerService,$rootScope,ngTableParams,$filter,$q,$state,$sendSMTPErrorEmail,$btProp,$POSService,$securityService){$scope.isLoaded=false;$scope.isReturnOrder=false;$scope.orderDetail={};$scope.isCsr=$securityService.isCsr();var storeNumber="";storeNumber=$POSService.getPOSParameters().storeNumber;storeNumber=storeNumber.toString();while(storeNumber.length<3){storeNumber="0"+storeNumber;}
var selectedOrder=$order.getSelectedOrder();if(selectedOrder==undefined){$location.path("/orderSearch");};var param={"GetSterlingOrderDetailReq":{"_OrderNo":selectedOrder._OrderNo,"_EnterpriseCode":"BONTON"}};if(angular.isDefined(selectedOrder._DocumentType)&&angular.isString(selectedOrder._DocumentType)){param.GetSterlingOrderDetailReq._DocumentType=selectedOrder._DocumentType;}
var deregisterPrinterErrorEvent=$rootScope.$on('Printer_Error',function(event,errorData){swal({title:"Alert!",text:errorData.StatusText,showConfirmButton:true});});$scope.$on('destroy',function(){deregisterPrinterErrorEvent();});$scope.printPickUpReceipt=function(PrintType){$printerService.claimPrinter().then(function(){selectedOrder._DocumentType="0001";$printerService.printOrder(selectedOrder._OrderNo,false,"BOPISPickupReceipt");$printerService.releasePrinter();});};$scope.printOrderSummary=function(PrintType){$printerService.claimPrinter().then(function(){$printerService.printOrder(selectedOrder._OrderNo,false,"LUFIOrderSummary");$printerService.releasePrinter();});}
$scope.itemDetail=function(upc){$itemSearch.searchUPC(upc,function(response){if(response.ngroups&&response.ngroups==0){jQuery('.not-found-alert').modal('show');}else if(response.isnGroup.length==1){$itemSearch.setSelectedISNGroup(response.isnGroup[0]);$location.path('/itemDetail');}else{$location.path("/itemResults");}},function(err){alert(err);});};var myIScroll=null;$scope.refreshIScroll=function(){if(!myIScroll){myIScroll=new IScroll('#orderLineWrapper',{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip',scrollX:true});}
setTimeout(function(){myIScroll.refresh();},500);};var returnsIScroll=null;$scope.refreshReturnsIScroll=function(){if(!returnsIScroll){returnsIScroll=new IScroll('#orderLineWrapperReturns',{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip',scrollX:true});}
setTimeout(function(){returnsIScroll.refresh();},500);};$scope.hasBopisLines=false;$scope.bopisOverallStatus="---";var _determineBopisOverallStatus=function(){if(angular.isDefined($scope.orderDetail)&&angular.isDefined($scope.orderDetail.Shipments)&&angular.isArray($scope.orderDetail.Shipments.Shipment)&&($scope.orderDetail.Shipments.Shipment.length>0)){var statusEnum={"1100.100":1,"1400.100":2,"1600.002":2,"1600.002.001":2,"1600.002.010":3,"1600.002.020":4,"9000":5,getStatusName:function(statusInt){if(statusInt===1){return"Picking Items";}else if(statusInt===2){return"Ready for Pick-Up";}else if(statusInt===3){return"Customer Has Picked-Up";}else if(statusInt===4){return"Returned-Restocked";}else if(statusInt===5){return"Cancelled";}else{return"Unknown Status";}}};var lowestStatus=undefined;for(var i=0;i<$scope.orderDetail.Shipments.Shipment.length;i++){var currentShipment=$scope.orderDetail.Shipments.Shipment[i];if((/^\s*BOPIS\s*$/i).test(currentShipment._ShipmentType)){if(lowestStatus===undefined){lowestStatus=statusEnum[currentShipment._Status];}else{if(angular.isDefined(currentShipment._Status)&&angular.isDefined(statusEnum[currentShipment._Status])&&(statusEnum[currentShipment._Status]<lowestStatus)){lowestStatus=statusEnum[currentShipment._Status];}}}}
$scope.bopisOverallStatus=statusEnum.getStatusName(lowestStatus);}else{$scope.bopisOverallStatus="---";}};_determineBopisOverallStatus();$scope.selectLineItem=function(lineItem){$scope.selectedLineItem=lineItem;};var _setBtLogicDetails=function(){if($scope.orderDetail&&$scope.orderDetail.OrderLines&&$scope.orderDetail.OrderLines.OrderLine){var shipmentKepMap={};if($scope.orderDetail.Shipments&&angular.isArray($scope.orderDetail.Shipments.Shipment)){for(var p=0;p<$scope.orderDetail.Shipments.Shipment.length;p++){if($scope.orderDetail.Shipments.Shipment[p]._ShipmentKey&&angular.isString($scope.orderDetail.Shipments.Shipment[p]._ShipmentKey)&&($scope.orderDetail.Shipments.Shipment[p]._ShipmentKey.trim().length>0)){shipmentKepMap[$scope.orderDetail.Shipments.Shipment[p]._ShipmentKey.trim()]=$scope.orderDetail.Shipments.Shipment[p];}}}
for(var i=0;i<$scope.orderDetail.OrderLines.OrderLine.length;i++){var currentLine=$scope.orderDetail.OrderLines.OrderLine[i];currentLine.btLogic.orderDetail={isReturned:false,isGiftMessage:false,isBopisLine:false,trackingNoString:'',ShipDate:'',CarrierServiceCode:''};if(currentLine.ReturnOrderLines&&currentLine.ReturnOrderLines.OrderLine&&(currentLine.ReturnOrderLines.OrderLine.length>0)){currentLine.btLogic.orderDetail.isReturned=true;}
if(angular.isString(currentLine._LineType)&&(/^\s*BOPIS\s*$/i).test(currentLine._LineType)){currentLine.btLogic.orderDetail.isBopisLine=true;}
currentLine.btLogic.orderDetail.sortableUnitPrice=parseFloat(currentLine.LinePriceInfo._UnitPrice);currentLine.btLogic.orderDetail.sortableQuantity=parseFloat(currentLine._OrderedQty);if(currentLine.btDisplay&&currentLine.btDisplay.id){currentLine.btLogic.orderDetail.sortableUpc=parseInt(currentLine.btDisplay.id);}else{currentLine.btLogic.orderDetail.sortableUpc=isFinite(parseInt(currentLine.Item._UPCCode))?parseInt(currentLine.Item._UPCCode):-1;}
if(currentLine.Notes&&currentLine.Notes.Note){var isGiftNotes=false;for(var p=0;p<currentLine.Notes.Note.length;p++){if((/^GIFT_(?:MESSAGE|FROM|TO)/).test(currentLine.Notes.Note[p]._ReasonCode)){isGiftNotes=true;break;}}
currentLine.btLogic.orderDetail.isGiftMessage=isGiftNotes;}
if(currentLine.btLogic.orderDetail.isBopisLine){currentLine.btLogic.orderDetail.trackingNoString="---";}
else if(currentLine.Containers&&currentLine.Containers.Container&&(currentLine.Containers.Container.length>0)){var tempStringArray=[];for(var x=0;x<currentLine.Containers.Container.length;x++){if(currentLine.Containers.Container[x]._TrackingNo){tempStringArray.push(currentLine.Containers.Container[x]._TrackingNo.toString());}}
tempStringArray.sort();currentLine.btLogic.orderDetail.trackingNoString=tempStringArray.join(', ');}
if(currentLine.btLogic.orderDetail.isBopisLine){currentLine.btLogic.orderDetail.ShipDate="---";}
else if(currentLine.ShipmentLines&&angular.isArray(currentLine.ShipmentLines.ShipmentLine)&&(currentLine.ShipmentLines.ShipmentLine.length>0)&&angular.isString(currentLine.ShipmentLines.ShipmentLine[0]._ShipmentKey)){var shipment=shipmentKepMap[currentLine.ShipmentLines.ShipmentLine[0]._ShipmentKey.trim()];if(shipment){if(angular.isString(shipment._ShipDate)&&(shipment._ShipDate.trim().length>0)){currentLine.btLogic.orderDetail.ShipDate=shipment._ShipDate.trim();}else if(angular.isString(shipment._ExpectedShipmentDate)&&(shipment._ExpectedShipmentDate.trim().length>0)){currentLine.btLogic.orderDetail.ShipDate=shipment._ExpectedShipmentDate.trim();}}}
if(currentLine.btLogic.orderDetail.isBopisLine){currentLine.btLogic.orderDetail.CarrierServiceCode="---";}
else{currentLine.btLogic.orderDetail.CarrierServiceCode=angular.isString(currentLine._CarrierServiceCode)?currentLine._CarrierServiceCode:"";}}}};var _setUpDisplayTable=function(result){$scope.orderDetail=result;_setBtLogicDetails();_determineBopisOverallStatus();if($scope.orderDetail._DocumentType&&$scope.orderDetail._DocumentType=='0003'){$scope.isReturnOrder=true;}
$scope.selectLineItem($scope.orderDetail.OrderLines.OrderLine[0]);if(angular.isObject($scope.orderlineTableReturnParams)){$scope.orderlineTableReturnParams.reload();}else{$scope.orderlineTableReturnParams=new ngTableParams({page:1,count:100000},{total:$scope.orderDetail.OrderLines.OrderLine.length,counts:[],getData:function($defer,params){var orderedData=params.sorting()?$filter('orderBy')($scope.orderDetail.OrderLines.OrderLine,params.orderBy()):$scope.orderDetail.OrderLines.OrderLine;$defer.resolve(orderedData);$scope.refreshReturnsIScroll();}});}
if(angular.isObject($scope.orderlineTableParams)){$scope.orderlineTableParams.reload();}else{$scope.orderlineTableParams=new ngTableParams({page:1,count:100000},{total:$scope.orderDetail.OrderLines.OrderLine.length,counts:[],getData:function($defer,params){var orderedData=params.sorting()?$filter('orderBy')($scope.orderDetail.OrderLines.OrderLine,params.orderBy()):$scope.orderDetail.OrderLines.OrderLine;$defer.resolve(orderedData);$scope.refreshIScroll();}});}
$scope.isLoaded=true;if($scope.isReturnOrder){$scope.refreshIScroll();}else{$scope.refreshReturnsIScroll();}};$scope.getOrderDetails=function(){$scope.isLoaded=false;$order.getOrderDetail(param,_setUpDisplayTable,function(error){alert(error);});};var _initOrderDetail=function(){$scope.orderDetail={};var previousLoadedOrder=$order.getCurrentOrderDetails();if(!angular.isDefined(previousLoadedOrder)||previousLoadedOrder===null||previousLoadedOrder._OrderNo!==selectedOrder._OrderNo){$scope.getOrderDetails();}else{$scope.orderDetail=previousLoadedOrder;_setUpDisplayTable($scope.orderDetail);}};_initOrderDetail();$scope.goToNotes=function(orderline){var orderlineNo='';if(orderline){orderlineNo=orderline._PrimeLineNo.toString().trim()+'_'+orderline._SubLineNo.toString().trim();}
$state.go('orderNote',{'orderLineNo':orderlineNo});};$scope.isOrderPrintable=function(){if($scope.isCsr){return false;}
if($scope.orderDetail&&$scope.orderDetail._DocumentType&&$scope.orderDetail._Status&&$scope.orderDetail._DocumentType==="0001"&&!(/(^|\s)(draft|cancelled)/).test($scope.orderDetail._Status.toString().toLowerCase())){return true;}else{return false;}};$scope.isOrderHasReturns=function(){if($scope.orderDetail&&$scope.orderDetail.ReturnOrders&&$scope.orderDetail.ReturnOrders.ReturnOrder&&($scope.orderDetail.ReturnOrders.ReturnOrder.length>0)){return true;}else{return false;}};$scope.isShopRunnerOrder=function(){if($scope.orderDetail&&$scope.orderDetail.Extn&&angular.isString($scope.orderDetail.Extn._ExtnSRAuthToken)&&($scope.orderDetail.Extn._ExtnSRAuthToken.length>0)){return true;}else{return false;}};$scope.isBuyablePriceStatusFOrP=function(orderline){if(angular.isDefined(orderline.btDisplay)){return $itemProperty.isItemActiveBuyable(orderline.btDisplay);}
return false;};$scope.openOrderDetail=function(orderNo){$order.setSelectedOrder({'_OrderNo':angular.copy(orderNo)});param.GetSterlingOrderDetailReq._OrderNo=orderNo;$scope.orderDetail._OrderNo=orderNo;$scope.isReturnOrder=false;$scope.isLoaded=false;$scope.getOrderDetails();};$scope.openOrderPricingDetail=function(){var modalInstance=$modal.open({templateUrl:'html/order/orderPricingDetail.html',controller:'orderDetailsOrderPricingDetailCtrl',resolve:{cart:function(){return $scope.orderDetail;}}});};var _getBopisDesignee=function(orderline,order){var designee={Name:"",NotificationType:"",NotificationMobileOrEmailDetail:""};if(orderline.btLogic.orderDetail.isBopisLine){var tempDesignee={Name:"",NotificationType:"",MobilePhone:"",Email:"",hasName:false,hasMobilePhone:false,hasEmail:false};if($scope.orderDetail.Instructions&&angular.isArray($scope.orderDetail.Instructions.Instruction)){for(var i=0;i<$scope.orderDetail.Instructions.Instruction.length;i++){var currentInstruction=$scope.orderDetail.Instructions.Instruction[i];if(angular.isString(currentInstruction._InstructionType)&&angular.isString(currentInstruction._InstructionText)){if((/^\s*Designee\s*$/i).test(currentInstruction._InstructionType)){tempDesignee.Name=currentInstruction._InstructionText.trim();if(tempDesignee.Name.length>0){tempDesignee.hasName=true;}}
else if((/^\s*Text\s*$/i).test(currentInstruction._InstructionType)){tempDesignee.MobilePhone=currentInstruction._InstructionText.trim();if(tempDesignee.MobilePhone.length>0){tempDesignee.hasMobilePhone=true;}}
else if((/^\s*Email\s*$/i).test(currentInstruction._InstructionType)){tempDesignee.Email=currentInstruction._InstructionText.trim();if(tempDesignee.Email.length>0){tempDesignee.hasEmail=true;}}}}}
if(!tempDesignee.hasName){if(order&&order.PersonInfoBillTo){if(angular.isString(order.PersonInfoBillTo._FirstName)){tempDesignee.Name=order.PersonInfoBillTo._FirstName.trim();}
if(angular.isString(order.PersonInfoBillTo._LastName)){tempDesignee.Name+=" "+order.PersonInfoBillTo._LastName.trim();}
tempDesignee.Name=tempDesignee.Name.trim();if(tempDesignee.Name.length<1){tempDesignee.Name="Unknown";}}}
if(!tempDesignee.hasEmail){if(order&&order.PersonInfoBillTo){if(angular.isString(order.PersonInfoBillTo._EmailID)){tempDesignee.Email=order.PersonInfoBillTo._EmailID.trim();}
if(tempDesignee.Email.length<1){tempDesignee.Email="Unknown";tempDesignee.hasEmail=false;}else{tempDesignee.hasEmail=true;}}}
designee.Name=tempDesignee.Name;if(tempDesignee.hasMobilePhone){designee.NotificationType="Text";designee.NotificationMobileOrEmailDetail=tempDesignee.MobilePhone;}else if(tempDesignee.hasEmail){designee.NotificationType="Email";designee.NotificationMobileOrEmailDetail=tempDesignee.Email;}else{designee.NotificationType="None";designee.NotificationMobileOrEmailDetail="";}}
return designee;};$scope.openOrderLineDetail=function(ngTableOrderline){var modalInstance=$modal.open({templateUrl:'html/order/orderDetailOrderLineAdditionalDetails.html',controller:'orderDetailsOrderLineDetailCtrl',resolve:{orderline:function(){return ngTableOrderline;},associateCreatedOrder:function(){if($scope.orderDetail.Extn){return $scope.orderDetail.Extn._ExtnAssociateId;}else{return'';}},bopisDesignee:function(){return _getBopisDesignee(ngTableOrderline,$scope.orderDetail);}},size:'lg'});};$scope.returnSummary=function(){$state.go('returnSummary');};$scope.showCancelOrderButton=function(){if($btProp.getProp('orderDetailCanCancelOrder')===false){return false;}
else{return $order.canCancelOrder($scope.orderDetail);}};$scope.cancelOrder=function(orderDetail){var modalInstance=$modal.open({templateUrl:'html/order/cancelOrderModal.html',controller:'cancelOrderCtrl',resolve:{passedOrderDetail:function(){return orderDetail;}}});modalInstance.result.then(function(){$order.getOrderDetail(param,function(result){$scope.orderDetail=result;$scope.orderlineTableParams.reload();},function(error){alert(error);});},function(){});};$scope.showDraftReOrderButton=function(){if($btProp.getProp('orderDetailCanLoadDraftOrder')===false){return false;}
if(angular.isDefined($scope.orderDetail)&&angular.isDefined($scope.orderDetail._DocumentType)&&$scope.orderDetail._DocumentType=="0001"){return true;}else{return false;}};$scope.showPickUpReceiptButton=function(){if($scope.isCsr){return false;}
var response=false;if(angular.isDefined($scope.orderDetail)&&angular.isDefined($scope.orderDetail.Shipments)&&angular.isArray($scope.orderDetail.Shipments.Shipment)&&($scope.orderDetail.Shipments.Shipment.length>0)){var bopisShipment=null;for(var i=0;i<$scope.orderDetail.Shipments.Shipment.length;i++){var currentShipment=$scope.orderDetail.Shipments.Shipment[i];if((/^\s*BOPIS\s*$/i).test(currentShipment._ShipmentType)){$scope.hasBopisLines=true;if(currentShipment._ShipNode===storeNumber){bopisShipment=currentShipment;break;}}}
if(bopisShipment!==null&&angular.isString(bopisShipment._Status)){if(bopisShipment._Status==="1100.100"||bopisShipment._Status==="1400.100"||bopisShipment._Status==="1600.002"||bopisShipment._Status==="1600.002.001"){if(angular.isDefined(bopisShipment.ShipmentLines)&&angular.isArray(bopisShipment.ShipmentLines.ShipmentLine)&&(bopisShipment.ShipmentLines.ShipmentLine.length>0)){var isAllLinesYes=true;for(var p=0;p<bopisShipment.ShipmentLines.ShipmentLine.length;p++){var currentShipmentLine=bopisShipment.ShipmentLines.ShipmentLine[p];if(!(angular.isDefined(currentShipmentLine.Extn)&&angular.isString(currentShipmentLine.Extn._ExtnIsPicked)&&(currentShipmentLine.Extn._ExtnIsPicked==="Y"))){isAllLinesYes=false;break;}}
response=isAllLinesYes;}}}}
return response;};$scope.draftButtonText=function(){if(angular.isDefined($scope.orderDetail)&&angular.isDefined($scope.orderDetail._DraftOrderFlag)&&$scope.orderDetail._DraftOrderFlag==="Y"){return'Continue Draft';}else{return'Re-Order';}};$scope.loadDraftOrder=function(){$rootScope.$broadcast('breadCrumbReset');$state.go('orderCart',{'loadDraft':'LoadDraft'});};$scope.showConfirmPickupButton=function(){if($scope.isCsr){return false;}
var response=false;if(angular.isDefined($scope.orderDetail)&&angular.isDefined($scope.orderDetail.Shipments)&&angular.isArray($scope.orderDetail.Shipments.Shipment)&&($scope.orderDetail.Shipments.Shipment.length>0)){var bopisShipment=null;for(var i=0;i<$scope.orderDetail.Shipments.Shipment.length;i++){var currentShipment=$scope.orderDetail.Shipments.Shipment[i];if((/^\s*BOPIS\s*$/i).test(currentShipment._ShipmentType)){$scope.hasBopisLines=true;if(currentShipment._ShipNode===storeNumber){bopisShipment=currentShipment;break;}}}
if(bopisShipment!==null&&angular.isString(bopisShipment._Status)){if(bopisShipment._Status==="1400.100"||bopisShipment._Status==="1600.002"||bopisShipment._Status==="1600.002.001"){response=true;}}}
return response;};$scope.confirmCustomerPickup=function(){var modalInstance=$modal.open({templateUrl:'html/pickUpInStore/confirmPickupModal.html',controller:'confirmPickupCtrl',backdrop:'static',resolve:{cart:function(){return $scope.orderDetail;}},size:'lg',});modalInstance.result.then(function(){$scope.getOrderDetails()},function(){});};}]).controller('orderDetailsOrderLineDetailCtrl',['$scope','orderline','associateCreatedOrder','bopisDesignee','$filter','$modalInstance','order',function($scope,orderline,associateCreatedOrder,bopisDesignee,$filter,$modalInstance,$order){$scope.orderline=orderline;$scope.bopisPickup={Name:"",NotificationType:"",NotificationMobileOrEmailDetail:""};$scope.associateCreatedOrder=associateCreatedOrder;if($scope.orderline.btLogic.orderDetail.isBopisLine&&angular.isObject(bopisDesignee)){$scope.bopisPickup.Name=angular.isString(bopisDesignee.Name)?bopisDesignee.Name.trim():"N/A";$scope.bopisPickup.NotificationType=angular.isString(bopisDesignee.NotificationType)?bopisDesignee.NotificationType.trim():"N/A";$scope.bopisPickup.NotificationMobileOrEmailDetail=angular.isString(bopisDesignee.NotificationMobileOrEmailDetail)?bopisDesignee.NotificationMobileOrEmailDetail.trim():"";$scope.bopisPickup.NotificationMobileOrEmailDetail=((/^\s*Text\s*$/i).test($scope.bopisPickup.NotificationType))?"Mobile Number: "+$filter('phoneFormat')($scope.bopisPickup.NotificationMobileOrEmailDetail):"Email: "+$scope.bopisPickup.NotificationMobileOrEmailDetail;}
var pricingWithBadTotal=$order.orderLineItemPricingDetail(orderline);if(pricingWithBadTotal&&angular.isArray(pricingWithBadTotal.category)){for(var i=0;i<pricingWithBadTotal.category.length;i++){if((/^total$/i).test(pricingWithBadTotal.category[i].categoryDescription)){pricingWithBadTotal.category.splice(i,1);break;}}}
$scope.pricingDetail=pricingWithBadTotal;$scope.hasCoupons=angular.isArray($scope.pricingDetail.coupons)&&($scope.pricingDetail.coupons.length>0);var myModalIScroll=null;$scope.refreshModalIScroll=function(){if(!myModalIScroll){myModalIScroll=new IScroll("#discountsWrapper",{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip'});}
setTimeout(function(){myModalIScroll.refresh();},500);};$scope.close=function(){$modalInstance.close();};}]).controller('orderDetailsOrderPricingDetailCtrl',['$scope','order','cart','$modalInstance','$modal','numberOnlyKeyPressValidator',function($scope,order,cart,$modalInstance,$modal,$numberOnlyKeyPressValidator){var totalShippingDiscount;$scope.updatingPrice=false;$scope.isModalCalledFromOrderDetails=true;order.getSkyTotaling(cart);$scope.openModifyCharge=function(item){$scope.item=item;$scope.newCharge=item.total;$scope.updatingPrice=true;};$scope.numberValidator=$numberOnlyKeyPressValidator;$scope.calculateFlatRate=function(){$scope.newCharge=$scope.item.total;$scope.percentage=undefined;if($scope.flatRate&&isFinite($scope.flatRate)){$scope.newCharge=$scope.flatRate>$scope.item.total||$scope.flatRate<0?$scope.item.total:$scope.flatRate;}}
$scope.update=function(){totalShippingDiscount=(parseFloat(cart._ShippingChrgTotal)-parseFloat($scope.newCharge)).toFixed(2);var orderTotal=0;angular.forEach($scope.pricingDetail.category,function(value,key){if(value.categoryDescription.toLowerCase()==='shipping'){value.total=$scope.newCharge;}
if(value.categoryDescription.toLowerCase()==='order total'){value.total=cart._OrderTotal-((cart._ShippingChrgTotal-$scope.newCharge)-cart._ShippingDiscTotal);}});$scope.updatingPrice=false;$scope.newCharge=0;$scope.close();}
$scope.cancel=function(){$scope.updatingPrice=false;}
$scope.pricingDetail=order.orderPricingDetail(cart,!$scope.isModalCalledFromOrderDetails);$scope.close=function(){var returnVar={newShippingDiscount:totalShippingDiscount,cart:cart};$modalInstance.close(returnVar);};$scope.dismiss=function(){$modalInstance.dismiss();};}]).controller('orderPricingDetailCtrl',['$scope','order','cart','$modalInstance','$modal','numberOnlyKeyPressValidator',function($scope,order,cart,$modalInstance,$modal,$numberOnlyKeyPressValidator){var totalShippingDiscount;$scope.isModalCalledFromOrderDetails=false;$scope.updatingPrice=false;if(!angular.isDefined(cart._UnitPriceTotal)||cart._UnitPriceTotal===null){$scope.isModalCalledFromOrderDetails=true;order.getSkyTotaling(cart);}
$scope.openModifyCharge=function(item){$scope.item=item;$scope.newCharge=item.total;$scope.updatingPrice=true;};$scope.numberValidator=$numberOnlyKeyPressValidator;$scope.calculateFlatRate=function(){$scope.newCharge=$scope.item.total;$scope.percentage=undefined;if($scope.flatRate&&isFinite($scope.flatRate)){$scope.newCharge=$scope.flatRate>$scope.item.total||$scope.flatRate<0?$scope.item.total:$scope.flatRate;}}
$scope.update=function(){totalShippingDiscount=(parseFloat(cart._ShippingChrgTotal)-parseFloat($scope.newCharge)).toFixed(2);var orderTotal=0;angular.forEach($scope.pricingDetail.category,function(value,key){if(value.categoryDescription.toLowerCase()==='shipping'){value.total=$scope.newCharge;}
if(value.categoryDescription.toLowerCase()==='order total'){value.total=cart._OrderTotal-((cart._ShippingChrgTotal-$scope.newCharge)-cart._ShippingDiscTotal);}});$scope.updatingPrice=false;$scope.newCharge=0;$scope.close();}
$scope.cancel=function(){$scope.updatingPrice=false;}
$scope.pricingDetail=order.orderPricingDetail(cart,!$scope.isModalCalledFromOrderDetails);$scope.close=function(){var returnVar={newShippingDiscount:totalShippingDiscount,cart:cart};$modalInstance.close(returnVar);};$scope.dismiss=function(){$modalInstance.dismiss();};}]).controller('orderLinePricingDetailCtrl',['$scope','order','orderLine','$modalInstance','$modal','numberOnlyKeyPressValidator',function($scope,order,orderLine,$modalInstance,$modal,$numberOnlyKeyPressValidator){var totalShippingDiscount=0;$scope.openModifyCharge=function(){var item={};var lineShippingTotal=0;angular.forEach(orderLine.LineCharges.LineCharge,function(lineCharge){if(lineCharge._ChargeCategory==='BTN_SHIP_CHRG'){lineShippingTotal+=parseFloat(lineCharge._ChargeAmount);shippingCharge=parseFloat(lineCharge._ChargeAmount);}else if(lineCharge._ChargeCategory==='BTN_SHIP_DISC'){lineShippingTotal-=parseFloat(lineCharge._ChargeAmount);}});item.total=lineShippingTotal;$scope.item=item;$scope.newCharge=item.total;$scope.updatingPrice=true;};$scope.numberValidator=$numberOnlyKeyPressValidator;$scope.calculateFlatRate=function(){$scope.newCharge=$scope.item.total;$scope.percentage=undefined;if($scope.flatRate&&isFinite($scope.flatRate)){$scope.newCharge=$scope.flatRate>$scope.item.total||$scope.flatRate<0?$scope.item.total:$scope.flatRate;}}
$scope.cancel=function(){$scope.updatingPrice=false;}
$scope.update=function(){totalShippingDiscount=($scope.item.total-parseFloat($scope.newCharge)).toFixed(2);angular.forEach($scope.pricingDetail.category,function(value,key){if(value.categoryDescription===$scope.item.categoryDescription){value.total=$scope.newCharge;}});$scope.updatingPrice=false;$scope.newCharge=0;$scope.save();}
$scope.pricingDetail=order.orderLineItemPricingDetail(orderLine);$scope.close=function(){$modalInstance.dismiss('closed');};$scope.save=function(){$modalInstance.close(totalShippingDiscount);};}]).controller('cancelOrderCtrl',['$scope','passedOrderDetail','$modalInstance','order','sendSMTPErrorEmail',function($scope,passedOrderDetail,$modalInstance,$order,$sendSMTPErrorEmail){var _IsCancelling=false;$scope.canCancelOrder=function(){return!_IsCancelling&&$order.canCancelOrder(passedOrderDetail);};$scope.cancelOrder=function(){if($order.canCancelOrder(passedOrderDetail)){_IsCancelling=true;$order.cancelOrder(passedOrderDetail).then(function(){_IsCancelling=false;$modalInstance.close();},function(errorMessage){_IsCancelling=false;$modalInstance.dismiss();$sendSMTPErrorEmail(errorMessage,serviceURL+"/Order/ChangeOrderJSON");});}else{$scope.dismiss();}};$scope.dismiss=function(){$modalInstance.dismiss();};}]);
﻿angular.module('itemDetail',['ui.bootstrap']).controller('itemDetailCtrl',['$scope','$state','$modal','itemSearch','itemDetail','orderCart','numberOnlyKeyPressValidator','bigTicketValidate','itemToLocate','loggerService','btProp','securityService',function($scope,$state,$modal,$itemSearch,$itemDetail,$orderCart,$numberOnlyKeyPressValidator,$bigTicketValidate,$itemToLocate,$loggerService,$btProp,$securityService){$scope.queryParameters={}
$scope.numberValidator=$numberOnlyKeyPressValidator;$scope.refreshIScroll=function(){setTimeout(function(){$scope.$parent.myScroll['ItemDetailWrapper'].refresh();},500);};$scope.openItemDescription=function(currentItem){var modalInstance=$modal.open({templateUrl:'html/item/itemDetailDescription.html',controller:'itemDescriptionCtrl',resolve:{currentItem:function(){return $scope.currentItem;},isCart:function(){return false;}}});};$scope.orderSimilarItems=function(isnGroup){var searchParam=$itemSearch.getCachedQueryParam();var originalUPC=searchParam.originalUPC;var upcIndex=0;if(originalUPC!=undefined&&originalUPC!=""){for(var i=0,len=isnGroup.length;i<len;i++){if(isnGroup[i].id===parseInt(originalUPC)){upcIndex=i}}
$scope.selectedRow=upcIndex;$scope.updateCurrentItem(isnGroup[upcIndex])}else{$scope.selectedRow=0;$scope.updateCurrentItem(isnGroup[0])}
$loggerService.log(isnGroup);},function(err){};$scope.openGWP=function(currentItem){var modalInstance=$modal.open({templateUrl:'html/item/itemDetailGWP.html',controller:'gwpCtrl',resolve:{currentItem:function(){return $scope.currentItem;}}});};$scope.openZipCodeValidation=function(currentItem){var modalInstance=$modal.open({templateUrl:'zipCodeValidation.html',controller:'zipCodeValidationCtrl',resolve:{currentItem:function(){return $scope.currentItem;}}});};$scope.openOrderCart=function(currentItem){var qty=$scope.txtQtyInput
if(currentItem.itemtype=="BGT"){$scope.openZipCodeValidation(currentItem)}else{try{$orderCart.orderLine.addOrderLine(currentItem,qty);$state.go('orderCart');}catch(ex){swal({title:"Cannot Add Item",text:ex.message,showConfirmButton:true});}}};$scope.openItemLocate=function(currentItem){$itemToLocate.set(currentItem);$state.go('itemLocate');};$scope.isnGroup=$itemSearch.getSelectedISNGroup();$scope.isPricingOnlySingleItems=$btProp.getProp('isSingleItemPricingOnly');$scope.isPricingOnlySingleItems=($scope.isPricingOnlySingleItems!==true)?false:true;$scope.maxItemsForBulkPricing=parseInt($btProp.getProp('maxItemsAllowedToCallBulkPricingOnItemDetails'));$scope.maxItemsForBulkPricing=(isFinite($scope.maxItemsForBulkPricing)&&($scope.maxItemsForBulkPricing>-1))?$scope.maxItemsForBulkPricing:10;var _getItemPricing=function(item){var configObj;var index=-1;if(angular.isObject(item)){index=$scope.isnGroup.productList.indexOf(item);}
if(index>-1){configObj={index:index};}
_callItemService(configObj);};var _callItemService=function(configObj){$itemDetail($scope.isnGroup,function(isnGroup){$scope.isnGroup=isnGroup;$scope.refreshIScroll();$loggerService.log(isnGroup);},function(err){$scope.refreshIScroll();},configObj);};if(!$scope.isPricingOnlySingleItems&&($scope.isnGroup.productList.length<=$scope.maxItemsForBulkPricing)){_callItemService({isBlocked:false});}
$scope.updateCurrentItem=function(item){if(!angular.isDefined(item.itemDetail)||(item.itemDetail===null)||!angular.isDefined(item._AvailableQty)||(item._AvailableQty===null)){_getItemPricing(item);}
$scope.currentItem=item;if($scope.currentItem.webid){var webidstring=$scope.currentItem.webid;$scope.currentItem.webid=webidstring.replace(/,/g,', ');}
if($scope.currentItem.colorimageid){$scope.ImageURL=serviceURL+"/image/BonTon/"+$scope.currentItem.colorimageid;}else if($scope.currentItem.imageid){$scope.ImageURL=serviceURL+"/image/BonTon/"+$scope.currentItem.imageid;}else{$scope.ImageURL="/assets/images/NotAvailable.jpg";}
$scope.txtQtyInput=1;if($scope.currentItem.itemDetail){$scope.currentItem.itemDetail.ComputedPrice.Extn._ExtnSpecialHandlingCode=$scope.currentItem.specialhandlingcode;}
if(item.productname===""||item.productname==undefined){$scope.showProductName=false;}else{$scope.showProductName=true;}
if(item.pickupallowed===""||item.pickupallowed==undefined){$scope.showpickUpAllowed=false;}else{$scope.showPickUpAllowed=true;}};$scope.disableCartButton=function(item){var returnVal=true;if(item==undefined||item.itemDetail==undefined||(item.itemDetail===null)||!angular.isDefined(item._AvailableQty)||(item._AvailableQty===null)){returnVal=true;}else{var qty=$scope.txtQtyInput
if(parseInt(item._AvailableQty)<qty||parseInt(item._AvailableQty)=='0'||item.itemDetail.ComputedPrice._RetailPrice=='-999999.99'||item.itemDetail.ComputedPrice._RetailPrice=='-8888888.88'){returnVal=true;}else if(item.isgwp=="Y"){if($securityService.isCsr()){returnVal=false;}else{returnVal=true;}}
else{returnVal=false;}}
return returnVal;};$scope.selectedRow=null;$scope.setClickedRow=function(index){$scope.selectedRow=index;}
$scope.pricingServiceDown=function(item){if(item==undefined||item.itemDetail==undefined){item=false;}else{if(item.itemDetail.ComputedPrice._RetailPrice=='-999999.99'||item.itemDetail.ComputedPrice._RetailPrice=='-8888888.88'){item=true;}else{item=false;}}
return item;};}]).controller('itemDescriptionCtrl',['$scope','$modalInstance','currentItem','isCart','$state','orderCart','$modal','securityService',function($scope,$modalInstance,currentItem,isCart,$state,$orderCart,$modal,$securityService){$scope.currentItem=currentItem;$scope.isCart=isCart;$scope.close=function(){$modalInstance.dismiss('closed');};$scope.openOrderCart=function(currentItem){if(currentItem.itemtype=="BGT"){$modalInstance.dismiss('closed');$scope.openZipCodeValidation(currentItem)}else{try{$orderCart.orderLine.addOrderLine(currentItem,"1");$state.go('orderCart');$modalInstance.dismiss('closed');}catch(ex){swal({title:"Cannot Add Item",text:ex.message,showConfirmButton:true});}}};$scope.disableCartButton=function(item){var returnVal=true;if(item==undefined||item.itemDetail==undefined||(item.itemDetail===null)||!angular.isDefined(item._AvailableQty)||(item._AvailableQty===null)){returnVal=true;}else{if(parseInt(item._AvailableQty)=='0'||item.itemDetail.ComputedPrice._RetailPrice=='-999999.99'||item.itemDetail.ComputedPrice._RetailPrice=='-8888888.88'){returnVal=true;}else if(item.isgwp=="Y"){if($securityService.isCsr()){returnVal=false;}else{returnVal=true;}}
else{returnVal=false;}}
return returnVal;};$scope.openZipCodeValidation=function(currentItem){var modalInstance=$modal.open({templateUrl:'zipCodeValidation.html',controller:'zipCodeValidationCtrl',resolve:{currentItem:function(){return $scope.currentItem;}}});};$scope.showValidDesc=function(desc){if(desc===""||desc==undefined||desc=="None"||desc=="Not Assigned"){desc=false;}else{desc=true;}
return desc;};}]).controller('gwpCtrl',['$scope','$modalInstance','currentItem',function($scope,$modalInstance,currentItem){$scope.currentItem=currentItem;$scope.close=function(){$modalInstance.dismiss('closed');};}]).controller('zipCodeValidationCtrl',['$scope','$modalInstance','currentItem','$state','orderCart','bigTicketValidate','numberOnlyKeyPressValidator','loggerService','btProp',function($scope,$modalInstance,currentItem,$state,$orderCart,$bigTicketValidate,$numberOnlyKeyPressValidator,$loggerService,btProp){$scope.isBigTicketPurchaseDisabled=btProp.getProp("isBigTicketPurchaseDisabled");$scope.isBigTicketPurchaseDisabled=$scope.isBigTicketPurchaseDisabled?true:false;$scope.numberValidator=$numberOnlyKeyPressValidator;$scope.currentItem=currentItem;$scope.isValid=true;$scope.validate=function(){var zip=$scope.txtZip
$bigTicketValidate.bigTicketPromise(zip).then(function(response){$loggerService.log(response);if(response.data.ValidateBigTicketZipCodeResp._isValid=="true"){$scope.openOrderCart(currentItem)}else{$scope.isValid=false;}});};$scope.close=function(){$modalInstance.dismiss('closed');};$scope.openOrderCart=function(currentItem){try{$orderCart.orderLine.addOrderLine(currentItem,"1",true);$state.go('orderCart');$modalInstance.dismiss('closed');}catch(ex){swal({title:"Cannot Add Item",text:ex.message,showConfirmButton:true});}};}]);
﻿angular.module('addModifyAddress',['ui.bootstrap']).controller('addModifyAddressCtrl',['$scope','$stateParams','customer','$state','appState','orderCart','$modal','$q','$filter','loggerService','isPoBoxAddress','customerKeyPressValidator',function($scope,$stateParams,$customer,$state,$appState,$orderCart,$modal,$q,$filter,$loggerService,$isPoBoxAddress,$customerKeyPressValidator){$scope.title='Add Address';$scope.address={};$scope.addressResponse=false;$scope.emailResponse=false;$scope.emailValidated=false;$scope.addressValidated=false;$scope.AllEntriesValid=true;$scope.EnterAddress=false;$scope.EnterCity=false;$scope.EnterState=false;$scope.EnterZip=false;$scope.EnterFirstName=false;$scope.EnterLastName=false;$scope.EnterPhone=false;$scope.EnterEmail=false;$scope.international=false;$scope.disableShipTo=false;$scope.disableBillTo=false;$scope.disableCountry=false;$scope.avsOverride=false;$scope.keyPressValidator=$customerKeyPressValidator;var additionalAddressModel={"_AddressType":"SB","_CustomerAdditionalAddressID":"","_IsBillTo":"Y","_IsDefaultBillTo":"N","_IsDefaultShipTo":"N","_IsShipTo":"Y","PersonInfo":{"_AddressID":"","_AddressLine1":"","_AddressLine2":"","_AddressLine3":"","_AddressLine4":"","_AddressLine5":"","_AddressLine6":"","_City":"","_Country":"US","_DayPhone":"","_EMailID":"","_EveningPhone":"","_FirstName":"","_IsCommercialAddress":"N","_LastName":"","_MiddleName":"","_MobilePhone":"","_OtherPhone":"","_State":"","_Suffix":"","_Title":"","_ZipCode":""}};var contactID=$stateParams.customerContactID.toString().trim();var addressID=$stateParams.customerAdditionalAddressID.toString().trim();var customer=$customer.getSelectedCustomer();var isNewCustomer=false;var realAdditionalAddress={};var _locateContact=function(){for(var i=0;i<customer.CustomerContactList.CustomerContact.length;i++){if(customer.CustomerContactList.CustomerContact[i]._CustomerContactID.toString().trim()==contactID){return customer.CustomerContactList.CustomerContact[i];}}
throw{name:"No contact found! "};};var _locateAddress=function(){var contact=_locateContact();for(var i=0;i<contact.CustomerAdditionalAddressList.CustomerAdditionalAddress.length;i++){if(contact.CustomerAdditionalAddressList.CustomerAdditionalAddress[i]._CustomerAdditionalAddressID.toString().trim()===addressID){realAdditionalAddress=angular.copy(contact.CustomerAdditionalAddressList.CustomerAdditionalAddress[i]);$scope.address=angular.copy(contact.CustomerAdditionalAddressList.CustomerAdditionalAddress[i]);$scope.formatPhone('_DayPhone');$scope.formatPhone('_EveningPhone');}}};var _setNewCustomerAddress=function(){var parms=$customer.getCachedQueryParam();if(angular.isDefined(parms)&&parms!==null&&angular.isDefined(parms.Customer)&&parms.Customer!==null){if(angular.isString(parms.Customer.FirstName)){$scope.address.PersonInfo._FirstName=$filter('titlecase')(parms.Customer.FirstName.trim());}
if(angular.isString(parms.Customer.LastName)){$scope.address.PersonInfo._LastName=$filter('titlecase')(parms.Customer.LastName.trim());}
if(angular.isString(parms.Customer.EmailAddress)){$scope.address.PersonInfo._EMailID=parms.Customer.EmailAddress.trim();}
if(angular.isString(parms.Customer.PhoneNumber)){$scope.address.PersonInfo._DayPhone=$filter('phoneFormat')(parms.Customer.PhoneNumber.trim());}}
$scope.address._IsDefaultBillTo='Y';$scope.address._IsDefaultShipTo='Y';isNewCustomer=true;};var _initializeData=function(){if(contactID.length>0&&addressID.length>0){$scope.title='Modify Address';_locateAddress();}else if(contactID.length>0){$scope.title='Add Address';$scope.address=angular.copy(additionalAddressModel);}else{$scope.title='New Customer';$scope.address=angular.copy(additionalAddressModel);_setNewCustomerAddress();}
$scope.setCheckBoxFromFlag();};var _copyAllAttributes=function(source,destination){var keyArr=Object.keys(source);for(var i=0;i<keyArr.length;i++){if((/^_/).test(keyArr[i])){destination[keyArr[i]]=source[keyArr[i]];}}};$scope.formatPhone=function(addressAttrName){$scope.address.PersonInfo[addressAttrName]=$filter('phoneFormat')($scope.address.PersonInfo[addressAttrName]);};$scope.cancel=function(){if(addressChangeObj.previousStateName){$state.go(addressChangeObj.previousStateName.toString().trim());}else if(isNewCustomer){$state.go('customerSearch');}else{$state.go('customerDetail');}};$scope.reset=function(){if(addressID){$scope.address=angular.copy(realAdditionalAddress);$scope.formatPhone('_DayPhone');$scope.formatPhone('_EveningPhone');$scope.setCheckBoxFromFlag();}else{$scope.address=angular.copy(additionalAddressModel);if(isNewCustomer){_setNewCustomerAddress();}
$scope.setCheckBoxFromFlag();}};$scope.setCheckBoxFromFlag=function(){if($scope.address._IsDefaultBillTo=='Y'){$scope.defaultBilling=true;$scope.disableBillTo=true;}else{$scope.defaultBilling=false;}
if($scope.address._IsDefaultShipTo=='Y'){$scope.defaultShipping=true;$scope.disableShipTo=true;}else{$scope.defaultShipping=false;}}
$scope.setFlagFromCheckBox=function(){if($scope.defaultBilling){$scope.address._IsDefaultBillTo='Y';}else{$scope.address._IsDefaultBillTo='N';}
if($scope.defaultShipping){$scope.address._IsDefaultShipTo='Y';}else{$scope.address._IsDefaultShipTo='N';}};var addressChangeObj=$appState.getAddressChange();if(addressChangeObj.customerKey!==null&&addressChangeObj.customerKey.toString().trim().length>0){if(customer._CustomerKey!=addressChangeObj.customerKey.toString().trim()){$customer.retrieveCustomerDetail("",addressChangeObj.customerKey.toString(),function(){_initializeData();},function(){});}else{_initializeData();}}else{_initializeData();};if($scope.address.PersonInfo._Country!="US"){$scope.international=true;}
$scope.save=function(){$scope.setFlagFromCheckBox();$scope.address.PersonInfo._Country=$scope.address.PersonInfo._Country.toUpperCase();if($scope.address.PersonInfo._Country.trim()!="US"&&$scope.address.PersonInfo._Country.trim()!="UNITED STATES OF AMERICA"){$scope.international=true;}else{$scope.international=false;}
if($scope.international==true){$scope.validateInternational();if($scope.AllEntriesValid==true){if($scope.defaultBilling==true){$scope.address._IsDefaultBillTo=='Y';}else{$scope.address._IsDefaultBillTo=='N';}
$scope.updateCustomer();}}else if($scope.avsOverride==true){$scope.validateFields();if($scope.AllEntriesValid==false){}
else{$scope.updateCustomer();}}else{$scope.validateFields();if($scope.AllEntriesValid==false){}
else{$scope.addressResponse=true;$scope.emailResponse=true;$scope.emailValidated=false;$scope.addressValidated=false;addressToVerify=[];addressToVerify.line1=$scope.address.PersonInfo._AddressLine1;addressToVerify.line2=$scope.address.PersonInfo._AddressLine2;addressToVerify.line3=$scope.address.PersonInfo._AddressLine3;addressToVerify.city=$scope.address.PersonInfo._City;addressToVerify.state=$scope.address.PersonInfo._State;addressToVerify.zip=$scope.address.PersonInfo._ZipCode;addressToVerify.country=$scope.address.PersonInfo._Country;var emailToVerify=$scope.address.PersonInfo._EMailID;if(addressToVerify.line2===null){addressToVerify.line2="";}
if(addressToVerify.line3===null){addressToVerify.line3="";}
address=addressToVerify.line1+"|"+addressToVerify.line2+"|"+addressToVerify.line3+"|"+addressToVerify.city+"|"+addressToVerify.state+"|"+addressToVerify.zip;$customer.verifyCustomerAddress(address).success(function(response){$scope.addressResponse=false;if(response.QASearchResult._VerifyLevel=="Verified"){$scope.address.PersonInfo._AddressLine1=response.QASearchResult.QAAddress.AddressLine[0].Line;$scope.address.PersonInfo._AddressLine2=response.QASearchResult.QAAddress.AddressLine[1].Line;$scope.address.PersonInfo._AddressLine3=response.QASearchResult.QAAddress.AddressLine[2].Line;$scope.address.PersonInfo._City=response.QASearchResult.QAAddress.AddressLine[3].Line;$scope.address.PersonInfo._State=response.QASearchResult.QAAddress.AddressLine[4].Line;$scope.address.PersonInfo._ZipCode=response.QASearchResult.QAAddress.AddressLine[5].Line.substring(0,5);if(response.QASearchResult.QAAddress.AddressLine[6].Line="UNITED STATES OF AMERICA"){$scope.address.PersonInfo._Country="US";}
if($scope.address.PersonInfo._AddressLine2===null){$scope.address.PersonInfo._AddressLine2="";}
if($scope.address.PersonInfo._AddressLine3===null){$scope.address.PersonInfo._AddressLine3="";}
$scope.addressValidated=true;if($scope.addressValidated==true&&$scope.emailValidated==true&&$scope.AllEntriesValid==true){$scope.updateCustomer();}}else if((response.QASearchResult._VerifyLevel=="PremisesPartial")||(response.QASearchResult._VerifyLevel=="StreetPartial")||(response.QASearchResult._VerifyLevel=="Multiple")){$scope.openAddressSelection(response);}else{swal({title:"Error!",text:"Please enter a valid address",showConfirmButton:true});}
$loggerService.log(response);}).error(function(data){$scope.addressValidated=true;if($scope.addressValidated==true&&$scope.emailValidated==true&&$scope.AllEntriesValid==true){$scope.updateCustomer();}});$customer.verifyEmail(emailToVerify).success(function(response){$scope.emailResponse=false;if(response.Certainty!="undeliverable"){$scope.address.PersonInfo._EMailID=emailToVerify;$loggerService.log(response);$scope.EnterEmail=false;$scope.emailValidated=true;if($scope.addressValidated==true&&$scope.emailValidated==true&&$scope.AllEntriesValid==true){$scope.updateCustomer();}}else{$loggerService.log(response);$scope.EnterEmail=true;}}).error(function(data){$scope.emailValidated=true;if($scope.addressValidated==true&&$scope.emailValidated==true&&$scope.AllEntriesValid==true){$scope.updateCustomer();}});}}};$scope.updateCustomer=function(){$scope.address.PersonInfo._DayPhone=$filter('phoneFormatRemove')($scope.address.PersonInfo._DayPhone);$scope.address.PersonInfo._EveningPhone=$filter('phoneFormatRemove')($scope.address.PersonInfo._EveningPhone);var stateName='customerDetail';if(addressChangeObj.previousStateName){stateName=addressChangeObj.previousStateName.toString().trim();}
if(isNewCustomer){$customer.createCustomerByAddress($scope.address,function(response){$state.go(stateName);},function(response){$loggerService.log(response);});}
else{$customer.addModifyAddress(customer._CustomerID,contactID,$scope.address,function(){if(angular.isDefined(addressChangeObj.setShipToOrderLinePrimeSubLineObjArray)&&addressChangeObj.setShipToOrderLinePrimeSubLineObjArray.length>0){try{$orderCart.address.setOrderLineShipToAddresses(addressChangeObj.setShipToOrderLinePrimeSubLineObjArray,$scope.address,false);}catch(e){$loggerService.log(e);}}else if(addressChangeObj.setBillTo){$orderCart.address.setBillingAddress($scope.address)}
$state.go(stateName);});}}
$scope.countryInfoMessage=function(){country=$scope.address.PersonInfo._Country;if(country!="US"){swal({title:"",text:"International address can only be used as a billing address",showConfirmButton:true});$scope.defaultShipping=false;$scope.disableShipTo=true;$scope.international=true;}else{$scope.international=false;if($scope.address._IsDefaultShipTo=='Y'){$scope.disableShipTo=true;}else{$scope.disableShipTo=false;}}
if($scope.defaultShipping==true){$scope.address._IsDefaultShipTo=='Y';}else{$scope.address._IsDefaultShipTo=='N';}}
$scope.validateFields=function(){if($scope.address._IsDefaultShipTo=='Y'){if($isPoBoxAddress($scope.address.PersonInfo)){swal({title:"",text:"Ship to address can not be a PO Box",showConfirmButton:true});var isPoBox=true;}else{isPoBox=false;}}
if($scope.address.PersonInfo._AddressLine1==""){$scope.EnterAddress=true;}else{$scope.EnterAddress=false;};if($scope.address.PersonInfo._City==""){$scope.EnterCity=true;}else{$scope.EnterCity=false;};if($scope.address.PersonInfo._State==""){$scope.EnterState=true;}else{$scope.EnterState=false;};if($scope.address.PersonInfo._ZipCode==""){$scope.EnterZip=true;}else{$scope.EnterZip=false;};if($scope.address.PersonInfo._FirstName==""){$scope.EnterFirstName=true;}else{$scope.EnterFirstName=false;};if($scope.address.PersonInfo._LastName==""){$scope.EnterLastName=true;}else{$scope.EnterLastName=false;};if(($scope.address.PersonInfo._EMailID=="")||($scope.address.PersonInfo._EMailID.indexOf('@')===-1)||($scope.address.PersonInfo._EMailID.indexOf('.')===-1)){$scope.EnterEmail=true;}else{$scope.EnterEmail=false;};if($scope.address.PersonInfo._DayPhone==""){$scope.EnterPhone=true;}else{$scope.EnterPhone=false;};if($scope.EnterAddress||$scope.EnterCity||$scope.EnterState||$scope.EnterZip||$scope.EnterFirstName||$scope.EnterLastName||$scope.EnterEmail||$scope.EnterPhone||isPoBox){$scope.AllEntriesValid=false;}else{$scope.AllEntriesValid=true;};};$scope.validateInternational=function(){if($scope.address.PersonInfo._AddressLine1==""){$scope.EnterAddress=true;}else{$scope.EnterAddress=false;};if($scope.address.PersonInfo._FirstName==""){$scope.EnterFirstName=true;}else{$scope.EnterFirstName=false;};if($scope.address.PersonInfo._LastName==""){$scope.EnterLastName=true;}else{$scope.EnterLastName=false;};if(($scope.address.PersonInfo._EMailID=="")||($scope.address.PersonInfo._EMailID.indexOf('@')===-1)||($scope.address.PersonInfo._EMailID.indexOf('.')===-1)){$scope.EnterEmail=true;}else{$scope.EnterEmail=false;};if($scope.address.PersonInfo._DayPhone==""){$scope.EnterPhone=true;}else{$scope.EnterPhone=false;};if($scope.EnterAddress==true||$scope.EnterFirstName==true||$scope.EnterLastName==true||$scope.EnterEmail==true||$scope.EnterPhone==true){$scope.AllEntriesValid=false;}else{$scope.AllEntriesValid=true;};}
$scope.CountryOptions=[{id:'AC',country:'Ascension Island'},{id:'AD',country:'Andorra'},{id:'AE',country:'United Arab Emirates'},{id:'AF',country:'Afghanistan'},{id:'AG',country:'Antigua and Barbuda'},{id:'AI',country:'Anguilla'},{id:'AL',country:'Albania'},{id:'AM',country:'Armenia'},{id:'AN',country:'Netherlands Antilles'},{id:'AO',country:'Angola'},{id:'AQ',country:'Antarctica'},{id:'AR',country:'Argentina'},{id:' AS',country:'American Samoa'},{id:'AT',country:'Austria'},{id:'AU',country:'Australia'},{id:'AW',country:'Aruba'},{id:'AX',country:'Aland Islands'},{id:'AZ',country:'Azerbaijan'},{id:'BA',country:'Bosnia and Herzegovina'},{id:'BB',country:'Barbados'},{id:'BD',country:'Bangladesh'},{id:'BE',country:'Belgium'},{id:'BF',country:'Burkina Faso'},{id:'BG',country:'Bulgaria'},{id:'BH',country:'Bahrain'},{id:'BI',country:'Burundi'},{id:'BJ',country:'Benin'},{id:' BM',country:'Bermuda'},{id:'BN',country:'Brunei Darussalam'},{id:'BO',country:'Bolivia'},{id:'BR',country:'Brazil'},{id:'BS',country:'Bahamas'},{id:'BT',country:'Bhutan'},{id:'BV',country:'Bouvet Island'},{id:'BW',country:'Botswana'},{id:'BY',country:'Belarus'},{id:'BZ',country:'Belize'},{id:'CA',country:'Canada'},{id:'CC',country:'Cocos (Keeling) Islands'},{id:'CD',country:'Congo, Democratic Republic'},{id:'CF',country:'Central African Republic'},{id:'CG',country:'Congo'},{id:'CH',country:'Switzerland'},{id:'CI',country:'Cote DIvoire (Ivory Coast)'},{id:'CK',country:'Cook Islands'},{id:'CL',country:'Chile'},{id:'CM',country:'Cameroon'},{id:'CN',country:'China'},{id:'CO',country:'Colombia'},{id:'CR',country:'Costa Rica'},{id:'CS',country:'Czechoslovakia (former)'},{id:'CU',country:'Cuba'},{id:'CV',country:'Cape Verde'},{id:'CX',country:'Christmas Island'},{id:'CY',country:'Cyprus'},{id:'CZ',country:'Czech Republic'},{id:'DE',country:'Germany'},{id:'DJ',country:'Djibouti'},{id:'DK',country:'Denmark'},{id:'DM',country:'Dominica'},{id:'DO',country:'Dominican Republic'},{id:'DZ',country:'Algeria'},{id:'EC',country:'Ecuador'},{id:'EE',country:'Estonia'},{id:'EG',country:'Egypt'},{id:'EH',country:'Western Sahara'},{id:'ER',country:'Eritrea'},{id:'ES',country:'Spain'},{id:'ET',country:'Ethiopia'},{id:'EU',country:'European Union'},{id:'FI',country:'Finland'},{id:'FJ',country:'Fiji'},{id:'FK',country:'Falkland Islands (Malvinas)'},{id:'FM',country:'Micronesia'},{id:'FO',country:'Faroe Islands'},{id:'FR',country:'France'},{id:'FX',country:'France, Metropolitan'},{id:'GA',country:'Gabon'},{id:'GB',country:'Great Britain (UK)'},{id:'GD',country:'Grenada'},{id:'GE',country:'Georgia'},{id:'GF',country:'French Guiana'},{id:'GG',country:'Guernsey'},{id:'GH',country:'Ghana'},{id:'GI',country:'Gibraltar'},{id:'GL',country:'Greenland'},{id:'GM',country:'Gambia'},{id:'GN',country:'Guinea'},{id:'GP',country:'Guadeloupe'},{id:'GQ',country:'Equatorial Guinea'},{id:'GR',country:'Greece'},{id:'GS',country:'S. Georgia and S. Sandwich Isls.'},{id:'GT',country:'Guatemala'},{id:'GU',country:'Guam'},{id:'GW',country:'Guinea-Bissau'},{id:'GY',country:'Guyana'},{id:'HK',country:'Hong Kong'},{id:'HM',country:'Heard and McDonald Islands'},{id:'HN',country:'Honduras'},{id:'HR',country:'Croatia (Hrvatska)'},{id:'HT',country:'Haiti'},{id:'HU',country:'Hungary'},{id:'ID',country:'Indonesia'},{id:'IE',country:'Ireland'},{id:'IL',country:'Israel'},{id:'IM',country:'Isle of Man'},{id:'IN',country:'India'},{id:'IO',country:'British Indian Ocean Territory'},{id:'IQ',country:'Iraq'},{id:'IR',country:'Iran'},{id:'IS',country:'Iceland'},{id:'IT',country:'Italy'},{id:'JE',country:'Jersey'},{id:'JM',country:'Jamaica'},{id:'JO',country:'Jordan'},{id:'JP',country:'Japan'},{id:'KE',country:'Kenya'},{id:'KG',country:'Kyrgyzstan'},{id:'KH',country:'Cambodia'},{id:'KI',country:'Kiribati'},{id:'KM',country:'Comoros'},{id:'KN',country:'Saint Kitts and Nevis'},{id:'KP',country:'Korea (North)'},{id:'KR',country:'Korea (South)'},{id:'KW',country:'Kuwait'},{id:'KY',country:'Cayman Islands'},{id:'KZ',country:'Kazakhstan'},{id:'LA',country:'Laos'},{id:'LB',country:'Lebanon'},{id:'LC',country:'Saint Lucia'},{id:'LI',country:'Liechtenstein'},{id:'LK',country:'Sri Lanka'},{id:'LR',country:'Liberia'},{id:'LS',country:'Lesotho'},{id:'LT',country:'Lithuania '},{id:'LU',country:'Luxembourg'},{id:'LV',country:'Latvia'},{id:'LY',country:'Libya'},{id:'MA',country:'Morocco'},{id:'MC',country:'Monaco'},{id:'MD',country:'Moldova'},{id:'ME',country:'Montenegro'},{id:'MG',country:'Madagascar'},{id:'MH',country:'Marshall Islands'},{id:'MK',country:'F.Y.R.O.M. (Macedonia)'},{id:'ML',country:'Mali'},{id:'MM',country:'Myanmar'},{id:'MN',country:'Mongolia'},{id:'MO',country:'Macau'},{id:'MP',country:'Northern Mariana Islands'},{id:'MQ',country:'Martinique'},{id:'MR',country:'Mauritania'},{id:'MS',country:'Montserrat'},{id:'MT',country:'Malta'},{id:'MU',country:'Mauritius'},{id:'MV',country:'Maldives'},{id:'MW',country:'Malawi'},{id:'MX',country:'Mexico'},{id:'MY',country:'Malaysia'},{id:'MZ',country:'Mozambique'},{id:'NA',country:'Namibia'},{id:'NC',country:'New Caledonia'},{id:'NE',country:'Niger'},{id:'NF',country:'Norfolk Island'},{id:'NG',country:'Nigeria'},{id:'NI',country:'Nicaragua'},{id:'NL',country:'Netherlands'},{id:'NO',country:'Norway'},{id:'NP',country:'Nepal'},{id:'NR',country:'Nauru'},{id:'NT',country:'Neutral Zone'},{id:'NU',country:'Niue'},{id:'NZ',country:'New Zealand (Aotearoa)'},{id:'OM',country:'Oman'},{id:'PA',country:'Panama'},{id:'PE',country:'Peru'},{id:'PF',country:'French Polynesia'},{id:'PG',country:'Papua New Guinea'},{id:'PH',country:'Philippines'},{id:'PK',country:'Pakistan'},{id:'PL',country:'Poland'},{id:'PM',country:'St. Pierre and Miquelon'},{id:'PN',country:'Pitcairn'},{id:'PR',country:'Puerto Rico'},{id:'PS',country:'Palestinian Territory, Occupied'},{id:'PT',country:'Portugal'},{id:'PW',country:'Palau'},{id:'PY',country:'Paraguay'},{id:'QA',country:'Qatar'},{id:'RE',country:'Reunion'},{id:'RS',country:'Serbia'},{id:'RO',country:'Romania'},{id:'RU',country:'Russian Federation'},{id:'RW',country:'Rwanda'},{id:'SA',country:'Saudi Arabia'},{id:'SB',country:'Solomon Islands'},{id:'SC',country:'Seychelles'},{id:'SD',country:'Sudan'},{id:'SE',country:'Sweden'},{id:'SG',country:'Singapore'},{id:'SH',country:'St. Helena'},{id:'SI',country:'Slovenia'},{id:'SJ',country:'Svalbard & Jan Mayen Islands'},{id:'SK',country:'Slovak Republic'},{id:'SL',country:'Sierra Leone'},{id:'SM',country:'San Marino'},{id:'SN',country:'Senegal'},{id:'SO',country:'Somalia'},{id:'SR',country:'Suriname'},{id:'ST',country:'Sao Tome and Principe'},{id:'SU',country:'USSR (former)'},{id:'SV',country:'El Salvador'},{id:'SY',country:'Syria'},{id:'SZ',country:'Swaziland'},{id:'TC',country:'Turks and Caicos Islands'},{id:'TD',country:'Chad'},{id:'TF',country:'French Southern Territories'},{id:'TG',country:'Togo'},{id:'TH',country:'Thailand'},{id:'TJ',country:'Tajikistan'},{id:'TK',country:'Tokelau'},{id:'TM',country:'Turkmenistan'},{id:'TN',country:'Tunisia'},{id:'TO',country:'Tonga'},{id:'TP',country:'East Timor'},{id:'TR',country:'Turkey'},{id:'TT',country:'Trinidad and Tobago'},{id:'TV',country:'Tuvalu'},{id:'TW',country:'Taiwan'},{id:'TZ',country:'Tanzania'},{id:'UA',country:'Ukraine'},{id:'UG',country:'Uganda'},{id:'UK',country:'United Kingdom'},{id:'UM',country:'US Minor Outlying Islands'},{id:'US',country:'United States'},{id:'UY',country:'Uruguay'},{id:'UZ',country:'Uzbekistan'},{id:'VA',country:'Vatican City State'},{id:'VC',country:'Saint Vincent & the Grenadines'},{id:'VE',country:'Venezuela'},{id:'VG',country:'British Virgin Islands'},{id:'VI',country:'Virgin Islands (U.S.)'},{id:'VN',country:'Viet Nam'},{id:'VU',country:'Vanuatu'},{id:'WF',country:'Wallis and Futuna Islands'},{id:'WS',country:'Samoa'},{id:'YE',country:'Yemen'},{id:'YT',country:'Mayotte'},{id:'YU',country:'Serbia and Montenegro'},{id:'ZA',country:'South Africa'},{id:'ZM',country:'Zambia'},{id:'ZR',country:'CD Congo, Democratic Republic'},{id:'ZW',country:'Zimbabwe'},];$scope.stateOptions=[{name:'',state:''},{name:'Alabama',state:'AL'},{name:'Alaska',state:'AK'},{name:'Arizona',state:'AZ'},{name:'Arkansas',state:'AR'},{name:'California',state:'CA'},{name:'Colorado',state:'CO'},{name:'Connecticut',state:'CT'},{name:'Delaware',state:'DE'},{name:'District of Columbia',state:'DC'},{name:'Florida',state:'FL'},{name:'Georgia',state:'GA'},{name:'Hawaii',state:'HI'},{name:'Idaho',state:'ID'},{name:'Illinois',state:'IL'},{name:'Indiana',state:'IN'},{name:'Iowa',state:'IA'},{name:'Kansas',state:'KS'},{name:'Kentucky',state:'KY'},{name:'Louisiana',state:'LA'},{name:'Maine',state:'ME'},{name:'Maryland',state:'MD'},{name:'Massachusetts',state:'MA'},{name:'Michigan',state:'MI'},{name:'Minnesota',state:'MN'},{name:'Mississippi',state:'MS'},{name:'Missouri',state:'MO'},{name:'Montana',state:'MT'},{name:'Nebraska',state:'NE'},{name:'Nevada',state:'NV'},{name:'New Hampshire',state:'NH'},{name:'New Jersey',state:'NJ'},{name:'New Mexico',state:'NM'},{name:'New York',state:'NY'},{name:'North Carolina',state:'NC'},{name:'North Dakota',state:'ND'},{name:'Ohio',state:'OH'},{name:'Oklahoma',state:'OK'},{name:'Oregon',state:'OR'},{name:'Pennsylvania',state:'PA'},{name:'Rhode Island',state:'RI'},{name:'South Carolina',state:'SC'},{name:'South Dakota',state:'SD'},{name:'Tennessee',state:'TN'},{name:'Texas',state:'TX'},{name:'Utah',state:'UT'},{name:'Vermont',state:'VT'},{name:'Virginia',state:'VA'},{name:'Washington',state:'WA'},{name:'West Virginia',state:'WV'},{name:'Wisconsin',state:'WI'},{name:'Wyoming',state:'WY'}];$scope.openAddressSelection=function(addressPickList){$scope.addressPickList=addressPickList;var modalInstance=$modal.open({templateUrl:'html/customer/addressSelection.html',controller:'addressSelectionCtrl',resolve:{addressPickList:function(){return $scope.addressPickList;}}});modalInstance.result.then(function(selectedAddress){$scope.address.PersonInfo._AddressLine1=selectedAddress.Line1;$scope.address.PersonInfo._AddressLine2=selectedAddress.Line2;$scope.address.PersonInfo._AddressLine3=selectedAddress.Line3;$scope.address.PersonInfo._City=selectedAddress.City;$scope.address.PersonInfo._State=selectedAddress.State;$scope.address.PersonInfo._ZipCode=selectedAddress.Zip;$scope.address.PersonInfo._Country="US";$scope.addressValidated=true;if(selectedAddress.Line2===null){$scope.address.PersonInfo._AddressLine2="";}
if(selectedAddress.Line3===null){$scope.address.PersonInfo._AddressLine3="";}
if($scope.addressValidated==true&&$scope.emailValidated==true&&$scope.AllEntriesValid==true){$scope.updateCustomer();}});};}]).controller('addressSelectionCtrl',['$scope','customer','$state','addressPickList','$modalInstance',function($scope,$customer,$state,addressPickList,$modalInstance){$scope.selectedRow=0;$scope.addressPickList=addressPickList.QASearchResult.QAPicklist;selectedAddress=[];$scope.selectableAddress=[];$scope.suggestedAddress=[];$scope.disableUpdateButton=false;if($scope.addressPickList.PicklistEntry.length==undefined){if($scope.addressPickList.PicklistEntry._FullAddress=='true'){selectlength=$scope.selectableAddress.length;$scope.selectableAddress[selectlength]=angular.copy($scope.addressPickList.PicklistEntry);}else{suggestlength=$scope.suggestedAddress.length;$scope.suggestedAddress[suggestlength]=angular.copy($scope.addressPickList.PicklistEntry);}}else{for(var i=0,len=$scope.addressPickList.PicklistEntry.length;i<len;i++){if($scope.addressPickList.PicklistEntry[i]._FullAddress=='true'){selectlength=$scope.selectableAddress.length;$scope.selectableAddress[selectlength]=angular.copy($scope.addressPickList.PicklistEntry[i]);}else{suggestlength=$scope.suggestedAddress.length;$scope.suggestedAddress[suggestlength]=angular.copy($scope.addressPickList.PicklistEntry[i]);}}}
if($scope.selectableAddress.length==0){$scope.selectAddressLabel=false;$scope.disableUpdateButton=true;}else{$scope.selectAddressLabel=true;$scope.disableUpdateButton=false;}
if($scope.suggestedAddress.length==0){$scope.suggestAddressLabel=false;}else{$scope.suggestAddressLabel=true;}
$scope.close=function(){$modalInstance.dismiss('closed');}
$scope.setClickedRow=function(index){$scope.selectedRow=index;}
$scope.refreshIScroll=function(){var myScroll=new IScroll('#ItemDetailWrapper',{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip'});setTimeout(function(){myScroll.refresh();},500);};$scope.formatSelectedAddress=function(){$scope.moniker=$scope.selectableAddress[$scope.selectedRow].Moniker;$customer.verifySelectedAddress($scope.moniker).success(function(response){if(response.Address.QAAddress.AddressLine.length===7){selectedAddress.Line1=response.Address.QAAddress.AddressLine[0].Line;selectedAddress.Line2=response.Address.QAAddress.AddressLine[1].Line;selectedAddress.Line3=response.Address.QAAddress.AddressLine[2].Line;selectedAddress.City=response.Address.QAAddress.AddressLine[3].Line;selectedAddress.State=response.Address.QAAddress.AddressLine[4].Line;selectedAddress.Zip=response.Address.QAAddress.AddressLine[5].Line.substring(0,5);selectedAddress.Country=response.Address.QAAddress.AddressLine[6].Line;if(response.Address.QAAddress.AddressLine[6].Line="UNITED STATES OF AMERICA"){selectedAddress.Country="US";}
if(selectedAddress.Line2===null){addressToVerify.line2="";}
if(selectedAddress.Line3===null){addressToVerify.line3="";}
$modalInstance.close(selectedAddress);}else{}}).error(function(data){swal({title:"Error!",text:data,showConfirmButton:true});});}}])
﻿angular.module('itemResults',['ui.bootstrap']).controller('itemResultsCtrl',['$scope','$location','$http','itemSearch','$modal','$rootScope',function($scope,$location,$http,$itemSearch,$modal,$rootScope){var openItemDetailAll=function(isnGroupItem){$itemSearch.setSelectedISNGroup(isnGroupItem);$location.path('/itemDetail');};var openItemDetail=function(isnGroupItem){$itemSearch.searchISNORProductCode(isnGroupItem.productList[0],function(response){if(response.ngroups==0){jQuery('.not-found-alert').modal('show');}else if(response.isnGroup.length==1){$itemSearch.setSelectedISNGroup(response.isnGroup[0]);$location.path('/itemDetail');}else{$location.path("/itemResults");}},function(err){alert(err);});}
var showResults=function(){var cachedResult=$itemSearch.getCachedResult();if(cachedResult===undefined){$location.path("/itemSearch");}else{$scope.response=cachedResult;$scope.page={};$scope.page.numberOfItems=$scope.response.ngroups;$scope.page.currentPage=$itemSearch.getCachedQueryParam().currentPage;$scope.page.maxSize=5;$scope.page.itemsPerPage=$itemSearch.MAX_NUMBER_OF_ROWS;$scope.page.numberOfPages=Math.ceil($scope.response.ngroups/$scope.page.itemsPerPage);var cachedParam=$itemSearch.getCachedQueryParam();$scope.selectedBrands=cachedParam.selectedBrands?cachedParam.selectedBrands:[];$scope.selectedColors=cachedParam.selectedColors?cachedParam.selectedColors:[];$scope.selectedItemSizes=cachedParam.selectedItemSizes?cachedParam.selectedItemSizes:[];$scope.selectedFOBs=cachedParam.selectedFOBs?cachedParam.selectedFOBs:[];}}
$scope.listClick=function(item){openItemDetail(item);};$scope.showAvailableItemsAction=function(){$scope.showAvailableItems=!$scope.showAvailableItems;var queryParam=$itemSearch.getCachedQueryParam();delete queryParam.buyable;if($scope.showAvailableItems){queryParam.buyable=true;}
$scope.filter(queryParam)};$scope.pageChanged=function(){var queryParam=$itemSearch.getCachedQueryParam();queryParam.start=($scope.page.currentPage-1)*$itemSearch.MAX_NUMBER_OF_ROWS;queryParam.currentPage=$scope.page.currentPage;$scope.filter(queryParam)};var _allSelectedFacetCriteria=[];$scope.facetItemClicket=function(array,value,filterFacet){var index=-1;for(var i=0;i<array.length;i++){if(array[i].name===value.name){index=i;break;}}
if(index!=-1){array.splice(index,1);for(var p=0;p<_allSelectedFacetCriteria.length;p++){if((_allSelectedFacetCriteria[p].name===value.name)&&(_allSelectedFacetCriteria[p].filterFacet===filterFacet)){_allSelectedFacetCriteria.splice(p,1);break;}}}else{value.filterFacet=filterFacet;array.push(value);_allSelectedFacetCriteria.push(value);}
var queryParam=$itemSearch.getCachedQueryParam();queryParam.selectedBrands=$scope.selectedBrands;queryParam.selectedColors=$scope.selectedColors;queryParam.selectedItemSizes=$scope.selectedItemSizes;queryParam.selectedFOBs=$scope.selectedFOBs;var filterFacetArray=[];var filterSet={};for(var p=0;p<_allSelectedFacetCriteria.length;p++){if(_allSelectedFacetCriteria[p].filterFacet in filterSet){continue;}else{filterFacetArray.push(_allSelectedFacetCriteria[p].filterFacet);filterSet[_allSelectedFacetCriteria[p].filterFacet]=true;}}
queryParam.filterFacet=filterFacetArray;queryParam.start=0;queryParam.currentPage=1;$scope.filter(queryParam)}
$scope.itemExist=function(array,value){for(var i=0;i<array.length;i++){if(array[i].name===value.name){return true;}}
return false;}
$scope.filter=function(queryParam){$itemSearch.filter(queryParam,function(response){if(response.ngroups==0){jQuery('.not-found-alert').modal('show');}else{showResults();}},function(err){alert(err);});};$scope.openItemSizes=function(isnGroupItem){if(isnGroupItem.colorSize.length>1){var modalInstance=$modal.open({templateUrl:'itemColorSize.html',controller:'itemColorSizeCtrl',resolve:{isnGroupItem:function(){return isnGroupItem;}}});}else{openItemDetail(isnGroupItem);}};showResults();var iScrollWrappers={};$scope.refreshScroll=function(scrollId){setTimeout(function(){var scroll=iScrollWrappers[scrollId];if(scroll){scroll.refresh();scroll.scrollToElement('td',500,null,null,null);}else{iScrollWrappers[scrollId]=new IScroll('#'+scrollId,{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip'});}},500);};$scope.itemTitleClass=function(isnGroup){return isnGroup.isnGroupAvailable?'itemResultsTitle':'zeroInventoryGroup';}
$scope.showAvailableItems=false;$scope.left=$rootScope.left;$scope.moveFacets=function(){$scope.left=!$scope.left;$rootScope.left=$scope.left;}}]);
﻿angular.module('itemSearch',['ui.bootstrap']).controller('itemSearchCtrl',['$scope','$location','numberOnlyKeyPressValidator','$rootScope','itemSearch','$stateParams','$timeout',function($scope,$location,$numberOnlyKeyPressValidator,$rootScope,$itemSearch,$stateParams,$timeout){$scope.queryParameters={}
$scope.numberValidator=$numberOnlyKeyPressValidator;$scope.cmgData=[];$scope.cfgData=[];$scope.fobData=[];$scope.specialCharRemove=function(keyEvent){var theEvent=keyEvent||window.event;var key=theEvent.keyCode||theEvent.which;if(key==13){return;}
key=String.fromCharCode(key);var regex=/[0-9a-zA-Z ]/;if(!regex.test(key)){theEvent.returnValue=false;if(theEvent.preventDefault)theEvent.preventDefault();}};$scope.upcPaste=function($event,inputQueryName){if(typeof $event.originalEvent.clipboardData!=="undefined"){handlePastedUPC($event.originalEvent.clipboardData.getData('text/plain'),inputQueryName);}else{$timeout(function(){handlePastedUPC(angular.element($event.currentTarget).val(),inputQueryName);},2);}};var handlePastedUPC=function(pastedText,inputQueryName){var cleansedText="";var inputField=angular.isString(inputQueryName)&&(inputQueryName.length>0)?inputQueryName:"upc";for(var i=0;i<pastedText.length;i++){if((/\d/).test(pastedText[i])){cleansedText+=pastedText[i];}}
$timeout(function(){$scope.queryParameters[inputField]=cleansedText;},3);};$scope.webIdPaste=function($event){if(typeof $event.originalEvent.clipboardData!=="undefined"){handlePastedWedId($event.originalEvent.clipboardData.getData('text/plain'));}else{$timeout(function(){handlePastedWedId(angular.element($event.currentTarget).val());},2);}};var handlePastedWedId=function(pastedText){var cleansedText="";for(var i=0;i<pastedText.length;i++){if((/[0-9a-zA-Z ]/).test(pastedText[i])){cleansedText+=pastedText[i];}}
$timeout(function(){$scope.queryParameters.webIdImageId=cleansedText;},3);};$scope.cleanSearchParameters=function(){$itemSearch.clearCachedResult();$scope.queryParameters={}
$scope.cmgData.forEach(function(item){item.visible=true;});$scope.cfgData.forEach(function(item){item.visible=true;});$scope.fobData.forEach(function(item){item.visible=true;});}
$scope.isSearchable=function(){var result=$scope.queryParameters.upc?true:false||$scope.queryParameters.webIdImageId?true:false||$scope.queryParameters.brandName?true:false||$scope.queryParameters.vendorStyle?true:false||$scope.queryParameters.description?true:false||$scope.queryParameters.selectedCFG?true:false||$scope.queryParameters.selectedCMG?true:false||$scope.queryParameters.selectedFOB?true:false||$scope.queryParameters.upcWSizeFilter?true:false||$scope.queryParameters.upcWColorFilter?true:false;return result;}
$scope.search=function(){if($scope.isSearchable()){$scope.queryParameters.start=0;$scope.queryParameters.currentPage=1;$scope.queryParameters.rows=$itemSearch.MAX_NUMBER_OF_ROWS;$scope.queryParameters.selectedBrands=[];$scope.queryParameters.selectedColors=[];$scope.queryParameters.selectedItemSizes=[];$scope.queryParameters.selectedFOBs=[];var searchFunction=null;var searchParams=null;if($scope.queryParameters.upc)
{searchFunction=$itemSearch.searchUPC;searchParams=$scope.queryParameters.upc;}
else if($scope.queryParameters.upcWSizeFilter){searchFunction=$itemSearch.searchUPCMoreColors;searchParams=$scope.queryParameters.upcWSizeFilter;}
else if($scope.queryParameters.upcWColorFilter){searchFunction=$itemSearch.searchUPCMoreSizes;searchParams=$scope.queryParameters.upcWColorFilter;}
else{searchFunction=$itemSearch.search;searchParams=$scope.queryParameters;}
searchFunction(searchParams,function(response){if(response.ngroups==0){jQuery('.not-found-alert').modal('show');}else if(response.isnGroup.length==1){$itemSearch.setSelectedISNGroup(response.isnGroup[0]);$location.path('/itemDetail');}else{$location.path("/itemResults");}},function(err){alert(err);});}};if(angular.isNumber($stateParams.upc)){$scope.cleanSearchParameters();$scope.queryParameters.upc=$stateParams.upc;$scope.search();$stateParams.upc="";}
$itemSearch.retrieveBrands(function(data){$scope.brandsData=data;},function error(err){alert(err)});$itemSearch.retrieveProductHierarchy(function(data){$scope.cmgData=data.cmgData;$scope.cfgData=data.cfgData;$scope.fobData=data.fobData;},function(err){alert(err);});function angularToItemStructureItem(itemStructureArray){return function populate(item){itemStructureArray.push(item);}}
var filterItems=function(arrayData,prop,selectedValue){arrayData.forEach(function(item){if(selectedValue){if(item[prop]==selectedValue)
item.visible=true;else
item.visible=false;}else{item.visible=true;}});}
$scope.cmgClick=function(){filterItems($scope.cfgData,'cmgItemOriginalValue',$scope.queryParameters.selectedCMG);filterItems($scope.fobData,'cmgItemOriginalValue',$scope.queryParameters.selectedCMG);$scope.queryParameters.selectedCFG=undefined;$scope.queryParameters.selectedFOB=undefined;}
$scope.cfgClick=function(){if($scope.queryParameters.selectedCFG){filterItems($scope.fobData,'cfgItemOriginalValue',$scope.queryParameters.selectedCFG);$scope.queryParameters.selectedFOB=undefined;}}
var localUPCScanHandler=function(event,upc){var location=document.activeElement.id;if(location=="upcSizesField"){$scope.queryParameters.upcWSizeFilter=upc;}else if(location=="upcColorsField"){$scope.queryParameters.upcWColorFilter=upc;}else{$scope.queryParameters.upc=upc;}
$scope.search();};var deregister=$rootScope.$on('Scanner_Event',localUPCScanHandler);$scope.$on("$destroy",function(){deregister();});}]);
﻿angular.module('orderCart',['ui.bootstrap','ui.router','pageslide-directive']).controller('orderCartCtrl',['$scope','$location','$modal','$state','$log','customer','$rootScope','orderCart','bigTicketValidate','$document','numberOnlyKeyPressValidator','itemSearch','loggerService','$stateParams','$timeout',function($scope,$location,$modal,$state,$log,customer,$rootScope,orderCart,bigTicketValidate,$document,$numberOnlyKeyPressValidator,$itemSearch,$loggerService,$stateParams,$timeout){var isLoadDraftOrder=false;if($stateParams.loadDraft){isLoadDraftOrder=$stateParams.loadDraft.toString().trim().length>0?true:false;}
$scope.numberValidator=$numberOnlyKeyPressValidator;$scope.upcPaste=function($event){if(typeof $event.originalEvent.clipboardData!=="undefined"){handlePastedUPC($event.originalEvent.clipboardData.getData('text/plain'));}else{$timeout(function(){handlePastedUPC(angular.element($event.currentTarget).val());},2);}};var handlePastedUPC=function(pastedText){var cleansedText="";for(var i=0;i<pastedText.length;i++){if((/\d/).test(pastedText[i])){cleansedText+=pastedText[i];}}
$timeout(function(){$scope.addUpcInput=cleansedText.substring(0,13);},3);};$scope.cart=orderCart.order.getLiveOrderCart();$scope.orderLinesArray=$scope.cart.OrderLines.OrderLine;var refreshOrderLineTempQty=function(orderline){orderline.btLogic.orderSummaryPageTempQty=parseInt(orderline._OrderedQty);};angular.forEach($scope.orderLinesArray,function(orderline){refreshOrderLineTempQty(orderline);});$scope.$on("$destroy",function(){orderCart.order.cleanOrderCart();});$scope.checkout=function(){orderCart.order.cleanOrderCart();if(orderCart.orderLine.util.orderlineCount()<1){return;}
$rootScope.$broadcast('uiBreadcrumbDisplay',{display:false,defer:true});$rootScope.$broadcast('uiCheckoutStepProgressDisplay',{display:true,defer:true});if(customer.isCustomerSelected()){$location.path('/shippingSelection')}else{$location.path('/customerSearch')}};$scope.deleteOrderLine=function(line){var primeLineObject={PrimeLine:line._PrimeLineNo,SubLine:line._SubLineNo};orderCart.orderLine.deleteOrderLine(primeLineObject);};var myScroll=new IScroll('#ItemDetailWrapper',{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip'});$scope.refreshIScroll=function(){setTimeout(function(){myScroll.refresh();},500);};$scope.lineTotal=function(orderline){var price=null;if(orderline.LinePriceInfo&&orderline.LinePriceInfo._btAdjustedPrice&&isFinite(parseFloat(orderline.LinePriceInfo._btAdjustedPrice))){price=parseFloat(orderline.LinePriceInfo._btAdjustedPrice);}else{if(angular.isDefined(orderline.LinePriceInfo._UnitPrice)&&isFinite(parseFloat(orderline.LinePriceInfo._UnitPrice))){price=parseFloat(orderline.LinePriceInfo._UnitPrice);}
if(price!==null){if(angular.isDefined(orderline.LinePriceInfo._RetailPrice)&&isFinite(parseFloat(orderline.LinePriceInfo._RetailPrice))){var temp=parseFloat(orderline.LinePriceInfo._RetailPrice);if(temp<price){price=temp;}}}else if(angular.isDefined(orderline.LinePriceInfo._RetailPrice)&&isFinite(parseFloat(orderline.LinePriceInfo._RetailPrice))){price=parseFloat(orderline.LinePriceInfo._RetailPrice);}}
var quantity=isFinite(parseInt(orderline._OrderedQty))?parseInt(orderline._OrderedQty):1;return price?quantity*price:'N/A';};$scope.orderSubtotal=function(){var runningTotal=0.0;angular.forEach($scope.orderLinesArray,function(orderline){runningTotal+=$scope.lineTotal(orderline);});return isFinite(runningTotal)?runningTotal:'N/A';};$scope.changeRouteState=function(stateName){$state.go(stateName);};$scope.addUpcInput='';$scope.addUpc=function(){if($scope.addUpcInput.trim()!==''){$rootScope.$broadcast('Scanner_Event',$scope.addUpcInput.trim());}};$scope.$on('scannerAddUpcError',function(event,error){if(error.code==='InvalidItem:BGT'){$loggerService.log("Big Ticket Rejected.");$scope.openZipCodeValidation(error.itemObject);$loggerService.log(error);}else{$scope.openErrorModal(error);}});$scope.$on('scannerAddUpcClearInput',function(event){$scope.addUpcInput='';});$scope.$on('orderCartDeleted',function(event,data){$scope.cart=orderCart.order.getLiveOrderCart();$scope.orderLinesArray=$scope.cart.OrderLines.OrderLine;$scope.refreshIScroll();angular.forEach($scope.orderLinesArray,function(orderline){refreshOrderLineTempQty(orderline);});$scope.currentItem={};});$scope.currentItem={};$scope.compareCurrentOrderline=function(orderlineInput){if($scope.isSliderOpen&&$scope.currentItem.orderline){return $scope.currentItem.orderline===orderlineInput;}else{return false;}}
$scope.isSliderOpen=false;$scope.openQtyModal=function(orderline){$scope.sliderShowInputBox=false;$scope.sliderInputError=false;$scope.sliderInput='';var availableQtyObj=orderCart.orderLine.util.getAvailableInventoryAndOrderedQty(orderline);$scope.currentItem.Available=availableQtyObj.largestAvailableInventory-(availableQtyObj.orderedQty-parseInt(orderline._OrderedQty));$scope.currentItem.orderline=orderline;$scope.isSliderOpen=!$scope.isSliderOpen;};$scope.sliderInput='';$scope.sliderInputError=false;var sliderKeyPressHandler=function(event){if(event.keyCode===27){$scope.sliderClose();}
if(event.keyCode===13){$scope.sliderSave();}};$scope.sliderClick=function(numberClicked){if($scope.sliderShowInputBox){if(numberClicked===-1){$scope.sliderInput="";return;}
$scope.sliderInput=$scope.sliderInput+numberClicked.toString();if(parseInt($scope.sliderInput)>$scope.currentItem.Available){$scope.sliderInputError=true;$scope.sliderInput=$scope.currentItem.Available.toString();}}else{if(parseInt($scope.sliderInput)>$scope.currentItem.Available){numberClicked=$scope.currentItem.Available;}
orderCart.orderLine.setOrderLineQuantity($scope.currentItem.orderline,numberClicked);$scope.sliderClose();}};$scope.sliderInputChange=function(){if(parseInt($scope.sliderInput)>$scope.currentItem.Available){$scope.sliderInputError=true;$scope.sliderInput=$scope.currentItem.Available.toString();}}
$scope.sliderChangeInput=function(){$scope.sliderShowInputBox=true;$document.find('input.sliderButton').first().attr("autofocus","autofocus");};$scope.sliderButtonDisable=function(buttonValue){if(buttonValue<=$scope.currentItem.Available){return false;}else{return true;}};$scope.sliderShowInputBox=false;$scope.sliderSave=function(){if(isFinite(parseInt($scope.sliderInput))){$scope.sliderClose();$scope.sliderClick(parseInt($scope.sliderInput));}else{$scope.sliderClose();}
$loggerService.log('submitted');};$scope.itemDetail=function(upc){$itemSearch.searchUPC(upc,function(response){if(response.ngroups&&response.ngroups==0){jQuery('.not-found-alert').modal('show');}else if(response.isnGroup.length==1){$itemSearch.setSelectedISNGroup(response.isnGroup[0]);$location.path('/itemDetail');}else{$location.path("/itemResults");}},function(err){alert(err);});};$scope.validUPC=function(upc){var isValid=false;if(upc){upc=upc.replace(/\D/g,'');if(upc.length>9){isValid=true;}}
return isValid;};$scope.sliderClose=function(){$scope.isSliderOpen=false;$scope.sliderInputError=false;$scope.sliderShowInputBox=false;$document.find('input.sliderButton').first().removeAttr("autofocus");};$scope.alwaysBlur=function(event){angular.element(event.target).each(function(){this.blur()});angular.element(event.target).closest('form').find('input').each(function(){this.focus()});};$scope.openItemDescription=function(currentItem){var modalInstance=$modal.open({templateUrl:'html/item/itemDetailDescription.html',controller:'itemDescriptionCtrl',resolve:{currentItem:function(){return currentItem;},isCart:function(){return true;}}});};$scope.openZipCodeValidation=function(currentItem){var modalInstance=$modal.open({templateUrl:'zipCodeValidation.html',controller:'zipCodeValidationCtrl',resolve:{currentItem:function(){return currentItem;}}});modalInstance.result.then(function(result){if('name'in result&&'message'in result){$scope.openErrorModal(result);}});};$scope.openErrorModal=function(error){var modalInstance=$modal.open({templateUrl:'html/modalTemplates/error.html',controller:'cartSummaryErrorCtrl',resolve:{currentError:function(){return error;}}});};$scope.openLoadDraftOrder=function(){var modalInstance=$modal.open({templateUrl:'html/order/draftOrderLoad.html',controller:'draftOrderLoadCtrl',backdrop:'static',keyboard:false,animation:false});modalInstance.result.then(function(){$scope.cart=orderCart.order.getLiveOrderCart();$scope.orderLinesArray=$scope.cart.OrderLines.OrderLine;$scope.refreshIScroll();angular.forEach($scope.orderLinesArray,function(orderline){refreshOrderLineTempQty(orderline);});$scope.currentItem={};},function(){$scope.cart=orderCart.order.getLiveOrderCart();$scope.orderLinesArray=$scope.cart.OrderLines.OrderLine;$scope.refreshIScroll();angular.forEach($scope.orderLinesArray,function(orderline){refreshOrderLineTempQty(orderline);});$scope.currentItem={};})};if(isLoadDraftOrder){$scope.openLoadDraftOrder();}}]).controller('draftOrderLoadCtrl',['$scope','$modalInstance','orderCart','order','customer','payment','orderCart','itemDetail','$timeout',function($scope,$modalInstance,$orderCart,$order,$customer,$payment,$orderCart,$itemDetail,$timeout){$scope.errorMessages=[];$scope.isLoaded=false;var myScroll;setTimeout(function(){myScroll=new IScroll('#ErrorWrapper',{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip'});},500);$scope.refreshIScroll=function(){setTimeout(function(){myScroll.refresh();},500);};var _init=function(){var draftOrder=$order.getCurrentOrderDetails();if(draftOrder===undefined||draftOrder===null||!angular.isDefined(draftOrder.OrderLines)||!angular.isArray(draftOrder.OrderLines.OrderLine)||(draftOrder.OrderLines.OrderLine.length<1)){$scope.isLoaded=true;$timeout($modalInstance.dismiss,500);return;}
$orderCart.order.deleteCart();$customer.clearSelectedCustomer();$orderCart.customer.deleteCustomer();$payment.clearPaymentData();if(angular.isString(draftOrder._BillToID)&&(draftOrder._BillToID.length>0)){$customer.retrieveCustomerDetail(draftOrder._BillToID,'',function(customer){if(angular.isString(customer._CustomerKey)&&customer._CustomerKey.length>0){$customer.addToCart(customer);$orderCart.customer.setCustomer(customer);}});}
var pricingAndInventoryObject={productList:[]};var skuAddedToPricingAndInventoryObject={};for(var i=0;i<draftOrder.OrderLines.OrderLine.length;i++){var solarDoc=null;if(angular.isObject(draftOrder.OrderLines.OrderLine[i].btDisplay)&&angular.isDefined(draftOrder.OrderLines.OrderLine[i].btDisplay._version_)){solarDoc=angular.copy(draftOrder.OrderLines.OrderLine[i].btDisplay);}else{var itemName='';if(angular.isObject(draftOrder.OrderLines.OrderLine[i].btDisplay)&&angular.isDefined(draftOrder.OrderLines.OrderLine[i].btDisplay.defaultItemDescription)&&angular.isString(draftOrder.OrderLines.OrderLine[i].btDisplay.defaultItemDescription)&&(draftOrder.OrderLines.OrderLine[i].btDisplay.defaultItemDescription.length>0)){itemName='"'+draftOrder.OrderLines.OrderLine[i].btDisplay.defaultItemDescription+'" ';}
$scope.errorMessages.push('Item '+itemName+(angular.isObject(draftOrder.OrderLines.OrderLine[i].btDisplay)?(' with UPC: '+draftOrder.OrderLines.OrderLine[i].btDisplay.id):'')+' cannot be found.');continue;}
if(!(solarDoc.sku in skuAddedToPricingAndInventoryObject)){pricingAndInventoryObject.productList.push(solarDoc);skuAddedToPricingAndInventoryObject[solarDoc.sku]=solarDoc.sku;}}
var addOrderlines=function(pricePricingAndInventoryObject){if($orderCart.orderLine.util.orderlineCount()>0){var orderCart=$orderCart.order.getLiveOrderCart();var deleteOrderLines=[];for(var p=0;p<orderCart.OrderLines.OrderLine.length;p++){deleteOrderLines.push($orderCart.orderLine.util.getPrimeSubLineObject(orderCart.OrderLines.OrderLine[p]));}
$orderCart.orderLine.deleteOrderLine(deleteOrderLines);}
for(var i=0;i<draftOrder.OrderLines.OrderLine.length;i++){var currentOrderLine=draftOrder.OrderLines.OrderLine[i];var amountToOrder=isFinite(Number.parseInt(currentOrderLine._OrderedQty))?Number.parseInt(currentOrderLine._OrderedQty):1;if(amountToOrder<0){amountToOrder=1;}
var itemPriced=null;for(var j=0;j<pricePricingAndInventoryObject.productList.length;j++){if(pricePricingAndInventoryObject.productList[j].sku===currentOrderLine.btDisplay.sku){itemPriced=pricePricingAndInventoryObject.productList[j];break;}}
try{$orderCart.orderLine.addOrderLine(itemPriced,amountToOrder,true);}catch(error){$scope.errorMessages.push(error.message);$scope.refreshIScroll();}}
$scope.isLoaded=true;$scope.refreshIScroll();if(angular.isArray($scope.errorMessages)&&$scope.errorMessages.length===0){$timeout($modalInstance.dismiss,500);}};if(pricingAndInventoryObject.productList.length>0){$itemDetail(pricingAndInventoryObject,addOrderlines,function(){});}else{$scope.isLoaded=true;$scope.refreshIScroll();}}
$scope.close=function(){$modalInstance.close();};_init();}]).controller('quantityEntryCtrl',['$scope','$modalInstance','orderline','orderCart',function($scope,$modalInstance,orderline,orderCart){var initial=parseInt(orderline._OrderedQty);var displayNew='';$scope.display=function(){if(displayNew.trim()===""){return initial;}else{return displayNew;}}
var availableQtyObj=orderCart.orderLine.util.getAvailableInventoryAndOrderedQty(orderline);$scope.maxAvailable=availableQtyObj.largestAvailableInventory-(availableQtyObj.orderedQty-parseInt(orderline._OrderedQty));$scope.input=function(input){displayNew=displayNew.toString()+input.toString();if(parseInt(displayNew)>$scope.maxAvailable){displayNew=$scope.maxAvailable.toString();}}
$scope.backspace=function(){displayNew=displayNew.substring(0,displayNew.length-1);if(parseInt(displayNew)>$scope.maxAvailable){displayNew=$scope.maxAvailable.toString();}};$scope.save=function(){};$scope.cancel=function(){$modalInstance.dismiss('cancel');};}]).controller('cartSummaryErrorCtrl',['$scope','$modalInstance','currentError',function($scope,$modalInstance,currentError){$scope.currentError=currentError;$scope.cancel=function(){$modalInstance.dismiss('cancel');};}]);
﻿
angular.module('shippingSelection',['ui.bootstrap','appServiceOrderCart','ui.router']).filter('filterShipToList',function(){return function(orderlineArray,addressFilterObj){if(angular.isArray(orderlineArray)&&angular.isObject(addressFilterObj)&&angular.isString(addressFilterObj.key)&&angular.isString(addressFilterObj.carrierServiceCode)){var tempArray=[];for(var i=0;i<orderlineArray.length;i++){if((orderlineArray[i].PersonInfoShipTo._PersonInfoKey===addressFilterObj.key)&&(orderlineArray[i]._CarrierServiceCode===addressFilterObj.carrierServiceCode)){tempArray.push(orderlineArray[i]);}}
return tempArray;}else{return orderlineArray;}};}).controller('shippingSelectionCtrl',['$scope','$location','orderCart','$cacheFactory','$modal','$state','customer','$filter','expectedDeliveryService','loggerService','loadingIconService',function($scope,$location,orderCart,$cacheFactory,$modal,$state,$customer,$filter,expectedDeliveryService,$loggerService,$loadingIconService){$scope.isDisplayGiftBoxComponents=false;$scope.isPageDataLoaded=false;$scope.isCheckOutButtonDisabled=true;$scope.cart=orderCart.order.getLiveOrderCart();$scope.orderLinesArray=$scope.cart.OrderLines.OrderLine;if($customer.isCustomerSelected()){$scope.customer=$customer.getSelectedCustomer();orderCart.customer.setCustomer($scope.customer);}else{$state.go('customerSearch')
return;}
if($scope.orderLinesArray.length<1){$state.go('itemSearch')
return;}
$scope.availableShippingAddresses={};$scope.orderedOrderLineAddressPersonKey=[];$scope.getLowestPrice=function(orderline){return orderCart.orderLine.util.getLowestSalePrice(orderline);};$scope.getConcatAddresses=function(address){var addressesArray=[];if(address._AddressLine1.toString().trim()){addressesArray.push(address._AddressLine1.toString());}
if(angular.isDefined(address._AddressLine2)&&address._AddressLine2.toString().trim()){addressesArray.push(address._AddressLine2.toString());}
if(angular.isDefined(address._AddressLine3)&&address._AddressLine3.toString().trim()){addressesArray.push(address._AddressLine3.toString());}
return addressesArray.join(", ");};$scope.isValidNonRegistryAddressObject=function(addressObject){if(!angular.isObject(addressObject)){return false;}
if(angular.isObject(addressObject.btLogic)&&addressObject.btLogic.isRegistryAddress){return true;}
var validObj=orderCart.address.validAddress(addressObject.PersonInfo);return validObj.isValid;}
$scope.printPrice=function(price){if(angular.isNumber(price)||(angular.isString(price)&&price.length>0)){return $filter('currency')(price);}else{return'N/A';}};$scope.getLineTotal=function(orderline){return orderCart.subtotal.computeShippingOrderLineSubtotal(orderline);};var shipToKeySet={};var _addCustomerAddressesToAvailableShippingAddress=function(){angular.forEach($scope.customer.CustomerContactList.CustomerContact[0].CustomerAdditionalAddressList.CustomerAdditionalAddress,function(addressObject){if(addressObject._IsShipTo==="Y"){addressObject.btLogic={isRegistryAddress:false};$scope.availableShippingAddresses[addressObject.PersonInfo._PersonInfoKey]=addressObject;}});};var _addRegistryAddressToAvailableShippingAddresses=function(addressObject){if(!(addressObject.PersonInfo._PersonInfoKey in $scope.availableShippingAddresses)){addressObject.btLogic={isRegistryAddress:true};$scope.availableShippingAddresses[addressObject.PersonInfo._PersonInfoKey]=addressObject;}};var _addAllCurrentRegistryAddressesToAvailableShippingAddresses=function(){return orderCart.giftOptions.loadRegistryAddresses().then(function(listOfRegAddr){angular.forEach(listOfRegAddr,_addRegistryAddressToAvailableShippingAddresses);});};var _initAvailableShippingAddresses=function(){var keys=Object.keys($scope.availableShippingAddresses);for(var index=0;index<keys.length;index++){delete $scope.availableShippingAddresses[keys[index]];}
_addCustomerAddressesToAvailableShippingAddress();_addAllCurrentRegistryAddressesToAvailableShippingAddresses();};var _regroupOrderLines=function(){$scope.orderedOrderLineAddressPersonKey.splice(0,$scope.orderedOrderLineAddressPersonKey.length);var keys=Object.keys(shipToKeySet);for(var index=0;index<keys.length;index++){delete shipToKeySet[keys[index]];}
for(var i=0;i<$scope.orderLinesArray.length;i++){var orderLineShipKey=$scope.orderLinesArray[i].PersonInfoShipTo._PersonInfoKey;if(!(orderLineShipKey in shipToKeySet)){shipToKeySet[orderLineShipKey]=[$scope.orderLinesArray[i]._CarrierServiceCode];$scope.orderedOrderLineAddressPersonKey.push({key:orderLineShipKey,carrierServiceCode:$scope.orderLinesArray[i]._CarrierServiceCode,carrierServicePrice:$scope.orderLinesArray[i].btDisplay.shippingMethodPrice,carrierServiceDescription:$scope.orderLinesArray[i].btDisplay.shippingMethodDescription,isRegistryAddress:$scope.orderLinesArray[i].btLogic.isGiftRegistryAddress,registryNo:$scope.orderLinesArray[i].Extn._ExtnGiftRegistryNo});}else{var carrierArray=shipToKeySet[orderLineShipKey];var currentServiceCode=$scope.orderLinesArray[i]._CarrierServiceCode;var isCarrierAlreadyInArray=false;for(var q=0;q<carrierArray.length;q++){if(carrierArray[q].toString()===currentServiceCode.toString()){isCarrierAlreadyInArray=true;break;}}
if(!isCarrierAlreadyInArray){shipToKeySet[orderLineShipKey].push($scope.orderLinesArray[i]._CarrierServiceCode);$scope.orderedOrderLineAddressPersonKey.push({key:orderLineShipKey,carrierServiceCode:$scope.orderLinesArray[i]._CarrierServiceCode,carrierServicePrice:$scope.orderLinesArray[i].btDisplay.shippingMethodPrice,carrierServiceDescription:$scope.orderLinesArray[i].btDisplay.shippingMethodDescription,isRegistryAddress:$scope.orderLinesArray[i].btLogic.isGiftRegistryAddress,registryNo:$scope.orderLinesArray[i].Extn._ExtnGiftRegistryNo});}}}};var _resetShippingDisplayData=function(){_initAvailableShippingAddresses();_regroupOrderLines();};var _init=function(){_resetShippingDisplayData();$scope.uncheckAll(null);$scope.isPageDataLoaded=true;};var _repriceReset=function(){$loggerService.log('Refreshing controllers $scope with orderCart.');$scope.cart=orderCart.order.getLiveOrderCart();$scope.orderLinesArray=$scope.cart.OrderLines.OrderLine;_resetShippingDisplayData();$scope.refreshIScroll();};var _getCustomerBillingAddresses=function(){var billingAddressObj={};angular.forEach($scope.customer.CustomerContactList.CustomerContact[0].CustomerAdditionalAddressList.CustomerAdditionalAddress,function(addressObject){if(addressObject._IsBillTo==="Y"){var validObj=orderCart.address.validAddress(addressObject.PersonInfo,true);var copyBilling=angular.copy(addressObject);copyBilling.btIsValid=validObj.isValid;billingAddressObj[addressObject.PersonInfo._PersonInfoKey]=copyBilling;}});return billingAddressObj;};$scope.goToPayment=function(){orderCart.address.validateOrderAddresses().then(function(data){var headerErrors=orderCart.order.validateOrderHeader();if(!data.defaultBillingAddressError.hasError&&!data.defaultShipToAddressError.hasError&&!data.carrierServiceCodeError.hasError&&!data.bigTicketError.hasError&&!data.orderlineShiptoAddressError.hasError&&!headerErrors.customerEmailIdError.hasError){$state.go('paymentSummary');}else{var ErrorTextArr=[];if(headerErrors.customerEmailIdError.hasError){ErrorTextArr.push(headerErrors.customerEmailIdError.errorText);}
if(data.defaultBillingAddressError.hasError){ErrorTextArr.push(data.defaultBillingAddressError.errorText);}
if(data.defaultShipToAddressError.hasError){ErrorTextArr.push(data.defaultShipToAddressError.errorText);}
if(data.carrierServiceCodeError.hasError){ErrorTextArr.push(data.carrierServiceCodeError.errorText);}
if(data.bigTicketError.hasError){ErrorTextArr.push(data.bigTicketError.errorText);}
if(data.orderlineShiptoAddressError.hasError){ErrorTextArr.push(data.orderlineShiptoAddressError.errorText);}
swal({title:"Alert!",text:ErrorTextArr.join('. '),showConfirmButton:true});}},function(data){swal({title:"Alert!",text:'validate order addresses ajax error.',showConfirmButton:true});$loggerService.log(data);});};$scope.getGiftMessage=function(orderLine){var primeSubLine={};primeSubLine.PrimeLine=orderLine._PrimeLineNo;if(orderLine._SubLineNo){primeSubLine.SubLine=orderLine._SubLineNo;}
var messages=orderCart.giftOptions.getGiftOptionFromOrderLines(primeSubLine);if(messages){return"To: "+messages.To+" From: "+messages.From+" Message: "+messages.Message;}else{return"";}};$scope.collapseGroup=function(event){var current=jQuery(event.currentTarget);current.toggleClass('shippingSelectGroupHeaderCollapsed');current.toggleClass('shippingSelectGroupHeader');current.find('.minIcon').toggle();current.find('.maxIcon').toggle();current.nextAll('.groupRow').toggle();$scope.refreshIScroll();};var _selectedLinesCount=0;$scope.isLineSelected=false;$scope.allLinesChecked=function(){return _selectedLinesCount==$scope.orderLinesArray.length;};$scope.isAllAddressGroupChecked=function(addressFilterObj){var linesToCheck=$filter('filterShipToList')($scope.orderLinesArray,addressFilterObj);for(var i=0;i<linesToCheck.length;i++){if(!angular.isDefined(linesToCheck[i].btLogic.isSelected)){return false;}else if(linesToCheck[i].btLogic.isSelected===false){return false;}}
return true;};var _updateSelectionCount=function(count){if(angular.isNumber(parseInt(count))){count=parseInt(count);_selectedLinesCount+=count;if(_selectedLinesCount<1){_selectedLinesCount=0;$scope.isLineSelected=false;}else{$scope.isLineSelected=true;}}};$scope.selectLine=function(orderline){if(orderline.btLogic.isSelected){orderline.btLogic.isSelected=false;_updateSelectionCount(-1);}else{orderline.btLogic.isSelected=true;_updateSelectionCount(1);}};$scope.checkedButtonFont='fa-check fa-2x';$scope.checkAll=function(addressFilterObj){if(angular.isObject(addressFilterObj)&&angular.isString(addressFilterObj.key)&&angular.isString(addressFilterObj.carrierServiceCode)){for(var i=0;i<$scope.orderLinesArray.length;i++){if(($scope.orderLinesArray[i].PersonInfoShipTo._PersonInfoKey===addressFilterObj.key)&&($scope.orderLinesArray[i]._CarrierServiceCode===addressFilterObj.carrierServiceCode)){if(!angular.isDefined($scope.orderLinesArray[i].btLogic.isSelected)){$scope.orderLinesArray[i].btLogic.isSelected=true;_updateSelectionCount(1);}else if(angular.isDefined($scope.orderLinesArray[i].btLogic.isSelected)&&$scope.orderLinesArray[i].btLogic.isSelected==false){$scope.orderLinesArray[i].btLogic.isSelected=true;_updateSelectionCount(1);}else{$scope.orderLinesArray[i].btLogic.isSelected=true;}}}}else{for(var p=0;p<$scope.orderLinesArray.length;p++){if(!angular.isDefined($scope.orderLinesArray[p].btLogic.isSelected)){$scope.orderLinesArray[p].btLogic.isSelected=true;_updateSelectionCount(1);}else if(angular.isDefined($scope.orderLinesArray[p].btLogic.isSelected)&&$scope.orderLinesArray[p].btLogic.isSelected==false){$scope.orderLinesArray[p].btLogic.isSelected=true;_updateSelectionCount(1);}else{$scope.orderLinesArray[p].btLogic.isSelected=true;}}}};$scope.uncheckAll=function(addressFilterObj){if(angular.isObject(addressFilterObj)&&angular.isString(addressFilterObj.key)&&angular.isString(addressFilterObj.carrierServiceCode)){for(var i=0;i<$scope.orderLinesArray.length;i++){if(($scope.orderLinesArray[i].PersonInfoShipTo._PersonInfoKey===addressFilterObj.key)&&($scope.orderLinesArray[i]._CarrierServiceCode===addressFilterObj.carrierServiceCode)){$scope.orderLinesArray[i].btLogic.isSelected=false;_updateSelectionCount(-1);}}}else{for(var p=0;p<$scope.orderLinesArray.length;p++){$scope.orderLinesArray[p].btLogic.isSelected=false;_updateSelectionCount(-1);}
_updateSelectionCount(-1000);}};$scope.giftOpen=function(orderline,isGiftMessageShow,isGiftRegistyShow,isGiftBoxShow){var modalInstance=$modal.open({templateUrl:'giftMessageModal.html',controller:'GiftRegModCtrl',resolve:{orderlines:function(){if(!angular.isArray(orderline)){var wrap=[];wrap.push(orderline);return wrap;}else{return orderline;}},show:function(){return{'isGiftMessageShow':isGiftMessageShow,'isGiftRegistyShow':isGiftRegistyShow,'isGiftBoxShow':isGiftBoxShow};}},size:'lg'});modalInstance.result.then(function(registryChange){if(registryChange.isRegistryChanged){if(registryChange.registryAddressAdded){_addRegistryAddressToAvailableShippingAddresses(registryChange.registryAddressAdded);}
_addressChangeResetProcess();}});};$scope.updateShipTo=function(orderline){var modalInstance=$modal.open({templateUrl:'shipToModal.html',controller:'shipToModCtrl',resolve:{orderlines:function(){if(!angular.isArray(orderline)){var wrap=[];wrap.push(orderline);return wrap;}else{return orderline;}},availableShippingAddresses:function(){var validatedAddresses={};for(key in $scope.availableShippingAddresses){var address=$scope.availableShippingAddresses[key].PersonInfo;var validObj=orderCart.address.validAddress(address);if(angular.isDefined(address._State)&&address._State!==null&&((/^(aa|ae|ap)$/).test(address._State.toString().toLowerCase()))){continue;}else{var addressCopy=angular.copy($scope.availableShippingAddresses[key]);addressCopy.btIsValid=validObj.isValid;validatedAddresses[key]=addressCopy;}}
return validatedAddresses;},customerContactID:function(){return $scope.customer.CustomerContactList.CustomerContact[0]._CustomerContactID;}},size:'lg'});modalInstance.result.then(function(){_addressChangeResetProcess();});};$scope.updateBillingAddress=function(){var billingAddresses=angular.copy(_getCustomerBillingAddresses());if(!angular.isObject(billingAddresses)){billingAddresses={};}
$loggerService.log(billingAddresses);var modalInstance=$modal.open({templateUrl:'html/customer/billingAddressModal.html',controller:'billingAddressModCtrl',resolve:{billingAddresses:function(){return billingAddresses;},customerContactID:function(){return $scope.customer.CustomerContactList.CustomerContact[0]._CustomerContactID;}},size:'lg'});};$scope.updateTaxExempt=function(){var modalInstance=$modal.open({templateUrl:'taxExemptModal.html',controller:'taxExemptModCtrl',size:'lg'});modalInstance.result.then(function(){_speedChangeResetProcess();});};$scope.updateShippingSpeed=function(orderline){var modalInstance=$modal.open({templateUrl:'shippingSpeedModal.html',controller:'shippingSpeedModCtrl',resolve:{orderlines:function(){if(!angular.isArray(orderline)){var wrap=[];wrap.push(orderline);return wrap;}else{return orderline;}}},size:'lg'});modalInstance.result.then(function(){_speedChangeResetProcess();});};$scope.updateMultiGiftMessage=function(){var orderlines=[];for(var i=0;i<$scope.orderLinesArray.length;i++){if($scope.orderLinesArray[i].btLogic.isSelected){orderlines.push($scope.orderLinesArray[i]);}}
if(orderlines.length>0){$scope.giftOpen(orderlines,true,false,false);}};$scope.updateMultiGiftRegistry=function(){var orderlines=[];for(var i=0;i<$scope.orderLinesArray.length;i++){if($scope.orderLinesArray[i].btLogic.isSelected){orderlines.push($scope.orderLinesArray[i]);}}
if(orderlines.length>0){$scope.giftOpen(orderlines,false,true,false);}};$scope.addMultiGiftBox=function(){var orderlines=[];for(var i=0;i<$scope.orderLinesArray.length;i++){if($scope.orderLinesArray[i].btLogic.isSelected){orderlines.push($scope.orderLinesArray[i]);}}
if(orderlines.length>0){var primeSubLineObjArray=[];for(var i=0;i<orderlines.length;i++){var tempObj={};if(orderlines[i]._PrimeLineNo){tempObj.PrimeLine=orderlines[i]._PrimeLineNo;if(orderlines[i]._SubLineNo){tempObj.SubLine=orderlines[i]._SubLineNo;}
primeSubLineObjArray.push(tempObj);}}
orderCart.giftOptions.addGiftBox(primeSubLineObjArray);}};$scope.deleteMultiGiftBox=function(){var orderlines=[];for(var i=0;i<$scope.orderLinesArray.length;i++){if($scope.orderLinesArray[i].btLogic.isSelected){orderlines.push($scope.orderLinesArray[i]);}}
if(orderlines.length>0){var primeSubLineObjArray=[];for(var i=0;i<orderlines.length;i++){var tempObj={};if(orderlines[i]._PrimeLineNo){tempObj.PrimeLine=orderlines[i]._PrimeLineNo;if(orderlines[i]._SubLineNo){tempObj.SubLine=orderlines[i]._SubLineNo;}
primeSubLineObjArray.push(tempObj);}}
orderCart.giftOptions.deleteGiftBox(primeSubLineObjArray);}};$scope.updateMultiShipTo=function(){var orderlines=[];for(var i=0;i<$scope.orderLinesArray.length;i++){if($scope.orderLinesArray[i].btLogic.isSelected){orderlines.push($scope.orderLinesArray[i]);}}
if(orderlines.length>0){$scope.updateShipTo(orderlines);}};$scope.updateMultiShippingSpeed=function(){var orderlines=[];for(var i=0;i<$scope.orderLinesArray.length;i++){if($scope.orderLinesArray[i].btLogic.isSelected){orderlines.push($scope.orderLinesArray[i]);}}
var modalInstance=$modal.open({templateUrl:'/html/modalTemplates/shippingSpeedMultiModal.html',controller:'shippingSpeedMultiModCtrl',resolve:{orderlines:function(){return orderlines;},expectedShipDatesMap:function(){var transformed=angular.copy($scope.expectedDeliveryDateMap);for(key in transformed){transformed[key]=new Date(transformed[key]);}
return transformed;}},size:'lg'});modalInstance.result.then(function(){_speedChangeResetProcess();});};var _reportRepriceErrors=function(){var ErrorText="Alert Help Desk. ";var ErrorFound=false;for(var i=0;i<$scope.cart.Errors.ErrorList.Error.length;i++){if($scope.cart.Errors.ErrorList.Error[i]._ErrorCode=='00'){continue;}else{ErrorFound=true;ErrorText+=" "+i.toString()+") "+$scope.cart.Errors.ErrorList.Error[i]._ErrorDescription.toString();$loggerService.log("REPRICE ERRORS:");$loggerService.log($scope.cart.Errors.ErrorList.Error[i]);}}
if(ErrorFound){swal({title:"Alert!",text:ErrorText,showConfirmButton:true});}};var _addressChangeResetProcess=function(){$scope.isCheckOutButtonDisabled=true;$loadingIconService.lockIcon();orderCart.carrierService.updateCarrierServiceList().then(function(){orderCart.order.repriceOrder(true).then(function(){_repriceReset();_reportRepriceErrors();$scope.isCheckOutButtonDisabled=false;$loadingIconService.resetIcon();});},function(error){swal({title:"Alert!",text:error.message,showConfirmButton:true});$loadingIconService.resetIcon();$scope.isCheckOutButtonDisabled=false;_resetShippingDisplayData();$scope.refreshIScroll();});};var _speedChangeResetProcess=function(){$scope.isCheckOutButtonDisabled=true;orderCart.order.repriceOrder(true).then(function(){_repriceReset();_reportRepriceErrors();$scope.isCheckOutButtonDisabled=false;});};_init();var myScroll=new IScroll('#GroupWrapper',{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip'});$scope.refreshIScroll=function(){setTimeout(function(){myScroll.refresh();},500);};expectedDeliveryService.getDates().success(function(data){var serviceMap={};for(var i=0;i<data.ExpectedDeliveryDates.length;i++){serviceMap[data.ExpectedDeliveryDates[i].CarrierServiceCode]=data.ExpectedDeliveryDates[i].Date;}
$scope.expectedDeliveryDateMap=serviceMap;});_addressChangeResetProcess();}]).controller('GiftRegModCtrl',['$scope','$modalInstance','orderlines','show','orderCart','giftRegistryService','$q','loggerService',function($scope,$modalInstance,orderlines,show,orderCart,giftRegistryService,$q,$loggerService){$scope.orderlines=orderlines;$scope.To="";$scope.From="";$scope.Message="";$scope.Registry="";$scope.isGiftMessageShow=show.isGiftMessageShow;$scope.isGiftRegistyShow=show.isGiftRegistyShow;$scope.isGiftBoxShow=show.isGiftBoxShow;$scope.isShowInvalidRegError=false;var primeSubLineObjArray=[];for(var i=0;i<$scope.orderlines.length;i++){var tempObj={};if($scope.orderlines[i]._PrimeLineNo){tempObj.PrimeLine=$scope.orderlines[i]._PrimeLineNo;if($scope.orderlines[i]._SubLineNo){tempObj.SubLine=$scope.orderlines[i]._SubLineNo;}
primeSubLineObjArray.push(tempObj);}}
var originalGiftMessageObj=orderCart.giftOptions.getGiftOptionFromOrderLines(primeSubLineObjArray);if(originalGiftMessageObj){$scope.To=angular.isDefined(originalGiftMessageObj.To)?originalGiftMessageObj.To:'';$scope.From=angular.isDefined(originalGiftMessageObj.From)?originalGiftMessageObj.From:'';$scope.Message=angular.isDefined(originalGiftMessageObj.Message)?originalGiftMessageObj.Message:'';$scope.Registry=angular.isDefined(originalGiftMessageObj.Registry)?originalGiftMessageObj.Registry:'';}
$scope.cancel=function(){$modalInstance.dismiss();};$scope.save=function(){var registryAddressAdded=null;var isRegistryChanged=false;if($scope.isGiftMessageShow){orderCart.giftOptions.setGiftMessage(primeSubLineObjArray,{To:$scope.To.trim().substring(0,30),From:$scope.From.trim().substring(0,40),Message:$scope.Message.trim().substring(0,130)});}
if($scope.isGiftBoxShow){$loggerService.log("GiftBox is not implemented");saveGiftBox();}
if(!$scope.isGiftRegistyShow){$modalInstance.close({'isRegistryChanged':isRegistryChanged,'registryAddressAdded':registryAddressAdded});}
if($scope.isGiftRegistyShow){saveRegistry(primeSubLineObjArray,$scope.Registry.trim()).then(function(response){$loggerService.log(response);if(response.invalidRegNo){$scope.isShowInvalidRegError=true;}else{$scope.isShowInvalidRegError=false;}
if(response.success){$modalInstance.close({'isRegistryChanged':true,'registryAddressAdded':response.regAddress});}});}};var saveRegistry=function(primeSubLineObjArray,registry){var success={success:false,regAddress:null,invalidRegNo:false};var tempAddress=null;if(registry){registry=registry.toString().trim();}
var deferred=$q.defer();if(registry){giftRegistryService.preferredAddressPromise(registry).success(function(data){if(data.PreferredAddressOutput.PreferredAddressResponse.IsValid==='true'&&data.PreferredAddressOutput.PreferredAddressResponse.HasErrors==='false'){try{tempAddress=giftRegistryService.constructRegistryAddress(registry,data.PreferredAddressOutput.PreferredAddressResponse);success={success:true,regAddress:tempAddress,invalidRegNo:false};orderCart.giftOptions.setGiftRegistry(primeSubLineObjArray,registry,tempAddress);}catch(error){alert('Gift Registry Error. Returned Registry Address is invalid.');$loggerService.log(error);success={success:false,regAddress:null,invalidRegNo:false};}}else{if(data.PreferredAddressOutput.PreferredAddressResponse.ErrorMessage==="No data exists for the row/column."){success={success:false,regAddress:null,invalidRegNo:true};}
else if(data.PreferredAddressOutput.PreferredAddressResponse.ErrorMessage==="Object reference not set to an instance of an object."){success={success:false,regAddress:null,invalidRegNo:false};$loggerService.log('Programmer Error.');$loggerService.log(data);}else{success={success:true,regAddress:null,invalidRegNo:false};$loggerService.log(data);orderCart.giftOptions.setGiftRegistry(primeSubLineObjArray,registry,tempAddress);}}
deferred.resolve(success);}).error(function(data){success={success:true,regAddress:null,invalidRegNo:false};$loggerService.log(data);orderCart.giftOptions.setGiftRegistry(primeSubLineObjArray,registry,tempAddress);deferred.resolve(success);});}else{success={success:true,regAddress:null,invalidRegNo:false};orderCart.giftOptions.setGiftRegistry(primeSubLineObjArray,registry,tempAddress);deferred.resolve(success);}
return deferred.promise;};var saveGiftBox=function(){};$scope.clear=function(){$scope.To="";$scope.From="";$scope.Message="";$scope.Registry="";};}]).controller('shipToModCtrl',['$scope','$modalInstance','orderlines','availableShippingAddresses','orderCart','$q','bigTicketValidate','appState','$state','customerContactID','loggerService',function($scope,$modalInstance,orderlines,availableShippingAddresses,orderCart,$q,bigTicketValidate,$appState,$state,customerContactID,$loggerService){$scope.addressKeyToRegistryMap={};var primeSubLineObjArray=[];var registryAddressFromOrderCart=orderCart.giftOptions.getRegistryAddressSet();$scope.isBigTicket=false;var myScroll;setTimeout(function(){myScroll=new IScroll('#ItemDetailWrapper',{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip'});},500);$scope.refreshIScroll=function(){setTimeout(function(){myScroll.refresh();},500);};for(var i=0;i<orderlines.length;i++){var tempObj={};if(orderlines[i]._PrimeLineNo){tempObj.PrimeLine=orderlines[i]._PrimeLineNo;if(orderlines[i]._SubLineNo){tempObj.SubLine=orderlines[i]._SubLineNo;}
primeSubLineObjArray.push(tempObj);}
if(orderlines[i].Extn._ExtnGiftRegistryNo&&(orderlines[i].Extn._ExtnGiftRegistryNo.toString().trim()!=="")){var tempRegNo=orderlines[i].Extn._ExtnGiftRegistryNo.toString().trim();if(angular.isDefined(registryAddressFromOrderCart[tempRegNo])){$scope.addressKeyToRegistryMap[registryAddressFromOrderCart[tempRegNo].PersonInfo._PersonInfoKey]=tempRegNo;}}
if(orderlines[i].btDisplay.itemtype=='BGT'){$scope.isBigTicket=true;}}
$scope.availableShippingAddresses={};var setAvailableShippingAddresses=function(){var tempAddressSet={};for(var addressKey in availableShippingAddresses){if(availableShippingAddresses[addressKey].btLogic&&availableShippingAddresses[addressKey].btLogic.isRegistryAddress){if(availableShippingAddresses[addressKey].PersonInfo._PersonInfoKey in $scope.addressKeyToRegistryMap){tempAddressSet[availableShippingAddresses[addressKey].PersonInfo._PersonInfoKey]=availableShippingAddresses[addressKey];}}else{tempAddressSet[availableShippingAddresses[addressKey].PersonInfo._PersonInfoKey]=availableShippingAddresses[addressKey];}}
if($scope.isBigTicket){var zipCodeSet={};for(var prop in tempAddressSet){var addressZip=tempAddressSet[prop].PersonInfo._ZipCode.toString();zipCodeSet[addressZip]='false';}
var promiseArr=[];var zipArr=Object.keys(zipCodeSet);for(var i=0;i<zipArr.length;i++){(function(){var zip=zipArr[i];promiseArr.push(bigTicketValidate.bigTicketPromise(zip).then(function(response){if(response.data.ValidateBigTicketZipCodeResp._statusMessage.toString()==='Success'){zipCodeSet[zip]=response.data.ValidateBigTicketZipCodeResp._isValid;}}));})();}
$q.all(promiseArr).then(function(){for(var prop in tempAddressSet){var checkzip=tempAddressSet[prop].PersonInfo._ZipCode.toString();if(zipCodeSet[checkzip]==='true'){$scope.availableShippingAddresses[tempAddressSet[prop].PersonInfo._PersonInfoKey]=tempAddressSet[prop];}}});}else{$scope.availableShippingAddresses=tempAddressSet;}};setAvailableShippingAddresses();$scope.saveAddress=function(address){var isGiftRegAddress=false;if(address.btLogic&&address.btLogic.isRegistryAddress){isGiftRegAddress=true;primeSubLineObjArray=[];for(var i=0;i<orderlines.length;i++){var tempObj={};$loggerService.log(orderlines[i]);$loggerService.log($scope.addressKeyToRegistryMap);if(orderlines[i].Extn._ExtnGiftRegistryNo===$scope.addressKeyToRegistryMap[address.PersonInfo._PersonInfoKey]){if(orderlines[i]._PrimeLineNo){tempObj.PrimeLine=orderlines[i]._PrimeLineNo;if(orderlines[i]._SubLineNo){tempObj.SubLine=orderlines[i]._SubLineNo;}
primeSubLineObjArray.push(tempObj);}}}}
if(address.btIsValid){delete address.btIsValid;orderCart.address.setOrderLineShipToAddresses(primeSubLineObjArray,address,isGiftRegAddress);$modalInstance.close();}else{swal({title:"Alert!",text:'Cannot set an invalid address.',showConfirmButton:true});$loggerService.log('Tried to set invalid address for ship to.');}};$scope.cancel=function(){$modalInstance.dismiss();};$scope.openEditAddress=function(address){if(!angular.isDefined(address)){address={_CustomerAdditionalAddressID:''};}
$appState.setAddressChange({previousStateName:'shippingSelection',customerKey:orderCart.customer.getCustomerKey(),setShipToOrderLinePrimeSubLineObjArray:primeSubLineObjArray});$state.go('addModifyAddress',{'customerContactID':customerContactID,'customerAdditionalAddressID':address._CustomerAdditionalAddressID});$modalInstance.dismiss();};}]).controller('billingAddressModCtrl',['$scope','$modalInstance','billingAddresses','orderCart','appState','$state','customerContactID','loggerService',function($scope,$modalInstance,billingAddresses,orderCart,$appState,$state,customerContactID,$loggerService){$scope.billingAddresses=billingAddresses;var myScroll;setTimeout(function(){myScroll=new IScroll('#ItemDetailWrapper',{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip'});},500);$scope.refreshIScroll=function(){setTimeout(function(){myScroll.refresh();},500);};$scope.saveAddress=function(address){if(address.btIsValid){delete address.btIsValid;orderCart.address.setBillingAddress(address);$modalInstance.close();}else{swal({title:"Alert!",text:'Cannot set an invalid address.',showConfirmButton:true});$loggerService.log('Tried to set invalid address for bill to.');}};$scope.openEditAddress=function(address){if(!angular.isDefined(address)){address={_CustomerAdditionalAddressID:''};}
$appState.setAddressChange({previousStateName:'shippingSelection',customerKey:orderCart.customer.getCustomerKey(),setBillTo:true});$state.go('addModifyAddress',{'customerContactID':customerContactID,'customerAdditionalAddressID':address._CustomerAdditionalAddressID});$modalInstance.dismiss();};$scope.cancel=function(){$modalInstance.dismiss();};}]).controller('taxExemptModCtrl',['$scope','$modalInstance','orderCart',function($scope,$modalInstance,orderCart){$scope.TaxExemptCertificate=orderCart.order.getTaxExemptionCertificate();$scope.save=function(){orderCart.order.setTaxExemptionCertificate($scope.TaxExemptCertificate);$modalInstance.close();};$scope.clear=function(){$scope.TaxExemptCertificate="";};$scope.cancel=function(){$modalInstance.dismiss();};}]).controller('shippingSpeedModCtrl',['$scope','$modalInstance','orderlines','orderCart',function($scope,$modalInstance,orderlines,orderCart){$scope.orderline=orderlines[0];$scope.saveService=function(carrierService){orderCart.carrierService.setOrderlineCarrierService(orderlines[0],carrierService);angular.forEach(orderlines,function(orderLine){orderLine=orderCart.order.deleteShippingDiscount(orderLine);});$modalInstance.close();};$scope.cancel=function(){$modalInstance.dismiss();};}]).controller('shippingSpeedMultiModCtrl',['$scope','$modalInstance','orderlines','expectedShipDatesMap','orderCart','$filter',function($scope,$modalInstance,orderlines,expectedShipDatesMap,orderCart,$filter){$scope.shippingSpeeds=[];var _merge=function(possibleCarrierServiceArr,secondCarrierServiceArr){var temp=[];for(var i=0;i<possibleCarrierServiceArr.length;i++){for(var p=0;p<secondCarrierServiceArr.length;p++){if(possibleCarrierServiceArr[i]._CarrierServiceCode===secondCarrierServiceArr[p]._CarrierServiceCode){if(parseFloat(possibleCarrierServiceArr[i]._Price)===parseFloat(secondCarrierServiceArr[p]._Price)){temp.push(possibleCarrierServiceArr[i]);}
else{possibleCarrierServiceArr[i]._Price="-1";temp.push(possibleCarrierServiceArr[i]);}
break;}}}
return temp;};var possibleCarrierService=[];if(orderlines.length==1){angular.copy(orderlines[0].CarrierServiceList.CarrierService,possibleCarrierService);}else if(orderlines.length>1){for(var i=0;i<orderlines[0].CarrierServiceList.CarrierService.length;i++){possibleCarrierService.push({_CarrierServiceCode:orderlines[0].CarrierServiceList.CarrierService[i]._CarrierServiceCode,_CarrierServiceDesc:orderlines[0].CarrierServiceList.CarrierService[i]._CarrierServiceDesc,_Currency:"USD",_Price:orderlines[0].CarrierServiceList.CarrierService[i]._Price});}
for(var i=1;i<orderlines.length;i++){possibleCarrierService=_merge(possibleCarrierService,orderlines[i].CarrierServiceList.CarrierService);}}
$scope.shippingSpeeds=$scope.shippingSpeeds.concat(possibleCarrierService);$scope.saveService=function(carrierService){if(carrierService._CarrierServiceDesc==="Lowest Cost Shipping"){for(var i=0;i<orderlines.length;i++){orderCart.carrierService.setOrderLineCarrierServiceToLowestPrice(orderlines[i]);}}else if(carrierService._CarrierServiceDesc==="Fastest Shipping"){for(var i=0;i<orderlines.length;i++){var currentOrderline=orderlines[i];if(angular.isDefined(currentOrderline.CarrierServiceList)&&angular.isArray(currentOrderline.CarrierServiceList.CarrierService)&&currentOrderline.CarrierServiceList.CarrierService.length>0){var bestService=currentOrderline.CarrierServiceList.CarrierService[0];for(var p=1;p<currentOrderline.CarrierServiceList.CarrierService.length;p++){if(expectedShipDatesMap[bestService._CarrierServiceCode]>expectedShipDatesMap[currentOrderline.CarrierServiceList.CarrierService[p]._CarrierServiceCode]){bestService=currentOrderline.CarrierServiceList.CarrierService[p];}else if(expectedShipDatesMap[bestService._CarrierServiceCode]===expectedShipDatesMap[currentOrderline.CarrierServiceList.CarrierService[p]._CarrierServiceCode]){if(parseFloat(bestService._Price)>=parseFloat(currentOrderline.CarrierServiceList.CarrierService[p]._Price)){bestService=currentOrderline.CarrierServiceList.CarrierService[p];}}}
orderCart.carrierService.setOrderlineCarrierService(currentOrderline,bestService);}}}else{for(var i=0;i<orderlines.length;i++){var currentOrderline=orderlines[i];if(angular.isDefined(currentOrderline.CarrierServiceList)&&angular.isArray(currentOrderline.CarrierServiceList.CarrierService)&&currentOrderline.CarrierServiceList.CarrierService.length>0){for(var p=0;p<currentOrderline.CarrierServiceList.CarrierService.length;p++){if(currentOrderline.CarrierServiceList.CarrierService[p]._CarrierServiceCode===carrierService._CarrierServiceCode){orderCart.carrierService.setOrderlineCarrierService(currentOrderline,currentOrderline.CarrierServiceList.CarrierService[p]);break;}}}}}
$modalInstance.close();};$scope.priceText=function(carrierService){if(carrierService._Price.toString().trim().length>0){if(parseFloat(carrierService._Price)===-1){return'Various Orderline Shipping Prices';}else{return $filter('currency')(carrierService._Price);}}else{return'';}};$scope.cancel=function(){$modalInstance.dismiss();};}]);
﻿
angular.module('paymentsummary',['ui.bootstrap','ui.router']).controller('paymentSummaryCtrl',['$scope','$location','$modal','$state','customer','$rootScope','orderCart','order','payment','repriceService','numberKeyPressValidator','currencyKeyPressValidator','msrService','loggerService','serviceArrayFix','alertMessages','POSService','$q','sendSMTPErrorEmail','$timeout','securityService','$filter','btProp',function($scope,$location,$modal,$state,$customer,$rootScope,$orderCart,$order,$payment,$repriceService,$numberKeyPressValidator,$currencyKeyPressValidator,$msrService,$loggerService,$serviceArrayFix,$alertMessages,POSService,$q,$sendSMTPErrorEmail,$timeout,$securityService,$filter,$btProp){$scope.cart=$orderCart.order.getLiveOrderCart();$scope.orderLinesArray=$scope.cart.OrderLines.OrderLine;$scope.numberValidator=$numberKeyPressValidator;$scope.currencyValidator=$currencyKeyPressValidator;$scope.txtCouponFromPayment="";var isUseCsrInContactPayments=$btProp.getProp("isUseCsrInContactPayments")===null?true:$btProp.getProp("isUseCsrInContactPayments");$scope.showCsrPayments=function(){return isUseCsrInContactPayments&&$securityService.isCsr();};$scope.priceChangeArr=[];angular.forEach($scope.orderLinesArray,function(orderLine){$scope.priceChangeArr.push(false);});var myScroll=new IScroll('#paymentOrderCartWrapper',{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip'});$scope.refreshIScroll=function(){setTimeout(function(){myScroll.refresh();},500);};$orderCart.address.validateOrderAddresses().then(function(data){var headerErrors=$orderCart.order.validateOrderHeader();if(data.defaultBillingAddressError.hasError||data.defaultShipToAddressError.hasError||data.carrierServiceCodeError.hasError||data.bigTicketError.hasError||data.orderlineShiptoAddressError.hasError||headerErrors.customerEmailIdError.hasError){$state.go('shippingSelection');}},function(data){$loggerService.log(data);$state.go('shippingSelection');});var cachedPaymentData=$payment.getPaymentData();if(cachedPaymentData){$scope.paymentData=cachedPaymentData;$scope.cart.Extn._ExtnAccID=$scope.paymentData.accNumber?$scope.paymentData.accNumber:'';}else{$scope.paymentData={};$scope.paymentData.cards=[];$scope.paymentData.inContactPaymentId=null;}
$scope.addCoupon=function(CouponID){$scope.txtCouponFromPayment="";if($scope.cart.Promotions.Promotion!=undefined){var i=$scope.cart.Promotions.Promotion.length;$scope.cart.Promotions.Promotion[i]={_PromotionId:CouponID,_PromotionType:"PROMO",}}else{$scope.cart.Promotions={Promotion:[{_PromotionId:CouponID,_PromotionType:"PROMO",}]}}
$repriceService.reprice($scope.cart).then(function(response){$scope.cart=response.data;$scope.orderLinesArray=$scope.cart.OrderLines.OrderLine;$orderCart.order.setOrderCart($scope.cart);$loggerService.log(response.data);if($scope.cart.Promotions.Promotion!=undefined){var i=($scope.cart.Promotions.Promotion.length-1);if($scope.cart.Promotions.Promotion[i]._PromotionApplied=="Y"){$scope.description=$scope.cart.Promotions.Promotion[i]._Description;}else{$scope.description=$scope.cart.Promotions.Promotion[i]._DenialReason;}
swal({title:"Coupon",text:$scope.description,timer:3000,showConfirmButton:false});}})}
var _registerCouponHandler=function(){return $rootScope.$on('Scanner_Event',function(event,data){if(data&&paymentSummaryScreen){$scope.txtCouponFromPayment=data;$scope.addCoupon($scope.txtCouponFromPayment);}
if($scope.cart.Promotions.Promotion!=undefined){var i=($scope.cart.Promotions.Promotion.length-1);if($scope.cart.Promotions.Promotion[i]._PromotionApplied=="Y"){$scope.description=$scope.cart.Promotions.Promotion[i]._Description;}else{$scope.description=$scope.cart.Promotions.Promotion[i]._DenialReason;}
swal({title:"Coupon",text:$scope.description,timer:3000,showConfirmButton:false});}});};var paymentSummaryScreen=true;var deregister=_registerCouponHandler();$scope.$on("$destroy",function(){if($orderCart.btLogic&&$orderCart.btLogic.cartTimeStamp==$scope.cart.btLogic.cartTimeStamp){$orderCart.order.setOrderCart($scope.cart);}
deregister();});function cardExists(card){for(var i=0;i<$scope.paymentData.cards.length;i++){var temp=$scope.paymentData.cards[i];if(Number(temp.token)==Number(card.token)){temp.selected=true;return true;}}
return false;}
$scope.numberOfGiftCards=function(){var count=0;$scope.paymentData.cards.forEach(function(card){if(card.cardType=='GIFTCARD'){count++;}});return count;}
$scope.numberOfCreditCards=function(){var count=0;$scope.paymentData.cards.forEach(function(card){if(card.cardType!='GIFTCARD'){count++;}});return count;}
$scope.$watchCollection('cart',function(){$scope.calculateBalanceRefunds();});$scope.numberOfCards=function(){return $scope.paymentData.cards.length;}
$scope.$watchCollection('paymentData.cards',function(){$payment.setPaymentData($scope.paymentData);reprice().then(function(){$scope.calculateBalanceRefunds();});});$scope.balanceRefund=0;$scope.calculateBalanceRefunds=function(){var totalTimeHundred=Math.round(Number($scope.orderTotal())*100);$scope.paymentData.cards.forEach(function(card){card.chargeAmount=0;})
for(var i=0;i<$scope.paymentData.cards.length;i++){var card=$scope.paymentData.cards[i];if(card.cardType=='GIFTCARD'){if(card.gcBalance===null||!isFinite(card.gcBalance))
{continue;}
var curCardBalanceTimesHundred=Math.round(Number(card.gcBalance)*100);if(curCardBalanceTimesHundred>=totalTimeHundred){card.chargeAmount=totalTimeHundred/100;card.chargeAmount=card.chargeAmount+"";totalTimeHundred=0;}else{card.chargeAmount=""+card.gcBalance;totalTimeHundred=totalTimeHundred-curCardBalanceTimesHundred;}}}
if(totalTimeHundred>0){for(var i=0;i<$scope.paymentData.cards.length;i++){var card=$scope.paymentData.cards[i];if(card.cardType!='GIFTCARD'){card.chargeAmount=totalTimeHundred/100;card.chargeAmount=card.chargeAmount+"";totalTimeHundred=0;}}}
$scope.balanceRefund=totalTimeHundred<0?0:totalTimeHundred/100;}
function reprice(index){var defer=$q.defer();delete $scope.cart.PaymentMethods;$scope.cart.PaymentMethods={PaymentMethod:$payment.createRepricePaymentContract($scope.paymentData.cards)};$repriceService.reprice($scope.cart).then(function(response){$scope.cart=response.data;$scope.orderLinesArray=$scope.cart.OrderLines.OrderLine;$orderCart.order.setOrderCart($scope.cart);$loggerService.log(response);if($scope.cart.Errors&&$scope.cart.Errors.ErrorList&&$scope.cart.Errors.ErrorList.Error&&$scope.cart.Errors.ErrorList.Error.length>0){if($scope.cart.Errors.ErrorList.Error[0]._ErrorCode!='00'){var errorCode=$scope.cart.Errors.ErrorList.Error[0]._ErrorCode;var errDescription=$scope.cart.Errors.ErrorList.Error[0]._ErrorDescription;if((angular.equals(errorCode,'99')&&errDescription.indexOf("THE MAXIMUM PRICE OVERRIDE FOR A")>-1)){if($scope.orderLinesArray.length>index){$scope.orderLinesArray[index].Extn._ExtnIsPriceLocked='N';$scope.orderLinesArray[index].LinePriceInfo._UnitPrice="0.00";$scope.orderLinesArray[index].LinePriceInfo._ChargeAmount="0.00";$scope.priceChangeArr[index]=false;reprice();}}
swal({title:"Alert!",text:errDescription,showConfirmButton:true});}}
defer.resolve();},function(response){$loggerService.log(response);swal({title:"Alert!",text:$alertMessages.paymentMessages.REPRICE_ERROR,showConfirmButton:true});defer.resolve();});return defer.promise;}
$scope.priceModified=function(index,setNotModified){if(setNotModified){$scope.priceChangeArr[index]=false;}else{$scope.priceChangeArr[index]=true;}};$scope.priceOverride=function(orderLine,index){var itemType=orderLine.ItemDetails.PrimaryInformation._ItemType
if(Number($scope.priceChangeArr[index])<0){swal({title:"Alert!",text:$alertMessages.paymentMessages.NEGATIVE_AMOUNT_NOT_ALLOWED,showConfirmButton:true});}else{if(orderLine.Extn._ExtnIsPriceLocked=='N'){orderLine.Extn._ExtnIsPriceLocked='Y';}else{orderLine.Extn._ExtnIsPriceLocked='N';$scope.priceChangeArr[index]=false;};angular.forEach($scope.cart.OrderLines.OrderLine,function(orderLine){orderLine=$orderCart.order.deleteShippingDiscount(orderLine);});if(orderLine.LinePriceInfo._UnitPrice==""){orderLine.LinePriceInfo._UnitPrice="0.00";}
reprice(index);}}
var _priceRegEx=/^(\d+\.{0,1}|\.)\d{0,2}$/;$scope.onBlurCheckOverrideValue=function(orderLine,index){if(angular.isObject(orderLine)&&angular.isObject(orderLine.LinePriceInfo)){var stringPrice=angular.isString(orderLine.LinePriceInfo._UnitPrice)?orderLine.LinePriceInfo._UnitPrice.trim():"";if(!_priceRegEx.test(stringPrice)){if(angular.isObject(orderLine.btDisplay)&&angular.isObject(orderLine.btDisplay.itemDetail)&&angular.isObject(orderLine.btDisplay.itemDetail.ComputedPrice)&&angular.isString(orderLine.btDisplay.itemDetail.ComputedPrice._UnitPrice)&&_priceRegEx.test(orderLine.btDisplay.itemDetail.ComputedPrice._UnitPrice))
{var _pretty=$filter('currency')(orderLine.btDisplay.itemDetail.ComputedPrice._UnitPrice.trim(),"");orderLine.LinePriceInfo._UnitPrice=_pretty.replace(/,/g,'');$scope.priceModified(index,true);}else{orderLine.LinePriceInfo._UnitPrice="0.00";}}}};function addCard(card){if((card.cardType!='GIFTCARD')&&$scope.numberOfCreditCards()>0){swal({title:"Alert!",text:$alertMessages.paymentMessages.MAX_ALLOWED_CC,showConfirmButton:true});return;}
if(card.cardType=='GIFTCARD'&&$scope.numberOfGiftCards()==4){swal({title:"Alert!",text:$alertMessages.paymentMessages.MAX_GC,showConfirmButton:true});return;}
if($scope.paymentData.accNumber&&card.cardType!='GIFTCARD'){swal({title:"Alert!",text:$alertMessages.paymentMessages.CC_NOT_ALLOWED_WITH_ADC,showConfirmButton:true});return;}
if(!cardExists(card)){$scope.paymentData.cards.push(card);}}
$scope.calculateLineTotal=function(orderLine){return $order.calculateOrderLineTotal(orderLine);}
$scope.orderTotal=function(){return $scope.cart._OrderTotal;}
$scope.taxTotal=function(){return $order.calculateTaxTotal($scope.cart);}
$scope.shippingTotal=function(){return $order.calculateShippingTotal($scope.cart)}
$scope.orderSubTotal=function(){return $order.calculateOrderSubTotal($scope.cart);};$scope.merchandiseTotal=function(){return $order.calculateMerchandiseTotal($scope.cart);};$scope.couponDiscountTotal=function(){return $order.calculateCouponDiscountTotal($scope.cart);};$scope.misChargesTotal=function(){return $order.calculateMisChargesTotal($scope.cart);};$scope.assocDiscTotal=function(){return $order.calculateAssocDiscTotal($scope.cart);};$scope.lineTotal=function(orderline){return $order.lineTotal(orderline);};$scope.isPriceOverideOccuring=function(){for(var i=0;i<$scope.priceChangeArr.length;i++){if($scope.priceChangeArr[i]&&(!angular.isDefined($scope.cart.OrderLines.OrderLine[i].Extn)||!angular.isDefined($scope.cart.OrderLines.OrderLine[i].Extn._ExtnIsPriceLocked)||$scope.cart.OrderLines.OrderLine[i].Extn._ExtnIsPriceLocked=='N')){return true;}}
return false;};$scope.confirmOrder=function(){if($scope.numberOfGiftCards()>0){if($orderCart.order.hasBigTicketItems($scope.cart)){swal({title:"Big Ticket Error",text:'Orders with Big Ticket items cannot be paid with gift cards.  Please remove all gift cards from the order.',showConfirmButton:true});return;}}
if($scope.cart._OrderTotal>0){var totalUnitPrice=0;angular.forEach($scope.cart.OrderLines.OrderLine,function(orderLine){var unitPrice=parseFloat(orderLine.LinePriceInfo._UnitPrice);if(isFinite(unitPrice)){totalUnitPrice=totalUnitPrice+unitPrice;}});if(totalUnitPrice==0.00){swal({title:"Error!",text:"Total Unit Price cannot be zero",showConfirmButton:true});return false;}
if(totalUnitPrice<0){swal({title:"Error!",text:"Total Unit Price cannot less than zero",showConfirmButton:true});return false;}
var orderNumber="";$orderCart.order.getOrderNumber().then(function(orderNo){$scope.cart._OrderNo=orderNo;$payment.authRequest($scope.cart,$scope.paymentData.cards).then(function(){_asyncOrderCreate();});},function(){swal({title:"Order Number Error",text:'Could not retrieve an Order Number.  Please try again.',showConfirmButton:true});});}
else{swal({title:"Error!",text:"Line total cannot be zero",showConfirmButton:true});return false;}};var _asyncOrderCreate=function(){delete $scope.cart._OrderDate;$order.createOrder($scope.cart,function(response){var selectedOrder={};selectedOrder._OrderNo=response._OrderNumber;$order.setSelectedOrder(selectedOrder);$orderCart.order.deleteCart();$orderCart.customer.deleteCustomer();$customer.clearSelectedCustomer();$payment.clearPreviousAuthCache();$payment.clearPaymentData();$rootScope.$broadcast('uiBreadcrumbDisplay',{display:true,defer:true,orderCompleteReset:true});$rootScope.$broadcast('uiCheckoutStepProgressDisplay',{display:false,defer:true});$location.path("/orderDetail");},function(error){var errorAsString=angular.toJson(error);if((/Order total can not be negative/i).test(errorAsString)){swal({title:"Order Create Error",text:'Order total can not be negative',showConfirmButton:true});}else if((/javax.jms.JMSException/i).test(errorAsString)){swal({title:"Order Create Error",text:'Java JMS error. If there are not giftcards as payment. Please retry order confirmation.',showConfirmButton:true});}else{var errorText='';if(angular.isString(error)){errorText=error;}else{errorText=angular.toJson(error);}
swal({title:"Order Create Error",text:errorText,showConfirmButton:true});}
$loggerService.log(error);});};$scope.openOrderPricingDetail=function(){var modalInstance=$modal.open({templateUrl:'html/order/orderPricingDetail.html',controller:'orderPricingDetailCtrl',resolve:{cart:function(){return $scope.cart;}}});modalInstance.result.then(function(result){var newShippingDiscount=result.newShippingDiscount;var cart=result.cart;var previousOrderShippingTotal=cart._ShippingChrgTotal-cart._ShippingDiscTotal;var newActualShippingDiscount=0;if(newShippingDiscount&&(newShippingDiscount>0)&&(previousOrderShippingTotal>0)){angular.forEach(cart.OrderLines.OrderLine,function(orderLine){var lineShippingTotal=0;var shippingCharge=0;angular.forEach(orderLine.LineCharges.LineCharge,function(lineCharge){if(lineCharge._ChargeCategory==='BTN_SHIP_CHRG'){lineShippingTotal+=parseFloat(lineCharge._ChargeAmount);shippingCharge=parseFloat(lineCharge._ChargeAmount);}else if(lineCharge._ChargeCategory==='BTN_SHIP_DISC'){lineShippingTotal-=parseFloat(lineCharge._ChargeAmount);}});var lineProportionOfTotal=lineShippingTotal/previousOrderShippingTotal;var amountToCharge=(((cart._ShippingChrgTotal-newShippingDiscount)*lineProportionOfTotal/orderLine._OrderedQty).toFixed(2)*orderLine._OrderedQty).toFixed(2);var hasShippingDiscount=false;angular.forEach(orderLine.LineCharges.LineCharge,function(charge){if(charge._ChargeCategory==='BTN_SHIP_DISC'){hasShippingDiscount=true;charge._ChargePerUnit=((shippingCharge-amountToCharge)/orderLine._OrderedQty).toFixed(2);charge._ChargeAmount=charge._ChargePerUnit*orderLine._OrderedQty;newActualShippingDiscount+=charge._ChargeAmount;}});if(!hasShippingDiscount){orderLine.LineCharges.LineCharge.push({_ChargeAmount:shippingCharge-amountToCharge,_ChargeCategory:"BTN_SHIP_DISC",_ChargeName:"DISC_SHIPPING",_ChargePerLine:"0.00",_ChargePerUnit:((shippingCharge-amountToCharge)/orderLine._OrderedQty).toFixed(2),_IsDiscount:"Y",_IsManual:"Y",_Reference:""});newActualShippingDiscount+=shippingCharge-amountToCharge;}});var remainingShippingCostToDistribute=(newShippingDiscount-newActualShippingDiscount).toFixed(2);if(remainingShippingCostToDistribute!==0){angular.forEach(cart.OrderLines.OrderLine,function(orderLine){if((orderLine._OrderedQty*.01).toFixed(2)==remainingShippingCostToDistribute){angular.forEach(orderLine.LineCharges.LineCharge,function(charge){if(charge._ChargeCategory==='BTN_SHIP_DISC'){if(remainingShippingCostToDistribute>0){var amountToAdd=.01*orderLine._OrderedQty;charge._ChargeAmount=(parseFloat(charge._ChargeAmount)+amountToAdd).toFixed(2);charge._ChargePerUnit=(parseFloat(charge._ChargePerUnit)+.01).toFixed(2);remainingShippingCostToDistribute-=amountToAdd;}else{var amountToSubtract=.01*orderLine._OrderedQty;charge._ChargeAmount=(parseFloat(charge._ChargeAmount)-amountToSubtract).toFixed(2);charge._ChargePerUnit=(parseFloat(charge._ChargePerUnit)-.01).toFixed(2);remainingShippingCostToDistribute+=amountToSubtract;}}});}});}
if(remainingShippingCostToDistribute>0){angular.forEach(cart.OrderLines.OrderLine,function(orderLine){var orderLineShippingTotal=0;var orderLineShippingCharge=0;angular.forEach(orderLine.LineCharges.LineCharge,function(lineCharge){if(lineCharge._ChargeCategory==='BTN_SHIP_CHRG'){orderLineShippingTotal+=parseFloat(lineCharge._ChargeAmount);orderLineShippingCharge=parseFloat(lineCharge._ChargeAmount);}else if(lineCharge._ChargeCategory==='BTN_SHIP_DISC'){orderLineShippingTotal-=parseFloat(lineCharge._ChargeAmount);}});if(remainingShippingCostToDistribute>0&&orderLineShippingTotal>remainingShippingCostToDistribute){angular.forEach(orderLine.LineCharges.LineCharge,function(charge){if(charge._ChargeCategory==='BTN_SHIP_DISC'){if(remainingShippingCostToDistribute==0||orderLine._ChargeAmount==0){}else if(remainingShippingCostToDistribute<(orderLine._OrderedQty*.01).toFixed(2)){var amountToAdd=.01*orderLine._OrderedQty;charge._ChargeAmount=(parseFloat(charge._ChargeAmount)+amountToAdd).toFixed(2);charge._ChargePerUnit=(parseFloat(charge._ChargePerUnit)+.01).toFixed(2);remainingShippingCostToDistribute-=amountToAdd;}else{var perUnitAmountToAdd=parseFloat(charge._ChargePerUnit)+(remainingShippingCostToDistribute/orderLine._OrderedQty).toFixed(2)*orderLine._OrderedQty;charge._ChargePerUnit=perUnitAmountToAdd;charge._ChargeAmount=charge._ChargePerUnit*orderLine._OrderedQty;remainingShippingCostToDistribute-=charge._ChargeAmount;}}});}else{angular.forEach(orderLine.LineCharges.LineCharge,function(charge){if(charge._ChargeCategory==='BTN_SHIP_DISC'){var previousChargeAmount=charge._ChargeAmount;charge._ChargePerUnit=(orderLineShippingCharge/orderLine._OrderedQty).toFixed(2);charge._ChargeAmount=charge._ChargePerUnit*orderLine._OrderedQty;remainingShippingCostToDistribute=remainingShippingCostToDistribute+previousChargeAmount-charge._ChargeAmount;}});}});}
$repriceService.reprice(cart).then(function(response){$scope.cart=response.data;$scope.orderLinesArray=$scope.cart.OrderLines.OrderLine;$orderCart.order.setOrderCart(cart);$loggerService.log(response.data);});}},function(){});};$scope.openOrderLinePricingDetail=function(orderLine){var modalInstance=$modal.open({templateUrl:'html/order/orderLineAdditionalDetails.html',controller:'orderLinePricingDetailCtrl',resolve:{orderLine:function(){return orderLine;}}});modalInstance.result.then(function(additionalDiscount){if(additionalDiscount&&additionalDiscount>0){var hasShippingDiscount=false;angular.forEach(orderLine.LineCharges.LineCharge,function(charge){if(charge._ChargeCategory==='BTN_SHIP_DISC'){var newShippingDiscount=parseFloat(charge._ChargeAmount)+parseFloat(additionalDiscount);hasShippingDiscount=true;charge._ChargePerUnit=(newShippingDiscount/orderLine._OrderedQty).toFixed(2);charge._ChargeAmount=(charge._ChargePerUnit*orderLine._OrderedQty).toFixed(2);}});if(!hasShippingDiscount){orderLine.LineCharges.LineCharge.push({_ChargeAmount:(additionalDiscount/orderLine._OrderedQty).toFixed(2)*orderLine._OrderedQty,_ChargeCategory:"BTN_SHIP_DISC",_ChargeName:"DISC_SHIPPING",_ChargePerLine:"0.00",_ChargePerUnit:(additionalDiscount/orderLine._OrderedQty).toFixed(2),_IsDiscount:"Y",_IsManual:"Y",_Reference:""});}}
$repriceService.reprice($scope.cart).then(function(response){$scope.cart=response.data;$scope.orderLinesArray=$scope.cart.OrderLines.OrderLine;$orderCart.order.setOrderCart($scope.cart);$loggerService.log(response.data);});},function(){});};var isRetalixReady=null;var retalixStatusPolling=0;POSService.getPmmConfigAndStatus().then(function(data){isRetalixReady=(/^true$/i).test(data.UseEPS)?true:false;},function(data){isRetalixReady=false;});$scope.openPaymentEntry=function(){deregister()
paymentSummaryScreen=false;var modalInstance=undefined;if($securityService.isCsr())
{isRetalixReady=$scope.showCsrPayments();}
if(isRetalixReady===null){retalixStatusPolling=retalixStatusPolling+1;if(retalixStatusPolling<5){$timeout($scope.openPaymentEntry,200);}else{isRetalixReady=false;$scope.openPaymentEntry();}}
else{if(isRetalixReady){modalInstance=$modal.open({templateUrl:'html/payment/paymentEntryRetalix.html',controller:'paymentEntryRetalixCtrl',backdrop:'static',resolve:{billTo:function(){return $scope.cart.PersonInfoBillTo;},paymentData:function(){return $scope.paymentData;},orderLine:function(){return $scope.orderLinesArray;}}});}else{modalInstance=$modal.open({templateUrl:'html/payment/paymentEntry.html',backdrop:'static',controller:'paymentEntryCtrl',resolve:{billTo:function(){return $scope.cart.PersonInfoBillTo;},paymentData:function(){return $scope.paymentData;},orderLine:function(){return $scope.orderLinesArray;}}});}
modalInstance.result.then(function(card){deregister=_registerCouponHandler();addCard(card);paymentSummaryScreen=true;},function(){deregister=_registerCouponHandler();});}};$scope.openInContactPaymentEntry=function(){deregister()
paymentSummaryScreen=false;var modalInstance=$modal.open({templateUrl:'html/payment/inContactPaymentEntry.html',backdrop:'static',controller:'InContactPaymentEntryCtrl',resolve:{billTo:function(){return $scope.cart.PersonInfoBillTo;},paymentData:function(){return $scope.paymentData;}}});modalInstance.result.then(function(card){deregister=_registerCouponHandler();if(card&&angular.isString(card.inContactPaymentId)&&card.inContactPaymentId.length>0){$scope.paymentData.inContactPaymentId=card.inContactPaymentId;}
addCard(card);paymentSummaryScreen=true;},function(inContactId){if(inContactId&&angular.isString(inContactId.inContactPaymentId)&&inContactId.inContactPaymentId.length>0){$scope.paymentData.inContactPaymentId=inContactId.inContactPaymentId;}
deregister=_registerCouponHandler();});};var saveACCtoCart=function(accNumber){$scope.paymentData.accNumber=accNumber.toString();$scope.cart.Extn._ExtnAccID=accNumber.toString();reprice();}
$scope.openACCEntry=function(){if($scope.numberOfCreditCards()>0){swal({title:"Alert!",text:$alertMessages.paymentMessages.ADC_NOT_ALLOWED_WITH_CC,showConfirmButton:true});return;}
if($scope.paymentData.accNumber){$scope.paymentData.accNumber=undefined;delete $scope.cart.Extn._ExtnAccID;reprice();return;}
var modalInstance=$modal.open({templateUrl:'html/payment/accEntry.html',controller:'accEntryCtrl'});modalInstance.result.then(function(accNumber){saveACCtoCart(accNumber);},function(){});};$scope.removePayment=function(card){var index=$scope.paymentData.cards.indexOf(card);if(index!=-1){swal({title:"Remove Payment",text:"Do you want to remove this payment?",type:"warning",showCancelButton:true,confirmButtonColor:"#DD6B55",confirmButtonText:"Yes",closeOnConfirm:false},function(isConfirm){swal.close();if(isConfirm){$scope.$apply(function(){if(card.cardType!='GIFTCARD'){$scope.paymentData.inContactPaymentId=null;}
$scope.paymentData.cards.splice(index,1);});}});}};$scope.showOverrideButton=function(orderLine,index){return $scope.priceChangeArr[index]||orderLine.Extn._ExtnIsPriceLocked=='Y';};$scope.canAddPayment=function(){return $payment.getAvailablePaymentTypes($scope.paymentData).length>0;};$scope.canAddGiftcardPayment=function(){return!$orderCart.order.hasBigTicketItems($scope.cart)&&$payment.canAddGiftcard($scope.paymentData);};$scope.canAddCreditCardOrPlccPayment=function(){return $payment.canAddCreditCardOrPlcc($scope.paymentData);};reprice();if($msrService.accCard&&$msrService.accCard.cardType=='AssociateDiscountCard'){if($msrService.accCard.msrData.AccountNumber){if($scope.numberOfCreditCards()>0){swal({title:"Alert!",text:$alertMessages.paymentMessages.ADC_NOT_ALLOWED_WITH_CC,showConfirmButton:true});}else{saveACCtoCart($msrService.accCard.msrData.AccountNumber);}
$msrService.accCard=undefined;}}
if($msrService.lastCard&&$msrService.lastCard!='AssociateDiscountCard'){$scope.openPaymentEntry();}}]).controller('paymentEntryCtrl',['$scope','$modalInstance','$modal','payment','billTo','paymentData','numberKeyPressValidator','msrService','$rootScope','loggerService','alertMessages','$window','$timeout','POSService','$http','orderLine','securityService',function($scope,$modalInstance,$modal,$payment,billTo,paymentData,$numberKeyPressValidator,$msrService,$rootScope,$loggerService,$alertMessages,$window,$timeout,$POSService,$http,orderLine,$securityService)
{$scope.isExpError=false;$scope.isCsr=$securityService.isCsr();$scope.giftCardRemoved=false;var NubridgeTokenFlag='T';$scope.paymentTypes=$payment.getAvailablePaymentTypes(paymentData);checkForBigTicket();$scope.cardTypes=$payment.cardTypes;var msrEvent=$rootScope.$on('MSR_Event',function(event,msrData){setCCData(msrData);});var msrErrorEvent=$rootScope.$on('MSR_Event_Error',function(event,msrData){if((/^(MSR_ERR_ENABLE|MSR_ERR_TOKEN|MSR_ERR_STAND_IN)$/i).test(msrData.StatusCode)){$scope.$apply(function(){$scope.resetPaymentToBlank();});swal({title:$alertMessages.paymentMessages.BANK_CARD_SYSTEM_OFFLINE_TITLE,text:$alertMessages.paymentMessages.BANK_CARD_SYSTEM_OFFLINE_MESSAGE,showConfirmButton:true});}else if((/^MSR_ERR_DECLINE$/i).test(msrData.StatusCode)||(/.*ResponseCode_DeclineHard.*/i).test(msrData.StatusText)){$scope.$apply(function(){$scope.resetPaymentToBlank();});swal({title:"Card Error",text:msrData.StatusText,showConfirmButton:true});}else if((/^MSR_ERR_NOT_ENABLED$/i).test(msrData.StatusCode)||(/MSR is not enabled/i).test(msrData.StatusText)){}else if((/^(MSR_ERR_NOT_REQUESTED|MSR_ERR_INVALID_TYPE)$/i).test(msrData.StatusCode)||(/Card swiped does not match requested tender type/i).test(msrData.StatusText)){$scope.$apply(function(){$scope.swipeCard()});swal({title:"Card Error",text:$alertMessages.paymentMessages.INVALID_CARD_TYPE,showConfirmButton:true});}else if((/^MSR_ERR_UNKNOWN_TYPE$/i).test(msrData.StatusCode)){$scope.$apply(function(){$scope.swipeCard()});swal({title:"Card Error",text:$alertMessages.paymentMessages.UNKNOWN_CARD_TYPE,showConfirmButton:true});}
else{swal({title:"MSR Error",text:msrData.StatusText,showConfirmButton:true});$scope.$apply(function(){$scope.close()});}});$scope.$on("$destroy",function(){msrEvent();msrErrorEvent();deregister();tempPLCCErrorEventDeregister();});$scope.paymentTypeChange=function(){var paymentType=$scope.ccData.paymentType;$scope.ccData={};$scope.ccData.paymentType=paymentType;$scope.ccDisabled=false;$timeout(function(){var element=$window.document.getElementById('cardNumInput');if(element){element.focus();}});};var clearFields=function(){$scope.paymentTypeChange();}
function checkForBigTicket()
{for(var i=0;i<orderLine.length;i++){if(orderLine[i].btDisplay.itemtype=="BGT"){for(var index=0;index<$scope.paymentTypes.length;index++)
{if($scope.paymentTypes[index].contractType==='GIFTCARD')
{$scope.paymentTypes.splice(index,1);break;}}
$scope.giftCardRemoved=true;break;}}}
function setCCData(msrData){$scope.ccData.cardNumber=msrData.AccountNumber;if(msrData.CardType=='PLCC'){$scope.ccData.paymentType=$payment.paymentTypes.PLCC;}
if(msrData.FirstName&&msrData.FirstName.trim().length>0){$scope.ccData.FirstName=msrData.FirstName.trim();}
if(msrData.LastName&&msrData.LastName.trim().length>0){$scope.ccData.LastName=msrData.LastName.trim();}
var firstName=$scope.ccData.FirstName?$scope.ccData.FirstName:'';var lastName=$scope.ccData.LastName?$scope.ccData.LastName:'';$scope.ccData.name=firstName+' '+lastName;if(msrData.ExpirationDate){$scope.ccData.exp=msrData.ExpirationDate;}
$scope.ccData.swipped=true;$scope.tokenize();$scope.swipping=false;}
var deregister=$rootScope.$on('Scanner_Event',function(event,barcodeData,scannerMessage){if(scannerMessage.BarcodeType==3)
{if(!$scope.giftCardRemoved)
{$scope.ccData.paymentType=$payment.paymentTypes.GIFTCARD;$scope.ccData.cardNumber=barcodeData;$scope.ccData.scanned=true;$scope.tokenize();}}else if(scannerMessage.BarcodeType==17||scannerMessage.BarcodeType==6){if(barcodeData&&barcodeData.trim().length>0){var url=serviceURL+'/CreditService/Lookup';var findCustomerObj={"LookupRequest":{"_AccountNumber":barcodeData,"_OriginStoreNum":$POSService.getPOSParameters().storeNumber,"_SourceApplication":"Sterling","_IsTokenized":"N"}};$http.post(url,findCustomerObj).success(function(result){setCCData({CardType:$payment.paymentTypes.PLCC.msrType,AccountNumber:barcodeData,FirstName:result.LookupResponse._FirstName,LastName:result.LookupResponse._LastName});}).error(function(data){$loggerService.error(data);});}else{swal({title:"Bad PLCC Scan",text:$alertMessages.paymentMessages.SCAN_ERROR,showConfirmButton:true});}}else{swal({title:"Card Error",text:$alertMessages.paymentMessages.INVALID_CARD_TYPE,showConfirmButton:true});}});var tempPLCCErrorEventDeregister=$rootScope.$on('Scanner_Event_Error_Temp_PLCC_Error',function(event,scannerMessage){if((/^SCN_ERR_INVALID_BARCODE$/i).test(scannerMessage.StatusCode))
{swal({title:"Temporary Card Error",text:$alertMessages.paymentMessages.INVALID_TEMP_PLCC_BARCODE,showConfirmButton:true});}else if((/^SCN_ERR_EXPIRED$/i).test(scannerMessage.StatusCode)){swal({title:"Temporary Card Error",text:$alertMessages.paymentMessages.INVALID_TEMP_PLCC_EXPIRED,showConfirmButton:true});}else if((/^SCN_ERR_INVALID_STORE$/i).test(scannerMessage.StatusCode)){swal({title:"Temporary Card Error",text:$alertMessages.paymentMessages.INVALID_TEMP_PLCC_INVALID_STORE,showConfirmButton:true});}});$scope.disableSwipeCard=function(){$msrService.disableMSR($scope.ccData.paymentType.msrType);$scope.swipping=false;}
$scope.swipeCard=function(){$msrService.enableMSR($scope.ccData.paymentType.msrType);$scope.swipping=true;}
$scope.close=function(){$scope.disableSwipeCard();$modalInstance.dismiss('closed');};$scope.numberValidator=$numberKeyPressValidator;$scope.ccData={};$scope.ccData.paymentType=$scope.paymentTypes[0];$scope.ccData.billTo=billTo;$scope.ccData.gcBalance=0;$scope.showExpCIDFields=function(){switch($scope.ccData.paymentType){case $payment.paymentTypes.CREDITCARD:return true;default:return false;}}
$scope.isCheckBalanceEnabled=function(){switch($scope.ccData.paymentType){case $payment.paymentTypes.GIFTCARD:if($scope.ccData.token&&$scope.ccData.giftCardPin)
return true;else
return false;default:return false;}}
$scope.showNameField=function(){switch($scope.ccData.paymentType){case $payment.paymentTypes.GIFTCARD:return false;default:return true;}}
$scope.showAddress=function(){switch($scope.ccData.paymentType){case $payment.paymentTypes.GIFTCARD:return false;default:return true;}}
$scope.giftCardPin=function(){switch($scope.ccData.paymentType){case $payment.paymentTypes.GIFTCARD:return true;default:return false;}}
$scope.tokenize=function(){if($scope.ccData.cardNumber&&!$scope.ccData.token&&$scope.ccData.paymentType){$payment.tokenize($scope.ccData.cardNumber,$scope.ccData.paymentType.contractType,function(item){$scope.ccData.token=item._token;$scope.ccData.AccountNumberIndicator=NubridgeTokenFlag;$scope.ccData.cardNumber=$scope.ccData.cardNumber.replace(/.(?=.{4})/g,'*');$scope.ccData.cardType=item._cardType;if($payment.testBankCardType($scope.ccData.cardType)){$scope.ccData.cardType=$payment.translateCardType($scope.ccData.cardType);}
if(item._cardType=='GIFTCARD'){$scope.ccData.paymentType=$payment.paymentTypes.GIFTCARD;}
else if(item._cardType=='PLCC'){$scope.ccData.paymentType=$payment.paymentTypes.PLCC;}
else{$scope.ccData.paymentType=$payment.paymentTypes.CREDITCARD;}
if($scope.ccData.paymentType==$payment.paymentTypes.GIFTCARD){$scope.ccData.svcNo=$scope.ccData.cardNumber;}
$scope.ccDisabled=true;if($scope.ccData.cardType=='PLCC'&&$scope.ccData.name){$scope.save();return;}
$scope.gcBalance();},function err(error){swal({title:"Alert!",text:$alertMessages.paymentMessages.TOKENIZATION_ERROR,showConfirmButton:true});clearFields();$loggerService.log(error);});}}
var closeModal=function(){var returnData=angular.copy($scope.ccData);$modalInstance.close(returnData);}
$scope.gcBalance=function(exit){if($scope.ccData.giftCardPin&&$scope.ccData.token){$payment.gcBalance($scope.ccData.token,$scope.ccData.giftCardPin,function(response){if(response.EGCBalanceResp._MasterResultCode=="0"&&response.EGCBalanceResp.GCList){if(response.EGCBalanceResp.GCList.Item._DetailBalanceResult=="Unsuccessful"){swal({title:$alertMessages.paymentMessages.GC_PIN_ERROR,text:response.EGCBalanceResp.GCList.Item._DetailBalanceResultReason,showConfirmButton:true});}else{$scope.ccData.gcBalance=Number(response.EGCBalanceResp.GCList.Item._Balance);if(exit){closeModal();}}}else if(response.EGCBalanceResp._MasterResultCode!="0"){swal({title:$alertMessages.paymentMessages.GC_ALERT,text:response.EGCBalanceResp._MasterResultText,showConfirmButton:true});}},function err(error){swal({title:$alertMessages.paymentMessages.GC_ALERT,text:$alertMessages.paymentMessages.GC_BALANCE_ERROR,showConfirmButton:true});clearFields();$loggerService.log(error);});}else if(!$scope.ccData.token){$scope.tokenize();}}
$scope.ccClicked=function(){if($scope.ccDisabled){clearFields();}}
$scope.canSave=function(){switch($scope.ccData.paymentType){case $payment.paymentTypes.CREDITCARD:if($scope.ccData.token&&$scope.ccData.name&&$scope.ccData.exp&&$scope.ccData.cid)
return true;else
return false;case $payment.paymentTypes.GIFTCARD:if($scope.ccData.token&&$scope.ccData.giftCardPin)
return true
else
return false;case $payment.paymentTypes.PLCC:if($scope.ccData.token&&$scope.ccData.name)
return true;else
return false;default:return false;}}
$scope.save=function(){if($scope.ccData.giftCardPin&&$scope.ccData.token){$scope.gcBalance(true);}else{if(($scope.ccData.paymentType===$payment.paymentTypes.CREDITCARD)&&$scope.ccData.exp&&isInvalidExpDate($scope.ccData.exp)){$scope.isExpError=true;}else{$scope.isExpError=false;closeModal();}}};var isInvalidExpDate=function(date){if(date.length!==4){return true;}else{var month=date.substring(0,2);if(Number(month)>12){return true;}}
return false;}
if($msrService.lastCard&&$msrService.lastCard!='AssociateDiscountCard'){$scope.ccData={};$scope.ccData.paymentType=$payment.paymentTypes.CREDITCARD;setCCData($msrService.lastCard.msrData);$msrService.lastCard=undefined;}}]).controller('paymentEntryRetalixCtrl',['$scope','$modalInstance','$modal','payment','billTo','paymentData','numberKeyPressValidator','msrService','$rootScope','loggerService','alertMessages','$window','$timeout','POSService','$http','orderLine','sendSMTPErrorEmail','securityService',function($scope,$modalInstance,$modal,$payment,billTo,paymentData,$numberKeyPressValidator,$msrService,$rootScope,$loggerService,$alertMessages,$window,$timeout,$POSService,$http,orderLine,$sendSMTPErrorEmail,$securityService)
{var pmmVantivFlagIndicatorRegEx=/^(N|V)$/i;var backendVantivFlagIndicator='V';var backendVantivFlagIndicatorRegEx=new RegExp('^'+backendVantivFlagIndicator+'$','i');var NubridgeTokenFlag='T';$scope.isExpError=false;$scope.isCsr=$securityService.isCsr();$scope.paymentTypes=$payment.getAvailablePaymentTypes(paymentData,$scope.isCsr);$scope.giftCardRemoved=false;checkForBigTicket();$scope.cardTypes=$payment.cardTypes;var msrEvent=$rootScope.$on('MSR_Event',function(event,msrData){setCCData(msrData);});var msrErrorEvent=$rootScope.$on('MSR_Event_Error',function(event,msrData){if((/^(MSR_ERR_ENABLE|MSR_ERR_TOKEN|MSR_ERR_STAND_IN)$/i).test(msrData.StatusCode)){$scope.resetPaymentToBlank();swal({title:$alertMessages.paymentMessages.BANK_CARD_SYSTEM_OFFLINE_TITLE,text:$alertMessages.paymentMessages.BANK_CARD_SYSTEM_OFFLINE_MESSAGE,showConfirmButton:true});}else if((/^MSR_ERR_NOT_FUNCTIONAL$/i).test(msrData.StatusCode)){$scope.resetPaymentToBlank();swal({title:"MSR Error",text:$alertMessages.paymentMessages.MSR_NOT_FUNCTIONAL,showConfirmButton:true});}else if((/^MSR_ERR_DECLINE$/i).test(msrData.StatusCode)||(/.*ResponseCode_DeclineHard.*/i).test(msrData.StatusText)){$scope.resetPaymentToBlank();swal({title:"Card Error",text:msrData.StatusText,showConfirmButton:true});}else if((/^MSR_ERR_NOT_ENABLED$/i).test(msrData.StatusCode)||(/MSR is not enabled/i).test(msrData.StatusText)){}else if((/^(MSR_ERR_NOT_REQUESTED|MSR_ERR_INVALID_TYPE)$/i).test(msrData.StatusCode)||(/Card swiped does not match requested tender type/i).test(msrData.StatusText)){$scope.swipeCard();swal({title:"Card Error",text:$alertMessages.paymentMessages.INVALID_CARD_TYPE,showConfirmButton:true});}else if((/^MSR_ERR_UNKNOWN_TYPE$/i).test(msrData.StatusCode)){$scope.swipeCard();swal({title:"Card Error",text:$alertMessages.paymentMessages.UNKNOWN_CARD_TYPE,showConfirmButton:true});}else if((/^(MSR_ERR_CUSTOMER_CANCEL|MSR_ERR_BANK_CUST_CANCEL|MSR_ERR_PLCC_CUST_CANCEL)$/i).test(msrData.StatusCode)||(/The card swipe was cancelled by the associate/i).test(msrData.StatusText)){$scope.close();swal({title:"MSR Error",text:msrData.StatusText,showConfirmButton:true});}else if((/^(MSR_ERR_DISABLE|MSR_ERR_ENABLED)$/i).test(msrData.StatusCode)||(/Cannot disable MSR.*Card swipe has already occurred/i).test(msrData.StatusText)){}
else{$scope.close();swal({title:"MSR Error",text:msrData.StatusText,showConfirmButton:true});$sendSMTPErrorEmail(msrData,'PMM Payment Entry Error on ENV: '+serviceURL);}});$scope.$on("$destroy",function(){msrEvent();msrErrorEvent();deregister();tempPLCCErrorEventDeregister();});function checkForBigTicket(){for(var i=0;i<orderLine.length;i++){if(orderLine[i].btDisplay.itemtype=="BGT"){for(var index=0;index<$scope.paymentTypes.length;index++){if($scope.paymentTypes[index].contractType==='GIFTCARD'){$scope.paymentTypes.splice(index,1);break;}}
$scope.giftCardRemoved=true;break;}}}
$scope.resetPaymentToBlank=function(){$scope.ccData.paymentType='';$scope.paymentTypeChange();};$scope.paymentTypeChange=function(){var paymentType=$scope.ccData.paymentType;$scope.ccData={};$scope.ccData.paymentType=paymentType;$scope.ccDisabled=false;switch($scope.ccData.paymentType){case $payment.paymentTypes.CREDITCARD:case $payment.paymentTypes.GIFTCARD:case $payment.paymentTypes.PLCC:if(!$scope.isCsr){$scope.swipeCard();}
break;default:$scope.disableSwipeCard();}};var clearFields=function(){$scope.paymentTypeChange();}
function setCCData(msrData){if(pmmVantivFlagIndicatorRegEx.test(msrData.AccountNumberIndicator)){$scope.ccData.cardNumber='************'+msrData.AccountNumberLast4;$scope.ccData.token=msrData.AccountNumber;msrData.AccountNumberIndicator=backendVantivFlagIndicator;if($payment.testBankCardType(msrData.CardType)){$scope.ccData.cardType=$payment.translateCardType(msrData.CardType);}}else{$scope.ccData.cardNumber=msrData.AccountNumber;}
if(msrData.AccountNumberIndicator){$scope.ccData.AccountNumberIndicator=msrData.AccountNumberIndicator;}else{$scope.ccData.AccountNumberIndicator='C';}
if(msrData.CardType=='PLCC'){$scope.ccData.paymentType=$payment.paymentTypes.PLCC;$scope.ccData.cardType=$payment.paymentTypes.PLCC.msrType;}
if(msrData.FirstName&&msrData.FirstName.trim().length>0){$scope.ccData.FirstName=msrData.FirstName.trim();}
if(msrData.LastName&&msrData.LastName.trim().length>0){$scope.ccData.LastName=msrData.LastName.trim();}
var firstName=$scope.ccData.FirstName?$scope.ccData.FirstName:'';var lastName=$scope.ccData.LastName?$scope.ccData.LastName:'';$scope.ccData.name=firstName+' '+lastName;$scope.ccData.name=$scope.ccData.name.trim();if(msrData.ExpirationDate){$scope.ccData.exp=msrData.ExpirationDate;}
$scope.ccData.swipped=true;$scope.tokenize();};var deregister=$rootScope.$on('Scanner_Event',function(event,barcodeData,scannerMessage){if(scannerMessage.BarcodeType==3){if(!$scope.giftCardRemoved)
{$scope.ccData.paymentType=$payment.paymentTypes.GIFTCARD;$scope.ccData.cardNumber=barcodeData;$scope.ccData.scanned=true;$scope.tokenize();}}else if(scannerMessage.BarcodeType==17||scannerMessage.BarcodeType==6){if(barcodeData&&barcodeData.trim().length>0){var url=serviceURL+'/CreditService/Lookup';var findCustomerObj={"LookupRequest":{"_AccountNumber":barcodeData,"_OriginStoreNum":$POSService.getPOSParameters().storeNumber,"_SourceApplication":"Sterling","_IsTokenized":"N"}};$http.post(url,findCustomerObj).success(function(result){setCCData({CardType:$payment.paymentTypes.PLCC.msrType,AccountNumber:barcodeData,FirstName:result.LookupResponse._FirstName,LastName:result.LookupResponse._LastName});}).error(function(data){$loggerService.error(data);});}else{swal({title:"Bad PLCC Scan",text:$alertMessages.paymentMessages.SCAN_ERROR,showConfirmButton:true});}}else{swal({title:"Card Error",text:$alertMessages.paymentMessages.INVALID_CARD_TYPE,showConfirmButton:true});}});var tempPLCCErrorEventDeregister=$rootScope.$on('Scanner_Event_Error_Temp_PLCC_Error',function(event,scannerMessage){if((/^SCN_ERR_INVALID_BARCODE$/i).test(scannerMessage.StatusCode)){swal({title:"Temporary Card Error",text:$alertMessages.paymentMessages.INVALID_TEMP_PLCC_BARCODE,showConfirmButton:true});}else if((/^SCN_ERR_EXPIRED$/i).test(scannerMessage.StatusCode)){swal({title:"Temporary Card Error",text:$alertMessages.paymentMessages.INVALID_TEMP_PLCC_EXPIRED,showConfirmButton:true});}else if((/^SCN_ERR_INVALID_STORE$/i).test(scannerMessage.StatusCode)){swal({title:"Temporary Card Error",text:$alertMessages.paymentMessages.INVALID_TEMP_PLCC_INVALID_STORE,showConfirmButton:true});}});var waitingForMsr={DISABLE:0,ENABLE:1,wait:function(waitType){if(waitType===waitingForMsr.ENABLE){$scope.msrWaitingMessage="Enabling...";$scope.msrWaiting=true;$scope.swipping=true;}else if(waitType===waitingForMsr.DISABLE){$scope.swipping=true;$scope.msrWaitingMessage="Disabling...";$scope.msrWaiting=true;}},doneWaiting:function(waitType){if(waitType===waitingForMsr.ENABLE){$scope.swipping=true;$scope.msrWaiting=false;$scope.msrWaitingMessage=" ";}else if(waitType===waitingForMsr.DISABLE){$scope.swipping=false;$scope.msrWaitingMessage=" ";$scope.msrWaiting=false;}}};$scope.disableSwipeCard=function(isIgnoreStateSendDisable){if($msrService.isEnabled()||isIgnoreStateSendDisable){waitingForMsr.wait(waitingForMsr.DISABLE);$msrService.disableMSR(isIgnoreStateSendDisable).then(function(){waitingForMsr.doneWaiting(waitingForMsr.DISABLE);},function(){waitingForMsr.doneWaiting(waitingForMsr.DISABLE);});}else{waitingForMsr.doneWaiting(waitingForMsr.DISABLE);}}
$scope.swipeCard=function(){waitingForMsr.wait(waitingForMsr.ENABLE);$msrService.disableMSR().then(function(){$msrService.enableMSR($scope.ccData.paymentType.msrType).then(function(){waitingForMsr.doneWaiting(waitingForMsr.ENABLE);},function(){waitingForMsr.doneWaiting(waitingForMsr.DISABLE);});},function(error){var message=(angular.isObject(error)&&angular.isString(error.StatusText))?error.StatusText:"Disable MSR failed.";swal({title:"MSR Disable Error",text:message,showConfirmButton:true});waitingForMsr.doneWaiting(waitingForMsr.DISABLE);});}
$scope.close=function(){$scope.disableSwipeCard(true);$modalInstance.dismiss('closed');};$scope.numberValidator=$numberKeyPressValidator;$scope.ccData={};$scope.ccData.paymentType='';$scope.ccData.billTo=billTo;$scope.ccData.gcBalance=0;$scope.showCIDFields=function(){return false;switch($scope.ccData.paymentType){case $payment.paymentTypes.CREDITCARD:return true;default:return false;}};$scope.isCheckBalanceEnabled=function(){switch($scope.ccData.paymentType){case $payment.paymentTypes.GIFTCARD:if($scope.ccData.token&&$scope.ccData.giftCardPin)
return true;else
return false;default:return false;}};$scope.showNameField=function(){switch($scope.ccData.paymentType){case $payment.paymentTypes.PLCC:case $payment.paymentTypes.CREDITCARD:return true;default:return false;}};$scope.showCardNumberField=function(){switch($scope.ccData.paymentType){case $payment.paymentTypes.PLCC:case $payment.paymentTypes.CREDITCARD:case $payment.paymentTypes.GIFTCARD:return true;default:return false;}};$scope.showAddress=function(){switch($scope.ccData.paymentType){case $payment.paymentTypes.GIFTCARD:return false;default:return false;}};$scope.giftCardPin=function(){switch($scope.ccData.paymentType){case $payment.paymentTypes.GIFTCARD:return true;default:return false;}};$scope.showKeyInButton=function(){if($scope.swipping&&$scope.ccData.paymentType==$payment.paymentTypes.GIFTCARD){return true;}else{return false;}};$scope.showSwipeCardButton=function(){if($scope.isCsr){return false;}
if(!$scope.swipping&&$scope.ccData.paymentType==$payment.paymentTypes.GIFTCARD){return true;}else{return false;}};$scope.showGiftcardManualEntry=function(){$scope.disableSwipeCard(true);};$scope.tokenize=function(){if($scope.ccData.cardNumber&&!$scope.ccData.token&&$scope.ccData.paymentType){$payment.tokenize($scope.ccData.cardNumber,$scope.ccData.paymentType.contractType,function(item){$scope.ccData.token=item._token;$scope.ccData.AccountNumberIndicator=NubridgeTokenFlag;$scope.ccData.cardNumber=$scope.ccData.cardNumber.replace(/.(?=.{4})/g,'*');$scope.ccData.cardType=item._cardType;if($payment.testBankCardType($scope.ccData.cardType)){$scope.ccData.cardType=$payment.translateCardType($scope.ccData.cardType);}
if(item._cardType=='GIFTCARD'){$scope.ccData.paymentType=$payment.paymentTypes.GIFTCARD;}
else if(item._cardType=='PLCC'){$scope.ccData.paymentType=$payment.paymentTypes.PLCC;}
else{$scope.ccData.paymentType=$payment.paymentTypes.CREDITCARD;}
if($scope.ccData.paymentType==$payment.paymentTypes.GIFTCARD){$scope.ccData.svcNo=$scope.ccData.cardNumber;}
$scope.ccDisabled=true;if($scope.ccData.cardType=='PLCC'&&$scope.ccData.name){$scope.save();return;}
$scope.gcBalance();$scope.disableSwipeCard();},function err(error){swal({title:"Alert!",text:$alertMessages.paymentMessages.TOKENIZATION_ERROR,showConfirmButton:true});clearFields();$loggerService.log(error);});}else if($scope.ccData.cardNumber&&$scope.ccData.token&&$scope.ccData.paymentType&&backendVantivFlagIndicatorRegEx.test($scope.ccData.AccountNumberIndicator)){$scope.ccDisabled=true;$scope.save();}}
var closeModal=function(){var returnData=angular.copy($scope.ccData);$modalInstance.close(returnData);}
$scope.gcBalance=function(exit){if($scope.ccData.giftCardPin&&$scope.ccData.token){$payment.gcBalance($scope.ccData.token,$scope.ccData.giftCardPin,function(response){if(response.EGCBalanceResp._MasterResultCode=="0"&&response.EGCBalanceResp.GCList){if(response.EGCBalanceResp.GCList.Item._DetailBalanceResult=="Unsuccessful"){swal({title:$alertMessages.paymentMessages.GC_PIN_ERROR,text:response.EGCBalanceResp.GCList.Item._DetailBalanceResultReason,showConfirmButton:true});}else{$scope.ccData.gcBalance=Number(response.EGCBalanceResp.GCList.Item._Balance);if(exit){closeModal();}}}else if(response.EGCBalanceResp._MasterResultCode!="0"){swal({title:$alertMessages.paymentMessages.GC_ALERT,text:response.EGCBalanceResp._MasterResultText,showConfirmButton:true});}},function err(error){swal({title:$alertMessages.paymentMessages.GC_ALERT,text:$alertMessages.paymentMessages.GC_BALANCE_ERROR,showConfirmButton:true});clearFields();$loggerService.log(error);});}else if(!$scope.ccData.token){$scope.tokenize();}}
$scope.ccClicked=function(){if($scope.ccDisabled){clearFields();}}
$scope.canSave=function(){switch($scope.ccData.paymentType){case $payment.paymentTypes.CREDITCARD:if($scope.ccData.token&&$scope.ccData.name&&$scope.ccData.exp)
return true;else
return false;case $payment.paymentTypes.GIFTCARD:if($scope.ccData.token&&$scope.ccData.giftCardPin)
return true
else
return false;case $payment.paymentTypes.PLCC:if($scope.ccData.token&&$scope.ccData.name)
return true;else
return false;default:return false;}}
$scope.save=function(){if($scope.ccData.giftCardPin&&$scope.ccData.token){$scope.gcBalance(true);}else{if(($scope.ccData.paymentType===$payment.paymentTypes.CREDITCARD)&&$scope.ccData.exp&&isInvalidExpDate($scope.ccData.exp)){$scope.isExpError=true;}else{$scope.isExpError=false;}
if(!$scope.isExpError&&$scope.ccData.paymentType&&($scope.ccData.paymentType===$payment.paymentTypes.PLCC)&&angular.isString($scope.ccData.name)&&$scope.ccData.name.length>0){closeModal();}else{$scope.disableSwipeCard();}
if(!$scope.isExpError&&$scope.ccData.paymentType&&($scope.ccData.paymentType===$payment.paymentTypes.CREDITCARD)&&angular.isString($scope.ccData.name)&&$scope.ccData.name.length>0){closeModal();}else{$scope.disableSwipeCard();}}};var isInvalidExpDate=function(date){if(date.length!==4){return true;}else{var month=date.substring(0,2);if(Number(month)>12){return true;}}
return false;};var delayedLastCard=function(){if($msrService.lastCard&&$msrService.lastCard!='AssociateDiscountCard'){$scope.ccData={};$scope.ccData.paymentType=$payment.paymentTypes.CREDITCARD;setCCData($msrService.lastCard.msrData);$msrService.lastCard=undefined;}};$timeout(delayedLastCard,1000);if($scope.isCsr){$scope.ccData.paymentType=$payment.paymentTypes.GIFTCARD;$scope.showGiftcardManualEntry();$scope.swipping=false;}}]).controller('InContactPaymentEntryCtrl',['$scope','$modalInstance','payment','billTo','paymentData','sendSMTPErrorEmail',function($scope,$modalInstance,$payment,billTo,paymentData,$sendSMTPErrorEmail){$scope.inContactPaymentId=paymentData.inContactPaymentId;$scope.paymentErrors="";$scope.ccData={};$scope.ccData.paymentType='';$scope.ccData.billTo=billTo;$scope.ccData.gcBalance=0;if($scope.inContactPaymentId===null||$scope.inContactPaymentId===undefined){$payment.getInContactPaymentId().then(function(response){$scope.inContactPaymentId=response.data.PCRN;},function(response){reportFailure("Payment ID generation failed.");});}
var reportFailure=function(displayMessage){if(displayMessage.toString()){$scope.paymentErrors=displayMessage;}else{$scope.paymentErrors="Payment collection process failed.";}};$scope.getPayment=function(){$payment.getInContactPayment($scope.inContactPaymentId).then(function(response){var isEmptyJSON=function(obj){return JSON.stringify(obj)===JSON.stringify({});};if(angular.isObject(response.data)&&isEmptyJSON(response.data)){reportFailure("No payment with ID "+$scope.inContactPaymentId+" was found. Please try again.");}
else if(response.data&&angular.isObject(response.data.Tender)&&angular.isString(response.data.Tender.TenderType)&&(response.data.Tender.Token!==null&&response.data.Tender.Token!==undefined)&&angular.isString(response.data.Tender.TokenType)&&angular.isString(response.data.Tender.ExpirationDate)&&angular.isString(response.data.Tender.CardType))
{var tenderData=response.data.Tender;$scope.ccData.cardNumber='************';$scope.ccData.cardNumber+=tenderData.Last4?tenderData.Last4:"****";$scope.ccData.token=tenderData.Token;$scope.ccData.AccountNumberIndicator=tenderData.TokenType;if(billTo._FirstName&&billTo._FirstName.trim().length>0){$scope.ccData.FirstName=billTo._FirstName.trim();}
if(billTo._LastName&&billTo._LastName.trim().length>0){$scope.ccData.LastName=billTo._LastName.trim();}
var firstName=$scope.ccData.FirstName?$scope.ccData.FirstName:'';var lastName=$scope.ccData.LastName?$scope.ccData.LastName:'';$scope.ccData.name=firstName+' '+lastName;$scope.ccData.name=$scope.ccData.name.trim();$scope.ccData.exp=tenderData.ExpirationDate.substring(5,7)+tenderData.ExpirationDate.substring(2,4);if((/BankCard/i).test(tenderData.TenderType)){$scope.ccData.paymentType=$payment.paymentTypes.CREDITCARD;if(tenderData.CVV&&(/^\d{3,4}$/).test(tenderData.CVV.toString().trim())){$scope.ccData.cid=tenderData.CVV.toString().trim();}else{reportFailure("Retrieved Payment CVV is invalid.");return;}
if($payment.testBankCardType(tenderData.CardType)){$scope.ccData.cardType=$payment.translateCardType(tenderData.CardType);}else{$scope.ccData.cardType=tenderData.CardType;}}else if((/PLCC/i).test(tenderData.TenderType)){$scope.ccData.paymentType=$payment.paymentTypes.PLCC;$scope.ccData.cardType=$payment.paymentTypes.PLCC.msrType;}else{reportFailure("Retrieved Payment TenderType is invalid.");return;}
closeModal();}else{reportFailure("Retrieved Payment Data is invalid.");}},function(response){reportFailure("InContact Payment service failed.");});};$scope.close=function(){var returnData={inContactPaymentId:null};if($scope.inContactPaymentId!==null&&$scope.inContactPaymentId!==null&&$scope.inContactPaymentId.toString().trim().length>0){returnData.inContactPaymentId=$scope.inContactPaymentId.toString().trim();}
$modalInstance.dismiss(returnData);};var closeModal=function(){var returnData=angular.copy($scope.ccData);returnData.inContactPaymentId=null;if($scope.inContactPaymentId!==null&&$scope.inContactPaymentId!==null&&$scope.inContactPaymentId.toString().trim().length>0){returnData.inContactPaymentId=$scope.inContactPaymentId.toString().trim();}
$modalInstance.close(returnData);}}]).controller('accEntryCtrl',['$scope','$modalInstance','$modal','payment','numberKeyPressValidator','msrService','$rootScope','alertMessages','securityService',function($scope,$modalInstance,$modal,$payment,$numberKeyPressValidator,$msrService,$rootScope,$alertMessages,$securityService){$scope.isCsr=$securityService.isCsr();var msrErrorEvent=$rootScope.$on('MSR_Event_Error',function(event,msrData){swal({title:"Alert!",text:$alertMessages.paymentMessages.CARD_ERROR,showConfirmButton:true});$scope.swipping=false;});var msrEvent=$rootScope.$on('MSR_Event',function(event,msrData){$modalInstance.close(msrData.AccountNumber);});$scope.$on("$destroy",function(){msrErrorEvent();msrEvent();});$scope.disableSwipeCard=function(){$msrService.disableMSR('AssociateDiscountCard');$scope.swipping=false;}
$scope.swipeCard=function(){$msrService.enableMSR('AssociateDiscountCard');$scope.swipping=true;}
$scope.close=function(){$scope.disableSwipeCard();$modalInstance.dismiss('closed');};$scope.numberValidator=$numberKeyPressValidator;$scope.canSave=function(){if($scope.accNumber)
return true;else
return false;}
$scope.save=function(){var firstFour=$scope.accNumber.substring(0,4);if(firstFour=='2119'){$modalInstance.close($scope.accNumber);}else{$scope.cardNumValidationError=true;}};$scope.close=function(){$modalInstance.dismiss('close');};}]);
﻿angular.module('returnSummary',['ngTable']).controller('returnSummaryCtrl',['$scope','order','$filter','ngTableParams','numberOnlyKeyPressValidator','loggerService','$state',function($scope,$order,$filter,ngTableParams,$numberOnlyKeyPressValidator,$loggerService,$state){var returnScroll=new IScroll('#returnsWrapper',{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip'});$scope.refreshReturnScroll=function(){setTimeout(function(){returnScroll.refresh();},500);};var exchangeScroll=new IScroll('#exchangesWrapper',{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip'});$scope.refreshExchangeScroll=function(){setTimeout(function(){exchangeScroll.refresh();},500);};$scope.returnTotal=0;$scope.exchangeTotal=0;$scope.refundTotal=0;$scope.returnOrderlines=[];$scope.exchangeOrderlines=[];$scope.orderDetail={};var _addOrderlineDetails=function(cart,currentObj){var salesOrderline=null;for(var i=0;i<cart.OrderLines.OrderLine.length;i++)
{if(cart.OrderLines.OrderLine[i].Item._ItemID===currentObj.itemId)
{salesOrderline=cart.OrderLines.OrderLine[i];break;}}
if(salesOrderline!==null){currentObj.imageUrl=salesOrderline.btDisplay.defaultImageUrl;currentObj.upc=parseInt(salesOrderline.btDisplay.id);currentObj.description=salesOrderline.btDisplay.defaultItemDescription;}else{}};var _init=function(){$scope.returnTotal=0;$scope.exchangeTotal=0;$scope.refundTotal=0;$scope.returnOrderlines=[];$scope.exchangeOrderlines=[];$scope.orderDetail={};$scope.orderDetail=$order.getCurrentOrderDetails();if(!angular.isDefined($scope.orderDetail)||$scope.orderDetail===null){$scope.getOrderDetails();}else{if($scope.orderDetail.ReturnOrders&&$scope.orderDetail.ReturnOrders!==null&&angular.isArray($scope.orderDetail.ReturnOrders.ReturnOrder)){for(var i=0;i<$scope.orderDetail.ReturnOrders.ReturnOrder.length;i++){var currentReturn=$scope.orderDetail.ReturnOrders.ReturnOrder[i];var currentOrderNo=currentReturn._OrderNo;var currentOrderDate=currentReturn._OrderDate;if(angular.isDefined(currentReturn.OverallTotals)&&currentReturn.OverallTotals!==null&&angular.isDefined(currentReturn.OverallTotals._GrandTotal)&&isFinite(parseFloat(currentReturn.OverallTotals._GrandTotal))){$scope.returnTotal=$scope.returnTotal+parseFloat(currentReturn.OverallTotals._GrandTotal);$scope.refundTotal=$scope.refundTotal+parseFloat(currentReturn.OverallTotals._GrandTotal);}
if(angular.isDefined(currentReturn.OrderLines)&&currentReturn.OrderLines!==null&&angular.isArray(currentReturn.OrderLines.OrderLine)){for(var p=0;p<currentReturn.OrderLines.OrderLine.length;p++){var orderline=currentReturn.OrderLines.OrderLine[p];var currentObj={orderNo:parseInt(currentOrderNo),orderDate:currentOrderDate,imageUrl:'',upc:'',itemId:orderline.Item._ItemID,description:'',returnQty:parseInt(orderline._OrderedQty),unitPrice:parseFloat(orderline.LinePriceInfo._UnitPrice),status:orderline._Status,returnReason:orderline._ReturnReasonShortDesc,customerKeep:(orderline._ReturnReason&&orderline._ReturnReason!==null&&(/^(10|11|12|13)$/).test(orderline._ReturnReason.toString().trim()))?'Yes':'No'};_addOrderlineDetails($scope.orderDetail,currentObj);$scope.returnOrderlines.push(currentObj);}}
if(currentReturn.ExchangeOrders&&currentReturn.ExchangeOrders!==null&&angular.isArray(currentReturn.ExchangeOrders.ExchangeOrder)){for(var q=0;q<currentReturn.ExchangeOrders.ExchangeOrder.length;q++){var currentExchange=currentReturn.ExchangeOrders.ExchangeOrder[q];var currentExchangeOrderNo=currentExchange._OrderNo;var currentExchangeOrderDate=currentExchange._OrderDate;if(angular.isDefined(currentExchange.OverallTotals)&&currentExchange.OverallTotals!==null&&angular.isDefined(currentExchange.OverallTotals._GrandTotal)&&isFinite(parseFloat(currentExchange.OverallTotals._GrandTotal))){$scope.exchangeTotal=$scope.exchangeTotal+parseFloat(currentExchange.OverallTotals._GrandTotal);$scope.refundTotal=$scope.refundTotal-parseFloat(currentExchange.OverallTotals._GrandTotal);}
if(angular.isDefined(currentExchange.OrderLines)&&currentExchange.OrderLines!==null&&angular.isArray(currentExchange.OrderLines.OrderLine)){for(var p=0;p<currentExchange.OrderLines.OrderLine.length;p++){var orderline=currentExchange.OrderLines.OrderLine[p];var currentObj={orderNo:parseInt(currentExchangeOrderNo),orderDate:currentExchangeOrderDate,imageUrl:orderline.btDisplay.defaultImageUrl,upc:orderline.btDisplay.id,itemId:orderline.Item._ItemID,description:orderline.btDisplay.defaultItemDescription,returnQty:parseInt(orderline._OrderedQty),unitPrice:parseFloat(orderline.LinePriceInfo._UnitPrice),status:orderline._Status,returnReason:'',customerKeep:''};_addOrderlineDetails($scope.orderDetail,currentObj);$scope.exchangeOrderlines.push(currentObj);}}}}}}
$scope.refundTotal=($scope.refundTotal<0)?0:$scope.refundTotal;_setUpReturnsDisplayTable();_setUpExchangesDisplayTable();}};var _setUpReturnsDisplayTable=function(){$scope.returnsTable=new ngTableParams({page:1,count:100000,sorting:{_OrderDate:'desc'}},{total:$scope.returnOrderlines.length,counts:[],getData:function($defer,params){var orderedData=$scope.returnOrderlines;$defer.resolve(orderedData);$scope.refreshReturnScroll();}});};var _setUpExchangesDisplayTable=function(){$scope.exchangesTable=new ngTableParams({page:1,count:100000,sorting:{_OrderDate:'desc'}},{total:$scope.exchangeOrderlines.length,counts:[],getData:function($defer,params){var orderedData=$scope.exchangeOrderlines;$defer.resolve(orderedData);$scope.refreshExchangeScroll();}});};$scope.goToSalesDetail=function(){$state.go('orderDetail');};$scope.openOrderDetail=function(orderNo,orderType){var docType='0001';if(orderType&&orderType==="return"){docType='0003';}
$order.setSelectedOrder({_OrderNo:orderNo,_DocumentType:docType});$scope.goToSalesDetail();};_init();}]);
﻿angular.module('pickingConfirm',['ui.bootstrap']).controller('pickingConfirmCtrl',['$scope','$state','pickConfirmService','POSService','$modal','itemSearch','itemDetail','numberOnlyKeyPressValidator','loggerService','btProp',function($scope,$state,$pickConfirmService,$POSService,$modal,$itemSearch,$itemDetail,$numberOnlyKeyPressValidator,$loggerService,$btProp){$scope.isLoading=true;$scope.isZeroItemsToPick=false;$scope.numberValidator=$numberOnlyKeyPressValidator;$scope.refreshIScroll=function(){setTimeout(function(){$scope.$parent.myScroll['ItemDetailWrapper'].refresh();},500);};$scope.pickList=[];$scope.refreshPickList=function(){$scope.isLoading=true;$scope.isZeroItemsToPick=false;var storeNumber=$POSService.getPOSParameters().storeNumber;if(storeNumber===null||storeNumber===undefined){$scope.isLoading=false;return;}
storeNumber=storeNumber.toString();while(storeNumber.length<3){storeNumber="0"+storeNumber;}
$pickConfirmService.getUnpickedShipmentLines(storeNumber).then(function(rawShipmentLineArr){if(!angular.isArray(rawShipmentLineArr)){swal({title:"Pick List Load Fail",text:"Pick list Sterling Order Data Failed To Load.",confirmButtonText:"OK"});$scope.isLoading=false;return;}
if(rawShipmentLineArr.length<1){$scope.isLoading=false;$scope.isZeroItemsToPick=true;return;}
$pickConfirmService.retrievePickingDisplayDetails(storeNumber,rawShipmentLineArr).then(function(completeShipmentLines){completeShipmentLines=$pickConfirmService.fobSortShipmentLines(completeShipmentLines);$scope.pickList.length=0;for(var i=0;i<completeShipmentLines.length;i++){$scope.pickList.push(completeShipmentLines[i]);}
$scope.isLoading=false;},function(data){$scope.isLoading=false;swal({title:"Pick List Load Fail",text:"Pick list Solr Data Failed to Load.",confirmButtonText:"OK"});return data;});},function(data){$scope.isLoading=false;swal({title:"Pick List Load Fail",text:"Pick list Sterling Order Data Failed To Load.",confirmButtonText:"OK"});return data;});};$scope.goBack=function(){$state.go('alternatePickAndPack');};$scope.print=function(){$scope.$parent.myScroll['ItemDetailWrapper'].scrollTo(0,0);jQuery('#scrollTableHeader').css("transform","translate3d(0px, 0px, 0px)");window.print();};$scope.confirmPick=function(){var shipmentLineToConfirm={};var shortPickCount=0;for(var i=0;i<$scope.pickList.length;i++){var currentLine=$scope.pickList[i];if(angular.isString(currentLine.QtyPicked)&&(/^\s*\d{1,5}\s*$/).test(currentLine.QtyPicked)){var intValue=parseInt(currentLine.QtyPicked);if(isFinite(intValue)&&intValue>-1&&intValue<=currentLine.QtyToPick){shipmentLineToConfirm[currentLine._shipmentLine._ShipmentLineKey]=currentLine;if(intValue<currentLine.QtyToPick){++shortPickCount;}}else{swal({title:"Pick Confirm Failed",text:"Invalid input. Please update all red input boxes.",confirmButtonText:"OK"});return;}}}
if(shortPickCount>0){swal({title:"Confirm Short",text:"You are shorting "+shortPickCount+" line"+((shortPickCount>1)?"s.":"."),showCancelButton:true,confirmButtonText:"Confirm"},function(isConfirm){if(isConfirm){_asyncCompleteConfirmPick(shipmentLineToConfirm);}});}else{_asyncCompleteConfirmPick(shipmentLineToConfirm);}};var _asyncCompleteConfirmPick=function(shipmentLineToConfirm){var shipmentLineKeys=[];angular.forEach(shipmentLineToConfirm,function(value,key){shipmentLineKeys.push(key);});if(shipmentLineKeys.length<1){swal({title:"Pick Confirm Failed",text:"No valid picks to confirm.",confirmButtonText:"OK"});return;}
var shipmentLinesAlreadyPicked=[];$pickConfirmService.validateShipmentLinesForPicking(shipmentLineKeys).then(function(shipmentLineKeyIsPickedDic){angular.forEach(shipmentLineToConfirm,function(value,key){if((/^Y$/i).test(shipmentLineKeyIsPickedDic[key])){shipmentLinesAlreadyPicked.push(value);}});if(shipmentLinesAlreadyPicked.length>0){{var modalInstance=$modal.open({templateUrl:'/html/pickUpInStore/alreadyPickedModal.html',controller:'alreadyPickedModCtrl',resolve:{shipmentLinesAlreadyPicked:function(){return shipmentLinesAlreadyPicked;}},size:'lg'});modalInstance.result.then(function(registryChange){$scope.refreshPickList();});};}else{var arrayOfShipmentLines=[];angular.forEach(shipmentLineToConfirm,function(value,key){arrayOfShipmentLines.push(value);});$pickConfirmService.confirmPicks(arrayOfShipmentLines).then(function(){swal({title:"Pick Confirm",text:"Pick confirmation completed.",confirmButtonText:"OK"});$scope.refreshPickList();},function(message){swal({title:"Pick Confirm Failed",text:"Pick Confirmation Failed."+(angular.isString(message))?message:"",confirmButtonText:"OK"});$scope.refreshPickList();});}});};$scope.validatePickBounds=function(currentLine){if((/^\s*$/).test(currentLine.QtyPicked)){return true;}
var intValue=parseInt(currentLine.QtyPicked);if(isFinite(intValue)&&intValue>-1&&intValue<=currentLine.QtyToPick){return true;}else{return false;}};$scope.validatePickIsShorting=function(currentLine){var intValue=parseInt(currentLine.QtyPicked);if(isFinite(intValue)&&intValue>-1&&intValue<currentLine.QtyToPick){return true;}else{return false;}};$scope.refreshPickList();}]).controller('alreadyPickedModCtrl',['$scope','$modalInstance','pickConfirmService','shipmentLinesAlreadyPicked',function($scope,$modalInstance,$pickConfirmService,shipmentLinesAlreadyPicked){$scope.refreshIScroll=function(){setTimeout(function(){$scope.$parent.myScroll['ModalAlreadyPickedWrapper'].refresh();},500);};$scope.pickList=$pickConfirmService.fobSortShipmentLines(shipmentLinesAlreadyPicked);$scope.cancel=function(){$modalInstance.close();};}]);
﻿angular.module('packConfirm',['ui.bootstrap']).controller('packConfirmCtrl',['$scope','$state','pickConfirmService','POSService','$modal','itemSearch','itemDetail','numberOnlyKeyPressValidator','loggerService','btProp','ngTableParams','$filter',function($scope,$state,$pickConfirmService,$POSService,$modal,$itemSearch,$itemDetail,$numberOnlyKeyPressValidator,$loggerService,$btProp,ngTableParams,$filter){$scope.isLoading=true;$scope.isZeroItemsToPack=false;$scope.numberValidator=$numberOnlyKeyPressValidator;$scope.refreshIScroll=function(){setTimeout(function(){$scope.$parent.myScroll['wrapper'].refresh();},500);};$scope.myScrollOptions={tap:true};$scope.packList=[];$scope.tableParams=new ngTableParams({page:1,count:100000,sorting:{"_display._OrderNo":"asc"}},{total:$scope.packList.length,counts:[],defaultSort:"asc",getData:function($defer,params){console.log(params.sorting());console.log(params.orderBy());var orderedData=params.sorting()?$filter('orderBy')($scope.packList,params.orderBy()):$scope.packList;$defer.resolve(orderedData.slice((params.page()-1)*params.count(),params.page()*params.count()));$scope.refreshIScroll();}});if($scope.packList.length>0){$scope.tableParams.reload();}
$scope.refreshPackList=function(){$scope.isLoading=true;$scope.isZeroItemsToPack=false;$scope.packList.length=0;var storeNumber=$POSService.getPOSParameters().storeNumber;if(storeNumber===null||storeNumber===undefined){$scope.isLoading=false;return;}
storeNumber=storeNumber.toString();while(storeNumber.length<3){storeNumber="0"+storeNumber;}
$pickConfirmService.getUnConfirmedShipmentList(storeNumber).then(function(dictionaryShipmentNoToShipments){$scope.packList.length=0;angular.forEach(dictionaryShipmentNoToShipments,function(value,key){var orderno=null;if(value.ShipmentLines&&angular.isArray(value.ShipmentLines.ShipmentLine)&&value.ShipmentLines.ShipmentLine.length>0&&value.ShipmentLines.ShipmentLine[0]._OrderNo){orderno=parseInt(value.ShipmentLines.ShipmentLine[0]._OrderNo);if(!isFinite(orderno)){orderno=null;}}
var displayName=null;if(value.BillToAddress){if(angular.isString(value.BillToAddress._LastName)){displayName=value.BillToAddress._LastName.trim();}
if(angular.isString(value.BillToAddress._FirstName)){displayName+=", "+value.BillToAddress._FirstName.trim();}}
var isReceiptPrinted="No";if(value.Extn&&value.Extn._ExtnBatchPackSlipPrinted){if((/^\s*Y\s*$/i).test(value.Extn._ExtnBatchPackSlipPrinted)){isReceiptPrinted="Yes";}else{isReceiptPrinted="No";}}
value._display={_OrderNo:orderno,_CustomerName:displayName,_IsReceiptPrintedStr:isReceiptPrinted};$scope.packList.push(value);});$scope.isLoading=false;$scope.tableParams.reload();},function(data){$scope.isLoading=false;swal({title:"Pick List Load Fail",text:"Pick list Sterling Order Data Failed To Load.",confirmButtonText:"OK"});return data;});};var _remove=function(currentShipment){for(var i=0;i<$scope.packList.length;i++){if($scope.packList[i]._ShipmentKey==currentShipment._ShipmentKey){$scope.packList.splice(i,1);$scope.tableParams.reload();break;}}};$scope.openConfirmOrderModal=function(currentShipment){var modalInstance=$modal.open({templateUrl:'html/pickUpInStore/packConfirmModal.html',controller:'packConfirmModalCtrl',size:"lg",resolve:{currentShipment:function(){return currentShipment;}}});modalInstance.result.then(function(result){if(result===true){_remove(currentShipment);}});};$scope.goBack=function(){$state.go('alternatePickAndPack');};$scope.formInput={orderNo:'',};$scope.tryOpenOrder=function(orderNo){if($scope.isLoading){return;}
var isOrderFound=false;var inputStr="";if(angular.isString(orderNo)){inputStr=orderNo.trim();}
if(/^\d{9}$/.test(inputStr)){var numInputOrderNumber=parseInt(inputStr);for(var i=0;i<$scope.packList.length;i++){if($scope.packList[i]._display._OrderNo==numInputOrderNumber){isOrderFound=true;$scope.openConfirmOrderModal($scope.packList[i]);break;}}}
if(!isOrderFound){$scope.formInput.orderNo="";var errorText="";if(inputStr.length>0){errorText="Order: "+inputStr+" is not in the correct state for pack confirmation.";}else{errorText="This order is not in the correct state for pack confirmation.";}
swal({title:"Cannot Pack Confirm Order",text:errorText,confirmButtonText:"OK"});}};var handleBarCodeScan=function(event,barcodeData){if(!angular.isString(barcodeData)){barcodeData=(!angular.isDefined(barcodeData)||barcodeData===null)?'':barcodeData.toString().trim();}
$scope.formInput.orderNo=barcodeData.substring(0,9);$scope.tryOpenOrder($scope.formInput.orderNo);};var deregister=$scope.$on('Scanner_Event',handleBarCodeScan);$scope.$on("$destroy",function(){deregister();});$scope.refreshPackList();}]).controller('packConfirmModalCtrl',['$scope','$modalInstance','pickConfirmService','currentShipment',function($scope,$modalInstance,$pickConfirmService,currentShipment){$scope.currentShipment=currentShipment;$scope.currentShipmentLines=[];var gatherShipmentLineData=function(){if($scope.currentShipment&&$scope.currentShipment.ShipmentLines&&angular.isArray($scope.currentShipment.ShipmentLines.ShipmentLine)){if($scope.currentShipment.ShipmentLines.ShipmentLine.length>0){$pickConfirmService.retrievePackDisplayDetails($scope.currentShipment.ShipmentLines.ShipmentLine).then(function(displayDataArray){for(var i=0;i<displayDataArray.length;i++){$scope.currentShipmentLines.push(displayDataArray[i]);}
$scope.refreshIScroll();});}}};gatherShipmentLineData();$scope.refreshIScroll=function(){setTimeout(function(){$scope.$parent.myScroll['ItemDetailWrapper'].refresh();},500);};$scope.cancel=function(){$modalInstance.dismiss();};$scope.successClose=function(){$modalInstance.close(true);};$scope.confirm=function(){$pickConfirmService.confirmShipmentPacking(currentShipment).then(function(successMessage){$scope.successClose();swal({title:"Order Confirmed",text:"",timer:1500,showConfirmButton:false});},function(errorMessage){swal({title:"Order Confirm Failed",text:""});});};}]);
﻿angular.module('pickUpInStore',['ui.bootstrap']).controller('pickUpInStoreCtrl',['$scope','$modal','order','$rootScope','$filter','$q','$state','sendSMTPErrorEmail','pickUpInStore','POSService','printerService','ngTableParams','$interval',function($scope,$modal,$order,$rootScope,$filter,$q,$state,$sendSMTPErrorEmail,$pickUpInStore,$POSService,$printerService,ngTableParams,$interval){$scope.isPrintingPackReceipts=false;$scope.openOrder=function(){if($scope.formInput.orderNo){param={"GetSterlingOrderListReq":{"_ReadFromHistory":"N","_OrderNo":$scope.formInput.orderNo,"_DraftOrderFlag":"N"}};if(angular.isDefined($scope.formInput.orderNo)){$order.getOrderList(param,function(result){if(result===undefined){jQuery('.not-found-alert').modal('show');}else{$scope.openOrderDetail($scope.formInput.orderNo);}},function(error){alert(error);});}}};$scope.batchprintresponseArray={};$scope.batchLength="--";var _refreshBatchPrint=function(){$scope.batchLength="--";$pickUpInStore.getBatchPrintShipmentListArray($POSService.getPOSParameters().storeNumber).then(function(map){$scope.batchprintresponseArray=map;$scope.batchLength=""+Object.keys($scope.batchprintresponseArray).length;});};_refreshBatchPrint();$interval(_refreshBatchPrint,660000);$scope.openOrderDetail=function(orderNo){$order.setSelectedOrder({_OrderNo:orderNo,_DocumentType:"0001"});$state.go("orderDetail");}
$scope.navigateToOrderSearchPage=function(){$state.go("orderSearch");}
$scope.navigateToBopisBackupPick=function(){$state.go("alternatePickAndPack");};var deregisterPrinterErrorEvent=$rootScope.$on('Printer_Error',function(event,errorData){swal({title:"Alert!",text:errorData.StatusText,showConfirmButton:true});});$scope.$on('destroy',function(){deregisterPrinterErrorEvent();});$scope.navigateToPickListPage=function(){$state.go('pickingConfirm');}
$scope.navigateToPackConfirmPage=function(){$state.go('packingConfirm');}
$scope.printPendingReceipts=function(PrintType){if(!$scope.isPrintingPackReceipts){$printerService.claimPrinter().then(function(){$scope.isPrintingPackReceipts=true;var promiseArray=[];for(var key in $scope.batchprintresponseArray){if($scope.batchprintresponseArray.hasOwnProperty(key)){var currentShipment=$scope.batchprintresponseArray[key];if(angular.isDefined(currentShipment)&&angular.isDefined(currentShipment.ShipmentLines)&&angular.isArray(currentShipment.ShipmentLines.ShipmentLine)&&(currentShipment.ShipmentLines.ShipmentLine.length>0)){var OrderNo=currentShipment.ShipmentLines.ShipmentLine[0]._OrderNo;$printerService.printOrder(OrderNo,false,"BOPISPickupReceipt");promiseArray.push($pickUpInStore.changeShipment(currentShipment._ShipmentKey,$POSService.getPOSParameters.storeNumber));}}}
$printerService.releasePrinter();$scope.batchLength="--";$q.all(promiseArray).then(function(){$scope.batchprintresponseArray={};$scope.isPrintingPackReceipts=false;_refreshBatchPrint();},function(){$scope.isPrintingPackReceipts=false;_refreshBatchPrint();});});};};$scope.formInput={orderNo:'',};var handleBarCodeScan=function(event,barcodeData){if(!angular.isString(barcodeData)){barcodeData=(!angular.isDefined(barcodeData)||barcodeData===null)?'':barcodeData.toString().trim();}
$scope.formInput.orderNo=barcodeData.substring(0,9);$scope.openOrder();};var deregister=$scope.$on('Scanner_Event',handleBarCodeScan);$scope.$on("$destroy",function(){deregister();});}]).controller('alternatePickAndPackCtrl',['$scope','$modal','order','$rootScope','$filter','$q','$state','sendSMTPErrorEmail','pickUpInStore','POSService','printerService','ngTableParams','$interval',function($scope,$modal,$order,$rootScope,$filter,$q,$state,$sendSMTPErrorEmail,$pickUpInStore,$POSService,$printerService,ngTableParams,$interval){$scope.isPrintingPackReceipts=false;$scope.goBack=function(){$state.go('pickUpInStore');};$scope.openOrder=function(){if($scope.formInput.orderNo){param={"GetSterlingOrderListReq":{"_ReadFromHistory":"N","_OrderNo":$scope.formInput.orderNo,"_DraftOrderFlag":"N"}};if(angular.isDefined($scope.formInput.orderNo)){$order.getOrderList(param,function(result){if(result===undefined){jQuery('.not-found-alert').modal('show');}else{$scope.openOrderDetail($scope.formInput.orderNo);}},function(error){alert(error);});}}};$scope.batchprintresponseArray={};$scope.batchLength="--";var _refreshBatchPrint=function(){$scope.batchLength="--";$pickUpInStore.getBatchPrintShipmentListArray($POSService.getPOSParameters().storeNumber).then(function(map){$scope.batchprintresponseArray=map;$scope.batchLength=""+Object.keys($scope.batchprintresponseArray).length;});};$interval(_refreshBatchPrint,660000);_refreshBatchPrint();$scope.openOrderDetail=function(orderNo){$order.setSelectedOrder({_OrderNo:orderNo,_DocumentType:"0001"});$state.go("orderDetail");}
$scope.navigateToOrderSearchPage=function(){$state.go("orderSearch");}
var deregisterPrinterErrorEvent=$rootScope.$on('Printer_Error',function(event,errorData){swal({title:"Alert!",text:errorData.StatusText,showConfirmButton:true});});$scope.$on('destroy',function(){deregisterPrinterErrorEvent();});$scope.navigateToPickListPage=function(){$state.go('pickingConfirm');}
$scope.navigateToPackConfirmPage=function(){$state.go('packingConfirm');}
$scope.printPendingReceipts=function(PrintType){if(!$scope.isPrintingPackReceipts){$printerService.claimPrinter().then(function(){$scope.isPrintingPackReceipts=true;var promiseArray=[];for(var key in $scope.batchprintresponseArray){if($scope.batchprintresponseArray.hasOwnProperty(key)){var currentShipment=$scope.batchprintresponseArray[key];if(angular.isDefined(currentShipment)&&angular.isDefined(currentShipment.ShipmentLines)&&angular.isArray(currentShipment.ShipmentLines.ShipmentLine)&&(currentShipment.ShipmentLines.ShipmentLine.length>0)){var OrderNo=currentShipment.ShipmentLines.ShipmentLine[0]._OrderNo;$printerService.printOrder(OrderNo,false,"BOPISPickupReceipt");promiseArray.push($pickUpInStore.changeShipment(currentShipment._ShipmentKey,$POSService.getPOSParameters.storeNumber));}}}
$scope.batchLength="--";$printerService.releasePrinter();$q.all(promiseArray).then(function(){$scope.batchprintresponseArray={};$scope.isPrintingPackReceipts=false;_refreshBatchPrint();},function(){$scope.isPrintingPackReceipts=false;_refreshBatchPrint();});});};};$scope.formInput={orderNo:'',};var handleBarCodeScan=function(event,barcodeData){if(!angular.isString(barcodeData)){barcodeData=(!angular.isDefined(barcodeData)||barcodeData===null)?'':barcodeData.toString().trim();}
$scope.formInput.orderNo=barcodeData.substring(0,9);$scope.openOrder();};var deregister=$scope.$on('Scanner_Event',handleBarCodeScan);$scope.$on("$destroy",function(){deregister();});}]).controller('bopisReportCtrl',['$scope','pickConfirmService','order','$q','$state','pickUpInStore','POSService','ngTableParams',"$filter",function($scope,$pickConfirmService,$order,$q,$state,$pickUpInStore,$POSService,ngTableParams,$filter){$scope.readyforCustomerShipmentresponseArray=[];$scope._loadingReadyForCustomer=false;$scope._loadingPickList=false;$scope._loadingPackList=false;$scope._loadingRestockList=false;$scope.openOrder=function(orderNo){if(orderNo){param={"GetSterlingOrderListReq":{"_ReadFromHistory":"N","_OrderNo":orderNo,"_DraftOrderFlag":"N"}};if(angular.isDefined(orderNo)){$order.getOrderList(param,function(result){if(result===undefined){jQuery('.not-found-alert').modal('show');}else{$scope.openOrderDetail(orderNo);}},function(error){alert(error);});}}};$scope.openOrderDetail=function(orderNo){$order.setSelectedOrder({_OrderNo:orderNo,_DocumentType:"0001"});$state.go("orderDetail");}
$scope.refresh=function(){$scope._loadingReadyForCustomer=true;$scope._loadingPickList=true;$scope._loadingPackList=true;$scope._loadingRestockList=true;$scope.refreshReadyForCustomer();$scope.refreshPickList();$scope.refreshPackList();$scope.getRestockList();};$scope.refreshReadyForCustomer=function(){var storeNumber=$POSService.getPOSParameters().storeNumber;if(storeNumber===null||storeNumber===undefined){return;}
storeNumber=storeNumber.toString();while(storeNumber.length<3){storeNumber="0"+storeNumber;}
$pickUpInStore.getReadyforCustomerShipmentListArray(storeNumber).then(function(arrayResult){$scope.readyforCustomerShipmentresponseArray=arrayResult;$scope._loadingReadyForCustomer=false;});};$scope.orderToPickArr=[];$scope.refreshPickList=function(){var storeNumber=$POSService.getPOSParameters().storeNumber;if(storeNumber===null||storeNumber===undefined){return;}
storeNumber=storeNumber.toString();while(storeNumber.length<3){storeNumber="0"+storeNumber;}
$pickConfirmService.getUnpickedShipmentLines(storeNumber).then(function(rawShipmentLineArr){if(!angular.isArray(rawShipmentLineArr)){swal({title:"Pick List Load Fail",text:"Pick list Sterling Order Data Failed To Load.",confirmButtonText:"OK"});return;}
if(rawShipmentLineArr.length<1){$scope._loadingPickList=false;return;}
$scope.orderToPickArr=$pickConfirmService.getPickingShipmentSummaryDisplay(rawShipmentLineArr);$scope._loadingPickList=false;},function(data){swal({title:"Pick List Load Fail",text:"Pick list Sterling Order Data Failed To Load.",confirmButtonText:"OK"});return data;});};$scope.packList=[];$scope.tableParams=new ngTableParams({page:1,count:100000,sorting:{"_display._OrderNo":"asc"}},{total:$scope.packList.length,counts:[],defaultSort:"asc",getData:function($defer,params){var orderedData=params.sorting()?$filter('orderBy')($scope.packList,params.orderBy()):$scope.packList;$defer.resolve(orderedData.slice((params.page()-1)*params.count(),params.page()*params.count()));}});if($scope.packList.length>0){$scope.tableParams.reload();}
$scope.refreshPackList=function(){var storeNumber=$POSService.getPOSParameters().storeNumber;if(storeNumber===null||storeNumber===undefined){$scope.isLoading=false;return;}
storeNumber=storeNumber.toString();while(storeNumber.length<3){storeNumber="0"+storeNumber;}
$pickConfirmService.getUnConfirmedShipmentList(storeNumber).then(function(dictionaryShipmentNoToShipments){$scope.packList=[];angular.forEach(dictionaryShipmentNoToShipments,function(value,key){var orderno=null;if(value.ShipmentLines&&angular.isArray(value.ShipmentLines.ShipmentLine)&&value.ShipmentLines.ShipmentLine.length>0&&value.ShipmentLines.ShipmentLine[0]._OrderNo){orderno=parseInt(value.ShipmentLines.ShipmentLine[0]._OrderNo);if(!isFinite(orderno)){orderno=null;}}
var displayName=null;if(value.BillToAddress){if(angular.isString(value.BillToAddress._LastName)){displayName=value.BillToAddress._LastName.trim();}
if(angular.isString(value.BillToAddress._FirstName)){displayName+=", "+value.BillToAddress._FirstName.trim();}}
var isReceiptPrinted="No";if(value.Extn&&value.Extn._ExtnBatchPackSlipPrinted){if((/^\s*Y\s*$/i).test(value.Extn._ExtnBatchPackSlipPrinted)){isReceiptPrinted="Yes";}else{isReceiptPrinted="No";}}
value._display={_OrderNo:orderno,_CustomerName:displayName,_IsReceiptPrintedStr:isReceiptPrinted};$scope.packList.push(value);});$scope.tableParams.reload();$scope._loadingPackList=false;},function(data){swal({title:"Pick List Load Fail",text:"Pick list Sterling Order Data Failed To Load.",confirmButtonText:"OK"});return data;});};$scope.restockList=[];$scope.getRestockList=function(){var storeNumber=$POSService.getPOSParameters().storeNumber;if(storeNumber===null||storeNumber===undefined){return;}
storeNumber=storeNumber.toString();while(storeNumber.length<3){storeNumber="0"+storeNumber;}
$pickUpInStore.getListOfShipmentToRestock(storeNumber).then(function(shipmentArray){$scope.restockList=shipmentArray;$scope._loadingRestockList=false;});};$scope.refresh();}]);
﻿angular.module('orderPickup',['ui.bootstrap']).controller('confirmPickupCtrl',['$scope','$modalInstance','$modal','$state','cart','pickUpInStore','POSService','PaymentTerminalService','$timeout','sendSMTPErrorEmail','btProp',function($scope,$modalInstance,$modal,$state,$cart,$pickUpInStore,$POSService,$PaymentTerminalService,$timeout,$sendSMTPErrorEmail,$btProp){$scope.pickup={};$scope.pickup.govtId=false;$scope.pickup.orderConfirmEmail=false;$scope.pickup.paymentTender=false;$scope.pickup.customerName="";var errorMessage="";$scope.disableConfirmButton=false;var isSignatureCaptured=false;var isRetalixReady=false;var isPaymentTerminalReleased=true;$scope.processingConfirm=false;$scope.processingConfirmSuccess=false;var isSignatureCapturedFailed=false;$POSService.getPmmConfigAndStatus().then(function(data){isRetalixReady=(/^\s*true\s*$/i).test(data.UseEPS)?true:false;if(isRetalixReady){claimSigCap();}},function(data){isRetalixReady=false;});$scope.openErrorModal=function(error){$scope.disableConfirmButton=false;swal({title:"Pickup Confirm Error",text:error});};var EventHandler=function(){isPaymentTerminalReleased=true;$PaymentTerminalService.releasePaymentTerminal();}
var lastPmmBopisError=null;var EventHandlerError=function(eventData){isSignatureCapturedFailed=true;$PaymentTerminalService.releasePaymentTerminal();isPaymentTerminalReleased=true;if(!angular.isObject(eventData)){eventDate={StatusText:"There was an error.",eventData:eventData};}
lastPmmBopisError=angular.copy(eventData);var errorString="";if(angular.isString(eventData.StatusText)){errorString+=eventData.StatusText.trim();}
if((/^PMT_ERR_NOT_FUNCTIONAL$/i).test(eventData.StatusCode)){swal({title:"Pickup Confirm Error",text:"Signature capture is not functioning.  Please complete confirmation without Signature."});$sendSMTPErrorEmail(eventData,'PMM - BOPIS Signature Capture Failure');}else if((/^PMT_ERR_SIG_CUST_CANCEL$/i).test(eventData.StatusCode)){swal({title:"Pickup Confirm Error",text:"Signature capture was canceled by the customer.  Please retry."});isSignatureCapturedFailed=false;$scope.cancelConfirmPickup(false);}
else if((/^(PMT_ERR_CLAIMED|PMT_ERR_ENABLED)$/i).test(eventData.StatusCode)){isSignatureCapturedFailed=false;}
else if((/^LUFI_BOPIS_TIMEOUT_ON_CAPTURE$/i).test(eventData.StatusCode))
{swal({title:"Pickup Confirm Error",text:errorString});}
else if((/^(LUFI_BOPIS_WEBSOCKET_DOWN|LUFI_BOPIS_TIMEOUT)$/i).test(eventData.StatusCode))
{errorString+="  Please complete confirmation without Signature.";swal({title:"Pickup Confirm Error",text:errorString});}
else{errorString+="  Please complete confirmation without Signature.";swal({title:"Pickup Confirm Error",text:errorString});$sendSMTPErrorEmail(eventData,'PMM - BOPIS Signature Capture Failure');}};var claimSigCap=function(){isPaymentTerminalReleased=false;var associateId=$POSService.getPOSParameters().associateId;associateId=associateId?associateId:"0";$PaymentTerminalService.getSignature($cart._OrderNo,associateId).then(function(){isSignatureCaptured=true;EventHandler();},function(data){EventHandlerError(data);});};$scope.checkedButtonFont='fa-check fa-2x';$scope.uncheckedButtonFont='fa-check fa-2x whiteText';$scope.checkboxClick=function(inputName){$scope.pickup[inputName]=!$scope.pickup[inputName];};$scope.processConfirmPickup=function(){var idSelected=false;var errorMessage;if($scope.pickup.orderConfirmEmail){idSelected=true;}else if($scope.pickup.govtId){idSelected=true;}else if($scope.pickup.paymentTender){idSelected=true;}
if(!idSelected){errorMessage="Please confirm the selection of the identification method that the customer presented.";}
else if($scope.pickup.customerName===undefined||$scope.pickup.customerName===null||$scope.pickup.customerName.toString().trim()==""){errorMessage="Please enter the customer's name.";}
if(angular.isDefined(errorMessage)&&errorMessage!=""){$scope.openErrorModal(errorMessage);return;}else{$scope.disableConfirmButton=true;var orderNo=$cart._OrderNo;var shipNode=$POSService.getPOSParameters().storeNumber;var IdType="";var designee="";if($scope.pickup.govtId){IdType="Government ID";}
if($scope.pickup.orderConfirmEmail){IdType="Order Confirmation Email";}
if($scope.pickup.paymentTender){IdType="Payment Tender";}
if(!angular.isArray($cart.Shipments.Shipment)){$cart.Shipments.Shipment=[$cart.Shipments.Shipment];}
var shipmentKey="";for(var it=0;it<$cart.Shipments.Shipment.length;it++){var currentShipmentShipNodeInt=parseInt($cart.Shipments.Shipment[it]._ShipNode);if(isFinite(currentShipmentShipNodeInt)&&(parseInt(shipNode)===currentShipmentShipNodeInt)&&(/^\s*BOPIS\s*$/i).test($cart.Shipments.Shipment[it]._ShipmentType)){shipmentKey=$cart.Shipments.Shipment[it]._ShipmentKey;break;}}
if(shipmentKey===null||shipmentKey===undefined||(shipmentKey.toString().trim().length<1)){errorMessage="No shipment in this order matches your current store number: "+shipNode;$scope.openErrorModal(errorMessage);return;}
if(angular.isDefined($scope.pickup.customerName)){designee=$scope.pickup.customerName;}
if(!isRetalixReady||(isRetalixReady&&(isSignatureCaptured||isSignatureCapturedFailed))){$scope.processingConfirm=true;if(isRetalixReady&&isSignatureCapturedFailed){$sendSMTPErrorEmail(lastPmmBopisError,'PMM - BOPIS Confirmed without Signature',null,"Confirmed BOPIS OrderNo: "+orderNo+" without collecting a signature on a Retalix ready system.",$btProp.getProp('bopisFailedSigCapEmailList'));}
$pickUpInStore.changeShipmentStatus(orderNo,shipmentKey,designee,IdType,shipNode).then(function(){$scope.processingConfirmSuccess=true;$timeout(function(){$scope.modalCloseSuccess();},3000);},function(){$scope.processingConfirm=false;$scope.processingConfirmSuccess=false;$scope.openErrorModal("Failed to update shipment status. Please try again.");});}else{$scope.openErrorModal("Please have the customer sign for the merchandise.");}}};$scope.cancelConfirmPickup=function(isSuccessfulConfirm){if(!isPaymentTerminalReleased){$PaymentTerminalService.releasePaymentTerminal();}
if(isSuccessfulConfirm){$modalInstance.close();}else{$modalInstance.dismiss('closed');}};$scope.modalCloseSuccess=function(){$scope.cancelConfirmPickup(true);};}]).controller('confirmPickupErrorCtrl',['$scope','$modalInstance','currentError',function($scope,$modalInstance,currentError){$scope.currentError=currentError;$scope.close=function(){$modalInstance.dismiss('closed');};}]);