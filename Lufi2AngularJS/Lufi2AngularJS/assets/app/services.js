
﻿var app=angular.module('app',['ui.router','ngAnimate','angularUtils.directives.uiBreadcrumbs','home','index','swipeCard','itemSearch','itemResults','itemDetail','itemLocate','customerSearch','customerDetail','modifyCustomer','orderSearch','orderCart','shippingSelection','coupons','ui.bootstrap','paymentsummary','appDirectives','appFilters','orderDetail','appServicesCustomer','appServicesPayment','appServicesOrder','appServicesItem','appServicesWebSocket','appServicesAnnouncements','appUtilities','appServicespickUpInStore','propertiesService','appServicesCommonCode','ngSanitize','appServiceOrderCart','appServicesGiftRegistry','appServiceReprice','addModifyAddress','appServiceAppState','orderNote','returnSummary','pickUpInStore','orderPickup','pickingConfirm','packConfirm','ngclipboard']);app.controller('appCtrl',['$scope','securityService',function($scope,$securityService){$scope.isCsr=function(){return $securityService.isCsr();};}]);app.controller('footerCtrl',['$scope','btProp',function($scope,btProp){$scope.footerText=btProp.getProp('btFooterText');}]);app.controller('breadCtl',['$scope',function($scope){}]);app.controller('checkoutProgressCtl',['$scope',function($scope){$scope.checkoutDisplay=false;$scope.progressSteps=[{display:'Home',routerstate:'home',isFinished:true,isActive:false,isHideOnClick:true},{display:'Cart',routerstate:'orderCart',isFinished:true,isActive:false,isHideOnClick:false},{display:'Customer Info',routerstate:'customerSearch',isFinished:true,isActive:true},{display:'Shipping',routerstate:'shippingSelection',isFinished:false,isActive:false},{display:'Payment',routerstate:'paymentSummary',isFinished:false,isActive:false}];$scope.isCouponLinkAdded=false;$scope.$on('breadCrumbReset',function(event,args){$scope.checkoutDisplay=false;$scope.progressSteps[3].isFinished=false;$scope.progressSteps[3].isActive=false;$scope.progressSteps[4].isFinished=false;$scope.progressSteps[4].isActive=false;});$scope.$on('$stateChangeSuccess',function(event,toState,toParams,fromState,fromParams){var stateName=toState.name;});}]);var loadingIcon={isLockedBusyIcon:false,showBusyIcon:function showBusyIcon(){$('#loadDIV').show();},hideBusyIcon:function(){if(!loadingIcon.isLockedBusyIcon){$('#loadDIV').hide();}},resetIcon:function(){loadingIcon.isLockedBusyIcon=false;loadingIcon.hideBusyIcon();}};app.config(['$httpProvider','$stateProvider','$urlRouterProvider',function($httpProvider,$stateProvider,$urlRouterProvider){delete $httpProvider.defaults.headers.common["X-Requested-With"];$httpProvider.defaults.useXDomain=true;$httpProvider.interceptors.push(['$q','$log','loadingIconService',function($q,$log,$loadingIconService){function setCustomHeaders(config){if(xAuth&&(config.url.indexOf('http://broker')>-1||config.url.indexOf('https://broker')>-1)){config.headers['X-Auth-Token']=xAuth;}}
loadingIcon.resetIcon();return{request:function(config){loadingIcon.showBusyIcon();setCustomHeaders(config);return config||$q.when(config);},requestError:function(request){loadingIcon.hideBusyIcon();return $q.reject(request);},response:function(response){loadingIcon.hideBusyIcon();return response||$q.when(response);},responseError:function(response){loadingIcon.hideBusyIcon();$log.error(response);if(response.status===401)
alert(response)
return $q.reject(response);}};}]);$stateProvider.state('home',{url:'/home',views:{'main@':{templateUrl:'Home.html',controller:'homeCtrl',}},data:{displayName:'Home',isBreadCrumbDisplay:true}}).state('orderSearch',{url:'/orderSearch',views:{'main@':{templateUrl:'html/order/orderSearch.html',controller:'orderSearchCtrl',}},data:{displayName:'Order Search',isBreadCrumbDisplay:true}}).state('orderDetail',{url:'/orderDetail',views:{'main@':{templateUrl:'html/order/orderDetail.html',controller:'orderDetailCtrl',}},data:{displayName:'Order Detail',isBreadCrumbDisplay:true}}).state('orderNote',{url:'/orderNote/:orderLineNo',views:{'main@':{templateUrl:'html/order/orderNote.html',controller:'orderNoteCtrl',isBreadCrumbDisplay:true}},data:{displayName:'Order Note',isBreadCrumbDisplay:true}}).state('returnSummary',{url:'/returnSummary',views:{'main@':{templateUrl:'html/order/returnSummary.html',controller:'returnSummaryCtrl',isBreadCrumbDisplay:true}},data:{displayName:'Returns',isBreadCrumbDisplay:true}}).state('itemSearch',{url:'/itemSearch',views:{'main@':{templateUrl:'html/item/itemSearch.html',controller:'itemSearchCtrl',}},data:{displayName:'Item Search',isBreadCrumbDisplay:true}}).state('itemSearchupc',{url:'/itemSearch/upc/:upc',views:{'main@':{templateUrl:'html/item/itemSearch.html',controller:'itemSearchCtrl',}},data:{displayName:'Item Search',isBreadCrumbDisplay:true}}).state('itemResults',{url:'/itemResults',views:{'main@':{templateUrl:'html/item/itemResults.html',controller:'itemResultsCtrl'}},data:{displayName:'Item Results',isBreadCrumbDisplay:true}}).state('coupons',{url:'/coupons',views:{'main@':{templateUrl:'html/coupons/coupons.html',controller:'couponCtrl',}},data:{displayName:'Coupon Summary',isBreadCrumbDisplay:true}}).state('itemLocate',{url:'/itemLocate',views:{'main@':{templateUrl:'html/item/itemLocate.html',controller:'itemLocateCtrl',}},data:{displayName:'Item Locate',isBreadCrumbDisplay:true}}).state('itemDetail',{url:'/itemDetail',views:{'main@':{templateUrl:'html/item/itemDetail.html',controller:'itemDetailCtrl',}},data:{displayName:'Item Detail',isBreadCrumbDisplay:true}}).state('paymentSummary',{url:'/paymentSummary',views:{'main@':{templateUrl:'html/payment/paymentSummary.html',controller:'paymentSummaryCtrl',}},data:{displayName:'Payment',isBreadCrumbDisplay:true}}).state('orderCart',{url:'/orderCart/:loadDraft',views:{'main@':{templateUrl:'orderCart.html',controller:'orderCartCtrl',}},data:{displayName:'Order Cart',isBreadCrumbDisplay:true}}).state('addModifyAddress',{url:'/addModifyAddress/:customerContactID/:customerAdditionalAddressID',views:{'main@':{templateUrl:'html/customer/addModifyAddress.html',controller:'addModifyAddressCtrl',}},data:{displayName:'Modify Address',}}).state('customerSearch',{url:'/customerSearch',views:{'main@':{templateUrl:'html/customer/customerSearch.html',controller:'customerSearchCtrl',}},data:{displayName:'Customer Search',isBreadCrumbDisplay:true}}).state('customerDetail',{url:'/customerDetail',views:{'main@':{templateUrl:'html/customer/customerDetail.html',controller:'customerDetailCtrl',}},data:{displayName:'Customer Detail',isBreadCrumbDisplay:true}}).state('shippingSelection',{url:'/shippingSelection',views:{'main@':{templateUrl:'shippingSelection.html',controller:'shippingSelectionCtrl',}},data:{displayName:'Shipping Selection',isBreadCrumbDisplay:false}}).state('pickUpInStore',{url:'/pickUpInStore',views:{'main@':{templateUrl:'html/pickUpInStore/pickUpInStore.html',controller:'pickUpInStoreCtrl',}},data:{displayName:'Pick Up In Store',isBreadCrumbDisplay:true}}).state('alternatePickAndPack',{url:'/AlternatePickAndPack',views:{'main@':{templateUrl:'html/pickUpInStore/alternatePickAndPack.html',controller:'alternatePickAndPackCtrl',}},data:{displayName:'Alternate Pick & Pack',isBreadCrumbDisplay:true}}).state('pickingConfirm',{url:'/pickList',views:{'main@':{templateUrl:'html/pickUpInStore/pickingConfirm.html',controller:'pickingConfirmCtrl',}},data:{displayName:'Pick List',isBreadCrumbDisplay:true}}).state('confirmPickup',{url:'/confirmPickup',views:{'main@':{templateUrl:'html/pickUpInStore/confirmPickupModal.html',controller:'pickUpInStoreCtrl',}},data:{displayName:'Confirm Pick up In Store',isBreadCrumbDisplay:false}}).state('packingConfirm',{url:'/packConfirmation',views:{'main@':{templateUrl:'html/pickUpInStore/packConfirm.html',controller:'packConfirmCtrl',}},data:{displayName:'Pack Confirm',isBreadCrumbDisplay:true}}).state('bopisReport',{url:'/bopisReport',views:{'main@':{templateUrl:'html/pickUpInStore/bopisReport.html',controller:'bopisReportCtrl',}},data:{displayName:'Bopis Report',isBreadCrumbDisplay:true}})
$urlRouterProvider.otherwise('/home');}]);
﻿angular.module('appDirectives',[]).directive("btFocus",['$timeout',function($timeout){return function(scope,element){$timeout(function(){element[0].focus();});}}]).directive('onFinishRender',['$timeout',function($timeout){return{restrict:'A',link:function(scope,element,attr){if(scope.$last===true){scope.$evalAsync(attr.onFinishRender);}}}}]).directive('uiCheckoutProgress',['$state',function($state){return{restrict:'E',templateUrl:'checkoutStepProgress.tpl.html',scope:{steps:"=stepobjectarray",isCheckoutProgressDisplay:"=isstepdisplay"},link:function(scope,element,attrs){if(angular.isDefined(scope.isCheckoutProgressDisplay)){scope.isCheckoutProgressDisplay=!!scope.isCheckoutProgressDisplay;}else{scope.isCheckoutProgressDisplay=false;}
scope.olClass='progtrckr'+scope.steps.length;scope.alwaysBlur=function(event){$(event.target).each(function(){this.blur()});};scope.activate=function(step){angular.forEach(scope.steps,function(step){if(angular.isObject(step)){step.isActive=false;}});step.isActive=true;};scope.$on('$stateChangeSuccess',function(event,toState,toParams,fromState,fromParams){var stateName=$state.current.name;var currentStepIndex=-1;for(var i=0;i<scope.steps.length;i++){if(scope.steps[i].routerstate===stateName){if(scope.steps[i].isHideOnClick){scope.isCheckoutProgressDisplay=false;}}
if(scope.steps[i].routerstate===stateName){currentStepIndex=i;}}
for(var i=0;i<scope.steps.length;i++){if(i<=currentStepIndex){scope.steps[i].isFinished=true;}
if(currentStepIndex>=0){if(i===currentStepIndex){scope.steps[i].isActive=true;}else{scope.steps[i].isActive=false;}}}});scope.$on('uiCheckoutStepProgressDisplay',function(event,args){scope.isCheckoutProgressDisplay=!!args.display;});scope.$on('uiCheckoutStepProgressUpdate',function(event,args){scope.olClass='progtrckr'+scope.steps.length;});}};}]).directive('customeraddress',function(){var directive={};directive.restrict='E';directive.templateUrl="html/customer/customerAddress.html";directive.scope={address:"=address",addressclass:"=addressclass"}
return directive;}).directive("iscrolltap",function(){return{link:function(scope,element,attrs){var propExpression=attrs["iscrolltap"];element.on('tap',function(){scope.$eval(propExpression)});},restrict:"A"}}).directive('iscroll',function(){return{replace:false,restrict:'A',link:function(scope,element,attr){var ngiScroll_timeout=5;var ngiScroll_opts={mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip',probeType:3};var scroll_key=attr.iscroll;if(scroll_key===''){scroll_key=attr.id;}
if(scope.myScrollOptions){for(var i in scope.myScrollOptions){if(typeof(scope.myScrollOptions[i])!=="object"){ngiScroll_opts[i]=scope.myScrollOptions[i];}else if(i===scroll_key){for(var k in scope.myScrollOptions[i]){ngiScroll_opts[k]=scope.myScrollOptions[i][k];}}}}
function setScroll(){if(scope.$parent.myScroll===undefined){scope.$parent.myScroll=[];}
scope.$parent.myScroll[scroll_key]=new IScroll(element[0],ngiScroll_opts);scope.$parent.myScroll[scroll_key].enableStickyHeaders('thead');}
if(attr.ngIscrollDelay!==undefined){ngiScroll_timeout=attr.ngIscrollDelay;}
scope.$watch(attr.iscroll,function(){setTimeout(setScroll,ngiScroll_timeout);});if(attr.ngIscrollRefresher!==undefined){scope.$watch(attr.ngIscrollRefresher,function(){if(scope.$parent.myScroll[scroll_key]!==undefined)scope.$parent.myScroll[scroll_key].refresh();});}
scope.$on('$destroy',function(){scope.$parent.myScroll[scroll_key].destroy();});}};});
﻿var appServices=angular.module('appServicesCustomer',[]);appServices.factory('customer',['$http','$cacheFactory','serviceArrayFix','$rootScope','isPoBoxAddress','loggerService','sendSMTPErrorEmail','$filter',function($http,$cacheFactory,serviceArrayFix,$rootScope,$isPoBoxAddress,$loggerService,$sendSMTPErrorEmail,$filter){var cache=$cacheFactory('customer');var _definedSuccessError=function(functionDef){if(!angular.isFunction(functionDef)){functionDef=function(){};}
return functionDef;};var customerSearch=function(queryParam,success,error){success=_definedSuccessError(success);error=_definedSuccessError(error);var url=serviceURL+"/customerSearchJSON";$http.post(url,angular.toJson(queryParam)).success(function(data){var response=angular.fromJson(data);var customerArray=[];if(!angular.isArray(response.Customer.Addresses)){response.Customer.Addresses=[response.Customer.Addresses.Address];}
response.Customer.Addresses.forEach(function(address){if(address.IsDefaultBillTo=='Y'){customerArray.push(address);}});response.Customer.Addresses.forEach(function(address){if(address.IsDefaultShipTo=='Y'&&customerArray.indexOf(address)==-1){customerArray.push(address);}});response.Customer.Addresses.forEach(function(address){if(address.CustomerKey.trim().length>0&&customerArray.indexOf(address)==-1){customerArray.push(address);}});response.Customer.Addresses.forEach(function(address){if(customerArray.indexOf(address)==-1){customerArray.push(address);}});cache.put('cachedResult',customerArray);cache.put('queryParam',queryParam);success(customerArray);}).error(function(data){error(data);});};var _clearResultsOnly=function(){cache.remove('cachedResult');};var clearCachedResult=function(){_clearResultsOnly();cache.remove('queryParam');}
var clearSelectedCustomer=function(){var previousCustomer=getSelectedCustomer();clearCachedResult();cache.remove('selectedCustomer');$rootScope.$broadcast('selectedCustomerCleared',previousCustomer);};var setSelectedCustomer=function(customer){$loggerService.log(customer);cache.put('selectedCustomer',customer);$rootScope.$broadcast('customerSelected',customer);}
var normalizeCustomers=function(response){var customers={};if(!angular.isArray(response.Customer.Addresses)){response.Customer.Addresses=[response.Customer.Addresses.Address];}
response.Customer.Addresses.forEach(function(address){if(address.CustomerId.trim().length>0){if(!customers[address.CustomerId]){customers[address.CustomerId]={addresses:[]};}
var customer=customers[address.CustomerId];if(address.IsDefaultShipTo=='Y'){customer.defaultShipToAddress=address;}
if(address.IsDefaultBillTo=='Y'){customer.defaultBillToAddress=address;}
customer.addresses.push(address);}});var customerArray=[];for(key in customers){var customer=customers[key];if(customer.defaultBillToAddress){customerArray.push(customer);}}
var customerArray=[];for(key in customers){var customer=customers[key];if(customer.defaultBillToAddress){customerArray.push(customer);}}
return customerArray;}
var getSelectedCustomer=function(){return cache.get('selectedCustomer');}
var retrieveOrders=function(orderType,success,error){success=_definedSuccessError(success);error=_definedSuccessError(error);var selectedCustomer=cache.get('selectedCustomer');if(selectedCustomer){if(selectedCustomer[orderType]){success(selectedCustomer[orderType]);}else{var contract={"GetSterlingOrderListReq":{"_ReadFromHistory":"N","_DocumentType":"","_DraftOrderFlag":"","_BillToID":selectedCustomer._CustomerID,"_BillToIDQryType":"EQ"}};var url=serviceURL+"/Order/GetOrderListJSON";switch(orderType){case'draftOrders':contract.GetSterlingOrderListReq._DocumentType='0001';contract.GetSterlingOrderListReq._DraftOrderFlag='Y';break;case'confirmOrders':contract.GetSterlingOrderListReq._DocumentType='0001';contract.GetSterlingOrderListReq._DraftOrderFlag='N';break;case'returnOrders':contract.GetSterlingOrderListReq._DocumentType='0003';contract.GetSterlingOrderListReq._DraftOrderFlag='';break;}
$http.post(url,contract).success(function(data){serviceArrayFix(data);var ordersArr=data.GetSterlingOrderListResp.Order?data.GetSterlingOrderListResp.Order:[];selectedCustomer[orderType]=ordersArr;success(ordersArr);}).error(function(data){$sendSMTPErrorEmail(data,url,contract);serviceArrayFix(data);error(data);})}}else{error("No Customer Selected. Use Customer Search first.");}};$rootScope.$on('$stateChangeSuccess',function(event,toState,toParams,fromState,fromParams){var stateName=toState.name;if(stateName==='home'){var selectedCustomer=cache.get('selectedCustomer');if(selectedCustomer){selectedCustomer.draftOrders=false;selectedCustomer.confirmOrders=false;selectedCustomer.returnOrders=false;}}});var retrieveDraftOrders=function(success,error){success=_definedSuccessError(success);error=_definedSuccessError(error);retrieveOrders('draftOrders',success,error);}
var retrieveConfirmedOrders=function(success,error){success=_definedSuccessError(success);error=_definedSuccessError(error);retrieveOrders('confirmOrders',success,error);}
var retrieveReturnOrders=function(success,error){success=_definedSuccessError(success);error=_definedSuccessError(error);retrieveOrders('returnOrders',success,error);}
var getCachedResult=function(){return cache.get('cachedResult');};var getCachedQueryParam=function(){return cache.get('queryParam');};var manageCustomerUrl=serviceURL+"/Customer/manage";var createCustomer=function(customer){var url=manageCustomerUrl;if(isFinite(parseInt(customer.Zipcode))){customer.Zipcode=parseInt(customer.Zipcode);}
var contract={manageCustomerReq:{input:{CustomerContactList:{CustomerContact:[{CustomerAdditionalAddressList:{CustomerAdditionalAddress:[{PersonInfo:{_AddressLine1:customer.AddressLine1,_AddressLine2:customer.AddressLine2,_AddressLine3:customer.AddressLine3,_City:customer.City,_Country:customer.Country,_IsCommercialAddress:"N",_Lockid:"0",_State:customer.State,_UseCount:"0",_ZipCode:customer.Zipcode,_isHistory:"N",_EmailID:customer.EmailAddress,_PersonInfoKey:customer.PersonInfoKey},_IsBillTo:"Y",_IsDefaultBillTo:"Y",_IsDefaultShipTo:"Y",_IsShipTo:"Y"}],_Reset:"Y"},_DateOfBirth:"",_DayFaxNo:"",_DayPhone:$filter('phoneFormatRemove')(customer.DayPhone),_Department:"Legends",_EmailID:customer.EmailAddress,_EveningFaxNo:"",_EveningPhone:"",_FirstName:customer.FirstName,_JobTitle:"",_LastName:customer.LastName,_MiddleName:customer.MiddleName,_MobilePhone:"",_SpouseDateOfBirth:"",_Title:"",_UserID:"",_WeddingAnniversaryDate:""}]},_CustomerType:"02",_OrganizationCode:"BONTON",_Status:"10"}}}
return $http.post(url,angular.toJson(contract));}
var retrieveCustomerDetail=function(customerId,customerKey,success,error){success=_definedSuccessError(success);error=_definedSuccessError(error);var url=serviceURL+"/Customer/getDetails";var contract={getCustomerDetailsReq:{input:{_CustomerID:customerId,_CustomerKey:customerKey,_InheritFromParents:"?",_OrganizationCode:"BONTON",CustomerContact:{_CustomerContactID:"",_UserID:""}}}};$http.post(url,angular.toJson(contract)).success(function(data){var customer=angular.fromJson(data).getCustomerDetailsResponse.Customer;serviceArrayFix(customer);setSelectedCustomer(customer);setDefaultBillToShipTo(customer);success(customer);}).error(function(data){$sendSMTPErrorEmail(data,url,contract);error(data);});}
var customerAction=function(customer,success,error){success=_definedSuccessError(success);error=_definedSuccessError(error);if(customer.CustomerId.trim().length==0||customer.CustomerKey.trim().length==0){createCustomer(customer).success(function(data){var response=angular.fromJson(data);var customerKey=response.manageCustomerResp.return._CustomerKey;var customerId=response.manageCustomerResp.return._CustomerID;customer.CustomerId=customerId;customer.CustomerKey=customerKey;_clearResultsOnly();retrieveCustomerDetail(customerId,customerKey,success,error);}).error(function(data){$sendSMTPErrorEmail(data,manageCustomerUrl,customer);error(data);});}else{retrieveCustomerDetail(customer.CustomerId,customer.CustomerKey,success,error);}};var addToCart=function(customer){if(customer){setSelectedCustomer(customer);}else{customer=getSelectedCustomer();}
$rootScope.$broadcast('AddCustomerToCartCalled',customer);}
var setDefaultBillToShipTo=function(customer){var defaultAddresses={};defaultAddresses['PersonInfoBillTo']=null;defaultAddresses['PersonInfoShipTo']=null;var isDefaultsFound=false;var contacts=customer.CustomerContactList.CustomerContact;for(var i=0;(i<contacts.length)&&!isDefaultsFound;i++){var contact=contacts[i];if(angular.isObject(contact)&&angular.isObject(contact.CustomerAdditionalAddressList)&&angular.isArray(contact.CustomerAdditionalAddressList.CustomerAdditionalAddress)){var addresses=contact.CustomerAdditionalAddressList.CustomerAdditionalAddress;for(var j=0;(j<addresses.length)&&!isDefaultsFound;j++){var address=addresses[j];if(address._IsDefaultBillTo=="Y"){defaultAddresses['PersonInfoBillTo']=address.PersonInfo;}
if(address._IsDefaultShipTo=="Y"){defaultAddresses['PersonInfoShipTo']=address.PersonInfo;}
if(defaultAddresses['PersonInfoBillTo']!==null&&defaultAddresses['PersonInfoShipTo']!==null){isDefaultsFound=true;}}}}
if(!isDefaultsFound){var contact=contacts[0];if(angular.isObject(contact)&&angular.isObject(contact.CustomerAdditionalAddressList)&&angular.isArray(contact.CustomerAdditionalAddressList.CustomerAdditionalAddress)&&contact.CustomerAdditionalAddressList.CustomerAdditionalAddress.length>0){var address=contact.CustomerAdditionalAddressList.CustomerAdditionalAddress[0];if(defaultAddresses['PersonInfoBillTo']===null){defaultAddresses['PersonInfoBillTo']=address.PersonInfo;}
if(defaultAddresses['PersonInfoShipTo']===null){defaultAddresses['PersonInfoShipTo']=address.PersonInfo;}}}
customer.defaultAddresses=defaultAddresses;}
var isCustomerSelected=function(){return getSelectedCustomer()!=undefined;}
var _setDefaults=function(customer,contactID,modifiedAddress){var isNewDefaultBillTo=modifiedAddress._IsDefaultBillTo=='Y';var isNewDefaultShipTo=modifiedAddress._IsDefaultShipTo=='Y';var selectedContact=null;for(var i=0;i<customer.CustomerContactList.CustomerContact.length;i++){if(customer.CustomerContactList.CustomerContact[i]._CustomerContactID==contactID){selectedContact=customer.CustomerContactList.CustomerContact[i];break;}}
if(selectedContact){for(var i=0;i<selectedContact.CustomerAdditionalAddressList.CustomerAdditionalAddress.length;i++){if(selectedContact.CustomerAdditionalAddressList.CustomerAdditionalAddress[i]._CustomerAdditionalAddressID==modifiedAddress._CustomerAdditionalAddressID){selectedContact.CustomerAdditionalAddressList.CustomerAdditionalAddress[i]._IsDefaultBillTo=isNewDefaultBillTo?'Y':'N';selectedContact.CustomerAdditionalAddressList.CustomerAdditionalAddress[i]._IsDefaultShipTo=isNewDefaultShipTo?'Y':'N';}else{if(isNewDefaultBillTo){selectedContact.CustomerAdditionalAddressList.CustomerAdditionalAddress[i]._IsDefaultBillTo='N';}
if(isNewDefaultShipTo){selectedContact.CustomerAdditionalAddressList.CustomerAdditionalAddress[i]._IsDefaultShipTo='N';}}}}
return customer;};var verifyCustomerAddress=function(address,success,error){success=_definedSuccessError(success);error=_definedSuccessError(error);var url=serviceURL+"/Utility/AVS/DoSearch";var contract={AVSInput:{QASearch:{Country:"USA",Engine:{_Flatten:"true",_Intensity:"Close",_PromptSet:"Default",_Threshold:"100","#text":"Verification",},"Layout":"Database layout","Search":address,"FormattedAddressInPicklist":"false","_Localisation":"USA"}}}
return $http.post(url,angular.toJson(contract),{timeout:12000}).success(function(data){}).error(function(data){$sendSMTPErrorEmail(data,url);error(data.err);});};var verifySelectedAddress=function(Moniker,success,error){success=_definedSuccessError(success);error=_definedSuccessError(error);var url=serviceURL+"/Utility/AVS/DoGetAddress";var contract={AVSInput:{QAGetAddress:{"_Localisation":"USA","Layout":{"#text":"Database layout"},"Moniker":Moniker,}}}
return $http.post(url,angular.toJson(contract)).success(function(data){}).error(function(data){$sendSMTPErrorEmail(data,url,contract);error(data.err);});};var verifyEmail=function(email,success,error){success=_definedSuccessError(success);error=_definedSuccessError(error);var url=serviceURL+"/Validate/Email";var contract={Email:email,Timeout:"3"}
return $http.post(url,angular.toJson(contract),{timeout:12000}).success(function(data){}).error(function(data){$sendSMTPErrorEmail(data,url);error(data.err);});};var _cleanAddress=function(modifiedAddress){for(key in modifiedAddress){if(!angular.isDefined(modifiedAddress[key])||modifiedAddress[key]===null){try{delete modifiedAddress[key];}catch(e){}}}
for(key in modifiedAddress.PersonInfo){if(!angular.isDefined(modifiedAddress.PersonInfo[key])||modifiedAddress.PersonInfo[key]===null){try{delete modifiedAddress.PersonInfo[key];}catch(e){}}}};var createCustomerByAddress=function(modifiedAddress,success,error){success=_definedSuccessError(success);error=_definedSuccessError(error);_cleanAddress(modifiedAddress);modifiedAddress._AddressType="SB";modifiedAddress._CustomerAdditionalAddressID="";modifiedAddress._IsBillTo="Y";modifiedAddress._IsDefaultBillTo="Y";modifiedAddress._IsDefaultShipTo="Y";modifiedAddress._IsShipTo="Y";modifiedAddress._Operation="";var input={"manageCustomerReq":{"input":{"_CustomerID":"","_CustomerKey":"","_CustomerType":"02","_OrganizationCode":"BONTON","_Status":"10","CustomerContactList":{"CustomerContact":[{"_CustomerContactID":"","CustomerAdditionalAddressList":{"CustomerAdditionalAddress":[modifiedAddress]},"_DateOfBirth":"","_DayFaxNo":"","_DayPhone":$filter('phoneFormatRemove')(modifiedAddress.PersonInfo._DayPhone),"_Department":"","_EmailID":modifiedAddress.PersonInfo._EMailID,"_EveningFaxNo":"","_EveningPhone":$filter('phoneFormatRemove')(modifiedAddress.PersonInfo._EveningPhone),"_FirstName":modifiedAddress.PersonInfo._FirstName,"_JobTitle":"","_LastName":modifiedAddress.PersonInfo._LastName,"_MiddleName":modifiedAddress.PersonInfo._MiddleName,"_MobilePhone":"","_SpouseDateOfBirth":"","_Title":"","_UserID":"","_WeddingAnniversaryDate":""}]}}}};$http.post(manageCustomerUrl,input).success(function(data){var result=data.manageCustomerResp.return;retrieveCustomerDetail(result._CustomerID,result._CustomerKey,success,error);}).error(function(data){$sendSMTPErrorEmail(data,url,input);error(data);});};var _validAddress=function(address,isBillingAddress){isBillingAddress=isBillingAddress?isBillingAddress:false;var valid=true;var rollingErrorTextArray=[];if(!angular.isDefined(address)||address===null){return{isValid:false,errorMessage:'No Address Defined.'};}
if(angular.isDefined(address.PersonInfo)){address=address.PersonInfo;}
if(!angular.isDefined(address._FirstName)||address._FirstName===null||address._FirstName.toString().trim()===''){valid=false;rollingErrorTextArray.push('No First Name');}
if(!angular.isDefined(address._LastName)||address._LastName===null||address._LastName.toString().trim()===''){valid=false;rollingErrorTextArray.push('No Last Name');}
if(!angular.isDefined(address._EMailID)||address._EMailID===null||address._EMailID.toString().trim()===''){valid=false;rollingErrorTextArray.push('No Email');}
if(!angular.isDefined(address._DayPhone)||address._DayPhone===null||address._DayPhone.toString().trim()===''){valid=false;rollingErrorTextArray.push('No Primary Phone');}
if(!angular.isDefined(address._AddressLine1)||address._AddressLine1===null||address._AddressLine1.toString().trim()===''){valid=false;rollingErrorTextArray.push('No Address Line 1');}
if(!angular.isDefined(address._Country)||address._Country===null||address._Country.toString().trim()===''){valid=false;rollingErrorTextArray.push('No Country');}
if(!isBillingAddress||(angular.isDefined(address._Country)&&address._Country!==null&&(/^us$/).test(address._Country.toString().trim().toLowerCase()))){if(!isBillingAddress&&angular.isDefined(address._Country)&&address._Country!==null&&!((/^us$/).test(address._Country.toString().trim().toLowerCase()))){valid=false;rollingErrorTextArray.push('Ship Country ('+address._Country+') not US');}
if(!angular.isDefined(address._City)||address._City===null||address._City.toString().trim()===''){valid=false;rollingErrorTextArray.push('No City');}
if(!angular.isDefined(address._State)||address._State===null||address._State.toString().trim()===''){valid=false;rollingErrorTextArray.push('No State');}
if(angular.isDefined(address._State)&&address._State!==null&&!((/^[a-zA-Z]{2}$/).test(address._State.toString()))){valid=false;rollingErrorTextArray.push('State ('+address._State+') not state abbreviation');}
if(!isBillingAddress&&angular.isDefined(address._State)&&address._State!==null&&((/^(aa|ae|ap)$/).test(address._State.toString().toLowerCase()))){valid=false;rollingErrorTextArray.push('Cannot Ship by military or diplomatic post: ('+address._State+') ');}
if(!angular.isDefined(address._ZipCode)||address._ZipCode===null||address._ZipCode.toString().trim()===''){valid=false;rollingErrorTextArray.push('No Zip Code');}
if(angular.isDefined(address._ZipCode)&&address._ZipCode!==null&&!((/^[0-9]{5}$/).test(address._ZipCode.toString().trim()))){valid=false;rollingErrorTextArray.push('5 Digit Zip Code Only');}
if(!isBillingAddress&&angular.isDefined(address._AddressLine1)&&address._AddressLine1!==null&&$isPoBoxAddress(address)){valid=false;rollingErrorTextArray.push('Cannot Ship to PO Box');}}
return{isValid:valid,errorMessage:rollingErrorTextArray.join(', ')};};var updateCustomerContact=function(customer,success,error){success=_definedSuccessError(success);error=_definedSuccessError(error);var copyCustomer=angular.copy(customer);if(copyCustomer.CustomerContactList&&angular.isArray(copyCustomer.CustomerContactList.CustomerContact)){for(var i=0;i<copyCustomer.CustomerContactList.CustomerContact.length;i++){var currentContact=copyCustomer.CustomerContactList.CustomerContact[i];if('CustomerAdditionalAddressList'in currentContact){delete currentContact.CustomerAdditionalAddressList;}}
if('defaultAddresses'in copyCustomer){delete copyCustomer.defaultAddresses;}
var input={manageCustomerReq:{input:copyCustomer}};$http.post(manageCustomerUrl,input).success(function(data){var result=data.manageCustomerResp.return;retrieveCustomerDetail(result._CustomerID,result._CustomerKey,success,error);}).error(function(data){$sendSMTPErrorEmail(data,manageCustomerUrl,input);error(data);});}};var addModifyAddress=function(customerID,customerContactID,modifiedAddress,success,error){success=_definedSuccessError(success);error=_definedSuccessError(error);var customer=angular.copy(getSelectedCustomer());_cleanAddress(modifiedAddress);var resultValidBusiness=_validAddress(modifiedAddress,true);var resultValidShipping=_validAddress(modifiedAddress,false);if(!resultValidBusiness.isValid&&!resultValidShipping.isValid){error('Not a valid billing or shipping address.');return;}
if(resultValidShipping.isValid){modifiedAddress._IsShipTo='Y';}else{modifiedAddress._IsShipTo='N';modifiedAddress._IsDefaultShipTo='N'}
if(resultValidBusiness.isValid){modifiedAddress._IsBillTo='Y';}else{modifiedAddress._IsBillTo='N';modifiedAddress._IsDefaultBillTo='N'}
if(customerID==customer._CustomerID){var input={"manageCustomerReq":{"input":{}}};if(modifiedAddress._IsDefaultBillTo=='Y'||modifiedAddress._IsDefaultShipTo=='Y'){customer=_setDefaults(customer,customerContactID,modifiedAddress);}
var selectedContact=null;for(var i=0;i<customer.CustomerContactList.CustomerContact.length;i++){if(customer.CustomerContactList.CustomerContact[i]._CustomerContactID==customerContactID){selectedContact=customer.CustomerContactList.CustomerContact[i];}}
if(selectedContact){if(modifiedAddress._CustomerAdditionalAddressID.toString().trim()==""){selectedContact.CustomerAdditionalAddressList.CustomerAdditionalAddress.push(modifiedAddress);}else{for(var i=0;i<selectedContact.CustomerAdditionalAddressList.CustomerAdditionalAddress.length;i++){if(selectedContact.CustomerAdditionalAddressList.CustomerAdditionalAddress[i]._CustomerAdditionalAddressID==modifiedAddress._CustomerAdditionalAddressID){selectedContact.CustomerAdditionalAddressList.CustomerAdditionalAddress[i]=modifiedAddress;break;}}}
selectedContact.CustomerAdditionalAddressList._Reset='Y';}
delete customer.defaultAddresses;input.manageCustomerReq.input=customer;_clearResultsOnly();$http.post(manageCustomerUrl,input).success(function(data){var result=data.manageCustomerResp.return;retrieveCustomerDetail(result._CustomerID,result._CustomerKey,success,error);}).error(function(data){$sendSMTPErrorEmail(data,manageCustomerUrl,input);error(data);});}else{retrieveCustomerDetail(customerID,"",function(customer){if(customer._CustomerID==customerID){addModifyAddress(customerID,customerContactID,modifiedAddress,success,error);}else{throw{name:'customer.addModifyAddress  service failed.'};}},function(data){$loggerService.log('$customer.addModifyAddres called retrieve customer with error.');$loggerService.log(data);});}};var deleteAddress=function(customerID,customerContactID,customerAdditionalAddressID,success,error){success=_definedSuccessError(success);error=_definedSuccessError(error);var input={"manageCustomerReq":{"input":{"_CustomerID":customerID.toString(),"_CustomerType":"02","_OrganizationCode":"BONTON","CustomerContactList":{"CustomerContact":[{"_CustomerContactID":customerContactID.toString(),"CustomerAdditionalAddressList":{"CustomerAdditionalAddress":[{"_CustomerAdditionalAddressID":customerAdditionalAddressID.toString(),"_Operation":"Delete"}]}}]},"_Status":"10"}}};_clearResultsOnly();$http.post(manageCustomerUrl,input).success(function(data){var customer=getSelectedCustomer();if((customer===undefined||customer===null)||(customer&&(customerID==customer._CustomerID))){var result=data.manageCustomerResp.return;retrieveCustomerDetail(result._CustomerID,result._CustomerKey,success,error);}}).error(function(data){$sendSMTPErrorEmail(data,manageCustomerUrl,input);error(data);});};$rootScope.$on('orderCartDeleted',function(event,customerData){clearSelectedCustomer();});return{verifyEmail:verifyEmail,verifySelectedAddress:verifySelectedAddress,customerSearch:customerSearch,setSelectedCustomer:setSelectedCustomer,isCustomerSelected:isCustomerSelected,getSelectedCustomer:getSelectedCustomer,retrieveDraftOrders:retrieveDraftOrders,retrieveConfirmedOrders:retrieveConfirmedOrders,retrieveReturnOrders:retrieveReturnOrders,clearCachedResult:clearCachedResult,getCachedResult:getCachedResult,getCachedQueryParam:getCachedQueryParam,customerAction:customerAction,addToCart:addToCart,addModifyAddress:addModifyAddress,verifyCustomerAddress:verifyCustomerAddress,deleteAddress:deleteAddress,clearSelectedCustomer:clearSelectedCustomer,retrieveCustomerDetail:retrieveCustomerDetail,createCustomerByAddress:createCustomerByAddress,updateCustomerContact:updateCustomerContact,validateAddress:_validAddress};}]);
﻿var appServices=angular.module('appServicesOrder',[]);appServices.factory('order',['$http','$cacheFactory','serviceArrayFix','itemSearch','$q','loggerService','sendSMTPErrorEmail','btProp','POSService','$rootScope',function($http,$cacheFactory,serviceArrayFix,$itemSearch,$q,$loggerService,$sendSMTPErrorEmail,$btProp,$POSService,$rootScope){var cache=$cacheFactory("orderSearch");cache.put("orderSearchResult",[]);cache.put("orderSearchParam",[]);var getOrderList=function(searchParam,success,error){var url=serviceURL+"/Order/GetOrderListJSON";cache.put("orderSearchParam",searchParam);$http.post(url,angular.toJson(searchParam)).success(function(data){serviceArrayFix(data);var result=data.GetSterlingOrderListResp.Order;cache.put("orderSearchResult",result);clearSelectedOrder();success(result);}).error(function(data){$sendSMTPErrorEmail(data,url);error(data);})}
var addSolarData=function(orderline){return $itemSearch.searchItemBySKU(orderline.Item._ItemID).then(function(data){if(data){orderline.btDisplay=data;}else{orderline.btDisplay={};}
if(orderline.btDisplay.productname&&(orderline.btDisplay.productname.trim()!=="")){orderline.btDisplay.defaultItemDescription=orderline.btDisplay.productname;}else if(orderline.btDisplay.isnlongdesc&&(orderline.btDisplay.isnlongdesc.trim()!=="")){orderline.btDisplay.defaultItemDescription=orderline.btDisplay.isnlongdesc;}else{orderline.btDisplay.defaultItemDescription=orderline.ItemDetails.PrimaryInformation._ShortDescription;}
if(angular.isString(orderline.btDisplay.colorimageid)&&(orderline.btDisplay.colorimageid.trim()!=="")){orderline.btDisplay.defaultImageUrl=serviceURL.toString()+"/image/BonTon/"+orderline.btDisplay.colorimageid.trim();}else if(angular.isDefined(orderline.btDisplay.imageid)&&(orderline.btDisplay.imageid.toString().trim()!=="")){orderline.btDisplay.defaultImageUrl=serviceURL.toString()+"/image/BonTon/"+orderline.btDisplay.imageid.toString().trim();}else{orderline.btDisplay.defaultImageUrl="/assets/images/NotAvailable.jpg";}
if(!angular.isDefined(orderline.btLogic)){orderline.btLogic={};}
if(!angular.isDefined(orderline.btDisplay.id)||!isFinite(Number.parseInt(orderline.btDisplay.id))||(Number.parseInt(orderline.btDisplay.id)===0)){orderline.btDisplay.id=angular.copy(orderline.Item._UPCCode);}
if(!angular.isDefined(orderline.btDisplay.sku)||!isFinite(Number.parseInt(orderline.btDisplay.sku))||(Number.parseInt(orderline.btDisplay.sku)===0)){orderline.btDisplay.sku=angular.copy(orderline.Item._ItemID);}
return data;},function(response){$loggerService.log(response);return response});};var getOrderDetail=function(orderNumberParam,success,error){var url=serviceURL+"/Order/GetOrderDetailJSON";$http.post(url,angular.toJson(orderNumberParam)).success(function(data){var result=angular.fromJson(data).GetSterlingOrderDetailResp;serviceArrayFix(result);updateShipToLabel(result)
var promiseArray=[];for(var i=0;i<result.OrderLines.OrderLine.length;i++){(function(){var currentIndex=i;promiseArray.push(addSolarData(result.OrderLines.OrderLine[i]));})();}
if(result.ReturnOrders.ReturnOrder!==undefined&&result.ReturnOrders.ReturnOrder.length>0)
{for(var i=0;i<result.ReturnOrders.ReturnOrder.length;i++)
{var returnOrder=result.ReturnOrders.ReturnOrder[i];if(returnOrder.ExchangeOrders.ExchangeOrder!==undefined&&returnOrder.ExchangeOrders.ExchangeOrder.length>0)
{for(var j=0;j<returnOrder.ExchangeOrders.ExchangeOrder.length;j++)
{var exchangeOrder=returnOrder.ExchangeOrders.ExchangeOrder[j];if(exchangeOrder.OrderLines.OrderLine!==undefined&&exchangeOrder.OrderLines.OrderLine.length>0)
{for(var k=0;k<exchangeOrder.OrderLines.OrderLine.length;k++)
{(function()
{var currentIndex=k;promiseArray.push(addSolarData(exchangeOrder.OrderLines.OrderLine[k]));})();}}}}}}
$q.all(promiseArray).finally(function(){cache.put("orderDetails",result);success(result);});}).error(function(data){$sendSMTPErrorEmail(data,url);error(data);})};var getCurrentOrderDetails=function(){return cache.get("orderDetails");};var compareShipTos=function(shipTo1,shipTo2){return angular.toJson(shipTo1)==angular.toJson(shipTo2);}
var updateShipToLabel=function(orderDetail){var orderLine=orderDetail.OrderLines.OrderLine;for(var i=0;i<orderLine.length-1;i++){for(var j=i+1;j<orderLine.length;j++){var shipTo1=orderLine[i].PersonInfoShipTo;var shipTo2=orderLine[j].PersonInfoShipTo;if(!compareShipTos(shipTo1,shipTo2)){orderDetail.multipleShipTo=true;return;}}}
orderDetail.PersonInfoShipTo=orderLine[0].PersonInfoShipTo;}
var getPreviousSearchResult=function(){return cache.get("orderSearchResult");}
var getPreviousSearchParam=function(){return cache.get("orderSearchParam");}
$rootScope.$on('$stateChangeSuccess',function(event,toState,toParams,fromState,fromParams){var stateName=toState.name;var cachedResults=getPreviousSearchResult();if(angular.isArray(cachedResults)&&(cachedResults.length>0)&&!(stateName==='orderDetail'||stateName==='orderSearch')){cache.put("orderSearchResult",[]);cache.put("orderSearchParam",[]);}});var clearSelectedOrder=function(){cache.remove("selectedOrder");}
var getSelectedOrder=function(){var selectedOrder=cache.get("selectedOrder");return selectedOrder;}
var setSelectedOrder=function(selectedOrder){cache.put("selectedOrder",selectedOrder);}
var calculateOrderLineMerchandiseTotal=function(orderLine){return parseFloat(orderLine.LinePriceInfo._UnitPrice*orderLine._OrderedQty);}
var calculateOrderLineTotal=function(orderLine){if(angular.isDefined(orderLine.LineOverallTotals)&&angular.isDefined(orderLine.LineOverallTotals._ExtendedPrice)&&isFinite(parseFloat(orderLine.LineOverallTotals._ExtendedPrice))){return parseFloat(orderLine.LineOverallTotals._ExtendedPrice);}
return Number(orderLine.LinePriceInfo._btAdjustedPrice)*Number(orderLine._OrderedQty)}
var calculateTaxTotal=function(orderObject){return Number(orderObject._GiftBoxTaxTotal)+
Number(orderObject._SalesTaxTotal)+
Number(orderObject._ShippingTaxTotal)+
Number(orderObject._SpHandlingTaxTotal)+
Number(orderObject._TaxMiscTotal);}
var calculateShippingTotal=function(orderObject){return Number(orderObject._ShippingChrgTotal)-
Number(orderObject._ShippingDiscTotal)+
Number(orderObject._SpHandlingChrgTotal)-
Number(orderObject._SpHandlingDiscTotal);}
var calculateShippingTotalWithoutHandling=function(orderObject){return Number(orderObject._ShippingChrgTotal)-
Number(orderObject._ShippingDiscTotal);}
var calculateMerchandiseTotal=function(orderObject){return Number(orderObject._UnitPriceTotal);};var calculateCouponDiscountTotal=function(orderObject){return-1*Number(orderObject._CouponDiscTotal);};var calculateMisChargesTotal=function(orderObject){return(Number(orderObject._GiftBoxChrgTotal)+Number(orderObject._SPOChrgTotal)+Number(orderObject._ChrgMiscTotal))-(Number(orderObject._GiftBoxDiscTotal)+Number(orderObject._SPODiscTotal)+Number(orderObject._MPTDiscTotal)+Number(orderObject._PromoDiscTotal)+Number(orderObject._SeniorDiscTotal)+Number(orderObject._SpecialDiscTotal)+Number(orderObject._DiscMiscTotal));};var calculateMisChargesTotalWithoutGiftBox=function(orderObject){return(Number(orderObject._SPOChrgTotal)+
Number(orderObject._ChrgMiscTotal))-
(Number(orderObject._SPODiscTotal)+
Number(orderObject._MPTDiscTotal)+
Number(orderObject._PromoDiscTotal)+
Number(orderObject._SeniorDiscTotal)+
Number(orderObject._SpecialDiscTotal)+
Number(orderObject._DiscMiscTotal));};var calculateAssocDiscTotal=function(orderObject){return-1*(Number(orderObject._AssociateDiscTotal)+Number(orderObject._FirstDayDiscTotal));};var calculatePromoDiscountCharges=function(orderObject){return calculateMisChargesTotalWithoutGiftBox(orderObject);}
var calculateSpecialHandlingCharges=function(orderObject){return Number(orderObject._SpHandlingChrgTotal)-
Number(orderObject._SpHandlingDiscTotal);}
var calculateGiftBoxCharges=function(orderObject){return Number(orderObject._GiftBoxChrgTotal)-
Number(orderObject._GiftBoxDiscTotal);}
var lineTotal=function(orderline){return Number(orderline.LinePriceInfo._UnitPrice)*parseInt(orderline._OrderedQty);};var calculateOrderSubTotal=function(orderObject){return calculateMerchandiseTotal(orderObject)+calculateMisChargesTotal(orderObject)+calculateCouponDiscountTotal(orderObject)+calculateAssocDiscTotal(orderObject);};var orderPricingDetail=function(cart,isUpdateable){if(!angular.isDefined(isUpdateable)||isUpdateable===null){isUpdateable=true;}
var detail={};detail.category=[];detail.category.push({categoryDescription:"Merchandise Total","total":calculateMerchandiseTotal(cart)});detail.category.push({categoryDescription:"Promo Discounts/Charges","total":calculatePromoDiscountCharges(cart),"hideWhenZero":true});detail.category.push({categoryDescription:"Coupon Discounts","total":calculateCouponDiscountTotal(cart),"hideWhenZero":true});detail.category.push({categoryDescription:"Associate Discount/Instant Credit","total":calculateAssocDiscTotal(cart),"hideWhenZero":true});detail.category.push({categoryDescription:"Gift Box Charge","total":calculateGiftBoxCharges(cart),"hideWhenZero":true});detail.category.push({categoryDescription:"Special Handling","total":calculateSpecialHandlingCharges(cart),"hideWhenZero":true});detail.category.push({categoryDescription:"Shipping","total":calculateShippingTotalWithoutHandling(cart),"updateable":(isUpdateable&&true)});detail.category.push({categoryDescription:"Taxes","total":calculateTaxTotal(cart)});detail.category.push({categoryDescription:"Order Total","total":cart._OrderTotal});detail.coupons=[];cart.OrderLines.OrderLine.forEach(function(orderLine){if(angular.isDefined(orderLine.LineCharges)&&angular.isArray(orderLine.LineCharges.LineCharge))
{orderLine.LineCharges.LineCharge.forEach(function(lineCharge){if(lineCharge._ChargeCategory=='BTN_CPN_DISC'){var discAmount=_chargeAmount(orderLine._OrderedQty,lineCharge);var duplicate=false;angular.forEach(detail.coupons,function(coupon){if(coupon.couponCode==lineCharge._Reference){coupon.DiscountAmt+=discAmount;duplicate=true;}});if(!duplicate){detail.coupons.push({couponCode:lineCharge._Reference,"DiscountAmt":discAmount});}}});}});return detail;};var _chargeAmount=function(orderlineQty,charge){orderlineQty=isFinite(parseInt(orderlineQty))?parseInt(orderlineQty):0;orderlineQty=(orderlineQty&&isFinite(parseInt(orderlineQty)))?parseInt(orderlineQty):1;if(angular.isDefined(charge._ChargeAmount)&&charge._ChargeAmount!=null&&isFinite(parseFloat(charge._ChargeAmount))){return parseFloat(charge._ChargeAmount);}
else{var total=0;if(angular.isDefined(charge._ChargePerUnit)&&charge._ChargePerUnit!=null&&isFinite(parseFloat(charge._ChargePerUnit))){total=orderlineQty*parseFloat(charge._ChargePerUnit);}
if(angular.isDefined(charge._ChargePerLine)&&charge._ChargePerLine!=null&&isFinite(parseFloat(charge._ChargePerLine))){total=total+parseFloat(charge._ChargePerLine);}
if(angular.isDefined(charge._Tax)&&charge._ChargePerLine!=null&&isFinite(parseFloat(charge._Tax))){total=total+parseFloat(charge._Tax);}
return total;}};var getSkyTotaling=function(cart){var unitPriceTotal=0;var shippingDiscountTotal=0;var couponDiscountTotal=0;var spHandlingDiscountTotal=0;var giftBoxDiscountTotal=0;var promoDiscountTotal=0;var spoDiscountTotal=0;var associateDiscountTotal=0;var firstDayDiscountTotal=0;var mptDiscountTotal=0;var seniorDiscountTotal=0;var specialDiscountTotal=0;var discountMiscTotal=0;var shippingChargeTotal=0;var spHandlingChargeTotal=0;var giftBoxChargeTotal=0;var spoChargeTotal=0;var associateChargeTotal=0;var firstDayChargeTotal=0;var chargeMiscTotal=0;var salesTaxChargeTotal=0;var shippingTaxChargeTotal=0;var giftBoxTaxChargeTotal=0;var spHandlingTaxChargeTotal=0;var salesTaxDiscountTotal=0;var shippingTaxDiscountTotal=0;var giftBoxTaxDiscountTotal=0;var spHandlingTaxDiscountTotal=0;var taxMiscTotal=0;angular.forEach(cart.OrderLines.OrderLine,function(x){if(x.LinePriceInfo!=null){unitPriceTotal+=(parseFloat(x.LinePriceInfo._UnitPrice)*parseFloat(x._OrderedQty));}
if(angular.isDefined(x.LineCharges)&&x.LineCharges!=null&&angular.isArray(x.LineCharges.LineCharge)){angular.forEach(x.LineCharges.LineCharge,function(y){if(angular.isString(y._ChargeName)){if(y._IsDiscount=="Y"){if((/^DISC_SHIPPING.*/).test(y._ChargeName)||(/^ADJ_SHIPPING.*/).test(y._ChargeName)||(/^CREDITED_SHIP_CHRG.*/).test(y._ChargeName)){shippingDiscountTotal+=_chargeAmount(x._OrderedQty,y);}
else if((/^DISC_COUPON.*/).test(y._ChargeName)||(/^ADJ_COUPON.*/).test(y._ChargeName)){couponDiscountTotal+=_chargeAmount(x._OrderedQty,y);}
else if((/^DISC_SP_HANDLING.*/).test(y._ChargeName)||(/^ADJ_SP_HANDLING.*/).test(y._ChargeName)){spHandlingDiscountTotal+=_chargeAmount(x._OrderedQty,y);}
else if((/^DISC_GIFT_BOX.*/).test(y._ChargeName)||(/^ADJ_GIFT_BOX.*/).test(y._ChargeName)){giftBoxDiscountTotal+=_chargeAmount(x._OrderedQty,y);}
else if((/^DISC_PROMO.*/).test(y._ChargeName)){promoDiscountTotal+=_chargeAmount(x._OrderedQty,y);}
else if((/^DISC_SPO.*/).test(y._ChargeName)){spoDiscountTotal+=_chargeAmount(x._OrderedQty,y);}
else if((/^DISC_ASSOCIATE.*/).test(y._ChargeName)){associateDiscountTotal+=_chargeAmount(x._OrderedQty,y);}
else if((/^DISC_FIRST_DAY.*/).test(y._ChargeName)){firstDayDiscountTotal+=_chargeAmount(x._OrderedQty,y);}
else if((/^DISC_MPT.*/).test(y._ChargeName)){mptDiscountTotal+=_chargeAmount(x._OrderedQty,y);}
else if((/^DISC_SENIOR.*/).test(y._ChargeName)){seniorDiscountTotal+=_chargeAmount(x._OrderedQty,y);}
else if((/^DISC_SPECIAL.*/).test(y._ChargeName)){specialDiscountTotal+=_chargeAmount(x._OrderedQty,y);}
else{discountMiscTotal+=_chargeAmount(x._OrderedQty,y);}}else if(y._IsDiscount=="N"){if((/^CHRG_SHIPPING.*/).test(y._ChargeName)){shippingChargeTotal+=_chargeAmount(x._OrderedQty,y);}
else if((/^CHRG_SP_HANDLING.*/).test(y._ChargeName)){spHandlingChargeTotal+=_chargeAmount(x._OrderedQty,y);}
else if((/^CHRG_GIFT_BOX.*/).test(y._ChargeName)){giftBoxChargeTotal+=_chargeAmount(x._OrderedQty,y);}
else if((/^CHRG_SPO.*/).test(y._ChargeName)){spoChargeTotal+=_chargeAmount(x._OrderedQty,y);}
else if((/^ADJ_CHRG_ASSOCIATE.*/).test(y._ChargeName)){associateChargeTotal+=_chargeAmount(x._OrderedQty,y);}
else if((/^ADJ_CHRG_FIRST_DAY.*/).test(y._ChargeName)){firstDayChargeTotal+=_chargeAmount(x._OrderedQty,y);}
else{chargeMiscTotal+=_chargeAmount(x._OrderedQty,y);}}}});}
if(angular.isDefined(x.LineTaxes)&&x.LineTaxes!==null&&angular.isArray(x.LineTaxes.LineTax)){angular.forEach(x.LineTaxes.LineTax,function(y){if(angular.isString(y._ChargeName)&&angular.isDefined(y._Tax)&&y._Tax!==null){if((/^TAX_SALES.*/).test(y._ChargeName)){salesTaxChargeTotal+=parseFloat(y._Tax);}
else if((/^TAX_SHIPPING.*/).test(y._ChargeName)){shippingTaxChargeTotal+=parseFloat(y._Tax);}
else if((/^TAX_GIFT_BOX.*/).test(y._ChargeName)){giftBoxTaxChargeTotal+=parseFloat(y._Tax);}
else if((/^TAX_SP_HANDLING.*/).test(y._ChargeName)){spHandlingTaxChargeTotal+=parseFloat(y._Tax);}
else if((/^ADJ_TAX_SALES.*/).test(y._ChargeName)){salesTaxDiscountTotal+=parseFloat(y._Tax);}
else if((/^ADJ_TAX_SHIPPING.*/).test(y._ChargeName)||(/^CREDITED_SHIP_TAX.*/).test(y._ChargeName)){shippingTaxDiscountTotal+=parseFloat(y._Tax);}
else if((/^ADJ_TAX_GIFT_BOX.*/).test(y._ChargeName)){giftBoxTaxDiscountTotal+=parseFloat(y._Tax);}
else if((/^ADJ_TAX_SP_HANDLING.*/).test(y._ChargeName)){spHandlingTaxDiscountTotal+=parseFloat(y._Tax);}
else{taxMiscTotal+=parseFloat(y._Tax);}}});}});var SalesTaxTotal=(salesTaxChargeTotal-salesTaxDiscountTotal);var ShippingTaxTotal=(shippingTaxChargeTotal-shippingTaxDiscountTotal);var GiftBoxTaxTotal=(giftBoxTaxChargeTotal-giftBoxTaxDiscountTotal);var SpHandlingTaxTotal=(spHandlingTaxChargeTotal-spHandlingTaxDiscountTotal);var ShippingTotal=(shippingChargeTotal-shippingDiscountTotal)+(ShippingTaxTotal);var SpHandlingTotal=(spHandlingChargeTotal-spHandlingDiscountTotal)+(SpHandlingTaxTotal);var GiftBoxTotal=(giftBoxChargeTotal-giftBoxDiscountTotal)+(GiftBoxTaxTotal);var FirstDayDiscTotal=(firstDayDiscountTotal-firstDayChargeTotal);var AssociateDiscTotal=(associateDiscountTotal-associateChargeTotal);var SPODiscTotal=(spoDiscountTotal-spoChargeTotal);var chargeTotal=unitPriceTotal+SalesTaxTotal+taxMiscTotal+ShippingTotal+SpHandlingTotal+GiftBoxTotal+chargeMiscTotal;var discountTotal=FirstDayDiscTotal+AssociateDiscTotal+SPODiscTotal+couponDiscountTotal+mptDiscountTotal+promoDiscountTotal+specialDiscountTotal+seniorDiscountTotal+discountMiscTotal;var orderTotal=(chargeTotal-discountTotal);cart._OrderTotal=orderTotal;cart._UnitPriceTotal=unitPriceTotal;cart._ShippingChrgTotal=shippingChargeTotal;cart._ShippingDiscTotal=shippingDiscountTotal;cart._CouponDiscTotal=couponDiscountTotal;cart._SpHandlingChrgTotal=spHandlingChargeTotal;cart._SpHandlingDiscTotal=spHandlingDiscountTotal;cart._GiftBoxChrgTotal=giftBoxChargeTotal;cart._GiftBoxDiscTotal=giftBoxDiscountTotal;cart._SPOChrgTotal=spoChargeTotal;cart._SPODiscTotal=spoDiscountTotal;cart._MPTDiscTotal=mptDiscountTotal;cart._PromoDiscTotal=promoDiscountTotal;cart._AssociateDiscTotal=AssociateDiscTotal;cart._FirstDayDiscTotal=FirstDayDiscTotal;cart._SalesTaxTotal=SalesTaxTotal;cart._ShippingTaxTotal=ShippingTaxTotal;cart._GiftBoxTaxTotal=GiftBoxTaxTotal;cart._SpHandlingTaxTotal=SpHandlingTaxTotal;cart._SeniorDiscTotal=seniorDiscountTotal;cart._SpecialDiscTotal=specialDiscountTotal;cart._TaxMiscTotal=taxMiscTotal;cart._ChrgMiscTotal=chargeMiscTotal;cart._DiscMiscTotal=discountMiscTotal;};var orderLineItemPricingDetail=function(orderLine){var detail={};detail.category=[];var shippingTotal=0;var couponTotal=0;detail.coupons=[];if(!orderLine){return detail}
angular.forEach(orderLine.LineCharges.LineCharge,function(charge){if(charge._ChargeCategory=="BTN_SHIP_CHRG"){shippingTotal+=_chargeAmount(orderLine._OrderedQty,charge);}else if(charge._ChargeCategory=="BTN_SHIP_DISC"){shippingTotal-=_chargeAmount(orderLine._OrderedQty,charge);}});angular.forEach(orderLine.LineCharges.LineCharge,function(lineCharge){if(lineCharge._ChargeCategory=='BTN_CPN_DISC'){var discAmount=_chargeAmount(orderLine._OrderedQty,lineCharge);var duplicate=false;angular.forEach(detail.coupons,function(coupon){if(coupon.couponCode==lineCharge._Reference){coupon.DiscountAmt+=discAmount;duplicate=true;}});if(!duplicate){detail.coupons.push({couponCode:lineCharge._Reference,"DiscountAmt":discAmount});}
couponTotal+=discAmount;}});detail.category.push({categoryDescription:"Merchandise Total",isDiscount:false,"total":calculateOrderLineMerchandiseTotal(orderLine)});angular.forEach(orderLine.LineCharges.LineCharge,function(lineCharge){if(lineCharge._ChargeCategory=="BTN_SHIP_CHRG"){detail.category.push({categoryDescription:"Shipping Charge",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge),"updateable":true});}else if(lineCharge._ChargeCategory!='BTN_CPN_DISC'){if(lineCharge._ChargeName=="DISC_DLR"){detail.category.push({categoryDescription:"DLR Discount",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="DISC_PERC"){detail.category.push({categoryDescription:"PERC Discount",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="DISC_GIFT_BOX"){detail.category.push({categoryDescription:"Gift Box Discount",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="DISC_SP_HANDLING"){detail.category.push({categoryDescription:"Special Handling Discount",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="DISC_SHIPPING"){detail.category.push({categoryDescription:"Shipping Discount",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="DISC_SPO"){detail.category.push({categoryDescription:"SPO Discount",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="DISC_MPT"){detail.category.push({categoryDescription:"MPT Discount",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="DISC_PROMO"){detail.category.push({categoryDescription:"Promo Discount",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="DISC_WEB_PROMO"){detail.category.push({categoryDescription:"Web Promo Discount",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="DISC_CSR"){detail.category.push({categoryDescription:"CSR Discount",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="DISC_PREPAID_LABEL"){detail.category.push({categoryDescription:"Prepaid Label Discount",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="DISC_SPECIAL"){detail.category.push({categoryDescription:"Special Discount",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="DISC_SENIOR"){detail.category.push({categoryDescription:"Senior Discount",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="DISC_FIRST_DAY"){detail.category.push({categoryDescription:"First Day Discount",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="DISC_ASSOCIATE"){detail.category.push({categoryDescription:"Associate Discount",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="DISC_COUPON_"){detail.category.push({categoryDescription:"Coupon Discount",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="CREDITED_SHIP_TAX"){detail.category.push({categoryDescription:"Credited Ship Tax",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="CREDITED_SHIP_CHRG"){detail.category.push({categoryDescription:"Credited Ship Charge",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="CHRG_RETURN_LABEL"){detail.category.push({categoryDescription:"Return Label Charge",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="CHRG_GIFT_BOX"){detail.category.push({categoryDescription:"Gift Box Charge",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="CHRG_SP_HANDLING"){detail.category.push({categoryDescription:"Special Handling Charge",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="CHRG_SHIPPING"){detail.category.push({categoryDescription:"Shipping Charge",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="CHRG_SPO"){detail.category.push({categoryDescription:"SPO Charge",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="CHRG_CSR"){detail.category.push({categoryDescription:"CSR Charge",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="TAX_SP_HANDLING"){detail.category.push({categoryDescription:"Special Handling Tax",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="TAX_GIFT_BOX"){detail.category.push({categoryDescription:"Gift Box Tax",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="TAX_SHIPPING"){detail.category.push({categoryDescription:"Shipping Tax",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="TAX_SALES"){detail.category.push({categoryDescription:"Sales Tax",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="ADJ_CHRG_FIRST_DAY"){detail.category.push({categoryDescription:"Fist Day Charge Adjustment",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="ADJ_CHRG_RTN_LBL"){detail.category.push({categoryDescription:"Return Label Charge Adjustment",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="ADJ_CHRG_ASSOCIATE"){detail.category.push({categoryDescription:"Associate Charge Adjustment",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="ADJ_TAX_SP_HANDLING"){detail.category.push({categoryDescription:"Special Handling Tax Adjustment",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="ADJ_TAX_SP_HANDLING"){detail.category.push({categoryDescription:"Special Handling Tax Adjustment",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="ADJ_TAX_GIFT_BOX"){detail.category.push({categoryDescription:"Gift Box Tax Adjustment",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="ADJ_TAX_SHIPPING"){detail.category.push({categoryDescription:"Shipping Tax Adjustment",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="ADJ_TAX_SALES"){detail.category.push({categoryDescription:"Sales Tax Adjustment",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="ADJ_ELECTIVE"){detail.category.push({categoryDescription:"Elective Adjustment",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="ADJ_RTN_LBL"){detail.category.push({categoryDescription:"Return Label Adjustment",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="ADJ_PRICE"){detail.category.push({categoryDescription:"Price Adjustment",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="ADJ_SP_HANDLING"){detail.category.push({categoryDescription:"Special Handling Adjustment",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="ADJ_GIFT_BOX"){detail.category.push({categoryDescription:"Gift Box Adjustment",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="ADJ_COUPON_"){detail.category.push({categoryDescription:"Coupon Adjustment",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else if(lineCharge._ChargeName=="ADJ_SHIPPING"){detail.category.push({categoryDescription:"Shipping Adjustment",isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}
else{detail.category.push({categoryDescription:lineCharge._ChargeName,isDiscount:((/^y$/i).test(lineCharge._IsDiscount)),"total":_chargeAmount(orderLine._OrderedQty,lineCharge)});}}});if(couponTotal>0){detail.category.push({categoryDescription:"Coupon Total",isDiscount:true,"total":couponTotal});}
detail.category.push({categoryDescription:"Total",isDiscount:false,"total":calculateOrderLineTotal(orderLine)});detail.orderLine=orderLine;return detail;};var createOrder=function(orderCart,success,error){var url=serviceURL+"/Order/CreateOrderJSON";var contract={CreateSterlingOrderReq:orderCart}
$http.post(url,angular.toJson(contract)).then(function(data){var result=angular.fromJson(data.data).CreateSterlingOrderResp;success(result);},function(response){var cartCopy=angular.fromJson(angular.copy(response.config.data));var reportedInfo='';var additionalEmailRecipients=null;if(angular.isDefined(cartCopy.CreateSterlingOrderReq)){var giftCardsArr=[];for(var i=0;i<cartCopy.CreateSterlingOrderReq.PaymentMethods.PaymentMethod.length;i++){if(cartCopy.CreateSterlingOrderReq.PaymentMethods.PaymentMethod[i]._CreditCardType&&cartCopy.CreateSterlingOrderReq.PaymentMethods.PaymentMethod[i]._CreditCardType==='GC'){var processedAmount=Number.parseFloat(cartCopy.CreateSterlingOrderReq.PaymentMethods.PaymentMethod[i].PaymentDetails._ProcessedAmount);if(!isFinite(processedAmount)||processedAmount!==0.00){var tempGift=angular.copy(cartCopy.CreateSterlingOrderReq.PaymentMethods.PaymentMethod[i]);delete tempGift._PaymentReference2;delete tempGift._SvcNo;delete tempGift.PaymentDetails._Reference2;giftCardsArr.push(tempGift);}}}
cartCopy.CreateSterlingOrderReq.PaymentMethods.PaymentMethod=giftCardsArr;if(giftCardsArr.length>0){var giftcardReport=[];for(var i=0;i<giftCardsArr.length;i++){giftcardReport.push('Card:'+giftCardsArr[i]._DisplayCreditCardNo+", Auth Ref Num:"+giftCardsArr[i]._PaymentReference1+", Amount Processed:"+giftCardsArr[i].PaymentDetails._ProcessedAmount+", AuthReturnCode:"+giftCardsArr[i].PaymentDetails._AuthReturnCode);}
reportedInfo='Giftcard on Order: \n    '+giftcardReport.join(' \n    ');url=url+" Order Has Giftcards: "+giftCardsArr.length;if((/prod\.bonton\.com/i).test(serviceURL)){additionalEmailRecipients=$btProp.getProp('orderCreateFailureWithGiftCardEmailList');}}}
$sendSMTPErrorEmail(response.data,url,cartCopy,reportedInfo,additionalEmailRecipients);error(response.data);});}
var canCancelOrder=function(orderDetail){var isCanCancel=false;if(angular.isDefined(orderDetail)&&angular.isString(orderDetail._DocumentType)&&angular.isString(orderDetail._DraftOrderFlag)&&angular.isDefined(orderDetail.OrderLines)&&angular.isArray(orderDetail.OrderLines.OrderLine)){if(orderDetail._DocumentType==='0001'&&orderDetail._DraftOrderFlag==='N'&&orderDetail.OrderLines.OrderLine.length>0)
{var isAllLinesScheduledOrCanceledStatus=true;var isOneLineInScheduled=false;var scheduledRegEx=/^\s*Scheduled\s*$/i;var scheduledOrCancelledRegEx=/^\s*(Scheduled|Cancelled)\s*$/i;for(var i=0;i<orderDetail.OrderLines.OrderLine.length;i++){if(scheduledRegEx.test(orderDetail.OrderLines.OrderLine[i]._Status)){isOneLineInScheduled=true;}
if(!scheduledOrCancelledRegEx.test(orderDetail.OrderLines.OrderLine[i]._Status)){isAllLinesScheduledOrCanceledStatus=false;}}
if(isOneLineInScheduled&&isAllLinesScheduledOrCanceledStatus){isCanCancel=true;}}}
return isCanCancel;};var _isInRemorseHold=function(order){if(angular.isDefined(order)&&angular.isDefined(order.OrderHoldTypes)&&angular.isArray(order.OrderHoldTypes.OrderHoldType)&&angular.isDefined(order.OrderHoldTypes.OrderHoldType[0])){return(order.OrderHoldTypes.OrderHoldType[0]._HoldType=='REMORSE_PERIOD_HOLD'&&order.OrderHoldTypes.OrderHoldType[0]._Status=='1100');}else{return false;}};var cancelOrder=function(orderDetail){var terminalNumber=$POSService.getPOSParameters().terminalNumber;var storeNumber=$POSService.getPOSParameters().storeNumber;var associateId=$POSService.getPOSParameters().associateId;if(angular.isDefined(terminalNumber)&&null!=terminalNumber&&terminalNumber.length>0){terminalNumber="Order Cancelled in LUFI2 by the associate "+associateId+" in the Store "+storeNumber+" and terminal "+terminalNumber;}else{terminalNumber="Order Cancelled in LUFI2 by the associate "+associateId;}
var NoteText="This Order was Cancelled by "+terminalNumber;var contract={ChangeSterlingOrderReq:{'Notes':{'Note':[{'_ResonCode':'01','_NoteText':terminalNumber}]},'_Action':'CANCEL','_IgnoreOrdering':'Y','_ModificationReasonCode':'01','_ModificationReasonText':terminalNumber,'_OrderHeaderKey':orderDetail._OrderHeaderKey,'_Override':'Y'}};return $http.post(serviceURL+"/Order/ChangeOrderJSON",contract);};return{getOrderList:getOrderList,getOrderDetail:getOrderDetail,getPreviousSearchResult:getPreviousSearchResult,getPreviousSearchParam:getPreviousSearchParam,orderPricingDetail:orderPricingDetail,orderLineItemPricingDetail:orderLineItemPricingDetail,setSelectedOrder:setSelectedOrder,getSelectedOrder:getSelectedOrder,createOrder:createOrder,lineTotal:lineTotal,calculateOrderLineTotal:calculateOrderLineTotal,calculateTaxTotal:calculateTaxTotal,calculateShippingTotal:calculateShippingTotal,calculateMerchandiseTotal:calculateMerchandiseTotal,calculateCouponDiscountTotal:calculateCouponDiscountTotal,calculateMisChargesTotal:calculateMisChargesTotal,calculateAssocDiscTotal:calculateAssocDiscTotal,calculatePromoDiscountCharges:calculatePromoDiscountCharges,calculateSpecialHandlingCharges:calculateSpecialHandlingCharges,calculateGiftBoxCharges:calculateGiftBoxCharges,calculateOrderSubTotal:calculateOrderSubTotal,getCurrentOrderDetails:getCurrentOrderDetails,getSkyTotaling:getSkyTotaling,addSolarData:addSolarData,canCancelOrder:canCancelOrder,cancelOrder:cancelOrder};}]);
﻿var godmode={print:null,reprice:null,setExample:null,goState:null,addLine:null};angular.module('appServiceOrderCart',['propertiesService','appUtilities','appServicesGiftRegistry']).factory('orderCart',["$log","btProp",'POSService','$http','$rootScope','errorObj','giftRegistryService','serviceArrayFix','repriceService','$q','$state','customer','isPoBoxAddress','bigTicketValidate','itemProperty','loggerService','sendSMTPErrorEmail','securityService','$filter',function($log,btProp,POSService,$http,$rootScope,errorObj,giftRegistryService,serviceArrayFix,repriceService,$q,$state,$customer,$isPoBoxAddress,$bigTicketValidate,$itemProperty,$loggerService,$sendSMTPErrorEmail,$securityService,$filter){godmode.print=function(){$loggerService.log(_getLiveOrderCart());};godmode.reprice=function(isGetCarrierServices){_repriceOrder(isGetCarrierServices).then(function(response){$loggerService.log(response.data);},function(response){$loggerService.log(response.data);});};godmode.setExample=function(inputCart){if(inputCart){orderCart=inputCart;}else{_setExampleOrder();}};godmode.goState=function(stateName){$state.go(stateName);};godmode.addLine=function(itemType){var bigTicketItem={"id":450300070386,"isn":503103422,"sku":450300070386,"isnlongdesc":"iComf Prodigy Everfeel Plsh-Qn","vendorstyle":"PRODIGYPLUSH-QN","genclasslongdesc":"Mattresses","colorfamdesc":"No Color","colorattrdesc":"No Color","itemsize":"","desc1":"PLUSH","brandlongdesc":"Serta","proddtllongdesc":"Plush Top","deptlongdesc":"MATTRESSES","cmg":"220 - FURNITURE","cfg":"460 - FURNITURE","fob":"84 - MATTRESSES","crg":"600 - HOME","classlongdesc":"SERTA ICOMFORT","gensclalongdesc":"Mattress-Specialty","fablongdesc":"None","fabdtldesc":"None","proddetail2":"Queen","proddetail3":"None","labellongdesc":"Serta","productcode":340867,"productname":"iComfort&reg; by Serta&reg; Prodigy Everfeel Plush Mattress & Box Spring Set","imageid":742183,"keywords":",,iComfort by Serta Prodigy Everfeel Plush Mattress & Box Spring Set,BTI,iComfort by Serta,iComfort by Serta mattress and box spring set,iComfort by Serta sleep set,gel memory foam,12\" mattress height","webcatprodshortdesc":"Sleep soundly on this luxurious mattress set.","webcatprodlongdesc":"<p><strong>Enter ZIP code to confirm your address is located within our delivery area. If so, you may call with questions or to place an order. If your furniture order is placed online, we'll contact you to set up delivery.</strong></p>\n<p>The iComfort by Serta Prodigy Everfeel Plush Mattress & Box Spring Set gives the targeted support your body needs while cradling you in ultra-plush comfort. With three layers advanced memory foam to relieve pressure and provide even cooling throughout the night, this mattress and box spring set is sure to provide years of superior rest.</p>\n<ul>\n    <li>White/Black </li>\n    <li>Sold as a set with box spring </li>\n    <li>Choose between a 9\"H standard or 5.5\" low profile box spring </li>\n    <li>12\" mattress height </li>\n</ul>\n<p><strong>Construction:<br />\n</strong></p>\n<ul>\n    <li>The only iComfort&reg; model to feature 3 layers of advanced memory foams </li>\n    <li>Support layer features ComfortLast&reg; Foam Core with Ultimate Edge&reg; Mattress Edge Support </li>\n    <li>1.5\" Cool Action&trade; Dual Effects&reg; Gel Memory Foam helps relieve pressure while providing targeted support and enhanced cooling comfort </li>\n    <li>0.75\" EverFeel&trade; Technology for a difference you&rsquo;ll feel the moment you lie down </li>\n    <li>2\" EverCool&reg; Memory Foam and 1&rdquo; PillowSoft&trade; Foam </li>\n    <li>Cool Action&trade; Dual Effects&reg; Gel Memory Foam </li>\n    <li>1\" Cool Action&trade; Gel Memory Foam </li>\n    <li>Made in the USA </li>\n</ul>","itemtype":"BGT","pricestatus":"R","hazardCode":"1","giftwrapCode":"1","specialhandlingcode":"1","isactive":"Y","isgwp":"N","iswebexclusive":"N","isspecialhandling":"Y","isairshipallowed":"N","isgroundshipallowed":"Y","specialhandlingfee":0,"groupid":"503103422340867","_version_":1503035902681677800,"itemDetail":{"_ItemID":"450300070386","_ItemKey":"450300070386","_OrganizationCode":"BONTON","_UPCCode":"450300070386","ComputedPrice":{"_ListPrice":"4710","_RetailPrice":"4710","_UnitPrice":"4710","Extn":{"_btIsBonusEvent":"false","_btIsDoorBusterEvent":"false","_btIsHazMat":"false","_btIsIVPEvent":"false","_btIsNightOwlEvent":"false","_btIsOtherSpecialEvent":"false","_btIsSpecialHandling":"false","_btIsWebExclusive":"false","_btIsWebOnlyEvent":"false","_btSpecialHandlingFee":"0","_ExtnBadgingText":"Regular","_ExtnClass":"806","_ExtnDepartment":"503","_ExtnMPTID":"","_ExtnMPTOfferDetail":"","_ExtnMPTOfferMsg1":"","_ExtnMPTOfferMsg2":"","_ExtnPriceStatus":"R","_ExtnPromoNumber":"0","_ExtnSpecialHandlingCode":"0","_ExtnSPOID":"0","_ExtnSPOOfferDetail":"","_ExtnSPOOfferMsg1":"","_ExtnSPOOfferMsg2":""}}},"_AvailableQty":"50","defaultItemDescription":"iComfort&reg; by Serta&reg; Prodigy Everfeel Plush Mattress & Box Spring Set","defaultImageUrl":"http://broker.qa.bonton.com:7080/image/BonTon/742183"};var itemObject={"id":755179389899,"isn":400101743,"sku":440000688653,"isnlongdesc":"tay charc deq c/s ruched sq nk","vendorstyle":"3150M","genclasslongdesc":"Dresses","colorlongdesc":"CHARCOAL","colorfamdesc":"Black/Gray Fam","colorattrdesc":"Charcoal Gray","itemsize":"10       R","sizesequence":11020,"desc1":"OCTOBER 2011","desc2":"LBD","desc3":"SHTH (SHEATH)","desc4":"MATTE JERSEY","brandlongdesc":"Taylor Dresses","proddtllongdesc":"Cap Sleeve","deptlongdesc":"BETTER DRESSES","cmg":"110 - DRESSES","cfg":"10 - MISSES DRESSES","fob":"101 - BETTER DRESSES","crg":"100 - READY TO WEAR","classlongdesc":"TAYLOR","gensclalongdesc":"1pc Dress","fablongdesc":"Poly Blend-With Stretch","fabdtldesc":"Embellished","proddetail2":"Above the Knee Length","proddetail3":"Knit","labellongdesc":"Taylor Dresses","productcode":157134,"productname":"Taylor Charcoal Sequin Knit Cap-Sleeve Squareneck Party Dress","imageid":431692,"keywords":",,1,10,8,6,4,2,Taylor,Charcoal,Sequin Knit,Cap Sleeve,Squareneck Party Dress,party dress,cap sleeve dress,squareneck dress,knit dresses,cocktail dresses,women,apparel,","webcatprodshortdesc":"Mingle in high style in this gorgeous, sequin-knit cocktail dress, characterized by its ruched, pleated texture and revealing cap sleeves.","webcatprodlongdesc":"<ul>\n    <li>Squareneck party dress with cap sleeves</li>\n    <li>Ruched pleats over sequin knit fabric</li>\n    <li>Back-zip closure</li>\n    <li>Acrylic/nylon</li>\n    <li>Imported</li>\n</ul>","colorcode":10,"colorDc":"00010 - CHARCOAL","size1code":"10  ","size2code":"R   ","sizedc":"10    R   ","itemtype":"REG","pricestatus":"P","hazardCode":"1","giftwrapCode":"2","specialhandlingcode":"1","isactive":"Y","isgwp":"N","iswebexclusive":"Y","isspecialhandling":"N","isairshipallowed":"Y","isgroundshipallowed":"Y","specialhandlingfee":0,"groupid":"400101743157134","buyable":true,"_version_":1503052571298758700,"itemDetail":{"_ItemID":"440000688653","_ItemKey":"440000688653","_OrganizationCode":"BONTON","_UPCCode":"755179389899","ComputedPrice":{"_ListPrice":"158","_RetailPrice":"77.99","_UnitPrice":"77.99","Extn":{"_btIsBonusEvent":"false","_btIsDoorBusterEvent":"false","_btIsHazMat":"false","_btIsIVPEvent":"false","_btIsNightOwlEvent":"false","_btIsOtherSpecialEvent":"false","_btIsSpecialHandling":"false","_btIsWebExclusive":"false","_btIsWebOnlyEvent":"false","_btSpecialHandlingFee":"0","_ExtnBadgingText":"Black Dot","_ExtnClass":"600","_ExtnDepartment":"400","_ExtnMPTID":"","_ExtnMPTOfferDetail":"","_ExtnMPTOfferMsg1":"","_ExtnMPTOfferMsg2":"","_ExtnPriceStatus":"P","_ExtnPromoNumber":"0","_ExtnSpecialHandlingCode":"0","_ExtnSPOID":"0","_ExtnSPOOfferDetail":"","_ExtnSPOOfferMsg1":"","_ExtnSPOOfferMsg2":""}}},"_AvailableQty":"10","defaultItemDescription":"Taylor Charcoal Sequin Knit Cap-Sleeve Squareneck Party Dress","defaultImageUrl":"http://broker.qa.bonton.com:7080/image/BonTon/431692","shippingMethodPrice":"0.00","shippingMethodDescription":"UPS Ground/Standard"};if(itemType==='BGT'){_addItem(bigTicketItem,1,true);}else{_addItem(itemObject,1,false);}};var _isLogCart=false;var _currentCustomerKey='';var _giftRegistryAddressSet={};var orderLineModel={"_CarrierServiceCode":"UPS-GRND","_DeliveryMethod":"SHP","_GiftFlag":"N","_GiftWrap":"N","_LevelOfService":"GRND","_OrderedQty":"2.0","_PrimeLineNo":1,"_SCAC":"UPS","_ScacAndService":"UPS-GRND","_SubLineNo":1,"Item":{"_ItemID":"425800414756","_ProductClass":"NEW","_UnitCost":"26.98000","_UnitOfMeasure":"EACH","_UPCCode":"0888590925992"},"PersonInfoShipTo":{"_AddressID":"LOGON5918 Alias like Home","_AddressLine1":"2412 56th ave","_AddressLine2":"Unit 3","_AddressLine3":"Bld 2","_City":"kenosha","_Country":"US","_DayPhone":"2629605804","_EMailID":"garrett.stibb@bonton.com","_EveningPhone":"1019991234","_FirstName":"Garrett","_LastName":"Stibb","_MiddleName":"C just initial ever","_PersonInfoKey":"20140819160910224059208","_State":"WI","_ZipCode":"53144"},"LinePriceInfo":{"_ListPrice":"40.00000","_RetailPrice":"26.98000","_UnitPrice":"40.00","_TaxableFlag":"Y"},"LineCharges":{"LineCharge":[{"_ChargeCategory":"BTN_SHIP_CHRG","_ChargeName":"CHRG_SHIPPING","_ChargePerUnit":"0.76","_Reference":""},{"_ChargeCategory":"BTN_SHIP_DISC","_ChargeName":"DISC_SHIPPING","_ChargePerUnit":"0.77","_Reference":"FREESHIP75"},{"_ChargeCategory":"BTN_SALES_DISC","_ChargeName":"DISC_PROMO","_ChargePerUnit":"13.04","_Reference":""}]},"LineTaxes":{"LineTax":[{"_ChargeCategory":"BTN_TAX_CHRG","_ChargeName":"TAX_SALES","_Tax":"3.78000","_TaxName":"SALES","Extn":{"_ExtnTaxPerUnit":"1.89"}},{"_ChargeCategory":"BTN_TAX_CHRG","_ChargeName":"TAX_SHIPPING","_Tax":"0.00000","_TaxName":"SHIPPING","Extn":{"_ExtnTaxPerUnit":"1.89"}}]},"Notes":{"Note":[{"_NoteText":"Hi","_ReasonCode":"GIFT_MESSAGE"},{"_NoteText":"Garrett","_ReasonCode":"GIFT_FROM"},{"_NoteText":"Sister","_ReasonCode":"GIFT_TO"}]},"Extn":{"_ExtnBadgingText":"1:Coupon Excluded;4:Incredible Value","_ExtnClass":"","_ExtnDepartment":"","_ExtnGiftItemId":"","_ExtnGiftPurchaseRecordID":"","_ExtnGiftRegistryNo":"","_ExtnGWP":"","_ExtnIsPriceLocked":"Y","_ExtnMPTID":"","_ExtnMPTOfferDetail":"","_ExtnMPTOfferMsg1":"","_ExtnMPTOfferMsg2":"","_ExtnParentLineNo":"","_ExtnPriceStatus":"","_ExtnPromoNumber":"","_ExtnSpecialHandlingCd":"1","_ExtnSPOID":"","_ExtnSPOOfferDetail":"","_ExtnSPOOfferMsg1":"","_ExtnSPOOfferMsg2":"","_ExtnSREligible":"1","_ExtnTranID":""},"btDisplay":{"itemDescription":"Dress Blue Medium","extendedDescription":"Here we are <ul><li>Blue</li></ul>","itemType":"REG","storageType":"R","_AvailableQty":2000,"alternateUPCs":["031290088157"],"imageURL":"/assets/images/865391.jpg","brandlongdesc":"Carter's","cfgdesc":"GIRLS","cfgid":101,"classlongdesc":"CARTERS","cmgdesc":"CHILDRENS","cmgid":10,"colorattrdesc":"Asst Lt/Pale","colorcode":"","colorDc":"","colorfamdesc":"Asst Family","colorlongdesc":"Navy","corpdesc":"","crgdesc":"CHILDRENS","crgid":0,"deptlongdesc":"GIRLSWEAR 2-6X","desc1":"TEE","desc2":"FALL CARTERS OP","desc3":"CARTERS OCT","desc4":"4-6X GIRL","fabdtldesc":"Screen Print","fablongdesc":"Cotton Blend-With Stretch","fobdesc":"GIRLS 2-6X","fobid":28,"genclasslongdesc":"Knit Tops","gensclalongdesc":"Tee","imageid":"","isn":"243306978","isnlongdesc":"GREEN FLORAL BABYDOLL TOP","itemsize":"4","keywords":"","labellongdesc":"Carter's","longpatterndesc":"","proddetail2":"Scoop Neck","proddetail3":"Knit-Interlock/Jersey","proddtllongdesc":"Short Sleeve","productcode":"","productname":"Green Floral Babydoll Top","size1code":"","size2code":"","sizedc":"","sizesequence":"1","vendorstyle":"273B053","webcatprodlongdesc":"","webid":""},"btLogic":{"isDeliveryAllowed":"N","isHazmat":"N","isParcelShippingAllowed":"Y","isPickupAllowed":"N","isReturnable":"Y","isShippingAllowed":"Y","isPriceOverridden":"Y","priceOverrideValue":21.33,"isBigTicket":"Y","btIsWebExclusive":"false","btIsWebOnlyEvent":"false","btIsIVPEvent":"false","btIsBonusEvent":"false","btIsDoorBusterEvent":"false","btIsNightOwlEvent":"false","btIsOtherSpecialEvent":"false","btIsSpecialHandling":"false","btSpecialHandlingFee":"0",giftImgUrl:"assets/images/GiftMessage.gif",isGiftRegistryAddress:false,giftBoxImgUrl:"assets/images/giftBox.gif"}};var _INIT_CART={_AuthorizedClient:"Store",_BillToID:"",_CustomerContactID:"",_CustomerEMailID:"",_DocumentType:"0001",_DraftOrderFlag:"N",_EnteredBy:"",_EnterpriseCode:"BONTON",_EntryType:"BTN",_OrderNo:"",_PaymentRuleId:"BT_DEF_PAYMENT_RULE",_SellerOrganizationCode:"",_TaxExemptFlag:"N",_TaxExemptionCertificate:"",OrderLines:{OrderLine:[]},PersonInfoBillTo:{},PersonInfoShipTo:{},PaymentMethods:{PaymentMethod:[]},Extn:{},PriceInfo:{_Currency:"USD"},btLogic:{}};var _INIT_ORDER_LINE={_CarrierServiceCode:"",_DeliveryMethod:"SHP",_GiftFlag:"N",_GiftWrap:"N",_LevelOfService:"",_OrderedQty:"1",_PrimeLineNo:1,_SCAC:"",_ScacAndService:"",_SubLineNo:1,Item:{_ItemID:"",_ProductClass:"NEW",_UnitCost:"",_UnitOfMeasure:"EACH",_UPCCode:""},ItemDetails:{_ItemID:"",PrimaryInformation:{_IsAirShippingAllowed:"",_ItemType:"REG",_IsParcelShippingAllowed:""},"ItemAliasList":{"ItemAlias":[{"_AliasName":"ACTIVE_UPC","_AliasValue":""}]}},PersonInfoShipTo:{_AddressID:"",_AddressLine1:"",_AddressLine2:"",_AddressLine3:"",_City:"",_Country:"US",_DayPhone:"",_EMailID:"",_EveningPhone:"",_FirstName:"",_LastName:"",_MiddleName:"",_PersonInfoKey:"",_State:"",_ZipCode:""},LinePriceInfo:{_ListPrice:"",_RetailPrice:"",_UnitPrice:"",_TaxableFlag:"Y"},LineCharges:{LineCharge:[{_ChargeAmount:"0.00",_ChargeCategory:"BTN_SHIP_CHRG",_ChargeName:"CHRG_SHIPPING",_ChargePerLine:"0.00",_ChargePerUnit:"0.00",_IsDiscount:"N"}]},LineTaxes:{LineTax:[]},Notes:{Note:[]},Extn:{},btDisplay:{defaultItemDescription:"",defaultImageUrl:""},btLogic:{cartTimeStamp:new Date().getTime(),isPriceOverridden:"N",priceOverrideValue:0,isBigTicket:"N",giftImgUrl:"assets/images/GreyGiftMessage.gif",isGiftRegistryAddress:false,giftBoxImgUrl:"assets/images/greyGiftBox.gif"}};var orderCart={};var orderCartModel={_AuthorizedClient:"Store",_BillToID:"",_CustomerContactID:"",_CustomerEMailID:"garrett.stibb@bonton.com",_DocumentType:"0001",_DraftOrderFlag:"Y",_EnteredBy:"014265",_EnterpriseCode:"BONTON",_EntryType:"BTN",_OrderNo:"",_PaymentRuleId:"BT_DEF_PAYMENT_RULE",_SellerOrganizationCode:"101",_TaxExemptFlag:"N",_TaxExemptionCertificate:"",OrderLines:{OrderLine:[{"_CarrierServiceCode":"UPS-GRND","_DeliveryMethod":"DEL","_GiftFlag":"N","_GiftWrap":"N","_LevelOfService":"GRND","_OrderedQty":"2.0","_PrimeLineNo":1,"_SCAC":"UPS","_ScacAndService":"UPS-GRND","_SubLineNo":1,"Item":{"_ItemID":"425800414756","_ProductClass":"NEW","_UnitCost":"26.98000","_UnitOfMeasure":"EACH","_UPCCode":"0888590925992"},"PersonInfoShipTo":{"_AddressID":"LOGON5918 Alias like Home","_AddressLine1":"2412 56th ave","_AddressLine2":"Unit 3","_AddressLine3":"Bld 2","_City":"kenosha","_Country":"US","_DayPhone":"2629605804","_EMailID":"garrett.stibb@bonton.com","_EveningPhone":"1019991234","_FirstName":"Garrett","_LastName":"Stibb","_MiddleName":"C just initial ever","_PersonInfoKey":"20140819160910224059208","_State":"WI","_ZipCode":"53144"},"LinePriceInfo":{"_ListPrice":"40.00000","_RetailPrice":"26.98000","_UnitPrice":"40.00","_TaxableFlag":"Y"},"LineCharges":{"LineCharge":[{"_ChargeCategory":"BTN_SHIP_CHRG","_ChargeName":"CHRG_SHIPPING","_ChargePerUnit":"0.76","_Reference":""},{"_ChargeCategory":"BTN_SHIP_DISC","_ChargeName":"DISC_SHIPPING","_ChargePerUnit":"0.77","_Reference":"FREESHIP75"},{"_ChargeCategory":"BTN_SALES_DISC","_ChargeName":"DISC_PROMO","_ChargePerUnit":"13.04","_Reference":""}]},"LineTaxes":{"LineTax":[{"_ChargeCategory":"BTN_TAX_CHRG","_ChargeName":"TAX_SALES","_Tax":"3.78000","_TaxName":"SALES","Extn":{"_ExtnTaxPerUnit":"1.89"}},{"_ChargeCategory":"BTN_TAX_CHRG","_ChargeName":"TAX_SHIPPING","_Tax":"0.00000","_TaxName":"SHIPPING","Extn":{"_ExtnTaxPerUnit":"1.89"}}]},"Notes":{"Note":[{"_NoteText":"Hi","_ReasonCode":"GIFT_MESSAGE"},{"_NoteText":"Garrett","_ReasonCode":"GIFT_FROM"},{"_NoteText":"Sister","_ReasonCode":"GIFT_TO"}]},"Extn":{"_ExtnBadgingText":"1:Coupon Excluded;4:Incredible Value","_ExtnClass":"","_ExtnDepartment":"","_ExtnGiftItemId":"","_ExtnGiftPurchaseRecordID":"","_ExtnGiftRegistryNo":"","_ExtnGWP":"","_ExtnIsPriceLocked":"Y","_ExtnMPTID":"","_ExtnMPTOfferDetail":"","_ExtnMPTOfferMsg1":"","_ExtnMPTOfferMsg2":"","_ExtnParentLineNo":"","_ExtnPriceStatus":"","_ExtnPromoNumber":"","_ExtnSpecialHandlingCd":"1","_ExtnSPOID":"","_ExtnSPOOfferDetail":"","_ExtnSPOOfferMsg1":"","_ExtnSPOOfferMsg2":"","_ExtnSREligible":"1","_ExtnTranID":""},"btDisplay":{"itemDescription":"Dress Blue Medium","itemType":"REG","storageType":"R","_AvailableQty":2000,"alternateUPCs":["031290088157"],"imageURL":"/assets/images/865391.jpg","brandlongdesc":"Carter's","cfgdesc":"GIRLS","cfgid":101,"classlongdesc":"CARTERS","cmgdesc":"CHILDRENS","cmgid":10,"colorattrdesc":"Asst Lt/Pale","colorcode":"","colorDc":"","colorfamdesc":"Asst Family","colorlongdesc":"Navy","corpdesc":"","crgdesc":"CHILDRENS","crgid":0,"deptlongdesc":"GIRLSWEAR 2-6X","desc1":"TEE","desc2":"FALL CARTERS OP","desc3":"CARTERS OCT","desc4":"4-6X GIRL","fabdtldesc":"Screen Print","fablongdesc":"Cotton Blend-With Stretch","fobdesc":"GIRLS 2-6X","fobid":28,"genclasslongdesc":"Knit Tops","gensclalongdesc":"Tee","imageid":"","isn":"243306978","isnlongdesc":"GREEN FLORAL BABYDOLL TOP","itemsize":"4","keywords":"","labellongdesc":"Carter's","longpatterndesc":"","proddetail2":"Scoop Neck","proddetail3":"Knit-Interlock/Jersey","proddtllongdesc":"Short Sleeve","productcode":"","productname":"Green Floral Babydoll Top","size1code":"","size2code":"","sizedc":"","sizesequence":"1","vendorstyle":"273B053","webcatprodlongdesc":"","webid":""},"btLogic":{"isDeliveryAllowed":"N","isHazmat":"N","isParcelShippingAllowed":"Y","isPickupAllowed":"N","isReturnable":"Y","isShippingAllowed":"Y","isPriceOverridden":"Y","priceOverrideValue":21.33,"isBigTicket":"Y","btIsWebExclusive":"false","btIsWebOnlyEvent":"false","btIsIVPEvent":"false","btIsBonusEvent":"false","btIsDoorBusterEvent":"false","btIsNightOwlEvent":"false","btIsOtherSpecialEvent":"false","btIsSpecialHandling":"false","btSpecialHandlingFee":"0",giftImgUrl:"assets/images/GiftMessage.gif",isGiftRegistryAddress:false,giftBoxImgUrl:"assets/images/giftBox.gif"}}]},PersonInfoBillTo:{_AddressID:"LOGON5918",_AddressLine1:"2412 56th ave",_City:"kenosha",_Country:"US",_DayPhone:"2629605804",_EMailID:"garrett.stibb@bonton.com",_FirstName:"Garrett",_LastName:"Stibb",_PersonID:"8701684",_PersonInfoKey:"20140819160910224059208",_State:"WI",_ZipCode:"53144"},PersonInfoShipTo:{_AddressID:"LOGON5918",_AddressLine1:"2412 56th ave",_City:"kenosha",_Country:"US",_DayPhone:"2629605804",_EMailID:"garrett.stibb@bonton.com",_FirstName:"Garrett",_LastName:"Stibb",_PersonID:"8701684",_PersonInfoKey:"20140819160910224059208",_State:"WI",_ZipCode:"53144"},PaymentMethods:{PaymentMethod:[{_UnlimitedCharges:"Y",_PaymentType:"CREDIT_CARD",_DisplayCreditCardNo:"0691",_CreditCardType:"CP",_CreditCardNo:"8231211627154941",_CreditCardExpDate:"04/2018",PaymentDetails:{_ProcessedAmount:"102.65000",_ChargeType:"AUTHORIZATION",_AuthorizationID:"001060",_AuthCode:"001060"}}]},Extn:{},PriceInfo:{_Currency:"USD"}};var customerModel={"Customer":{"_CustomerType":"02","_OrganizationCode":"BONTON","_Status":"10","_ExternalCustomerID":"LOGON5918","_RegisteredDate":"2014-08-19T11:24:05-04:00","_CustomerID":"W231905","_CustomerKey":"20140819112410223924123","CustomerContactList":{"_TotalNumberOfRecords":"1","CustomerContact":{"_AggregateStatus":"10","CustomerAdditionalAddressList":{"_TotalNumberOfRecords":"9","CustomerAdditionalAddress":[{"_IsShipTo":"Y","_IsDefaultSoldTo":"N","_IsDefaultBillTo":"Y","_CustomerAdditionalAddressID":"100053538","_AddressType":"SB","_IsSoldTo":"Y","_IsDefaultShipTo":"Y","PersonInfo":{"_EMailID":"garrett.stibb@bonton.com","_PersonInfoKey":"20150402190721329128955","_VerificationStatus":"","_PreferredShipAddress":"","_DayPhone":"6969696969","_LastName":"Stibb","_EveningFaxNo":"","_OtherPhone":"","_DayFaxNo":"","_HttpUrl":"uid=logon5918,o=default organization,o=root organization","_PersonID":"8701684","_FirstName":"Garrett","_MobilePhone":"","_Company":"","_Department":"","_AlternateEmailID":"","_Suffix":"","_Country":"US","_ErrorTxt":"","_ZipCode":"53144","_Title":"","_City":"kenosha","_AddressID":"LOGON5918","_MiddleName":"","_State":"WI","_AddressLine4":"","_AddressLine5":"","_AddressLine6":"","_EveningPhone":"","_JobTitle":"","_Beeper":"","_AddressLine1":"2412 56th ave","_UseCount":"0","_AddressLine2":"","_AddressLine3":""},"_IsBillTo":"Y"},{"_IsShipTo":"Y","_IsDefaultSoldTo":"N","_IsDefaultBillTo":"N","_CustomerAdditionalAddressID":"100053539","_AddressType":"SB","_IsSoldTo":"Y","_IsDefaultShipTo":"N","PersonInfo":{"_EMailID":"garrett.stibb@bonton.com","_PersonInfoKey":"20150402190721329128956","_VerificationStatus":"","_PreferredShipAddress":"","_DayPhone":"6969696969","_LastName":"Stibb","_EveningFaxNo":"","_OtherPhone":"","_DayFaxNo":"","_HttpUrl":"uid=logon5918,o=default organization,o=root organization","_PersonID":"8701711","_FirstName":"Garrett","_MobilePhone":"","_Company":"","_Department":"","_AlternateEmailID":"","_Suffix":"","_Country":"US","_ErrorTxt":"","_ZipCode":"53132","_Title":"","_City":"Franklin","_AddressID":"ShopRunner billing","_MiddleName":"","_State":"WI","_AddressLine4":"","_AddressLine5":"","_AddressLine6":"","_EveningPhone":"","_JobTitle":"","_Beeper":"","_AddressLine1":"8878 S 84th Street","_UseCount":"0","_AddressLine2":"","_AddressLine3":""},"_IsBillTo":"Y"},{"_IsShipTo":"Y","_IsDefaultSoldTo":"N","_IsDefaultBillTo":"N","_CustomerAdditionalAddressID":"100053540","_AddressType":"SB","_IsSoldTo":"Y","_IsDefaultShipTo":"N","PersonInfo":{"_EMailID":"garrett.stibb@bonton.com","_PersonInfoKey":"20150402190721329128957","_VerificationStatus":"","_PreferredShipAddress":"","_DayPhone":"6969696969","_LastName":"Stibb","_EveningFaxNo":"","_OtherPhone":"","_DayFaxNo":"","_HttpUrl":"uid=logon5918,o=default organization,o=root organization","_PersonID":"8701710","_FirstName":"Garrett","_MobilePhone":"","_Company":"","_Department":"","_AlternateEmailID":"","_Suffix":"","_Country":"US","_ErrorTxt":"","_ZipCode":"53144","_Title":"","_City":"kenosha","_AddressID":"ShopRunner shipping","_MiddleName":"","_State":"WI","_AddressLine4":"","_AddressLine5":"","_AddressLine6":"","_EveningPhone":"","_JobTitle":"","_Beeper":"","_AddressLine1":"2412 56th ave","_UseCount":"0","_AddressLine2":"","_AddressLine3":""},"_IsBillTo":"Y"},{"_IsShipTo":"Y","_IsDefaultSoldTo":"N","_IsDefaultBillTo":"N","_CustomerAdditionalAddressID":"100054291","_AddressType":"","_IsDefaultShipTo":"N","PersonInfo":{"_EMailID":"garrett.stibb@bonton.com","_PersonInfoKey":"20141009153257247979216","_VerificationStatus":"","_PreferredShipAddress":"","_DayPhone":"4143475323","_LastName":"Stibb","_EveningFaxNo":"","_OtherPhone":"","_DayFaxNo":"","_HttpUrl":"","_PersonID":"","_FirstName":"Garrett","_MobilePhone":"","_Company":"","_Department":"","_AlternateEmailID":"","_Suffix":"","_Country":"US","_ErrorTxt":"","_ZipCode":"53144","_Title":"","_City":"kenosha","_AddressID":"LOGON5918","_MiddleName":"","_State":"WI","_AddressLine4":"","_AddressLine5":"","_AddressLine6":"","_EveningPhone":"","_JobTitle":"","_Beeper":"","_AddressLine1":"2412 56th ave","_UseCount":"0","_AddressLine2":"","_AddressLine3":""},"_IsBillTo":"Y"},{"_IsShipTo":"Y","_IsDefaultSoldTo":"N","_IsDefaultBillTo":"N","_CustomerAdditionalAddressID":"100054305","_AddressType":"","_IsDefaultShipTo":"N","PersonInfo":{"_EMailID":"garrett.stibb@bonton.com","_PersonInfoKey":"20150402190721329128958","_VerificationStatus":"","_PreferredShipAddress":"","_DayPhone":"6969696969","_LastName":"Stibb","_EveningFaxNo":"","_OtherPhone":"","_DayFaxNo":"","_HttpUrl":"","_PersonID":"","_FirstName":"Garrett","_MobilePhone":"","_Company":"","_Department":"","_AlternateEmailID":"","_Suffix":"","_Country":"US","_ErrorTxt":"","_ZipCode":"96821","_Title":"","_City":"Honolulu","_AddressID":"LOGON5918","_MiddleName":"","_State":"HI","_AddressLine4":"","_AddressLine5":"","_AddressLine6":"","_EveningPhone":"","_JobTitle":"","_Beeper":"","_AddressLine1":"34 Akilolo St","_UseCount":"0","_AddressLine2":"","_AddressLine3":""},"_IsBillTo":"Y"},{"_IsShipTo":"Y","_IsDefaultSoldTo":"N","_IsDefaultBillTo":"N","_CustomerAdditionalAddressID":"100054614","_AddressType":"","_IsDefaultShipTo":"N","PersonInfo":{"_EMailID":"garrett.stibb@bonton.com","_PersonInfoKey":"20150402190721329128959","_VerificationStatus":"","_PreferredShipAddress":"","_DayPhone":"6969696969","_LastName":"Stibb","_EveningFaxNo":"","_OtherPhone":"","_DayFaxNo":"","_HttpUrl":"","_PersonID":"","_FirstName":"Garrett","_MobilePhone":"","_Company":"","_Department":"","_AlternateEmailID":"","_Suffix":"","_Country":"US","_ErrorTxt":"","_ZipCode":"53144","_Title":"","_City":"kenosha","_AddressID":"LOGON5918","_MiddleName":"","_State":"WI","_AddressLine4":"","_AddressLine5":"","_AddressLine6":"","_EveningPhone":"","_JobTitle":"","_Beeper":"","_AddressLine1":"2412 22th street","_UseCount":"0","_AddressLine2":"","_AddressLine3":""},"_IsBillTo":"Y"},{"_IsShipTo":"Y","_IsDefaultSoldTo":"N","_IsDefaultBillTo":"N","_CustomerAdditionalAddressID":"100054627","_AddressType":"","_IsDefaultShipTo":"N","PersonInfo":{"_EMailID":"garrett.stibb@bonton.com","_PersonInfoKey":"20150402190721329128960","_VerificationStatus":"","_PreferredShipAddress":"","_DayPhone":"6969696969","_LastName":"Stibb","_EveningFaxNo":"","_OtherPhone":"","_DayFaxNo":"","_HttpUrl":"","_PersonID":"","_FirstName":"Garrett","_MobilePhone":"","_Company":"","_Department":"","_AlternateEmailID":"","_Suffix":"","_Country":"US","_ErrorTxt":"","_ZipCode":"33019","_Title":"","_City":"Hollywood","_AddressID":"Modified","_MiddleName":"","_State":"FL","_AddressLine4":"","_AddressLine5":"","_AddressLine6":"","_EveningPhone":"","_JobTitle":"","_Beeper":"","_AddressLine1":"904 N North Lake Dr","_UseCount":"0","_AddressLine2":"","_AddressLine3":""},"_IsBillTo":"Y"},{"_IsShipTo":"Y","_IsDefaultSoldTo":"N","_IsDefaultBillTo":"N","_CustomerAdditionalAddressID":"100054629","_AddressType":"","_IsDefaultShipTo":"N","PersonInfo":{"_EMailID":"garrett.stibb@bonton.com","_PersonInfoKey":"20141215171030280899222","_VerificationStatus":"","_PreferredShipAddress":"","_DayPhone":"2625512222","_LastName":"Stibb","_EveningFaxNo":"","_OtherPhone":"","_DayFaxNo":"","_HttpUrl":"","_PersonID":"","_FirstName":"Garrett","_MobilePhone":"","_Company":"","_Department":"","_AlternateEmailID":"","_Suffix":"","_Country":"US","_ErrorTxt":"","_ZipCode":"33019","_Title":"","_City":"Hollywood","_AddressID":"Florida","_MiddleName":"","_State":"FL","_AddressLine4":"","_AddressLine5":"","_AddressLine6":"","_EveningPhone":"","_JobTitle":"","_Beeper":"","_AddressLine1":"904 N North Lake Dr","_UseCount":"0","_AddressLine2":"","_AddressLine3":""},"_IsBillTo":"Y"},{"_IsShipTo":"Y","_IsDefaultSoldTo":"N","_IsDefaultBillTo":"N","_CustomerAdditionalAddressID":"100055317","_AddressType":"","_IsDefaultShipTo":"N","PersonInfo":{"_EMailID":"garrett.stibb@bonton.com","_PersonInfoKey":"20150402190721329128961","_VerificationStatus":"","_PreferredShipAddress":"","_DayPhone":"6969696969","_LastName":"Stibb","_EveningFaxNo":"","_OtherPhone":"","_DayFaxNo":"","_HttpUrl":"","_PersonID":"","_FirstName":"Garrett","_MobilePhone":"","_Company":"","_Department":"","_AlternateEmailID":"","_Suffix":"","_Country":"US","_ErrorTxt":"","_ZipCode":"33019","_Title":"","_City":"Hollywood","_AddressID":"Florida","_MiddleName":"","_State":"FL","_AddressLine4":"","_AddressLine5":"","_AddressLine6":"","_EveningPhone":"","_JobTitle":"","_Beeper":"","_AddressLine1":"904 N North Lake Dr","_UseCount":"0","_AddressLine2":"","_AddressLine3":""},"_IsBillTo":"Y"}]},"_UserID":"","_DayPhone":"6969696969","_LastName":"Stibb","_Title":"","_EveningFaxNo":"","_CustomerContactID":"W231905","_DayFaxNo":"","_MiddleName":"","_FirstName":"Garrett","_EveningPhone":"","_Company":"","_MobilePhone":"","_EmailID":"garrett.stibb@bonton.com"}}}};$rootScope.$on('AddCustomerToCartCalled',function(event,customer){_setCustomer(customer);});var _setStoreAndAssociateId=function(storeNumber,associateId){if(angular.isDefined(storeNumber)&&storeNumber.toString().trim().length>0){orderCart._EnteredBy="Store";}
if(angular.isDefined(associateId)){orderCart.Extn._ExtnAssociateId=associateId.toString();}
if(angular.isDefined(storeNumber)&&storeNumber.length>0){orderCart._SellerOrganizationCode=storeNumber.toString();var url=serviceURL+"/Organization/GetStoreInfo";var contract={GetStoreInfoReq:{Stores:[{_StoreID:storeNumber}]}}
$http.post(url,angular.toJson(contract)).success(function(data){if(data.GetStoreInfoResp.Stores&&data.GetStoreInfoResp.Stores){orderCart.Extn._EntryType=data.GetStoreInfoResp.Stores[0];orderCart._EntryType=data.GetStoreInfoResp.Stores[0];}else{orderCart.Extn._EntryType='BTN';orderCart._EntryType='BTN';}}).error(function(data){$sendSMTPErrorEmail(data,url,contract);orderCart.Extn._EntryType='BTN';orderCart._EntryType='BTN';});};};$rootScope.$on('POSParmsSet',function(event,parameters){_setStoreAndAssociateId(parameters.storeNumber,parameters.associateId);});var _getPrimeSubLineObject=function(orderline){var object={};if(angular.isDefined(orderline._PrimeLineNo)){object.PrimeLine=orderline._PrimeLineNo;}else{return null;}
if(angular.isDefined(orderline._SubLineNo)){object.SubLine=orderline._SubLineNo;}else{object.SubLine=1;}
return object;};var _findPrimeSubInCart=function(primeSubObj,cart){var returnedOrderlines=[];primeSubObj=_primeSubLineObjectCleaner(primeSubObj);if(angular.isDefined(cart)&&angular.isDefined(cart.OrderLines)&&angular.isArray(cart.OrderLines.OrderLine)){for(var i=0;i<cart.OrderLines.OrderLine.length;i++){if(cart.OrderLines.OrderLine[i]._PrimeLineNo==primeSubObj.PrimeLine&&cart.OrderLines.OrderLine[i]._SubLineNo==primeSubObj.SubLine){returnedOrderlines.push(cart.OrderLines.OrderLine[i]);}}}
return returnedOrderlines;};var _deleteOrderLine=function(arrayOfPrimeSubLineObjects,_isCleanCartToo){if(_isCleanCartToo){_cleanOrderCart();}
arrayOfPrimeSubLineObjects=_arrayOfPrimeSubCleaner(arrayOfPrimeSubLineObjects);for(var i=0;arrayOfPrimeSubLineObjects.length>0&&i<orderCart.OrderLines.OrderLine.length;i++){if(orderCart.OrderLines.OrderLine[i]._PrimeLineNo==arrayOfPrimeSubLineObjects[0].PrimeLine&&orderCart.OrderLines.OrderLine[i]._SubLineNo==arrayOfPrimeSubLineObjects[0].SubLine){orderCart.OrderLines.OrderLine.splice(i,1);arrayOfPrimeSubLineObjects.shift();}}};var _setOrderLineShipToAddresses=function(arrayOfPrimeSubLineObjects,addressObject,isGiftRegAddress){arrayOfPrimeSubLineObjects=_arrayOfPrimeSubCleaner(arrayOfPrimeSubLineObjects);for(var i=0;arrayOfPrimeSubLineObjects.length>0&&i<orderCart.OrderLines.OrderLine.length;i++){if(orderCart.OrderLines.OrderLine[i]._PrimeLineNo==arrayOfPrimeSubLineObjects[0].PrimeLine&&orderCart.OrderLines.OrderLine[i]._SubLineNo==arrayOfPrimeSubLineObjects[0].SubLine){_copyAddress(addressObject.PersonInfo,orderCart.OrderLines.OrderLine[i].PersonInfoShipTo);orderCart.OrderLines.OrderLine[i].btLogic.shippingAddress=angular.copy(addressObject);if(isGiftRegAddress){orderCart.OrderLines.OrderLine[i].btLogic.isGiftRegistryAddress=true;}else{orderCart.OrderLines.OrderLine[i].btLogic.isGiftRegistryAddress=false;}
arrayOfPrimeSubLineObjects.shift();}}};var _validAddress=function(address,isBillingAddress){return $customer.validateAddress(address,isBillingAddress);};var _validateOrderHeader=function(inputCart){if(!angular.isDefined(inputCart)){inputCart=orderCart;}
var result={customerEmailIdError:{hasError:false,errorText:''}};if(!angular.isDefined(inputCart._CustomerEMailID)||inputCart._CustomerEMailID===null||inputCart._CustomerEMailID.toString().trim()===''){result.customerEmailIdError.hasError=true;result.customerEmailIdError.errorText='Order Header Error: No Customer Contact Email.';}
return result;};var _hasBigTicketItems=function(inputCart){if(!angular.isDefined(inputCart)){inputCart=orderCart;}
if(angular.isDefined(inputCart.OrderLines)&&angular.isArray(inputCart.OrderLines.OrderLine)){for(var i=0;i<inputCart.OrderLines.OrderLine.length;i++){var currentLine=inputCart.OrderLines.OrderLine[i];if(angular.isDefined(currentLine.ItemDetails)&&angular.isDefined(currentLine.ItemDetails.PrimaryInformation)&&angular.isDefined(currentLine.ItemDetails.PrimaryInformation._ItemType)){if((/BGT/i).test(currentLine.ItemDetails.PrimaryInformation._ItemType)){return true;}}else if(angular.isDefined(currentLine.Extn)&&angular.isDefined(currentLine.Extn._btIsBigTicket)){if((/BGT/i).test(currentLine.Extn._btIsBigTicket)){return true;}}}
return false;}else{return false;}};var _validateOrderAddresses=function(inputCart){if(!angular.isDefined(inputCart)){inputCart=orderCart;}
var result={defaultBillingAddressError:{hasError:false,errorText:''},defaultShipToAddressError:{hasError:false,errorText:''},carrierServiceCodeError:{hasError:false,errorText:'',orderlines:[]},bigTicketError:{hasError:false,errorText:'',orderlines:[]},orderlineShiptoAddressError:{hasError:false,errorText:'',orderlines:[]}};var validObj=_validAddress(inputCart.PersonInfoBillTo,true);result.defaultBillingAddressError.hasError=!validObj.isValid;result.defaultBillingAddressError.errorText='Order Default Bill To Errors: '+validObj.errorMessage;var validObj=_validAddress(inputCart.PersonInfoShipTo);result.defaultShipToAddressError.hasError=!validObj.isValid;result.defaultShipToAddressError.errorText='Order Default Ship To Errors: '+validObj.errorMessage;var carrierErrorArray=[];var bigTicketErrorArray=[];var orderlineErrorArray=[];var bigTicketPromiseArray=[];for(var i=0;i<inputCart.OrderLines.OrderLine.length;i++){var currentOrderLine=inputCart.OrderLines.OrderLine[i];var lineNo=_getPrimeSubLineObject(currentOrderLine);if(!angular.isDefined(currentOrderLine._CarrierServiceCode)||currentOrderLine._CarrierServiceCode.toString().trim()===''){result.carrierServiceCodeError.hasError=true;result.carrierServiceCodeError.orderlines.push(currentOrderLine);carrierErrorArray.push('Line '+lineNo.PrimeLine+'.'+lineNo.SubLine+': Not set');}
var validObj=_validAddress(currentOrderLine.PersonInfoShipTo);if(!validObj.isValid){result.orderlineShiptoAddressError.hasError=true;orderlineErrorArray.push('Line '+lineNo.PrimeLine+'.'+lineNo.SubLine);result.orderlineShiptoAddressError.orderlines.push({orderline:currentOrderLine,errorText:'Line '+lineNo.PrimeLine+'.'+lineNo.SubLine+' errors: '+validObj.errorMessage});}
if(!angular.isDefined(currentOrderLine.ItemDetails)||!angular.isDefined(currentOrderLine.ItemDetails.PrimaryInformation)||!angular.isDefined(currentOrderLine.ItemDetails.PrimaryInformation._ItemType)){result.bigTicketError.hasError=true;bigTicketErrorArray.push('Line '+lineNo.PrimeLine+'.'+lineNo.SubLine+' No ItemType');}else if((/^BGT$/).test(currentOrderLine.ItemDetails.PrimaryInformation._ItemType.toString().trim())){try{(function(){var cPromise=$bigTicketValidate.bigTicketPromise(currentOrderLine.PersonInfoShipTo._ZipCode);var line=currentOrderLine;cPromise.then(function(response){if(response.data.ValidateBigTicketZipCodeResp._statusMessage==="Success"){if(response.data.ValidateBigTicketZipCodeResp._isValid=="false"){result.bigTicketError.hasError=true;var cLineNo=_getPrimeSubLineObject(line);bigTicketErrorArray.push('Line '+cLineNo.PrimeLine+'.'+cLineNo.SubLine+' Cannot Deliver to zip:'+
line.PersonInfoShipTo._ZipCode);result.orderlineShiptoAddressError.orderlines.push(line);}}else{result.bigTicketError.hasError=true;var cLineNo=_getPrimeSubLineObject(line);bigTicketErrorArray.push('Line '+cLineNo.PrimeLine+'.'+cLineNo.SubLine+' Big Ticket Service Down. Please retry.');}});bigTicketPromiseArray.push(cPromise);})();}catch(e){}}}
return $q.all(bigTicketPromiseArray).then(function(){result.carrierServiceCodeError.errorText='CarrierService Errors: '+carrierErrorArray.join(', ');result.bigTicketError.errorText='BigTicket Errors: '+bigTicketErrorArray.join(', ');result.orderlineShiptoAddressError.errorText='Orderline Ship To Address Errors: '+orderlineErrorArray.join('; ');return result;});};var _setBillingAddress=function(addressObject){if(addressObject){_copyAddress(addressObject.PersonInfo,orderCart.PersonInfoBillTo);orderCart.btLogic.defaultBillToAddress=angular.copy(addressObject);}else{_copyAddress(null,orderCart.PersonInfoBillTo);orderCart.btLogic.defaultBillToAddress=null;}};var _setDefaultShipToAddress=function(addressObject){if(addressObject){_copyAddress(addressObject.PersonInfo,orderCart.PersonInfoShipTo);orderCart.btLogic.defaultShipToAddress=angular.copy(addressObject);}else{_copyAddress(null,orderCart.PersonInfoShipTo);orderCart.btLogic.defaultShipToAddress=null;}};var _getRegistryAddressSet=function(){return _giftRegistryAddressSet;};var _loadRegistryAddresses=function(){var registryOnOrderSet={};for(var i=0;i<orderCart.OrderLines.OrderLine.length;i++){if(angular.isDefined(orderCart.OrderLines.OrderLine[i].Extn._ExtnGiftRegistryNo)&&orderCart.OrderLines.OrderLine[i].Extn._ExtnGiftRegistryNo.toString().trim().length>0){var registryValue=orderCart.OrderLines.OrderLine[i].Extn._ExtnGiftRegistryNo;if(!(registryValue in registryOnOrderSet)){registryOnOrderSet[registryValue]=registryValue;}}}
var missingRegistryAddress={};for(var registryValue in registryOnOrderSet){if(!(registryValue in _giftRegistryAddressSet)){missingRegistryAddress[registryValue]=registryValue;}}
var promiseArr=[];for(var registryValue in missingRegistryAddress){promiseArr.push(giftRegistryService.preferredAddressPromise(registryValue).then(function(response){if(response.data.PreferredAddressOutput.PreferredAddressResponse.IsValid==='true'&&response.data.PreferredAddressOutput.PreferredAddressResponse.HasErrors==='false'){var normalizedAddress=giftRegistryService.constructRegistryAddress(registryValue,response.data.PreferredAddressOutput.PreferredAddressResponse);_giftRegistryAddressSet[registryValue.toString().trim()]=normalizedAddress;}else{var ErrorMessage='';if(response.data.PreferredAddressOutput.PreferredAddressResponse.HasErrors==='true'){ErrorMessage=response.data.PreferredAddressOutput.PreferredAddressResponse.ErrorMessage;}
throw errorObj.newError('_loadRegistryAddresses():InvalidRegNo',"The Registry Number: "+registryValue+" is invalid.","_loadRegistryAddresses(): The Registry Number: "+registryValue+" is invalid. Error Message: '"+ErrorMessage+"'",'InvalidRegNo','WARN');}},function(data){$sendSMTPErrorEmail(data,serviceURL.toString()+'/GiftRegistry/GetPreferredAddress');}));}
return $q.all(promiseArr).then(function(){return _giftRegistryAddressSet;});};var _getCustomersDefaultBillToAndShipTo=function(customerObject){var defaultShipToKey=null;var defaultShipToAddress=null;var defaultBillToKey=null;var defaultBillToAddress=null;for(var i=0;i<customerObject.CustomerContactList.CustomerContact[0].CustomerAdditionalAddressList.CustomerAdditionalAddress.length;i++){if(customerObject.CustomerContactList.CustomerContact[0].CustomerAdditionalAddressList.CustomerAdditionalAddress[i]._IsDefaultBillTo=='Y'){defaultBillToAddress=customerObject.CustomerContactList.CustomerContact[0].CustomerAdditionalAddressList.CustomerAdditionalAddress[i];defaultBillToKey=defaultBillToAddress.PersonInfo._PersonInfoKey;}
if(customerObject.CustomerContactList.CustomerContact[0].CustomerAdditionalAddressList.CustomerAdditionalAddress[i]._IsDefaultShipTo=='Y'){defaultShipToAddress=customerObject.CustomerContactList.CustomerContact[0].CustomerAdditionalAddressList.CustomerAdditionalAddress[i];defaultShipToKey=defaultShipToAddress.PersonInfo._PersonInfoKey;}
if(defaultBillToKey&&defaultShipToKey){break;}}
if(defaultBillToKey===null||defaultShipToKey===null){if(defaultBillToKey===null){if(customerObject.CustomerContactList.CustomerContact[0].CustomerAdditionalAddressList.CustomerAdditionalAddress.length>0){defaultBillToAddress=customerObject.CustomerContactList.CustomerContact[0].CustomerAdditionalAddressList.CustomerAdditionalAddress[0];defaultBillToKey=defaultBillToAddress.PersonInfo._PersonInfoKey;}}
if(defaultShipToKey===null){for(var i=0;i<customerObject.CustomerContactList.CustomerContact[0].CustomerAdditionalAddressList.CustomerAdditionalAddress.length;i++){if(customerObject.CustomerContactList.CustomerContact[0].CustomerAdditionalAddressList.CustomerAdditionalAddress[i].PersonInfo._Country.toString().trim().toUpperCase()=='US'){defaultShipToAddress=customerObject.CustomerContactList.CustomerContact[0].CustomerAdditionalAddressList.CustomerAdditionalAddress[i];defaultShipToKey=defaultShipToAddress.PersonInfo._PersonInfoKey;break;}}}}
return{defaultShipToKey:defaultShipToKey,defaultShipToAddress:defaultShipToAddress,defaultBillToKey:defaultBillToKey,defaultBillToAddress:defaultBillToAddress};};var _resetOrderAddresses=function(customerObject){var defaultObject=_getCustomersDefaultBillToAndShipTo(customerObject);if(defaultObject.defaultBillToAddress===null||defaultObject.defaultShipToAddress===null){$loggerService.log('_resetOrderAddresses() did not find a default Bill To or Default Ship To for customer. defaultBillToKey:'+
defaultObject.defaultBillToAddress+'  defaultShipToKey:'+defaultObject.defaultShipToAddress);return;}
orderCart._BillToID=customerObject._CustomerID;orderCart._CustomerContactID=customerObject.CustomerContactList.CustomerContact[0]._CustomerContactID;orderCart._CustomerEMailID=customerObject.CustomerContactList.CustomerContact[0]._EmailID;if(defaultObject.defaultBillToAddress){_setBillingAddress(defaultObject.defaultBillToAddress);}
if(defaultObject.defaultShipToAddress){_setDefaultShipToAddress(defaultObject.defaultShipToAddress);}
for(var i=0;i<orderCart.OrderLines.OrderLine.length;i++){var tempOrderline=orderCart.OrderLines.OrderLine[i];var tempShipToAddress=defaultObject.defaultShipToAddress;if(tempOrderline.Extn._ExtnGiftRegistryNo&&tempOrderline.Extn._ExtnGiftRegistryNo.trim()){if(tempOrderline.Extn._ExtnGiftRegistryNo in _giftRegistryAddressSet){tempShipToAddress=_giftRegistryAddressSet[tempOrderline.Extn._ExtnGiftRegistryNo];tempOrderline.btLogic.isGiftRegistryAddress=true;}}
_copyAddress(tempShipToAddress.PersonInfo,tempOrderline.PersonInfoShipTo);tempOrderline.btLogic.shippingAddress=angular.copy(tempShipToAddress);}};var _customerAddressCheck=function(customerObject){var addressMap={};orderCart._CustomerEMailID=customerObject.CustomerContactList.CustomerContact[0]._EmailID;for(var i=0;i<customerObject.CustomerContactList.CustomerContact[0].CustomerAdditionalAddressList.CustomerAdditionalAddress.length;i++){addressMap[customerObject.CustomerContactList.CustomerContact[0].CustomerAdditionalAddressList.CustomerAdditionalAddress[i]._CustomerAdditionalAddressID]=customerObject.CustomerContactList.CustomerContact[0].CustomerAdditionalAddressList.CustomerAdditionalAddress[i];}
var defaultObject=_getCustomersDefaultBillToAndShipTo(customerObject);if(defaultObject.defaultBillToAddress===null||defaultObject.defaultShipToAddress===null){$loggerService.log('_resetOrderAddresses() did not find a default Bill To or Default Ship To for customer. defaultBillToKey:'+
defaultObject.defaultBillToAddress+'  defaultShipToKey:'+defaultObject.defaultShipToAddress);return;}
if(defaultObject.defaultShipToAddress){_setDefaultShipToAddress(defaultObject.defaultShipToAddress);}
if(defaultObject.defaultBillToAddress){if(orderCart.btLogic.defaultBillToAddress._CustomerAdditionalAddressID.toString()in addressMap){if(orderCart.PersonInfoBillTo._PersonInfoKey.toString().trim()!==addressMap[orderCart.btLogic.defaultBillToAddress._CustomerAdditionalAddressID.toString()].PersonInfo._PersonInfoKey.toString().trim()){_setBillingAddress(addressMap[orderCart.btLogic.defaultBillToAddress._CustomerAdditionalAddressID.toString()]);}}
else{_setBillingAddress(defaultObject.defaultBillToAddress);}}
for(var i=0;i<orderCart.OrderLines.OrderLine.length;i++){var currentOrderLine=orderCart.OrderLines.OrderLine[i];if(currentOrderLine.btLogic.shippingAddress._CustomerAdditionalAddressID.toString()in addressMap){if(currentOrderLine.PersonInfoShipTo._PersonInfoKey.toString().trim()!==addressMap[currentOrderLine.btLogic.shippingAddress._CustomerAdditionalAddressID.toString()].PersonInfo._PersonInfoKey.toString().trim()){_setOrderLineShipToAddresses(currentOrderLine,addressMap[currentOrderLine.btLogic.shippingAddress._CustomerAdditionalAddressID.toString()],false);}}
else if(!angular.isDefined(currentOrderLine.btLogic.isGiftRegistryAddress)||!currentOrderLine.btLogic.isGiftRegistryAddress){_setOrderLineShipToAddresses(currentOrderLine,defaultObject.defaultShipToAddress,false);}else{$loggerService.log('Skipping _customerAddressCheck of gift reg address');}}};var _setCustomer=function(customerObject){if(customerObject._CustomerKey!==_currentCustomerKey){_currentCustomerKey=customerObject._CustomerKey;return _resetOrderAddresses(customerObject);}else{_customerAddressCheck(customerObject);return true;}};var _getCustomerKey=function(){if(_currentCustomerKey.length>0){return _currentCustomerKey;}else{return null;}};var _isCartCustomerSet=function(){if(_currentCustomerKey.length>0){return true;}else{return false;}};var _deleteCustomer=function(){_currentCustomerKey='';orderCart._BillToID='';orderCart._CustomerContactID='';orderCart._CustomerEMailID='';_setBillingAddress(null);_setDefaultShipToAddress(null);for(var i=0;i<orderCart.OrderLines.OrderLine.length;i++){var tempOrderline=orderCart.OrderLines.OrderLine[i];var tempShipToAddress=null;if(tempOrderline.Extn._ExtnGiftRegistryNo&&tempOrderline.Extn._ExtnGiftRegistryNo.trim()){if(tempOrderline.Extn._ExtnGiftRegistryNo in _giftRegistryAddressSet){tempShipToAddress=_giftRegistryAddressSet[tempOrderline.Extn._ExtnGiftRegistryNo];tempOrderline.btLogic.isGiftRegistryAddress=true;}}else{tempOrderline.btLogic.isGiftRegistryAddress=false;}
if(tempShipToAddress){_copyAddress(tempShipToAddress.PersonInfo,tempOrderline.PersonInfoShipTo);tempOrderline.btLogic.shippingAddress=angular.copy(tempShipToAddress);}else{_copyAddress(null,tempOrderline.PersonInfoShipTo);tempOrderline.btLogic.shippingAddress=null;}}
$rootScope.$broadcast('orderCartReset',{cart:_getLiveOrderCart()});};var _copyAddress=function(source,destination){if(!destination){return false;};if(source){destination._AddressID=source._AddressID?source._AddressID:"";destination._AddressLine1=source._AddressLine1?source._AddressLine1:"";destination._AddressLine2=source._AddressLine2?source._AddressLine2:"";destination._AddressLine3=source._AddressLine3?source._AddressLine3:"";destination._City=source._City?source._City:"";destination._Country=source._Country?source._Country:"";destination._DayPhone=source._DayPhone?$filter('phoneFormatRemove')(source._DayPhone):"";destination._EveningPhone=source._EveningPhone?$filter('phoneFormatRemove')(source._EveningPhone):"";destination._EMailID=source._EMailID?source._EMailID:"";destination._FirstName=source._FirstName?source._FirstName:"";destination._MiddleName=source._MiddleName?source._MiddleName:"";destination._LastName=source._LastName?source._LastName:"";destination._PersonID=source._PersonID?source._PersonID:"";destination._PersonInfoKey=source._PersonInfoKey?source._PersonInfoKey:"";destination._State=source._State?source._State:"";destination._ZipCode=source._ZipCode?source._ZipCode:"";}
else{destination._AddressID="";destination._AddressLine1="";destination._AddressLine2="";destination._AddressLine3="";destination._City="";destination._Country="";destination._DayPhone="";destination._EveningPhone="";destination._EMailID="";destination._FirstName="";destination._MiddleName="";destination._LastName="";destination._PersonID="";destination._PersonInfoKey="";destination._State="";destination._ZipCode="";}
return true;};var _setGiftMessage=function(arrayOfPrimeSubLineObjects,giftMessageInputs){arrayOfPrimeSubLineObjects=_arrayOfPrimeSubCleaner(arrayOfPrimeSubLineObjects);if(!giftMessageInputs){giftMessageInputs={};}
if(!giftMessageInputs.To){giftMessageInputs.To="";}
if(!giftMessageInputs.From){giftMessageInputs.From="";}
if(!giftMessageInputs.Message){giftMessageInputs.Message="";}
giftMessageInputs.To=giftMessageInputs.To.trim();giftMessageInputs.From=giftMessageInputs.From.trim();giftMessageInputs.Message=giftMessageInputs.Message.trim();for(var i=0;arrayOfPrimeSubLineObjects.length>0&&i<orderCart.OrderLines.OrderLine.length;i++){if(orderCart.OrderLines.OrderLine[i]._PrimeLineNo==arrayOfPrimeSubLineObjects[0].PrimeLine&&orderCart.OrderLines.OrderLine[i]._SubLineNo==arrayOfPrimeSubLineObjects[0].SubLine){var noteArr=orderCart.OrderLines.OrderLine[i].Notes.Note;for(var h=0;h<noteArr.length;h++){var reasonCode=noteArr[h]._ReasonCode;if(reasonCode===btProp.getProp("btGiftMessageReasonTo")||reasonCode===btProp.getProp("btGiftMessageReasonFrom")||reasonCode===btProp.getProp("btGiftMessageReasonMessage")){noteArr.splice(h,1);--h;}}
var noteSet=false;if(giftMessageInputs.To){noteArr.push({"_NoteText":giftMessageInputs.To.toString(),"_ReasonCode":btProp.getProp("btGiftMessageReasonTo").toString()});noteSet=true;}
if(giftMessageInputs.From){noteArr.push({"_NoteText":giftMessageInputs.From.toString(),"_ReasonCode":btProp.getProp("btGiftMessageReasonFrom").toString()});noteSet=true;}
if(giftMessageInputs.Message){noteArr.push({"_NoteText":giftMessageInputs.Message.toString(),"_ReasonCode":btProp.getProp("btGiftMessageReasonMessage").toString()});noteSet=true;}
if(noteSet){orderCart.OrderLines.OrderLine[i].btLogic.giftImgUrl=btProp.getProp("btGiftMessageIcon");}else{orderCart.OrderLines.OrderLine[i].btLogic.giftImgUrl=btProp.getProp("btGiftMessageIconGrey");}
arrayOfPrimeSubLineObjects.shift();}}};var _setGiftRegistry=function(arrayOfPrimeSubLineObjects,regNo,regAddress){arrayOfPrimeSubLineObjects=_arrayOfPrimeSubCleaner(arrayOfPrimeSubLineObjects);if(regNo){regNo=regNo.toString().trim();}else{regNo='';}
if(regNo&&regAddress){if(!(regAddress.PersonInfo&&angular.isString(regAddress.PersonInfo._DayPhone)&&(regAddress.PersonInfo._DayPhone.length===10))){regAddress.PersonInfo._DayPhone=$filter('phoneFormatRemove')(orderCart.btLogic.defaultBillToAddress.PersonInfo._DayPhone.toString());if(!(regAddress.PersonInfo._DayPhone.length===10)){regAddress.PersonInfo._DayPhone="8009454438";}}
regNo=regNo.toString().trim();if(!(regNo in _giftRegistryAddressSet)){_giftRegistryAddressSet[regNo]=regAddress;}
_setOrderLineShipToAddresses(angular.copy(arrayOfPrimeSubLineObjects),_giftRegistryAddressSet[regNo],true);}else{_setOrderLineShipToAddresses(angular.copy(arrayOfPrimeSubLineObjects),{PersonInfo:orderCart.PersonInfoShipTo},false);}
for(var i=0;arrayOfPrimeSubLineObjects.length>0&&i<orderCart.OrderLines.OrderLine.length;i++){if(orderCart.OrderLines.OrderLine[i]._PrimeLineNo==arrayOfPrimeSubLineObjects[0].PrimeLine&&orderCart.OrderLines.OrderLine[i]._SubLineNo==arrayOfPrimeSubLineObjects[0].SubLine){orderCart.OrderLines.OrderLine[i].Extn._ExtnGiftRegistryNo=regNo;if(regNo.length>0){orderCart.OrderLines.OrderLine[i]._GiftFlag='Y';}
arrayOfPrimeSubLineObjects.shift();}}};var _getGiftOptionFromOrderLines=function(primeSubLineObject){var arrayOfPrimeSubLineObjects=_arrayOfPrimeSubCleaner(primeSubLineObject);var returnObject={To:"",From:"",Message:"",Registry:""};for(var index=0;index<arrayOfPrimeSubLineObjects.length;index++){for(var i=0;i<orderCart.OrderLines.OrderLine.length;i++){if(orderCart.OrderLines.OrderLine[i]._PrimeLineNo==arrayOfPrimeSubLineObjects[index].PrimeLine&&orderCart.OrderLines.OrderLine[i]._SubLineNo==arrayOfPrimeSubLineObjects[index].SubLine){if(!(returnObject.To||returnObject.From||returnObject.Message)){var noteArr=orderCart.OrderLines.OrderLine[i].Notes.Note;for(var h=0;h<noteArr.length;h++){var reasonCode=noteArr[h]._ReasonCode;if(reasonCode===btProp.getProp("btGiftMessageReasonTo")){returnObject.To=noteArr[h]._NoteText.toString();}
if(reasonCode===btProp.getProp("btGiftMessageReasonFrom")){returnObject.From=noteArr[h]._NoteText.toString();}
if(reasonCode===btProp.getProp("btGiftMessageReasonMessage")){returnObject.Message=noteArr[h]._NoteText.toString();}}}
if(!returnObject.Registry){returnObject.Registry=orderCart.OrderLines.OrderLine[i].Extn._ExtnGiftRegistryNo;}
if((returnObject.To||returnObject.From||returnObject.Message)&&returnObject.Registry){return returnObject;}}else{continue;}}}
if(returnObject.To||returnObject.From||returnObject.Message||returnObject.Registry){return returnObject;}else{return null;}};var _arrayOfPrimeSubCleaner=function(arrayOfPrimeSubLineObjects){var returnArray=[];if(angular.isObject(arrayOfPrimeSubLineObjects)&&!angular.isArray(arrayOfPrimeSubLineObjects)){arrayOfPrimeSubLineObjects=[arrayOfPrimeSubLineObjects];}
if(angular.isArray(arrayOfPrimeSubLineObjects)){angular.forEach(arrayOfPrimeSubLineObjects,function(primeSubLineObject){var tempObject=_primeSubLineObjectCleaner(primeSubLineObject);if(tempObject){returnArray.push(tempObject);}});}
returnArray.sort(function(a,b){if((a.PrimeLine-b.PrimeLine)===0){return a.SubLine-b.SubLine;}else{return a.PrimeLine-b.PrimeLine;}});return returnArray;};var _primeSubLineObjectCleaner=function(primeSubObject){var returnObject=null;if(!angular.isDefined(primeSubObject.PrimeLine)){primeSubObject=_getPrimeSubLineObject(primeSubObject);}
if(angular.isObject(primeSubObject)&&isFinite(parseInt(primeSubObject.PrimeLine))){returnObject={};returnObject.PrimeLine=parseInt(primeSubObject.PrimeLine);returnObject.SubLine=(primeSubObject.SubLine&&isFinite(parseInt(primeSubObject.SubLine)))?parseInt(primeSubObject.SubLine):1;}
return returnObject;};var _sortOrderCartOrderlines=function(){orderCart.OrderLines.OrderLine.sort(function(a,b){var aPrimeLine=parseInt(a._PrimeLineNo);var aSubLine;if(a._SubLineNo&&isFinite(parseInt(a._SubLineNo))){aSubLine=parseInt(a._SubLineNo);}else{aSubLine=1;}
var bPrimeLine=parseInt(b._PrimeLineNo);var bSubLine;if(b._SubLineNo&&isFinite(parseInt(b._SubLineNo))){bSubLine=parseInt(b._SubLineNo);}else{bSubLine=1;}
if((aPrimeLine-bPrimeLine)===0){return aSubLine-bSubLine;}else{return aPrimeLine-bPrimeLine;}});};var _padFront=function(stringOrNum,totalLength,optionalPadChar){if(isFinite(parseInt(totalLength))){totalLength=parseInt(totalLength);}else{return null;}
if(angular.isNumber(stringOrNum)){stringOrNum=stringOrNum.toString();}
var padChar="0";if(angular.isDefined(optionalPadChar)){try{padChar=""+optionalPadChar;}catch(e){padChar="0";}}
if(stringOrNum.length>=totalLength){return stringOrNum;}
while(padChar.length<=totalLength){padChar+=padChar;}
return(padChar+stringOrNum).slice(0-totalLength);};var _getAvailableInventoryAndOrderedQty=function(orderline){var sku=orderline.Item._ItemID;return _getLargestAvailableInventoryAndOrderedQtyForSkuInCart(sku);};var _getLargestAvailableInventoryAndOrderedQtyForSkuInCart=function(itemSku){var largestAvailableInventory=0;var orderedQty=0;for(var i=0;i<orderCart.OrderLines.OrderLine.length;i++){if(itemSku==orderCart.OrderLines.OrderLine[i].Item._ItemID){orderedQty+=parseInt(orderCart.OrderLines.OrderLine[i]._OrderedQty);if(isFinite(parseInt(orderCart.OrderLines.OrderLine[i].btDisplay._AvailableQty))&&largestAvailableInventory<parseInt(orderCart.OrderLines.OrderLine[i].btDisplay._AvailableQty)){largestAvailableInventory=parseInt(orderCart.OrderLines.OrderLine[i].btDisplay._AvailableQty);}}}
return{largestAvailableInventory:largestAvailableInventory,orderedQty:orderedQty};};var _setOrderLineQuantity=function(primeSubLineObject,newQuantity){primeSubLineObject=_primeSubLineObjectCleaner(primeSubLineObject);newQuantity=parseInt(newQuantity);if(primeSubLineObject===null){throw errorObj.newError('_setOrderLineQuantity():InputError',"Coding Error, please contact Help Desk.","_setOrderLineQuantity(): passed PrimeLineNo / SubLineNo is invalid.",'InvalidPrimeLineObject','WARN');}
if(!isFinite(newQuantity)){throw errorObj.newError('_setOrderLineQuantity():InputError',"Coding Error, please contact Help Desk.","_setOrderLineQuantity(): Quantity of "+newQuantity+" must be positive, finite integer.",'InvalidQuantity','WARN');}
if((newQuantity<0)){return;}
var totalOrderedQuantityOfSku=0;var refToChangingOrderLine=null;var largestAvailableQuantity=undefined;var itemSku="";for(var i=0;i<orderCart.OrderLines.OrderLine.length;i++){if(orderCart.OrderLines.OrderLine[i]._PrimeLineNo==primeSubLineObject.PrimeLine&&orderCart.OrderLines.OrderLine[i]._SubLineNo==primeSubLineObject.SubLine){refToChangingOrderLine=orderCart.OrderLines.OrderLine[i];itemSku=orderCart.OrderLines.OrderLine[i].Item._ItemID;largestAvailableQuantity=parseInt(orderCart.OrderLines.OrderLine[i].btDisplay._AvailableQty);if(!(angular.isDefined(largestAvailableQuantity))||!isFinite(largestAvailableQuantity)||largestAvailableQuantity<0){$loggerService.log("JS: appServiceOrderCart: invalid  orderable inventory value: "+largestAvailableQuantity.toString());largestAvailableQuantity=1000000;}}}
if(refToChangingOrderLine===null){throw errorObj.newError('_setOrderLineQuantity():InputError',"Coding Error, please contact Help Desk.","_setOrderLineQuantity(): Could not find PrimeLine: "+primeSubLineObject.PrimeLine+" Subline: "+primeSubLineObject.SubLine+" in the order.",'PrimelineSublineNotFound','WARN');}
if(newQuantity<=parseInt(refToChangingOrderLine._OrderedQty)){refToChangingOrderLine._OrderedQty=""+newQuantity;return;}else{var temp=_getLargestAvailableInventoryAndOrderedQtyForSkuInCart(itemSku);totalOrderedQuantityOfSku=temp.orderedQty;largestAvailableQuantity=temp.largestAvailableInventory;var oldValue='';if((newQuantity+totalOrderedQuantityOfSku-parseInt(refToChangingOrderLine._OrderedQty))>largestAvailableQuantity){oldValue=newQuantity.toString();newQuantity=largestAvailableQuantity-
(totalOrderedQuantityOfSku-parseInt(refToChangingOrderLine._OrderedQty));if(newQuantity<0){newQuantity=0;}}
refToChangingOrderLine._OrderedQty=""+newQuantity;if(oldValue){throw errorObj.newError('_setOrderLineQuantity():AvailableQtyError',"The item: "+refToChangingOrderLine.btDisplay.defaultItemDescription.toString()+' has available inventory of '+largestAvailableQuantity.toString()+". We lowered the line's quantity to "+newQuantity+".",'_setOrderLineQuantity(): had to lower quantity amount','AvailableQtyError','WARN');}}};var _addGiftBox=function(arrayOfPrimeSubLineObjects){$loggerService.log("method is not fully implemented");arrayOfPrimeSubLineObjects=_arrayOfPrimeSubCleaner(arrayOfPrimeSubLineObjects);for(var i=0;arrayOfPrimeSubLineObjects.length>0&&i<orderCart.OrderLines.OrderLine.length;i++){if(orderCart.OrderLines.OrderLine[i]._PrimeLineNo==arrayOfPrimeSubLineObjects[0].PrimeLine&&orderCart.OrderLines.OrderLine[i]._SubLineNo==arrayOfPrimeSubLineObjects[0].SubLine){orderCart.OrderLines.OrderLine[i].btLogic.giftBoxImgUrl=btProp.getProp("btGiftBoxIcon");arrayOfPrimeSubLineObjects.shift();}}};var _deleteGiftBox=function(arrayOfPrimeSubLineObjects){$loggerService.log("method is not fully implemented");arrayOfPrimeSubLineObjects=_arrayOfPrimeSubCleaner(arrayOfPrimeSubLineObjects);for(var i=0;arrayOfPrimeSubLineObjects.length>0&&i<orderCart.OrderLines.OrderLine.length;i++){if(orderCart.OrderLines.OrderLine[i]._PrimeLineNo==arrayOfPrimeSubLineObjects[0].PrimeLine&&orderCart.OrderLines.OrderLine[i]._SubLineNo==arrayOfPrimeSubLineObjects[0].SubLine){orderCart.OrderLines.OrderLine[i].btLogic.giftBoxImgUrl=btProp.getProp("btGiftBoxIconGrey");arrayOfPrimeSubLineObjects.shift();}}};var _getTaxExemptionCertificate=function(){var certValue="";if(orderCart._TaxExemptFlag&&orderCart._TaxExemptFlag==='Y'){if(orderCart._TaxExemptionCertificate){certValue=orderCart._TaxExemptionCertificate.toString().trim();}}
return certValue;};var _setTaxExemptionCertificate=function(taxCert){if(angular.isString(taxCert)&&(taxCert.trim()!=="")){orderCart._TaxExemptFlag='Y';orderCart._TaxExemptionCertificate=taxCert.trim();}else{orderCart._TaxExemptFlag='N';orderCart._TaxExemptionCertificate="";}};var _constructOrderLine=function(itemObject,quantity){var copyItemObject=angular.copy(itemObject);var workingOrderLine=angular.copy(_INIT_ORDER_LINE);if(copyItemObject.productname&&(copyItemObject.productname.trim()!=="")){copyItemObject.defaultItemDescription=copyItemObject.productname;}else{copyItemObject.defaultItemDescription=copyItemObject.isnlongdesc;}
if(angular.isString(copyItemObject.colorimageid)&&(copyItemObject.colorimageid.trim()!=="")){copyItemObject.defaultImageUrl=serviceURL.toString()+"/image/BonTon/"+copyItemObject.colorimageid.trim();}else if(angular.isDefined(copyItemObject.imageid)&&(copyItemObject.imageid.toString().trim()!=="")){copyItemObject.defaultImageUrl=serviceURL.toString()+"/image/BonTon/"+copyItemObject.imageid.toString().trim();}else{copyItemObject.defaultImageUrl="/assets/images/NotAvailable.jpg";}
workingOrderLine.btDisplay=copyItemObject;if(orderCart.OrderLines.OrderLine.length>0){var lastOrderLine=orderCart.OrderLines.OrderLine.slice(-1)[0];workingOrderLine._PrimeLineNo=parseInt(lastOrderLine._PrimeLineNo)+1;workingOrderLine._SubLineNo=1;}else{workingOrderLine._PrimeLineNo=1;workingOrderLine._SubLineNo=1;}
quantity=parseInt(quantity);quantity=(isFinite(quantity)&&quantity>0)?quantity:1;workingOrderLine._OrderedQty=quantity.toString();workingOrderLine.Item._ItemID=copyItemObject.sku.toString();workingOrderLine.ItemDetails._ItemID=copyItemObject.sku.toString();workingOrderLine.Item._UPCCode=copyItemObject.id.toString();workingOrderLine.ItemDetails.ItemAliasList.ItemAlias[0]._AliasValue=copyItemObject.id.toString();workingOrderLine.ItemDetails.PrimaryInformation._IsAirShippingAllowed=copyItemObject.isairshipallowed;workingOrderLine.ItemDetails.PrimaryInformation._ItemType=copyItemObject.itemtype;workingOrderLine.ItemDetails.PrimaryInformation._IsParcelShippingAllowed="Y";workingOrderLine.Extn=angular.copy(copyItemObject.itemDetail.ComputedPrice.Extn);workingOrderLine.LinePriceInfo._ListPrice=copyItemObject.itemDetail.ComputedPrice._ListPrice;workingOrderLine.LinePriceInfo._RetailPrice=copyItemObject.itemDetail.ComputedPrice._RetailPrice;workingOrderLine.LinePriceInfo._UnitPrice=copyItemObject.itemDetail.ComputedPrice._UnitPrice;if(_currentCustomerKey.trim().length>0){_copyAddress(orderCart.PersonInfoShipTo,workingOrderLine.PersonInfoShipTo);workingOrderLine.btLogic.shippingAddress=angular.copy(orderCart.btLogic.defaultShipToAddress);}
return workingOrderLine;};var _validateItemObject=function(itemObject,quantity,isBigTicketValidated){var itemName="";if(angular.isString(itemObject.productname)&&(itemObject.productname.trim()!=="")){itemName=itemObject.productname;}else{if(angular.isString(itemObject.isnlongdesc)){itemName=itemObject.isnlongdesc;}}
if(!$itemProperty.isItemActiveBuyable(itemObject)){throw errorObj.newError('addOrderLine():ItemInactiveOrNotBuyable',"The item"+(itemName?' "'+itemName+'"':'')+" with UPC: "+itemObject.id+' is no longer available for purchase.',"addOrderLine():The item"+(itemName?' "'+itemName+'"':'')+" with UPC: "+itemObject.id+' is no longer available for purchase.','InvalidItem','WARN');};if(!angular.isDefined(itemObject.itemDetail)){throw errorObj.newError('addOrderLine:SkyError','Code Error, Call Helpdesk.','addOrderLine(): addOrderLine() was passed an item with no itemDetail properties. These are the properties retrieved from SKY.','skyError','FATAL');}
if(!angular.isDefined(itemObject._AvailableQty)){throw errorObj.newError('addOrderLine:SkyError','Code Error, Call Helpdesk.','addOrderLine(): addOrderLine() was passed an item with no _AvailableQty defined.','skyError','FATAL');}else if(!isFinite(parseInt(itemObject._AvailableQty))){throw errorObj.newError('addOrderLine:SkyError','Code Error, Call Helpdesk.','addOrderLine(): addOrderLine() was passed an item with invalid _AvailableQty defined. Qty = '+parseInt(itemObject._AvailableQty).toString(),'skyError','FATAL');}
var excludedTypesArray=btProp.getProp("excludedItemTypesForLUFIOrder");var isBigTicketPurchaseDisabled=btProp.getProp("isBigTicketPurchaseDisabled");isBigTicketPurchaseDisabled=isBigTicketPurchaseDisabled?true:false;var bigTicketException=function(itemObject,isBigTicketPurchaseDisabled,isBigTicketValidated){if(itemObject.itemtype=='BGT'&&(isBigTicketPurchaseDisabled||!angular.isDefined(isBigTicketValidated)||!isBigTicketValidated)){throw errorObj.newError('addOrderLine:InvalidItem','The item'+(itemName?' "'+itemName+'"':'')+" with UPC: "+itemObject.id+' cannot be ordered on LUFI.','addOrderLine(): The item'+(itemName?' "'+itemName+'"':'')+" with UPC: "+itemObject.id+' is part of the Excluded Item Types. Cannot add type: '+excludedTypesArray[i],'InvalidItem:'+excludedTypesArray[i],'WARN');}};if(excludedTypesArray!==null){for(var i=0;i<excludedTypesArray.length;i++){if(itemObject.itemtype==excludedTypesArray[i]){if(itemObject.itemtype=='BGT'){bigTicketException(itemObject,isBigTicketPurchaseDisabled,isBigTicketValidated);}else{throw errorObj.newError('addOrderLine:InvalidItem','The item'+(itemName?' "'+itemName+'"':'')+" with UPC: "+itemObject.id+' cannot be ordered on LUFI.','addOrderLine(): The item'+(itemName?' "'+itemName+'"':'')+" with UPC: "+itemObject.id+' is part of the Excluded Item Types. Cannot add type: '+excludedTypesArray[i],'InvalidItem:'+excludedTypesArray[i],'WARN');}}}}else{$loggerService.log("var excludedTypesArray = btProp.getProp(excludedItemTypesForLUFIOrder); RETURNED NULL!!");if(itemObject.itemtype=='BGT'){bigTicketException(itemObject,isBigTicketPurchaseDisabled,isBigTicketValidated);}}
var isExcludeGwpFromLufiOrder=btProp.getProp("isExcludeGwpFromLufiOrder");if(isExcludeGwpFromLufiOrder!==null){if(isExcludeGwpFromLufiOrder){if(!(btProp.getProp("isAllowCsrToAddExcludedGwpFromLufiOrder")&&$securityService.isCsr())){if(itemObject.isgwp=='Y'){throw errorObj.newError('addOrderLine:InvalidItem','The item'+(itemName?' "'+itemName+'"':'')+" with UPC: "+itemObject.id+' cannot be ordered on LUFI.','addOrderLine(): The item'+(itemName?' "'+itemName+'"':'')+" with UPC: "+itemObject.id+' is a GWP (gift with purchase). You may not add gift to LUFI order unless property: "isExcludeGwpFromLufiOrder" is set to false.','InvalidItem:GWP','WARN');}}}}else{$loggerService.log("var excludedTypesArray = btProp.getProp(isExcludeGwpFromLufiOrder); RETURNED NULL!!");}
var temp=_getLargestAvailableInventoryAndOrderedQtyForSkuInCart(itemObject.sku);var largestAvailableInventory=temp.largestAvailableInventory;var orderCartQty=temp.orderedQty;if(parseInt(itemObject._AvailableQty)>largestAvailableInventory){largestAvailableInventory=parseInt(itemObject._AvailableQty);}
var oldValue='';var deferedError=null;if((quantity+orderCartQty)>largestAvailableInventory){oldValue=quantity.toString();quantity=largestAvailableInventory-orderCartQty;if(quantity<0){quantity=0;}}
if(oldValue){var currentCartQtyMessage='';if(orderCartQty>0){currentCartQtyMessage="Cart already contains "+orderCartQty.toString()+" of this item.";}
if(quantity<1){throw errorObj.newError('addOrderLine():AvailableQtyError',"The item"+(itemName?' "'+itemName+'"':'')+" with UPC: "+itemObject.id+' has available inventory of up to '+largestAvailableInventory.toString()+". More of this item cannot be added. "+currentCartQtyMessage,"addOrderLine():The item"+(itemName?' "'+itemName+'"':'')+" with UPC: "+itemObject.id+' has available inventory of up to '+largestAvailableInventory.toString()+". More of this item cannot be added. "+currentCartQtyMessage,'ZeroInventory','WARN');}else{deferedError=errorObj.newError('addOrderLine():AvailableQtyError',"The item"+(itemName?' "'+itemName+'"':'')+" with UPC: "+itemObject.id+' has available inventory of up to '+largestAvailableInventory.toString()+". We have added only "+quantity.toString()+" of this item. "+currentCartQtyMessage,"addOrderLine():The item"+(itemName?' "'+itemName+'"':'')+" with UPC: "+itemObject.id+' has available inventory of up to '+largestAvailableInventory.toString()+". We have added only "+quantity.toString()+" of this item. "+currentCartQtyMessage,'ReducedQuantity','WARN');return{newQuantity:quantity,errorMessage:deferedError};}}};var _addItem=function(itemObject,quantity,isBigTicketValidated){if(!angular.isObject(itemObject)){throw errorObj.newError('addOrderLine:CallerError','Code Error, Call Helpdesk.','addOrderLine(): Item passed to addOrderLine() is not an object.','CallerError','FATAL');}
quantity=parseInt(quantity);quantity=(isFinite(quantity)&&quantity>0)?quantity:1;var newQuantityError=_validateItemObject(itemObject,quantity,isBigTicketValidated);if(angular.isDefined(newQuantityError)&&angular.isDefined(newQuantityError.newQuantity)){quantity=newQuantityError.newQuantity;}
angular.forEach(orderCart.OrderLines.OrderLine,function(orderLine){orderLine=_deleteShippingDiscount(orderLine);});orderCart.OrderLines.OrderLine.push(_constructOrderLine(itemObject,quantity));if(angular.isDefined(newQuantityError)&&angular.isDefined(newQuantityError.errorMessage)){throw newQuantityError.errorMessage;}};var _removeQtyZeroOrderLines=function(){var orderlines=angular.copy(orderCart.OrderLines.OrderLine);for(var i=0;i<orderlines.length;i++){var lineQty=parseInt(orderlines[i]._OrderedQty);if(lineQty<1){_deleteOrderLine(_getPrimeSubLineObject(orderlines[i]),false);}}};var _renumberOrderLines=function(){_sortOrderCartOrderlines();var primeLineNoCount=1;var subLineNoCount=1;var currentLinePrimeNo=-1;var primeLineGroups=[];var currentPrimeGroup=[];for(var i=0;i<orderCart.OrderLines.OrderLine.length;i++){if((parseInt(orderCart.OrderLines.OrderLine[i]._PrimeLineNo)!==currentLinePrimeNo)){if(currentPrimeGroup.length>0){primeLineGroups.push(currentPrimeGroup);}
currentLinePrimeNo=parseInt(orderCart.OrderLines.OrderLine[i]._PrimeLineNo);currentPrimeGroup=[];}
currentPrimeGroup.push(orderCart.OrderLines.OrderLine[i]);if(i===(orderCart.OrderLines.OrderLine.length-1)){if(currentPrimeGroup.length>0){primeLineGroups.push(currentPrimeGroup);}}}
for(var i=0;i<primeLineGroups.length;i++){subLineNoCount=1;currentPrimeGroup=primeLineGroups[i];for(var q=0;q<currentPrimeGroup.length;q++){currentPrimeGroup[q]._PrimeLineNo=primeLineNoCount;currentPrimeGroup[q]._SubLineNo=subLineNoCount;++subLineNoCount;}
subLineNoCount=1;++primeLineNoCount;}};var _cleanOrderCart=function(){_removeQtyZeroOrderLines();_renumberOrderLines();};var _getOrderNumber=function()
{var defer=$q.defer();var regExOrderNo=/^\d{7,20}$/;if(angular.isDefined(orderCart._OrderNo)&&orderCart._OrderNo!==null&&regExOrderNo.test(orderCart._OrderNo)){defer.resolve(orderCart._OrderNo);}else{$http.get(serviceURL.toString()+'/OrderProcess/getNextOrderNo').then(function(response){if(response!==null&&response.data!==null&&angular.isDefined(response.data.NextOrderNo)&&response.data.NextOrderNo!==null&&regExOrderNo.test(""+response.data.NextOrderNo))
{orderCart._OrderNo=""+response.data.NextOrderNo;defer.resolve(orderCart._OrderNo);}
else{$sendSMTPErrorEmail(response,serviceURL.toString()+'/OrderProcess/getNextOrderNo',null,"Invalid Order Number returned from Broker's get Order Number.");defer.reject();}},function(error){$sendSMTPErrorEmail(error,serviceURL.toString()+'/OrderProcess/getNextOrderNo',null,"Call to Broker failed.");defer.reject(error);});}
return defer.promise;};var _getLiveOrderCart=function(){return orderCart;};var _orderlineCount=function(){return orderCart.OrderLines.OrderLine.length;};var _setOrderLineCarrierService=function(orderline,CarrierServiceObj){if(!angular.isDefined(CarrierServiceObj)){CarrierServiceObj={};}
CarrierServiceObj._CarrierServiceCode=CarrierServiceObj._CarrierServiceCode?CarrierServiceObj._CarrierServiceCode:"";CarrierServiceObj._Price=CarrierServiceObj._Price?CarrierServiceObj._Price:"";CarrierServiceObj._CarrierServiceDesc=CarrierServiceObj._CarrierServiceDesc?CarrierServiceObj._CarrierServiceDesc:"Cannot Ship to Address";orderline._CarrierServiceCode=CarrierServiceObj._CarrierServiceCode;orderline._ScacAndService=CarrierServiceObj._CarrierServiceCode;var carrierAndLevelArray=CarrierServiceObj._CarrierServiceCode.toString().split("-");if(carrierAndLevelArray[0].toLowerCase()==='email'){carrierAndLevelArray[0]='ELECTRONIC';}
orderline._SCAC=carrierAndLevelArray.shift();orderline._LevelOfService=carrierAndLevelArray.join("-");orderline.btDisplay.shippingMethodPrice=CarrierServiceObj._Price;orderline.btDisplay.shippingMethodDescription=CarrierServiceObj._CarrierServiceDesc;};var _setOrderLineCarrierServiceToLowestPrice=function(orderline){if(angular.isDefined(orderline)&&angular.isDefined(orderline.CarrierServiceList)&&angular.isArray(orderline.CarrierServiceList.CarrierService)&&angular.isDefined(orderline.CarrierServiceList.CarrierService[0])){var lowestCarrierService=orderline.CarrierServiceList.CarrierService[0];var lowestPrice=parseFloat(orderline.CarrierServiceList.CarrierService[0]._Price);if(!isFinite(lowestPrice)){$loggerService.log("Order in orderCart has invalid CarrierServiceList prices");lowestPrice=10000000;}
for(var i=1;i<orderline.CarrierServiceList.CarrierService.length;i++){var tempPrice=parseFloat(orderline.CarrierServiceList.CarrierService[i]._Price);if(!isFinite(tempPrice)){$loggerService.log("Order in orderCart has invalid CarrierServiceList prices");}else{if(tempPrice<lowestPrice){lowestCarrierService=orderline.CarrierServiceList.CarrierService[i];lowestPrice=tempPrice;}}}
_setOrderLineCarrierService(orderline,lowestCarrierService);}};var _validateOrderLineCarrierService=function(orderline){if(!angular.isDefined(orderline.CarrierServiceList.CarrierService)||orderline.CarrierServiceList.CarrierService.length<1){_setOrderLineCarrierService(orderline);}else if(orderline._CarrierServiceCode.trim()===""){_setOrderLineCarrierServiceToLowestPrice(orderline);}else{var selectedCarrierCode=orderline._CarrierServiceCode.toString();var matchingCarrierCodeObj=null;for(var i=0;i<orderline.CarrierServiceList.CarrierService.length;i++){if(orderline.CarrierServiceList.CarrierService[i]._CarrierServiceCode.toString()===selectedCarrierCode){matchingCarrierCodeObj=orderline.CarrierServiceList.CarrierService[i];break;}}
if(matchingCarrierCodeObj!==null){_setOrderLineCarrierService(orderline,matchingCarrierCodeObj);}else{_setOrderLineCarrierServiceToLowestPrice(orderline);}}};var concatRolling=function(rollingText,concatText){if(rollingText===undefined||rollingText===null||rollingText===""){rollingText=concatText;}
else{rollingText+=" and "+concatText;}
return rollingText;}
var _updateCarrierServiceList=function(){var _isValidShipTo=function(currentLine,errorMessage){var cntRolling=0;var valid=true;var shipTo=currentLine.PersonInfoShipTo;var primelineText=' Line: '+currentLine._PrimeLineNo+"."+currentLine._SubLineNo;var rollingErrorText='';if(angular.isDefined(shipTo._DayPhone)&&shipTo._DayPhone.toString().trim().length<10){valid=false;errorMessage.message="Customer profile contains invalid phone number."+"\n"+"Update profile with the correct phone number."
return valid;}
if(!angular.isDefined(shipTo._FirstName)||shipTo._FirstName.toString().trim()===''){valid=false;rollingErrorText+='First Name ';cntRolling=cntRolling+1;}
if(!angular.isDefined(shipTo._LastName)||shipTo._LastName.toString().trim()===''){valid=false;rollingErrorText=concatRolling(rollingErrorText,'Last Name');cntRolling=cntRolling+1;}
if(!angular.isDefined(shipTo._EMailID)||shipTo._EMailID.toString().trim()===''){valid=false;rollingErrorText=concatRolling(rollingErrorText,'Email');cntRolling=cntRolling+1;}
if(!angular.isDefined(shipTo._DayPhone)||shipTo._DayPhone.toString().trim()===''){valid=false;rollingErrorText=concatRolling(rollingErrorText,'Primary Phone');cntRolling=cntRolling+1;}
if(!angular.isDefined(shipTo._AddressLine1)||shipTo._AddressLine1.toString().trim()===''){valid=false;rollingErrorText=concatRolling(rollingErrorText,'Address Line 1');cntRolling=cntRolling+1;}
if(!angular.isDefined(shipTo._City)||shipTo._City.toString().trim()===''){valid=false;rollingErrorText=concatRolling(rollingErrorText,'City');cntRolling=cntRolling+1;}
if(!angular.isDefined(shipTo._State)||shipTo._State.toString().trim()===''){valid=false;rollingErrorText=concatRolling(rollingErrorText,'State');cntRolling=cntRolling+1;}
if(!angular.isDefined(shipTo._ZipCode)||shipTo._ZipCode.toString().trim()===''){valid=false;rollingErrorText=concatRolling(rollingErrorText,'Zip Code');cntRolling=cntRolling+1;}
if(!valid){errorMessage.message+=' is missing '+rollingErrorText;if(cntRolling===1){errorMessage.message+=". Update profile with a valid "+rollingErrorText+".";}
else if(cntRolling>1){errorMessage.message+=". Update profile with the required information.";}}
return valid;};var copyOfObj={OrderLine:[]};var isAllLineValid=true;var errorMessage={message:'Customer profile '};for(var i=0;i<orderCart.OrderLines.OrderLine.length;i++){var currentLine=orderCart.OrderLines.OrderLine[i];currentLine.CarrierServiceList={CarrierService:[]};currentLine.btDisplay.shippingMethodPrice='';currentLine.btDisplay.shippingMethodDescription='';var isCurrentLineValid=_isValidShipTo(currentLine,errorMessage);isAllLineValid=isAllLineValid&&isCurrentLineValid;if(isCurrentLineValid){var linecopy=angular.copy(currentLine);if(!angular.isArray(linecopy.LineCharges.LineCharge)){linecopy.LineCharges.LineCharge=[{"_ChargeAmount":"0.00","_ChargeCategory":"BTN_SHIP_CHRG","_ChargeName":"CHRG_SHIPPING","_ChargePerLine":"0.00","_ChargePerUnit":"0.00","_IsDiscount":"N","_IsManual":"N","_Reference":"UPS-GRND"}]}else{var hasShipChargeObj=false;for(var x=0;x<linecopy.LineCharges.LineCharge.length;x++){if(angular.isString(linecopy.LineCharges.LineCharge[x]._ChargeName)&&(/^CHRG_SHIPPING$/).test(linecopy.LineCharges.LineCharge[x]._ChargeName)){hasShipChargeObj=true;break;}}
if(!hasShipChargeObj){linecopy.LineCharges.LineCharge.push({"_ChargeAmount":"0.00","_ChargeCategory":"BTN_SHIP_CHRG","_ChargeName":"CHRG_SHIPPING","_ChargePerLine":"0.00","_ChargePerUnit":"0.00","_IsDiscount":"N","_IsManual":"N","_Reference":"UPS-GRND"});}}
copyOfObj.OrderLine.push(linecopy);}}
if(!isAllLineValid){return $q.reject(errorObj.newError('CarrierServiceCodes Error','Customer profile has missing or invalid information. Please update profile.','_updateCarrierServiceList found invalid Ship To address on orderlines: '+errorMessage.message,'CarrierService','FATAL'));}
if(copyOfObj.OrderLine.length===0){return $q.when('0');}
var input={GetCarrierServiceCodeIn:{}};input.GetCarrierServiceCodeIn._SellerOrganizationCode=orderCart._SellerOrganizationCode;input.GetCarrierServiceCodeIn._EnteredBy=orderCart._EnteredBy?orderCart._EnteredBy:'Store';input.GetCarrierServiceCodeIn._EnterpriseCode=orderCart._EnterpriseCode;input.GetCarrierServiceCodeIn._EntryType=orderCart._EntryType;input.GetCarrierServiceCodeIn.OrderLines=copyOfObj;var validPrice=function(price){if(!(angular.isString(price)||angular.isNumber(price))){return false;}
var numericValue;if(angular.isString(price)){if(price.trim().length>0){numericValue=Number(price);}else{return false;}}else{numericValue=price;}
if(isFinite(numericValue)&&(numericValue>=0)){return true;}
return false;};var resetLineUnitPrice=function(line){if(line.LinePriceInfo._RetailPrice&&validPrice(line.LinePriceInfo._RetailPrice)){line.LinePriceInfo._UnitPrice=angular.copy(line.LinePriceInfo._RetailPrice);}else if(line.LinePriceInfo._ListPrice&&validPrice(line.LinePriceInfo._ListPrice)){line.LinePriceInfo._UnitPrice=angular.copy(line.LinePriceInfo._ListPrice);}else{line.LinePriceInfo._UnitPrice="0.00";}};if(input.GetCarrierServiceCodeIn.OrderLines&&input.GetCarrierServiceCodeIn.OrderLines.OrderLine){for(var i=0;i<input.GetCarrierServiceCodeIn.OrderLines.OrderLine.length;i++){var line=input.GetCarrierServiceCodeIn.OrderLines.OrderLine[i];if(!validPrice(line.LinePriceInfo._UnitPrice)){resetLineUnitPrice(line);}}}
for(var i=0;i<input.GetCarrierServiceCodeIn.OrderLines.OrderLine.length;i++){var currentLine=input.GetCarrierServiceCodeIn.OrderLines.OrderLine[i];if(angular.isDefined(currentLine._OrderLineKey)){if(currentLine._OrderLineKey.toString().trim()===""||(/^temp/).test(currentLine._OrderLineKey.toString().trim())){currentLine._OrderLineKey="temp"+currentLine._PrimeLineNo.toString()+"_"+currentLine._SubLineNo.toString();}}else{currentLine._OrderLineKey="temp"+currentLine._PrimeLineNo.toString()+"_"+currentLine._SubLineNo.toString();}}
return $http.post(serviceURL.toString()+'/Price/GetCarrierServiceCodes',input).then(function(response){serviceArrayFix(response);var data=response.data;var errorsArray=data.GetCarrierServiceCodeOut.Errors.ErrorList.Error;if(angular.isDefined(errorsArray)){var ErrorText='CarrierServiceCodes Error. ';for(var i=0;i<errorsArray.length;i++){ErrorText+=' '+(i+1).toString()+') '+"Error Code: "+errorsArray[i]._ErrorCode.toString()+": "+errorsArray[i]._ErrorDescription.toString();$loggerService.log("CarrierServiceCodes Error: "+errorsArray[i]._ErrorCode.toString()+": "+errorsArray[i]._ErrorDescription.toString());}
return $q.reject(errorObj.newError('CarrierServiceCodes Error',ErrorText,'CarrierService Broker call returned errors: '+ErrorText,'CarrierService','FATAL'));}
var orderlinearray=data.GetCarrierServiceCodeOut.OrderLines.OrderLine;for(var i=0;i<orderlinearray.length;i++){var orderlinekey=orderlinearray[i]._OrderLineKey.toString();for(var q=0;q<input.GetCarrierServiceCodeIn.OrderLines.OrderLine.length;q++){if(input.GetCarrierServiceCodeIn.OrderLines.OrderLine[q]._OrderLineKey==orderlinekey){orderlinearray[i]._PrimeLineNo=input.GetCarrierServiceCodeIn.OrderLines.OrderLine[q]._PrimeLineNo;orderlinearray[i]._SubLineNo=input.GetCarrierServiceCodeIn.OrderLines.OrderLine[q]._SubLineNo;}}
var primeNoObject=_getPrimeSubLineObject(orderlinearray[i]);var orderlineArr=_findPrimeSubInCart(primeNoObject,orderCart);for(var q=0;q<orderlineArr.length;q++){orderlineArr[q].CarrierServiceList=angular.copy(orderlinearray[i].CarrierServiceList);_validateOrderLineCarrierService(orderlineArr[q]);}}},function(response){$sendSMTPErrorEmail(response,serviceURL.toString()+'/Price/GetCarrierServiceCodes',input);});};var _getLowestOrderLinePrice=function(orderline){var lowestprice;if(isFinite(parseFloat(orderline.LinePriceInfo._btAdjustedPrice))){lowestprice=parseFloat(orderline.LinePriceInfo._btAdjustedPrice);orderline.btLogic.lowestprice=lowestprice;}
else if(isFinite(parseFloat(orderline.btLogic.lowestprice))){lowestprice=parseFloat(orderline.btLogic.lowestprice);}else{var unitprice=(isFinite(parseFloat(orderline.LinePriceInfo._UnitPrice)))?parseFloat(orderline.LinePriceInfo._UnitPrice):null;var retailprice=(isFinite(parseFloat(orderline.LinePriceInfo._RetailPrice)))?parseFloat(orderline.LinePriceInfo._RetailPrice):null;if(unitprice){lowestprice=unitprice;}
if(retailprice){if(lowestprice){if(lowestprice>retailprice){lowestprice=retailprice;}}else{lowestprice=retailprice;}}
orderline.btLogic.lowestprice=lowestprice;}
return lowestprice;};var _computeShippingOrderLineSubtotal=function(orderline){var subtotal=0;if(angular.isDefined(orderline.LinePriceInfo)&&angular.isDefined(orderline.LinePriceInfo._btAdjustedPrice)){subtotal=parseFloat(orderline.LinePriceInfo._btAdjustedPrice)*parseInt(orderline._OrderedQty);}
else{_getLowestOrderLinePrice(orderline)*parseInt(orderline._OrderedQty);}
if(angular.isDefined(orderline.LineCharges)&&angular.isArray(orderline.LineCharges.LineCharge)){for(var i=0;i<orderline.LineCharges.LineCharge.length;i++){var currentCharge=orderline.LineCharges.LineCharge[i];if((/^BTN_SHIP.*/i).test(currentCharge._ChargeCategory)||(/^BTN_HNDL.*/i).test(currentCharge._ChargeCategory)){if((/^Y$/i).test(currentCharge._IsDiscount)){subtotal=subtotal-(parseFloat(currentCharge._ChargePerUnit)*parseInt(orderline._OrderedQty)+parseFloat(currentCharge._ChargePerLine));}else{subtotal=subtotal+(parseFloat(currentCharge._ChargePerUnit)*parseInt(orderline._OrderedQty)+parseFloat(currentCharge._ChargePerLine));}}}}
return subtotal;};var _setExampleOrder=function(){orderCart={"_AuthorizedClient":"Store","_BillToID":"W231905","_CustomerContactID":"W231905","_CustomerEMailID":"garrett.stibb@bonton.com","_DocumentType":"0001","_DraftOrderFlag":"N","_EnteredBy":"Store","_EnterpriseCode":"BONTON","_EntryType":"BTN","_OrderNo":"","_PaymentRuleId":"BT_DEF_PAYMENT_RULE","_SellerOrganizationCode":"101","_TaxExemptFlag":"N","_TaxExemptionCertificate":"","OrderLines":{"OrderLine":[{"_CarrierServiceCode":"UPS-GRND","_GiftWrap":"N","_HoldFlag":"N","_OrderedQty":"5.00","_OrderLineKey":"","_OriginalOrderedQty":"0","_PrimeLineNo":1,"_LevelOfService":"GRND","_ScacAndService":"UPS-GRND","_SCAC":"UPS","_Status":"","_SubLineNo":1,"_Timezone":"","Extn":{"_ExtnBadgingText":"Black Dot","_ExtnClass":"600","_ExtnDepartment":"400","_ExtnIsPriceLocked":"N","_ExtnMPTID":"","_ExtnMPTOfferDeatil":"","_ExtnMPTOfferMessage1":"","_ExtnMPTOfferMessage2":"","_ExtnPriceStatus":"P","_ExtnPromoNumber":"0","_ExtnSpecialHandlingCode":"0","_ExtnSPOID":"0","_ExtnSPOOfferDetail":"","_ExtnSPOOfferMsg1":"","_ExtnSPOOfferMsg2":""},"Item":{"_ItemID":"440000688653","_UPCCode":"755179389899","_ProductClass":"NEW","_UnitCost":"","_UnitOfMeasure":"EACH"},"ItemDetails":{"_ItemID":"440000688653","ItemAliasList":{"ItemAlias":[{"_AliasName":"ACTIVE_UPC","_AliasValue":"755179389899"}]},"PrimaryInformation":{"_IsAirShippingAllowed":"Y","_ItemType":"REG","_IsParcelShippingAllowed":"Y"}},"LineCharges":{"LineCharge":[{"_ChargeAmount":"0.00","_ChargeCategory":"BTN_SHIP_CHRG","_ChargeName":"CHRG_SHIPPING","_ChargePerLine":"0.00","_ChargePerUnit":"0.00","_IsDiscount":"N","_IsManual":"N","_Reference":"UPS-GRND"}]},"LineTaxes":{"LineTax":[{"_ChargeName":"TAX_SALES","_ChargeCategory":"BTN_TAX_CHRG","_Tax":"21.44","_TaxName":"SALES","_TaxPercentage":"5.50","Extn":{"_ExtnTaxPerUnit":"4.28"}}]},"Promotions":{},"LinePriceInfo":{"_ListPrice":"158.00","_RetailPrice":"77.99","_TaxableFlag":"Y","_TaxExemptionCertificate":"N","_UnitPrice":"77.99"},"PersonInfoShipTo":{"_AddressID":"LOGON5918","_AddressLine1":"2412 56th ave","_AddressLine2":"","_AddressLine3":"","_City":"kenosha","_Country":"US","_DayPhone":"6969696969","_EMailID":"garrett.stibb@bonton.com","_EveningPhone":"","_FirstName":"Garrett","_LastName":"Stibb","_MiddleName":"","_PersonInfoKey":"20150402190721329128955","_State":"WI","_ZipCode":"53144","_PersonID":"8701684"},"CarrierServiceList":{"CarrierService":[{"_CarrierServiceCode":"UPS-GRND","_CarrierServiceDesc":"UPS Ground/Standard","_Currency":"USD","_Price":"0.00"},{"_CarrierServiceCode":"UPS-TDAY","_CarrierServiceDesc":"UPS 2-day ship","_Currency":"USD","_Price":"19.95"},{"_CarrierServiceCode":"UPS-NDAY","_CarrierServiceDesc":"UPS Next day ship","_Currency":"USD","_Price":"29.95"}]},"Notes":{"Note":[]},"_DeliveryMethod":"SHP","_GiftFlag":"N","_LevelOfService":"GRND","_ScacAndService":"","btDisplay":{"id":755179389899,"isn":400101743,"sku":440000688653,"isnlongdesc":"tay charc deq c/s ruched sq nk","vendorstyle":"3150M","genclasslongdesc":"Dresses","colorlongdesc":"CHARCOAL","colorfamdesc":"Black/Gray Fam","colorattrdesc":"Charcoal Gray","itemsize":"10       R","sizesequence":11020,"desc1":"OCTOBER 2011","desc2":"LBD","desc3":"SHTH (SHEATH)","desc4":"MATTE JERSEY","brandlongdesc":"Taylor Dresses","proddtllongdesc":"Cap Sleeve","deptlongdesc":"BETTER DRESSES","cmg":"110 - DRESSES","cfg":"10 - MISSES DRESSES","fob":"101 - BETTER DRESSES","crg":"100 - READY TO WEAR","classlongdesc":"TAYLOR","gensclalongdesc":"1pc Dress","fablongdesc":"Poly Blend-With Stretch","fabdtldesc":"Embellished","proddetail2":"Above the Knee Length","proddetail3":"Knit","labellongdesc":"Taylor Dresses","productcode":157134,"productname":"Taylor Charcoal Sequin Knit Cap-Sleeve Squareneck Party Dress","imageid":431692,"keywords":",,1,10,8,6,4,2,Taylor,Charcoal,Sequin Knit,Cap Sleeve,Squareneck Party Dress,party dress,cap sleeve dress,squareneck dress,knit dresses,cocktail dresses,women,apparel,","webcatprodshortdesc":"Mingle in high style in this gorgeous, sequin-knit cocktail dress, characterized by its ruched, pleated texture and revealing cap sleeves.","webcatprodlongdesc":"<ul>\n    <li>Squareneck party dress with cap sleeves</li>\n    <li>Ruched pleats over sequin knit fabric</li>\n    <li>Back-zip closure</li>\n    <li>Acrylic/nylon</li>\n    <li>Imported</li>\n</ul>","colorcode":10,"colorDc":"00010 - CHARCOAL","size1code":"10  ","size2code":"R   ","sizedc":"10    R   ","itemtype":"REG","pricestatus":"P","hazardCode":"1","giftwrapCode":"2","specialhandlingcode":"1","isactive":"Y","isgwp":"N","iswebexclusive":"Y","isspecialhandling":"N","isairshipallowed":"Y","isgroundshipallowed":"Y","specialhandlingfee":0,"groupid":"400101743157134","buyable":true,"_version_":1503052571298758700,"itemDetail":{"_ItemID":"440000688653","_ItemKey":"440000688653","_OrganizationCode":"BONTON","_UPCCode":"755179389899","ComputedPrice":{"_ListPrice":"158","_RetailPrice":"77.99","_UnitPrice":"77.99","Extn":{"_btIsBonusEvent":"false","_btIsDoorBusterEvent":"false","_btIsHazMat":"false","_btIsIVPEvent":"false","_btIsNightOwlEvent":"false","_btIsOtherSpecialEvent":"false","_btIsSpecialHandling":"false","_btIsWebExclusive":"false","_btIsWebOnlyEvent":"false","_btSpecialHandlingFee":"0","_ExtnBadgingText":"Black Dot","_ExtnClass":"600","_ExtnDepartment":"400","_ExtnMPTID":"","_ExtnMPTOfferDetail":"","_ExtnMPTOfferMsg1":"","_ExtnMPTOfferMsg2":"","_ExtnPriceStatus":"P","_ExtnPromoNumber":"0","_ExtnSpecialHandlingCode":"0","_ExtnSPOID":"0","_ExtnSPOOfferDetail":"","_ExtnSPOOfferMsg1":"","_ExtnSPOOfferMsg2":""}}},"_AvailableQty":"10","defaultItemDescription":"Taylor Charcoal Sequin Knit Cap-Sleeve Squareneck Party Dress","defaultImageUrl":"http://broker.qa.bonton.com:7080/image/BonTon/431692","shippingMethodPrice":"0.00","shippingMethodDescription":"UPS Ground/Standard"},"btLogic":{"isPriceOverridden":"N","priceOverrideValue":0,"isBigTicket":"N","giftImgUrl":"assets/images/GreyGiftMessage.gif","isGiftRegistryAddress":false,"giftBoxImgUrl":"assets/images/greyGiftBox.gif","orderSummaryPageTempQty":5,"isSelected":false}}]},"PersonInfoBillTo":{"_AddressID":"LOGON5918","_AddressLine1":"2412 56th ave","_AddressLine2":"","_AddressLine3":"","_City":"kenosha","_Country":"US","_DayPhone":"6969696969","_EveningPhone":"","_EMailID":"garrett.stibb@bonton.com","_FirstName":"Garrett","_MiddleName":"","_LastName":"Stibb","_PersonID":"8701684","_PersonInfoKey":"20150402190721329128955","_State":"WI","_ZipCode":"53144"},"PersonInfoShipTo":{"_AddressID":"LOGON5918","_AddressLine1":"2412 56th ave","_AddressLine2":"","_AddressLine3":"","_City":"kenosha","_Country":"US","_DayPhone":"6969696969","_EveningPhone":"","_EMailID":"garrett.stibb@bonton.com","_FirstName":"Garrett","_MiddleName":"","_LastName":"Stibb","_PersonID":"8701684","_PersonInfoKey":"20150402190721329128955","_State":"WI","_ZipCode":"53144"},"PaymentMethods":{"PaymentMethod":[]},"Extn":{"_ExtnAssociateId":"898989"},"PriceInfo":{"_Currency":"USD"},"_OrderDate":"2015-06-10T21:36:18.037","_OrderHeaderKey":"","_OrderType":"","Errors":{"ErrorList":{"Error":[{"_ErrorCode":"00","_ErrorDescription":"Pricing: Successful","_ErrorRelatedMoreInfo":"","Attribute":{"_Name":"","_Value":""},"Stack":[]}]}},"Promotions":{}};};var _arraySplicePush=function(source,destination){if(angular.isArray(source)&&angular.isArray(destination)){destination.splice(0,destination.length);for(var i=0;i<source.length;i++){destination.push(source[i]);}}};var _mergeCart=function(mergedCart){repriceService.copyAllAttributes(mergedCart,orderCart);_arraySplicePush(mergedCart.OrderLines.OrderLine,orderCart.OrderLines.OrderLine);if(!angular.isDefined(orderCart.Errors)){orderCart.Errors={ErrorList:{Error:[]}};}
_arraySplicePush(mergedCart.OrderLines.OrderLine,orderCart.OrderLines.OrderLine);};var _getItemCount=function(){var quantity=0;for(var i=0;i<orderCart.OrderLines.OrderLine.length;i++){var lineQty=parseInt(orderCart.OrderLines.OrderLine[i]._OrderedQty);if(isFinite(lineQty)){quantity+=lineQty;}}
return quantity;};var _repriceOrder=function(inputCart,isSetToOrderCart){if(angular.isObject(inputCart)){return repriceService.reprice(inputCart).then(function(response){if(isSetToOrderCart){orderCart=response.data;$rootScope.$broadcast('orderCartReset',{cart:_getLiveOrderCart()});}
return response;});}else{return repriceService.reprice(_getLiveOrderCart()).then(function(response){if(isSetToOrderCart){orderCart=response.data;$rootScope.$broadcast('orderCartReset',{cart:_getLiveOrderCart()});}
return response;});}};var _setOrderCart=function(newCart){orderCart=newCart;$rootScope.$broadcast('orderCartReset',{cart:_getLiveOrderCart()});};var _initNewCart=function(){orderCart=angular.copy(_INIT_CART);_currentCustomerKey='';_giftRegistryAddressSet={};var posParams=POSService.getPOSParameters();if(!angular.isDefined(posParams)){POSService.setPOSTParametersFromURL(window.location.href);posParams=POSService.getPOSParameters();}
_setStoreAndAssociateId(posParams.storeNumber,posParams.associateId);if($customer.isCustomerSelected()){_setCustomer($customer.getSelectedCustomer());}};var _broadcastCartDeleteEvent=function(){$rootScope.$broadcast('orderCartDeleted',{cart:_getLiveOrderCart()});};var _deleteShippingDiscount=function(orderLine){var itemToDelete=-1;angular.forEach(orderLine.LineCharges.LineCharge,function(lineCharge,index){if(lineCharge._ChargeCategory==='BTN_SHIP_DISC'){itemToDelete=index;}});if(itemToDelete>-1){orderLine.LineCharges.LineCharge.splice(itemToDelete,1);}
return orderLine;}
_initNewCart();var returnObject={address:{setOrderLineShipToAddresses:function(arrayOfPrimeSubLineObjects,addressObject,isGiftRegAddress){var result=_setOrderLineShipToAddresses(angular.copy(arrayOfPrimeSubLineObjects),addressObject,isGiftRegAddress);if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"setOrderLineShipToAddresses");$loggerService.log(_getLiveOrderCart());}
return result;},setBillingAddress:function(addressObject){var result=_setBillingAddress(addressObject);if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"setBillingAddress");$loggerService.log(_getLiveOrderCart());}
return result;},validateOrderAddresses:function(inputCart){return _validateOrderAddresses(inputCart);},validAddress:function(address,isBillingAddress){return _validAddress(address,isBillingAddress);}},carrierService:{updateCarrierServiceList:function(){var result=_updateCarrierServiceList();if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"updateCarrierServiceList");$loggerService.log(_getLiveOrderCart());}
return result;},setOrderlineCarrierService:function(orderline,carrierService){var result=_setOrderLineCarrierService(orderline,carrierService);if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"setOrderlineCarrierService");$loggerService.log(_getLiveOrderCart());}
return result;},setOrderLineCarrierServiceToLowestPrice:function(orderline){return _setOrderLineCarrierServiceToLowestPrice(orderline);}},customer:{setCustomer:function(customerObject){var result=_setCustomer(customerObject);if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"setCustomer");$loggerService.log(_getLiveOrderCart());}
return result;},getCustomerKey:function(){return _getCustomerKey();},isCartCustomerSet:function(){return _isCartCustomerSet();},getAdditionalAddresses:function(){var result='';if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"getAdditionalAddresses");$loggerService.log(_getLiveOrderCart());}
return result;},addAdditionalAddress:function(addressObject){var result='';if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"addAdditionalAddress");$loggerService.log(_getLiveOrderCart());}
return result;},deleteCustomer:function(){return _deleteCustomer();}},discount:{addCoupon:function(couponCode){var result='';if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"addCoupon");$loggerService.log(_getLiveOrderCart());}
return result;},deleteCoupon:function(couponCode){var result='';if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"deleteCoupon");$loggerService.log(_getLiveOrderCart());}
return result;}},giftOptions:{getGiftOptionFromOrderLines:function(primeSubLineObject){var result=_getGiftOptionFromOrderLines(angular.copy(primeSubLineObject));if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"getGiftOptionFromOrderLines");$loggerService.log(_getLiveOrderCart());}
return result;},addGiftBox:function(arrayOfPrimeSubLineObjects){var result=_addGiftBox(arrayOfPrimeSubLineObjects);if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"addGiftBox");$loggerService.log(_getLiveOrderCart());}
return result;},deleteGiftBox:function(arrayOfPrimeSubLineObjects){var result=_deleteGiftBox(arrayOfPrimeSubLineObjects);if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"deleteGiftBox");$loggerService.log(_getLiveOrderCart());}
return result;},setGiftMessage:function(arrayOfPrimeSubLineObjects,giftMessageInputs){var result=_setGiftMessage(angular.copy(arrayOfPrimeSubLineObjects),giftMessageInputs);if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"setGiftMessage");$loggerService.log(_getLiveOrderCart());}
return result;},setGiftRegistry:function(arrayOfPrimeSubLineObjects,regNo,regAddress){var result=_setGiftRegistry(angular.copy(arrayOfPrimeSubLineObjects),regNo,regAddress);if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"setGiftRegistry");$loggerService.log(_getLiveOrderCart());}
return result;},getRegistryAddressSet:function(){var result=_getRegistryAddressSet();if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"getRegistryAddressSet");$loggerService.log(_getLiveOrderCart());}
return result;},loadRegistryAddresses:function(){var result=_loadRegistryAddresses();if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"loadRegistryAddresses");$loggerService.log(_getLiveOrderCart());}
return result;}},order:{getLiveOrderCart:function(){return _getLiveOrderCart();},repriceOrder:function(isSetToOrderCart){var result=_repriceOrder(null,isSetToOrderCart);if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"repriceOrder");$loggerService.log(_getLiveOrderCart());}
return result;},setOrderCart:function(newCart){return _setOrderCart(newCart);},getTaxExemptionCertificate:function(){var result=_getTaxExemptionCertificate();if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"getTaxExemptionCertificate");$loggerService.log(_getLiveOrderCart());}
return result;},setTaxExemptionCertificate:function(taxCert){var result=_setTaxExemptionCertificate(taxCert);if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"setTaxExemptionCertificate");$loggerService.log(_getLiveOrderCart());}
return result;},getOrderNumber:function()
{return _getOrderNumber();},cleanOrderCart:function(){var result=_cleanOrderCart();if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"cleanOrderCart");$loggerService.log(_getLiveOrderCart());}
return result;},deleteCart:function(){_initNewCart();_broadcastCartDeleteEvent();return _getLiveOrderCart();},getLargestAvailableInventoryAndOrderedQtyForSkuInCart:function(itemSku){return _getLargestAvailableInventoryAndOrderedQtyForSkuInCart(itemSku);},submitOrder:function(){var result='';if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"submitOrder");$loggerService.log(_getLiveOrderCart());}
return result;},getItemCount:function(){return _getItemCount();},deleteShippingDiscount:function(orderLine){return _deleteShippingDiscount(orderLine);},validateOrderHeader:function(inputCart){return _validateOrderHeader(inputCart);},hasBigTicketItems:function(inputCart){return _hasBigTicketItems(inputCart);}},orderLine:{addOrderLine:function(fullItemObject,quantity,isBigTicketValidated){var result=_addItem(fullItemObject,quantity,isBigTicketValidated);if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"addOrderLine");$loggerService.log(_getLiveOrderCart());}
return result;},setOrderLineQuantity:function(primeSubLineObject,newQuantity){var result=_setOrderLineQuantity(primeSubLineObject,newQuantity);if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"setOrderLineQuantity");$loggerService.log(_getLiveOrderCart());}
return result;},deleteOrderLine:function(arrayOfPrimeSubLineObjects){var result=_deleteOrderLine(arrayOfPrimeSubLineObjects,true);if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"deleteOrderLine");$loggerService.log(_getLiveOrderCart());}
return result;},util:{getPrimeSubLineObject:function(orderline){return _getPrimeSubLineObject(orderline);},orderlineCount:function(){return _orderlineCount();},getLowestSalePrice:function(orderline){return _getLowestOrderLinePrice(orderline);},getAvailableInventoryAndOrderedQty:function(orderline){return _getAvailableInventoryAndOrderedQty(orderline);}}},payment:{addCreditCard:function(creditCardObject){var result='';if(_isLogCart){$loggerService.log("CURRENT ORDER CART:"+"addCreditCard");$loggerService.log(_getLiveOrderCart());}
return result;}},subtotal:{computeShippingOrderLineSubtotal:function(orderline){return _computeShippingOrderLineSubtotal(orderline);}},util:{setExampleOrder:function(){return _setExampleOrder();},leftPad:function(stringOrNum,totalLength,optionalPadChar){return _padFront(stringOrNum,totalLength,optionalPadChar);}}};return returnObject;}]).factory('expectedDeliveryService',['$http','$filter',function($http,$filter){var _getDates=function(){return $http.get(serviceURL.toString()+'/Utility/GetExpectedDeliveryDates').success(function(data){for(var i=0;i<data.ExpectedDeliveryDates.length;i++){data.ExpectedDeliveryDates[i].Date=$filter('date')(data.ExpectedDeliveryDates[i].Date,'mediumDate');}
return data;}).error(function(data){$sendSMTPErrorEmail(response,serviceURL.toString()+'/Price/GetCarrierServiceCodes',data);});};return{getDates:_getDates};}]);
﻿var appServices=angular.module('appServicesItem',['appUtilities']);appServices.service('ISNModelHelper',[function(){var createFacetItem=function(items){var facet=[];if(items){for(var i=0;i<items.length-1;i=i+2){if(items[i]&&items[i].trim().length>0){var item={rawName:items[i],name:items[i],count:items[i+1]};facet.push(item);}}}
return facet;}
var populateISNModel=function(data){response={};for(groupField in data.grouped)break;response.ngroups=data.grouped[groupField].ngroups;var isnGroup=[];data.grouped[groupField].groups.forEach(function(item){var isn={};isn.isnNumber=item.groupValue;isn.isnLongDescription="N/A";isn.variations=item.doclist.numFound;if(item.doclist.docs.length>0){isn.productname=item.doclist.docs[0].isnlongdesc;isn.vendorstyle=item.doclist.docs[0].vendorstyle;}
var productList=[];var imageId='';var upc='';var colorSize=[];item.doclist.docs.forEach(function(docItem){productList.push(docItem);imageId=docItem.imageid;upc=docItem.id;colorSize.push({color:docItem.colorfamdesc,size:docItem.itemsize,docItem:docItem});});isn.imageId=imageId;isn.upc=upc;isn.colorSize=colorSize;isn.productList=productList;isnGroup.push(isn);})
response.isnGroup=isnGroup;return response;}
var createSOLRQueryString=function(queryParam){var createFacetQueryString=function(facetSelectionArray,fieldName){if(facetSelectionArray.length==0){return undefined;}else if(facetSelectionArray.length==1){return fieldName+':\"'+solrEncoding(facetSelectionArray[0].name)+'\"'}else{var facet='(';facetSelectionArray.forEach(function(item){if(facet==='('){facet=facet+fieldName+':\"'+solrEncoding(item.name)+'\"'}else{facet=facet+' OR '+fieldName+':\"'+solrEncoding(item.name)+'\"'}})
return facet+')';}};var createFacetFilterString=function(facetSelectionArray,fieldName){if(facetSelectionArray.length==0){return undefined;}else if(facetSelectionArray.length==1){return'fq={!tag=dt}'+fieldName+':\"'+solrEncoding(facetSelectionArray[0].name)+'\"'}else{var facet='(';facetSelectionArray.forEach(function(item){if(facet==='('){facet=facet+fieldName+':\"'+solrEncoding(item.name)+'\"'}else{facet=facet+' OR '+fieldName+':\"'+solrEncoding(item.name)+'\"'}})
return'fq={!tag=dt}'+facet+')';}};function replaceAll(find,replace,str){return str.replace(new RegExp(find,'g'),replace);}
var isnQuery=queryParam.isnAndProductCode?' isn:'+queryParam.isnAndProductCode.isn:'';var productCodeQuery=queryParam.isnAndProductCode&&queryParam.isnAndProductCode.productcode?'  OR productcode:'+queryParam.isnAndProductCode.productcode:'';var isnAndProductCode=queryParam.isnAndProductCode?'('+isnQuery+productCodeQuery+')':undefined;var buyable=queryParam.buyable?'buyable:true':undefined;var upc=queryParam.upc?'id:\"'+queryParam.upc+'\"':undefined;if(angular.isString(queryParam.webIdImageId))
{queryParam.webIdImageId=queryParam.webIdImageId.trim();}
var webIdSearchSection=[];if(queryParam.webIdImageId&&(/^\d{1,10}$/).test(queryParam.webIdImageId)&&(parseInt(queryParam.webIdImageId)<2147483600))
{webIdSearchSection.push('imageid:\"'+queryParam.webIdImageId+'\"');}
if(queryParam.webIdImageId)
{webIdSearchSection.push('webid:(\*'+solrEncoding(queryParam.webIdImageId)+'\*)');webIdSearchSection.push('keywords:"'+solrEncoding(queryParam.webIdImageId)+'"');}
var imageWebId=webIdSearchSection.length>0?"("+webIdSearchSection.join(" OR ")+")":undefined;var selectedCMG=queryParam.selectedCMG?'cmg:\"'+solrEncoding(queryParam.selectedCMG)+'\"':undefined;var selectedCFG=queryParam.selectedCFG?'cfg:\"'+solrEncoding(queryParam.selectedCFG)+'\"':undefined;var selectedFOB=queryParam.selectedFOB?'fob:\"'+solrEncoding(queryParam.selectedFOB)+'\"':undefined;var brandName=queryParam.brandName?'brandlongdesc:\"'+solrEncoding(queryParam.brandName)+'\"':undefined;var vendorStyle=queryParam.vendorStyle?'vendorstyle:\"'+solrEncoding(queryParam.vendorStyle)+'\"':undefined;var description=queryParam.description?'descriptions:('+solrEncoding(splitDescriptionTerms(queryParam.description))+')':undefined;var isActive='isactive:Y';var start=queryParam.start;var rows=queryParam.rows;var colorFilter=undefined;var size1Filter=undefined;var size2Filter=undefined;if(queryParam.colorFilter)
{if(queryParam.isnAndProductCode.colorcode!==null&&queryParam.isnAndProductCode.colorcode!==undefined)
{colorFilter='colorcode:\"'+queryParam.isnAndProductCode.colorcode+'\"';}}
if(queryParam.sizeFilter)
{if(angular.isString(queryParam.isnAndProductCode.size1code))
{size1Filter=queryParam.isnAndProductCode.size1code.trim().length>0?'size1code:\"'+solrEncoding(queryParam.isnAndProductCode.size1code)+'\"':undefined;}
if(angular.isString(queryParam.isnAndProductCode.size2code)){size2Filter=queryParam.isnAndProductCode.size2code.trim().length>0?'size2code:\"'+solrEncoding(queryParam.isnAndProductCode.size2code)+'\"':undefined;}}
var q=undefined;function buildQ(qItems){if(qItems){qItems.forEach(function(item){if(item&&!q){q=item;}else if(q&&item){q=q+' AND '+item;}});}}
buildQ([buyable,isnAndProductCode,upc,colorFilter,size1Filter,size2Filter,imageWebId,selectedCMG,selectedCFG,selectedFOB,brandName,vendorStyle,description,isActive]);var facetFields=undefined;var fq=[];var requestedFilterFacets={};if(angular.isString(queryParam.filterFacet)&&(queryParam.filterFacet.trim().length>0)){requestedFilterFacets[queryParam.filterFacet]=true;}else if(angular.isArray(queryParam.filterFacet)){for(var p=0;p<queryParam.filterFacet.length;p++){requestedFilterFacets[queryParam.filterFacet[p]]=true;}}
if(requestedFilterFacets.fob){facetFields="facet.field={!ex=dt}facetfob";fq.push(createFacetFilterString(queryParam.selectedFOBs,'facetfob'));}else{facetFields="facet.field=facetfob";buildQ([createFacetQueryString(queryParam.selectedFOBs,'facetfob')]);}
if(requestedFilterFacets.brand){facetFields=facetFields+"&facet.field={!ex=dt}facetbrand";fq.push(createFacetFilterString(queryParam.selectedBrands,'facetbrand'));}else{facetFields=facetFields+"&facet.field=facetbrand";buildQ([createFacetQueryString(queryParam.selectedBrands,'facetbrand')]);}
if(requestedFilterFacets.color){facetFields=facetFields+"&facet.field={!ex=dt}facetcolor";fq.push(createFacetFilterString(queryParam.selectedColors,'colorattrdesc'));}else{facetFields=facetFields+"&facet.field=facetcolor";buildQ([createFacetQueryString(queryParam.selectedColors,'colorattrdesc')]);}
if(requestedFilterFacets.itemSize){facetFields=facetFields+"&facet.field={!ex=dt}facetitemsize";fq.push(createFacetFilterString(queryParam.selectedItemSizes,'itemsize'));}else{facetFields=facetFields+"&facet.field=facetitemsize";buildQ([createFacetQueryString(queryParam.selectedItemSizes,'itemsize')]);}
if(!q){q='*:*';}
queryGroupField=!isnAndProductCode?'groupid':'isactive';var facetDef="facet=true&group.start=0&group.limit=500&group=true&group.field="+queryGroupField+"&group.facet=true&group.ngroups=true&facet.sort=index&facet.mincount=1&facet.limit=-1";var format='wt=json&indent=true';var range='start='+start+'&rows='+rows;var sort='sort=buyable desc';var responseHeaderSetting="omitHeader=true";var queryString=SOLRURL+"/select?q="+q+'&'+facetDef+'&'+facetFields+'&'+sort+'&'+format+'&'+range+'&'+responseHeaderSetting;for(var p=0;p<fq.length;p++){queryString=queryString+'&'+fq[p];}
return queryString;}
var solrEncoding=function(data){var result=data.replace(/\\/g,'\\\\');result=result.replace(/-/g,'\\-');result=result.replace(/\//g,'\\/');result=result.replace(/!/g,'\\!');result=result.replace(/\(/g,'\\(');result=result.replace(/\)/g,'\\)');result=result.replace(/{/g,'\\{');result=result.replace(/}/g,'\\}');result=result.replace(/\[/g,'\\[');result=result.replace(/\]/g,'\\]');result=result.replace(/\^/g,'\\^');result=result.replace(/"/g,'\\"');result=result.replace(/~/g,'\\~');result=result.replace(/\*/g,'\\*');result=result.replace(/\?/g,'\\?');result=result.replace(/:/g,'\\:');result=result.replace(/\+/g,'\\+');result=encodeURIComponent(result)
return result;};var splitDescriptionTerms=function(DesString){var result=DesString.trim().toLowerCase().replace(/(\s*,\s*|\s+)/g,",").split(",");result=result.filter(function(item){var commaSpaceRegex=/(\s+|.*,.*)/g;if(item.length>0&&!(commaSpaceRegex.test(item))){return true;}else{return false;}});var resultString=result.join(" AND ");if(resultString.length<1){return'""';}else{return resultString;}};var populateProductHierarchy=function(data){var cmg=[];var cfg=[];var fob=[];data.forEach(function(solrCMGItem){var cmgItem={};cmgItem.value=solrCMGItem.value.substring(solrCMGItem.value.indexOf('-')+2);cmgItem.originalValue=solrCMGItem.value;cmgItem.visible=true;cmg.push(cmgItem);solrCMGItem.pivot.forEach(function(solrCFGItem){var cfgItem={};cfgItem.cmgItemOriginalValue=cmgItem.originalValue;cfgItem.value=solrCFGItem.value.substring(solrCFGItem.value.indexOf('-')+2);cfgItem.originalValue=solrCFGItem.value;cfgItem.visible=true;cfg.push(cfgItem);solrCFGItem.pivot.forEach(function(solrFOBItem){var fobItem={};fobItem.cmgItemOriginalValue=cmgItem.originalValue;fobItem.cfgItemOriginalValue=cfgItem.originalValue;fobItem.value=solrFOBItem.value.substring(solrFOBItem.value.indexOf('-')+2);fobItem.originalValue=solrFOBItem.value;fobItem.visible=true;fob.push(fobItem);});});});function compare(a,b){if(a.value<b.value)
return-1;if(a.value>b.value)
return 1;return 0;}
cmg.sort(compare);cfg.sort(compare);fob.sort(compare);return{cmgData:cmg,cfgData:cfg,fobData:fob};}
var createSKUQueryString=function(sku){return SOLRURL+'/select?q=sku%3A'+sku+'&fl=sku%2Cid%2Cproductid%2Cisn%2Cgroupid%2Cisactive&wt=json&indent=true'}
var createUPCQueryString=function(upc){return SOLRURL+'/select?q=id%3A'+upc+'&fl=productcode%2Csku%2Cid%2Cproductid%2Cisn%2Cgroupid%2Cisactive%2Ccolorcode%2Csize1code%2Csize2code&wt=json&indent=true'}
var createBrandQueryString=function(){return SOLRURL+'/select?q=*%3A*&wt=json&indent=true&facet.sort=index&facet.field=facetbrand&facet=true&rows=0&facet.limit=-1';}
var createProductHierarchyQueryString=function(){return SOLRURL+'/select?q=*%3A*&wt=json&indent=true&rows=0&facet=true&facet.limit=-1&facet.pivot=cmg,cfg,fob&facet.mincount=1&facet.limit=-1';}
this.getParameterByName=function(name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regex=new RegExp("[\\?&]"+name+"=([^&#]*)"),results=regex.exec(location.search);return results===null?"":decodeURIComponent(results[1].replace(/\+/g," "));}
return{createFacetItem:createFacetItem,populateISNModel:populateISNModel,createSOLRQueryString:createSOLRQueryString,populateProductHierarchy:populateProductHierarchy,createUPCQueryString:createUPCQueryString,createSKUQueryString:createSKUQueryString,createBrandQueryString:createBrandQueryString,createProductHierarchyQueryString:createProductHierarchyQueryString};}]);appServices.factory('itemLocate',['$http','sendSMTPErrorEmail','$filter',function($http,$sendSMTPErrorEmail,$filter){var locate=function(zip,city,radius,state,id,store,success,error){var url=serviceURL+"/Inventory/GetAvailableStores";if(angular.isString(city)){city=city.toUpperCase();}
var contract={"GetAvailableStoresReq":{"_Radius":radius,"_Zipcode":(angular.isString(zip)&&zip.trim().length>0)?zip.trim():"","_City":(angular.isString(city)&&city.trim().length>0)?city.trim():"","_State":(angular.isString(state)&&state.trim().length>0)?state.trim():"","_BOPISEligible":"N","_ResultBy":"Store","_ATSType":"Store","ItemList":[{"_ItemID":id}]}};return $http.post(url,angular.toJson(contract)).then(function(response){var stores;var results=[];if(response.data===null||!angular.isObject(response.data.GetAvailableStoresResp)||response.data.GetAvailableStoresResp.StoreList===null){return[];}else if(angular.isArray(response.data.GetAvailableStoresResp.StoreList)){stores=response.data.GetAvailableStoresResp.StoreList;}else if(angular.isObject(response.data.GetAvailableStoresResp.StoreList)&&angular.isObject(response.data.GetAvailableStoresResp.StoreList.Store)){stores=[];stores.push(response.data.GetAvailableStoresResp.StoreList.Store);}else{return[];}
for(var i=0;i<stores.length;i++){results.push({StoreName:stores[i]._StoreID+"-"+stores[i]._StoreName,Address:stores[i].Address._Line1,City:stores[i].Address._City,Phone:$filter('phoneFormat')(stores[i]._MainPhone),Inventory:stores[i].ItemList.Item._AvailableQty,Distance:Number(stores[i]._Distance)});}
return $filter('orderBy')(results,"Distance");},function(response){$sendSMTPErrorEmail(response,url);error(response.data.err);});};var getOrganizationList=function(store,success,error){var url=serviceURL+"/Organization/GetStoreInfo";var contract={GetStoreInfoReq:{Stores:[{_StoreID:store}]}}
return $http.post(url,angular.toJson(contract)).success(function(data){}).error(function(data){$sendSMTPErrorEmail(data,url);error(data.err);});};return{locate:locate,getOrganizationList:getOrganizationList};}]);appServices.factory('itemToLocate',function(){var currentItem=[]
function set(data){savedItem=data;}
function get(){return savedItem;}
return{set:set,get:get}});appServices.factory('itemDetail',['$http','itemInventory','loggerService','$q','sendSMTPErrorEmail','POSService','loadingIconService',function($http,$itemInventory,$loggerService,$q,$sendSMTPErrorEmail,$POSService,$loadingIconService){return function(isnGroup,success,error,config){var localConfig={index:null,isBlocked:true};if(angular.isObject(config)){if(angular.isDefined(config.index)&&isFinite(parseInt(config.index))){localConfig.index=parseInt(config.index);if(localConfig.index>=isnGroup.productList.length){localConfig.index=null;}}
if(angular.isDefined(config.isBlocked)&&!config.isBlocked){localConfig.isBlocked=false;}}
$loadingIconService.resetIcon();POSParamStore=$POSService.getPOSParameters();var url=serviceURL+"/Price/GetItemListPrices";var contract={};contract.ItemListIn={};contract.ItemListIn._CallingOrganizationCode=POSParamStore.storeNumber;contract.ItemListIn._PricingDate=new Date().toJSON();var Item=[];var mergeInventoryResult=function(group,ItemList){if(!angular.isArray(ItemList)){ItemList=[ItemList.Item];}
group.isnGroupAvailableQty=0;group.productList.forEach(function(product){if(!angular.isDefined(product._AvailableQty)){product._AvailableQty=null;}
for(var i=0;i<ItemList.length;i=i+1){if(ItemList[i]._ItemID==parseInt(product.sku)){product._AvailableQty=ItemList[i]._AvailableQty;break;}}
group.isnGroupAvailableQty=group.isnGroupAvailableQty+parseInt(product._AvailableQty);});};var createInventoryContract=function(group){var contract={};contract.GetItemListForOrderingReq={};var ItemList=[];var createItemInput=function(product){var productId={};productId._ItemID=''+product.sku;ItemList.push(productId);};if(localConfig.index!==null){createItemInput(group.productList[localConfig.index]);}else{group.productList.forEach(createItemInput);}
contract.GetItemListForOrderingReq.ItemList=ItemList;return contract;};var createItemPricingItemInput=function(productItem){var tempItem={"_ItemID":productItem.sku,"_ItemKey":productItem.sku,"_OrganizationCode":"BONTON","PrimaryInformation":{"_IsAirShippingAllowed":"?","_ItemType":"REG","_UnitPrice":"0.00"},"ItemAliasList":{"ItemAlias":[{"_AliasName":"ACTIVE_UPC","_AliasValue":productItem.id}]},"Extn":{"_ExtnSpecialHandlingCode":productItem.specialhandlingcode}};Item.push(tempItem);};if(localConfig.index!==null){createItemPricingItemInput(isnGroup.productList[localConfig.index]);}else{isnGroup.productList.forEach(createItemPricingItemInput);}
contract.ItemListIn.Item=Item;var promiseArray=[];promiseArray.push($http.post(url,angular.toJson(contract)).success(function(data){var ItemListOut=angular.fromJson(data).ItemListOut;if(ItemListOut._ResponseCode==='9999'){error(data);}
else{isnGroup.productList.forEach(function(productItem){if(!angular.isDefined(productItem.itemDetail)){productItem.itemDetail=null;}
if(ItemListOut.Item.length!=undefined){for(var i=0;i<ItemListOut.Item.length;i++){var itemDetail=angular.fromJson(ItemListOut.Item[i]);if(productItem.sku==parseInt(itemDetail._ItemID)){productItem.itemDetail=itemDetail;productItem.itemDetail.ComputedPrice.Extn._ExtnSpecialHandlingCode=productItem.specialhandlingcode;break;}}}
else{var itemDetail=angular.fromJson(ItemListOut.Item);if(productItem.sku==parseInt(itemDetail._ItemID)){productItem.itemDetail=itemDetail;productItem.itemDetail.ComputedPrice.Extn._ExtnSpecialHandlingCode=productItem.specialhandlingcode;}}});}}));if(!localConfig.isBlocked){$loadingIconService.resetIcon();}
var contract=createInventoryContract(isnGroup);promiseArray.push($itemInventory.getSafetyInventory(contract).success(function(inventoryResponse){mergeInventoryResult(isnGroup,angular.fromJson(inventoryResponse).GetItemListForOrderingResp.ItemList)}));if(!localConfig.isBlocked){$loadingIconService.resetIcon();}
$q.all(promiseArray).then(function(){$loadingIconService.resetIcon();success(isnGroup)},function(err){$loadingIconService.resetIcon();error(err);});if(!localConfig.isBlocked){$loadingIconService.resetIcon();}}}]);appServices.factory('itemInventory',['$http','sendSMTPErrorEmail','serviceArrayFix',function($http,$sendSMTPErrorEmail,$serviceArrayFix){var _getSafetyInventory=function(contract){var url=serviceURL+"/Inventory/GetAvailable";return $http.post(url,angular.toJson(contract)).error(function(error){$sendSMTPErrorEmail(error,url);});};var _getOnHandInventoryFromShipnodeAndSkuArray=function(shipNode,skuArray){if(!((angular.isString(shipNode)&&(/^\d+$/i).test(shipNode.trim()))||(Number.isInteger(shipNode)&&(shipNode>-1)))){var defer=$q.defer();defer.reject('invalid shipNode value.');return defer.promise;}
if(angular.isNumber(shipNode)){shipNode=shipNode.toString();}
shipNode=shipNode.trim();while(shipNode.length<3){shipNode="0"+shipNode;}
shipNode=shipNode.substring(0,3);var skuOnHandDict={};angular.forEach(skuArray,function(value){skuOnHandDict[value]=0;});var url=serviceURL+"/Inventory/getSupplyDetails";var contract={"GetSupplyDetailsReq":{"input":{"getSupplyDetails":[]}}};angular.forEach(skuOnHandDict,function(value,key){contract.GetSupplyDetailsReq.input.getSupplyDetails.push({"_ItemID":""+key,"_OrganizationCode":"BONTON","_ProductClass":"NEW","_ShipNode":shipNode,"_UnitOfMeasure":"EACH"});});return $http.post(url,angular.toJson(contract)).then(function(response){$serviceArrayFix(response.data);var items=[];if(response.data.GetSupplyDetailsRes&&response.data.GetSupplyDetailsRes.Items){items=response.data.GetSupplyDetailsRes.Items.Item;}
for(var i=0;i<items.length;i++){var sku=items[i]._ItemID;var inventoryOnHand=0;if(angular.isObject(items[i].ShipNodes)&&angular.isArray(items[i].ShipNodes.ShipNode)&&items[i].ShipNodes.ShipNode.length>0&&angular.isObject(items[i].ShipNodes.ShipNode[0].Supplies)&&angular.isObject(items[i].ShipNodes.ShipNode[0].Supplies.Supply)&&angular.isString(items[i].ShipNodes.ShipNode[0].Supplies.Supply._TotalQuantity)){inventoryOnHand=parseInt(items[i].ShipNodes.ShipNode[0].Supplies.Supply._TotalQuantity);}
skuOnHandDict[sku]=inventoryOnHand;}
return skuOnHandDict;},function(response){$sendSMTPErrorEmail(response,url);return response;});};return{getSafetyInventory:_getSafetyInventory,getOnHandInventoryFromShipnodeAndSkuArray:_getOnHandInventoryFromShipnodeAndSkuArray}}]);appServices.factory('itemSearch',['$rootScope','$http','$cacheFactory','ISNModelHelper','$q','sendSMTPErrorEmail',function($rootScope,$http,$cacheFactory,ISNModelHelper,$q,$sendSMTPErrorEmail){var cache=$cacheFactory('itemResult');var cleanSelectedFacets=function(selectedValues,responseFacetValues){if(selectedValues&&selectedValues==[]){return[];}
selectedValues.forEach(function(selectedItem){selectedItem.keep=false;});responseFacetValues.forEach(function(responseItem){selectedValues.forEach(function(selectedItem){if(responseItem.name===selectedItem.name){selectedItem.keep=true;};});});var fixedSelectedValues=[];selectedValues.forEach(function(selectedItem){if(selectedItem.keep){fixedSelectedValues.push(selectedItem);};});return fixedSelectedValues;};var search=function(queryParam,success,error){var url=ISNModelHelper.createSOLRQueryString(queryParam);$http.get(url).success(function(data){var response=ISNModelHelper.populateISNModel(data);response.itemSizes=ISNModelHelper.createFacetItem(data.facet_counts.facet_fields.facetitemsize);response.colors=ISNModelHelper.createFacetItem(data.facet_counts.facet_fields.facetcolor);response.brands=ISNModelHelper.createFacetItem(data.facet_counts.facet_fields.facetbrand);response.fobs=ISNModelHelper.createFacetItem(data.facet_counts.facet_fields.facetfob);queryParam.selectedItemSizes=cleanSelectedFacets(queryParam.selectedItemSizes,response.itemSizes);queryParam.selectedColors=cleanSelectedFacets(queryParam.selectedColors,response.colors);queryParam.selectedBrands=cleanSelectedFacets(queryParam.selectedBrands,response.brands);queryParam.selectedFOBs=cleanSelectedFacets(queryParam.selectedFOBs,response.fobs);if(!queryParam.nocache){cache.put('cachedResult',response);cache.put('queryParam',queryParam);}
response.isnGroup.forEach(function(group){group.isnGroupAvailable=false;for(var i=0;i<group.productList.length;i++){var product=group.productList[i];if(!product.buyable){group.isnGroupAvailable=group.isnGroupAvailable||false;}else{group.isnGroupAvailable=group.isnGroupAvailable||true;}}});success(response);}).error(function(data){$sendSMTPErrorEmail(data,url);error(data.err);});};var MAX_NUMBER_OF_ROWS=20;var retrieveSKU=function(sku){var query=ISNModelHelper.createSKUQueryString(sku);return $http.get(query)}
var searchItemBySKU=function(sku){var query=SOLRURL+'/select?q=sku%3A"'+sku+'"+%0AAND+isactive%3A"Y"&wt=json';return $http.get(query).then(function(response){return response.data.response.docs[0];});}
var searchItemBySKUArray=function(skuArr){if(!angular.isArray(skuArr)||skuArr.length<1){var defer=$q.defer();defer.resolve([]);return defer.promise;}
var skuString=skuArr.join('"OR"');skuString='"'+skuString+'"';skuString=encodeURIComponent(skuString);var query=SOLRURL+'/select?q=sku%3A('+skuString+')+AND+isactive%3A%22Y%22&start=0&rows='+(skuArr.length+10).toString()+'&wt=json';return $http.get(query).then(function(response){var skuDict={};angular.forEach(response.data.response.docs,function(value){skuDict[value.sku]=value;});return skuDict;});}
var retrieveUPC=function(upc){var query=ISNModelHelper.createUPCQueryString(upc);return $http.get(query)}
var retrieveIds=function(upc){var defered=$q.defer();retrieveUPC(upc).then(function(result){var docs=result.data.response.docs;if(docs.length==0){defered.reject("notfound");}else{if(docs[0].isactive=='Y'){defered.resolve(docs[0]);}else{retrieveSKU(docs[0].sku).then(function(result){var docs=result.data.response.docs;for(var i=0;i<docs.length;i++){if(docs[i].isactive=='Y'){defered.resolve(docs[0]);}}});}}});return defered.promise;}
var searchUPCWithFilter=function(upc,filterBy,success,error){retrieveIds(upc).then(function(doc){var queryParameters={}
queryParameters.originalUPC=upc;queryParameters.isnAndProductCode=doc;queryParameters.start=0;queryParameters.currentPage=1;queryParameters.rows=-1;queryParameters.selectedBrands=[];queryParameters.selectedColors=[];queryParameters.selectedItemSizes=[];queryParameters.selectedFOBs=[];queryParameters.colorFilter=angular.isString(filterBy)&&(filterBy==='color')?true:false;queryParameters.sizeFilter=angular.isString(filterBy)&&(filterBy==='size')?true:false;search(queryParameters,success,error);}).catch(function(error){var response={};response.ngroups=0;success(response);})};var searchUPC=function(upc,success,error){searchUPCWithFilter(upc,null,success,error);}
var searchUPCMoreColors=function(upc,success,error){searchUPCWithFilter(upc,"size",success,error);}
var searchUPCMoreSizes=function(upc,success,error){searchUPCWithFilter(upc,"color",success,error);}
var searchISNORProductCode=function(doc,success,error){var queryParameters={}
queryParameters.isnAndProductCode=doc;queryParameters.start=0;queryParameters.currentPage=1;queryParameters.rows=-1;queryParameters.selectedBrands=[];queryParameters.selectedColors=[];queryParameters.selectedItemSizes=[];queryParameters.selectedFOBs=[];queryParameters.nocache=true;search(queryParameters,success,error);}
var filter=function(queryParam,success,error){search(queryParam,success,error);};var getCachedResult=function(){return cache.get('cachedResult');};var getCachedQueryParam=function(){return cache.get('queryParam');};var getSelectedISNGroup=function(){return cache.get("selectedISNGroup");};var setSelectedISNGroup=function(item){cache.put('selectedISNGroup',item);}
var retrieveBrands=function(success,error){$http.get(ISNModelHelper.createBrandQueryString(),{cache:true}).success(function(data){var brands=ISNModelHelper.createFacetItem(data.facet_counts.facet_fields.facetbrand);success(brands);}).error(function(data){error(data.err);})};var retrieveProductHierarchy=function(success,error){$http.get(ISNModelHelper.createProductHierarchyQueryString(),{cache:true}).success(function(data){var temp=ISNModelHelper.populateProductHierarchy(angular.fromJson(data).facet_counts.facet_pivot["cmg,cfg,fob"]);success(temp);}).error(function(data){error(data.err);})};var clearCachedResult=function(){cache.remove('cachedResult');cache.remove('queryParam');}
var clearSelectedISNGroup=function(){cache.remove('selectedISNGroup');}
var itemSearchFunctions={search:search,searchUPC:searchUPC,searchUPCMoreColors:searchUPCMoreColors,searchUPCMoreSizes:searchUPCMoreSizes,searchISNORProductCode:searchISNORProductCode,filter:filter,getCachedResult:getCachedResult,getCachedQueryParam:getCachedQueryParam,setSelectedISNGroup:setSelectedISNGroup,getSelectedISNGroup:getSelectedISNGroup,clearSelectedISNGroup:clearSelectedISNGroup,retrieveBrands:retrieveBrands,retrieveProductHierarchy:retrieveProductHierarchy,clearCachedResult:clearCachedResult,MAX_NUMBER_OF_ROWS:MAX_NUMBER_OF_ROWS,searchItemBySKU:searchItemBySKU,searchItemBySKUArray:searchItemBySKUArray}
return itemSearchFunctions;}]);appServices.factory('itemProperty',[function(){var _isItemActiveBuyable=function(solrItemDoc){if(angular.isDefined(solrItemDoc.isactive)&&(/^N$/i).test(solrItemDoc.isactive)){return false;}
if(!angular.isDefined(solrItemDoc.pricestatus)){return true;}else{if((/^(f|p)$/i).test(solrItemDoc.pricestatus)){if(!angular.isDefined(solrItemDoc.buyable)){return false;}else{return(/^true$/i).test(solrItemDoc.buyable)?true:false;}}else{return true;}}};return{isItemActiveBuyable:_isItemActiveBuyable};}]);appServices.factory('bigTicketValidate',['$http','errorObj','$q',function($http,errorObj,$q){var cache={};var _bigTicketPromise=function(zipCode){if(!isFinite(parseInt(zipCode))){throw errorObj.newError('_bigTicketPromise():InputError',"Zip code must be 5 digits.","_bigTicketPromise():InputError.  The zip code passed was: "+zipCode.toString(),'InputNotNumber','WARN');}
zipCode=parseInt(zipCode).toString();if(zipCode.length!==5){throw errorObj.newError('_bigTicketPromise():InputError',"Zip code must be 5 digits only.","_bigTicketPromise():InputError.  The zip code passed was too long.  Input was cleansed with code: parseInt(zipCode).toString(); Result:"+zipCode.toString(),'InputLengthInvalid','WARN');}
if(zipCode in cache){return $q.when({data:{"ValidateBigTicketZipCodeResp":{"_isValid":cache[zipCode].toString(),"_status":"00","_statusMessage":"Success"}}});}else{var input={"ValidateBigTicketZipCodeReq":{"_ZipCode":zipCode}}
return $http.post(serviceURL.toString()+'/Utility/ValidateBigTicketZipCode',input).then(function(response){if('Success'===response.data.ValidateBigTicketZipCodeResp._statusMessage){cache[zipCode]=response.data.ValidateBigTicketZipCodeResp._isValid.toString();}
return response;});}};return{bigTicketPromise:_bigTicketPromise};}]);
﻿var appServices=angular.module('appServicesPayment',[]);appServices.factory('payment',['$http','$cacheFactory','POSService','$rootScope','loggerService','sendSMTPErrorEmail','securityService','$q','alertMessages',function($http,$cacheFactory,$POSService,$rootScope,$loggerService,$sendSMTPErrorEmail,$securityService,$q,$alertMessages){var giftCard={label:'Gift Card',contractType:'GIFTCARD',authType:'GiftCard',msrType:"GiftCard"};var creditCard={label:'Bank/Credit Card',contractType:'CREDITCARD',authType:'BankCard',msrType:"BankCard"};var PLCC={label:'Store Charge',contractType:'CREDITCARD',authType:'PLCC',msrType:"PLCC"};var paymentTypes={GIFTCARD:giftCard,CREDITCARD:creditCard,PLCC:PLCC};var cardTypes=[{type:'VISA',label:'Visa'},{type:'DISCOVER',label:'Discover Network'},{type:'AMEX',label:'American Express'},{type:'MASTER',label:'MasterCard'},{type:'BT',label:'Bon-Ton'},{type:'BG',label:'Bergner\’s'},{type:'BS',label:'Boston Store'},{type:'CP',label:'Carson\’s'},{type:'EB',label:'Elder-Beerman'},{type:'HB',label:'Herberger\’s'},{type:'YK',label:'Younkers'},]
var bankCardRegEx=/^(MasterCard|VISA|AmericanExpress|Discover|DinersClub|JCB)$/i;var testBankCardType=function(cardTypeString){return bankCardRegEx.test(cardTypeString);};var translateCardType=function(cardTypeString){if((/^MasterCard$/i).test(cardTypeString)){return"MASTER";}else if((/^VISA$/i).test(cardTypeString)){return"VISA";}else if((/^(Discover|DinersClub|JCB)$/i).test(cardTypeString)){return"DISCOVER";}else if((/^AmericanExpress$/i).test(cardTypeString)){return"AMEX";}else{return'';}};var getExpDateCC=function(){var date=new Date();var year=date.getFullYear()+1;return"12/"+year;}
var getExpDateAuth=function(){var date=new Date();var year=date.getFullYear()+1;return year+"-12-31";}
var daysInMonth=function(year,month){return new Date(year,month,0).getDate();}
var createExpDateFormatForCC=function(exp){if(exp&&exp.length==4){var year='20'+exp.substring(2,4);var month=exp.substring(0,2);var day=daysInMonth(Number(year),Number(month));return month+'/'+year;}else{return getExpDateCC();}}
var createExpDateFormatForCCAuth=function(exp){if(exp&&exp.length==4){var year='20'+exp.substring(2,4);var month=exp.substring(0,2);var day=daysInMonth(Number(year),Number(month));return year+'-'+month+'-'+day;}else{return getExpDateAuth();}}
var pciCleanInfo=function(authFullHttpResponse,cartCards){var cleanPaymentHttp={IsRetalixActive:"",AuthRequest:{_OriginStoreNum:"",_FulfillmentStoreNum:"",_SourceApplication:"",_TotalToAuthorize:"",_ProvideAddressFlag:"",_ValidateAVSInd:"",_TenderCount:"",_FloorLimitEnable:"",TenderList:[]},AuthResponse:{_AuthorizationResult:"",_MasterErrorDetailLocation:"",_MasterResultAltReasonCode:"",_MasterResultCode:"",_MasterResultReasonCode:"",_MasterResultReasonText:"",_MasterResultText:"",TenderList:[]},CardDetailInCart:[]};if(angular.isUndefined(isRetalixReady)){cleanPaymentHttp.IsRetalixActive="undefined";}else if(isRetalixReady===null){cleanPaymentHttp.IsRetalixActive="null";}else{cleanPaymentHttp.IsRetalixActive=isRetalixReady.toString();}
if(angular.isObject(authFullHttpResponse)&&angular.isObject(authFullHttpResponse.config)&&angular.isObject(authFullHttpResponse.config.data)&&angular.isObject(authFullHttpResponse.config.data.CreditAuthRequest)){var requestPayload=authFullHttpResponse.config.data.CreditAuthRequest;cleanPaymentHttp.AuthRequest._OriginStoreNum=requestPayload._OriginStoreNum?requestPayload._OriginStoreNum:"";cleanPaymentHttp.AuthRequest._FulfillmentStoreNum=requestPayload._FulfillmentStoreNum?requestPayload._FulfillmentStoreNum:"";cleanPaymentHttp.AuthRequest._SourceApplication=requestPayload._SourceApplication?requestPayload._SourceApplication:"";cleanPaymentHttp.AuthRequest._TotalToAuthorize=requestPayload._TotalToAuthorize?requestPayload._TotalToAuthorize:"";cleanPaymentHttp.AuthRequest._ProvideAddressFlag=requestPayload._ProvideAddressFlag?requestPayload._ProvideAddressFlag:"";cleanPaymentHttp.AuthRequest._ValidateAVSInd=requestPayload._ValidateAVSInd?requestPayload._ValidateAVSInd:"";cleanPaymentHttp.AuthRequest._TenderCount=requestPayload._TenderCount?requestPayload._TenderCount:"";cleanPaymentHttp.AuthRequest._FloorLimitEnable=requestPayload._FloorLimitEnable?requestPayload._FloorLimitEnable:"";if(angular.isArray(requestPayload.TenderList)){for(var i=0;i<requestPayload.TenderList.length;i++){var cleanCard={_TenderType:"",_Token:"",_TokenType:""};cleanCard._TenderType=requestPayload.TenderList[i]._TenderType?requestPayload.TenderList[i]._TenderType:"";cleanCard._Token=requestPayload.TenderList[i]._Token?requestPayload.TenderList[i]._Token:"";cleanCard._TokenType=requestPayload.TenderList[i]._TokenType?requestPayload.TenderList[i]._TokenType:"";cleanPaymentHttp.AuthRequest.TenderList.push(cleanCard);}}}
if(angular.isObject(authFullHttpResponse)&&angular.isObject(authFullHttpResponse.data)&&angular.isObject(authFullHttpResponse.data.CreditAuthResponse)){var responseData=authFullHttpResponse.data.CreditAuthResponse;cleanPaymentHttp.AuthResponse._AuthorizationResult=responseData._AuthorizationResult?responseData._AuthorizationResult:"";cleanPaymentHttp.AuthResponse._MasterErrorDetailLocation=responseData._MasterErrorDetailLocation?responseData._MasterErrorDetailLocation:"";cleanPaymentHttp.AuthResponse._MasterResultAltReasonCode=responseData._MasterResultAltReasonCode?responseData._MasterResultAltReasonCode:"";cleanPaymentHttp.AuthResponse._MasterResultCode=responseData._MasterResultCode?responseData._MasterResultCode:"";cleanPaymentHttp.AuthResponse._MasterResultReasonCode=responseData._MasterResultReasonCode?responseData._MasterResultReasonCode:"";cleanPaymentHttp.AuthResponse._MasterResultReasonText=responseData._MasterResultReasonText?responseData._MasterResultReasonText:"";cleanPaymentHttp.AuthResponse._MasterResultText=responseData._MasterResultText?responseData._MasterResultText:"";if(!angular.isArray(responseData.TenderList.Item)){responseData.TenderList=[responseData.TenderList.Item];}else{responseData.TenderList=responseData.TenderList.Item;}
if(angular.isArray(responseData.TenderList)){for(var i=0;i<responseData.TenderList.length;i++){var cleanCard={_AccountType:"",_DetailAuthorizationResult:"",_ReferenceNum:"",_Token:"",_VendorResponseCode:""};cleanCard._AccountType=responseData.TenderList[i]._AccountType?responseData.TenderList[i]._AccountType:"";cleanCard._DetailAuthorizationResult=responseData.TenderList[i]._DetailAuthorizationResult?responseData.TenderList[i]._DetailAuthorizationResult:"";cleanCard._ReferenceNum=responseData.TenderList[i]._ReferenceNum?responseData.TenderList[i]._ReferenceNum:"";cleanCard._Token=responseData.TenderList[i]._Token?responseData.TenderList[i]._Token:"";cleanCard._VendorResponseCode=responseData.TenderList[i]._VendorResponseCode?responseData.TenderList[i]._VendorResponseCode:"";cleanPaymentHttp.AuthResponse.TenderList.push(cleanCard);}}}
if(angular.isArray(cartCards)){for(var i=0;i<cartCards.length;i++){var cleanCard={paymentType:{label:"",contractType:"",authType:"",msrType:""},cardNumber:"",token:"",AccountNumberIndicator:"",cardType:""};var curCard=cartCards[i];cleanCard.cardNumber=angular.isString(curCard.cardNumber)?curCard.cardNumber.slice(-4):"";cleanCard.token=curCard.token?curCard.token:"";cleanCard.AccountNumberIndicator=curCard.AccountNumberIndicator?curCard.AccountNumberIndicator:"";cleanCard.cardType=curCard.cardType?curCard.cardType:"";if(angular.isObject(curCard.paymentType)){cleanCard.paymentType.label=curCard.paymentType.label?curCard.paymentType.label:"";cleanCard.paymentType.contractType=curCard.paymentType.contractType?curCard.paymentType.contractType:"";cleanCard.paymentType.authType=curCard.paymentType.authType?curCard.paymentType.authType:"";cleanCard.paymentType.msrType=curCard.paymentType.msrType?curCard.paymentType.msrType:"";}
cleanPaymentHttp.CardDetailInCart.push(cleanCard);}}
return cleanPaymentHttp;};var _previousAuth={isAuthSuccess:false,authOrderTotal:"",previousTenders:[],previousOrderNo:""};var clearPreviousAuthCache=function()
{_previousAuth.isAuthSuccess=false;_previousAuth.authOrderTotal="";_previousAuth.previousTenders=[];_previousAuth.previousOrderNo="";};var _isAlreadyAuthed=function(cart,authRequest)
{if(_previousAuth.isAuthSuccess&&_previousAuth.previousOrderNo===cart._OrderNo&&_previousAuth.authOrderTotal===cart._OrderTotal){if(_previousAuth.previousTenders.length===authRequest.CreditAuthRequest.TenderList.length)
{for(var i=0;i<_previousAuth.previousTenders.length;i++)
{var prevToken=_previousAuth.previousTenders[i]._Token;var prevAmount=_previousAuth.previousTenders[i]._Amount;var reqToken=null;var reqAmount=null;for(var p=0;p<authRequest.CreditAuthRequest.TenderList.length;p++)
{if(authRequest.CreditAuthRequest.TenderList[p]._Token===prevToken)
{reqToken=authRequest.CreditAuthRequest.TenderList[p]._Token;reqAmount=authRequest.CreditAuthRequest.TenderList[p]._Amount;break;}}
if(reqToken===null||prevToken!==reqToken||prevAmount!==reqAmount)
{return false;}}
return true;}}
return false;};var authRequest=function(cart,cards){var defer=$q.defer();if(cards&&cards.length==0){defer.reject();return defer.promise;}
function createCardContract(card){if(card&&angular.isString(card.name)){card.name=card.name.replace(/[\u0000-\u001F]/g,"");}
var tenderContract={};if(card.cardType=='GIFTCARD'){tenderContract._TenderType=giftCard.authType;tenderContract._Token=card.token.toString();tenderContract._TokenType=card.AccountNumberIndicator.toString();tenderContract._ExpirationDate=getExpDateAuth();tenderContract._PIN=card.giftCardPin.toString();tenderContract._Amount=card.chargeAmount.toString();}else if(card.cardType=='PLCC'){tenderContract._TenderType=card.paymentType.authType;tenderContract._Token=card.token.toString();tenderContract._TokenType=card.AccountNumberIndicator.toString();tenderContract._ExpirationDate=createExpDateFormatForCCAuth(card.exp)
tenderContract._Name=card.name;tenderContract._Amount=card.chargeAmount.toString();}else{tenderContract._TenderType=card.paymentType.authType;tenderContract._Token=card.token.toString();tenderContract._TokenType=card.AccountNumberIndicator.toString();tenderContract._ExpirationDate=createExpDateFormatForCCAuth(card.exp)
tenderContract._Name=card.name;if(card.cid&&(card.cid.toString().trim().length>0)){tenderContract._PIN=card.cid;}
tenderContract._Amount=card.chargeAmount.toString();}
return tenderContract;}
var authRequestContract={"CreditAuthRequest":{"_OriginStoreNum":"0","_SourceApplication":"LUFI","_ProvideAddressFlag":"N","_OrderNo":"","TenderList":[],"OrderLines":[],"BillTo":{"_FirstName":"","_LastName":"","_AddressLine1":"","_AddressLine2":"","_City":"","_State":"","_ZipCode":"","_Country":"","_EmailAddress":""}}};var copyAuthAddress=function(source,destination){destination._FirstName=source._FirstName?angular.copy(source._FirstName):"";destination._LastName=source._LastName?angular.copy(source._LastName):"";destination._AddressLine1=source._AddressLine1?angular.copy(source._AddressLine1):"";destination._AddressLine2=source._AddressLine2?angular.copy(source._AddressLine2):"";destination._City=source._City?angular.copy(source._City):"";destination._State=source._State?angular.copy(source._State):"";destination._ZipCode=source._ZipCode?angular.copy(source._ZipCode):"";destination._Country=source._Country?angular.copy(source._Country):"";destination._EmailAddress=source._EMailID?angular.copy(source._EMailID):"";};authRequestContract.CreditAuthRequest._OriginStoreNum=$POSService.getPOSParameters().storeNumber;authRequestContract.CreditAuthRequest._OrderNo=angular.copy(cart._OrderNo);copyAuthAddress(cart.PersonInfoBillTo,authRequestContract.CreditAuthRequest.BillTo);var TenderList=[];cards.forEach(function(card){if(card.chargeAmount>0){TenderList.push(createCardContract(card));if(cards.length>1&&card.cardType=='GIFTCARD'){TenderList.push(TenderList.shift());}}});authRequestContract.CreditAuthRequest.TenderList=TenderList;for(var i=0;i<cart.OrderLines.OrderLine.length;i++)
{var currentLine=cart.OrderLines.OrderLine[i];var tempOrderLine={"_ItemID":"","_UPC":"","_Quantity":"0","_UnitPrice":"0.00","_ItemName":"","ShipTo":{"_FirstName":"","_LastName":"","_AddressLine1":"","_AddressLine2":"","_City":"","_State":"","_ZipCode":"","_Country":"","_EmailAddress":""}};tempOrderLine._ItemID=currentLine.Item._ItemID?angular.copy(currentLine.Item._ItemID):"";tempOrderLine._UPC=currentLine.Item._UPCCode?angular.copy(currentLine.Item._UPCCode):"";tempOrderLine._Quantity=currentLine._OrderedQty?angular.copy(currentLine._OrderedQty):"";tempOrderLine._UnitPrice=currentLine.LinePriceInfo._UnitPrice?angular.copy(currentLine.LinePriceInfo._UnitPrice):"";tempOrderLine._ItemName=currentLine.btDisplay.defaultItemDescription?angular.copy(currentLine.btDisplay.defaultItemDescription):"";copyAuthAddress(currentLine.PersonInfoShipTo,tempOrderLine.ShipTo);authRequestContract.CreditAuthRequest.OrderLines.push(tempOrderLine);}
if(_isAlreadyAuthed(cart,authRequestContract))
{defer.resolve();return defer.promise;}
var url=serviceURL+"/CreditService/AuthRequest";$http.post(url,authRequestContract).then(function(HttpResponse){try{var authFailed=false;var failureReason="";var isUnknownAuthResponse=false;var response=angular.fromJson(HttpResponse.data);var tenderList=null;if(angular.isDefined(response.CreditAuthResponse)&&angular.isDefined(response.CreditAuthResponse.TenderList)){tenderList=response.CreditAuthResponse.TenderList;}
if(tenderList===null||tenderList.Item===undefined||tenderList===null){authFailed=true;failureReason+="Payment Auth returned no tenderList or no tenderList.Item ";}else{if(!angular.isArray(tenderList.Item)){tenderList=[tenderList.Item];}else{tenderList=tenderList.Item;}
for(var i=0;i<cards.length;i++){var card=cards[i];if(card.chargeAmount>0){for(var j=0;j<tenderList.length;j++){var cardReturned=tenderList[j];if(Number(cardReturned._Token)==Number(card.token)){card.authInfo=cardReturned;break;}}}}
for(var i=0;i<cards.length;i++){var card=cards[i];if(card.chargeAmount>0){if(!angular.isObject(card.authInfo)||!angular.isString(card.authInfo._DetailAuthorizationResult)){authFailed=true;failureReason+="Card has no authInfo. ";}else if(card.authInfo._DetailAuthorizationResult!='Approve'){authFailed=true;failureReason+="Card has DetailAuthorizationResult != Approve. ";if((/Unknown/i).test(card.authInfo._DetailAuthorizationResult)){isUnknownAuthResponse=true;}}}}}
if(authFailed){swal({title:"Alert!",text:$alertMessages.paymentMessages.ACC_NOT_AUTHORIZED,showConfirmButton:true});if(isUnknownAuthResponse){$sendSMTPErrorEmail("One or more cards have failed auth.",$alertMessages.paymentMessages.FAILURE_ON_AUTH,pciCleanInfo(HttpResponse,cards),failureReason);}
defer.reject();}else{_previousAuth.isAuthSuccess=true;_previousAuth.authOrderTotal=angular.copy(cart._OrderTotal);_previousAuth.previousOrderNo=angular.copy(cart._OrderNo);_previousAuth.previousTenders=[];for(var r=0;r<tenderList.length;r++)
{_previousAuth.previousTenders.push({_Token:""+tenderList[r]._Token,_Amount:""+tenderList[r]._AmountAuthorized});}
delete cart.PaymentMethods;cart.PaymentMethods={PaymentMethod:createOrderPaymentContract(cards)};cart.CreditAuthResponse={"_AuthorizationResult":"","_MasterErrorDetailLocation":"","_MasterResultAltReasonCode":"","_MasterResultCode":"","_MasterResultReasonCode":"","_MasterResultReasonText":"","_MasterResultText":""};if(angular.isDefined(response.CreditAuthResponse)){cart.CreditAuthResponse._AuthorizationResult=response.CreditAuthResponse._AuthorizationResult?angular.copy(response.CreditAuthResponse._AuthorizationResult):"";cart.CreditAuthResponse._MasterErrorDetailLocation=response.CreditAuthResponse._MasterErrorDetailLocation?angular.copy(response.CreditAuthResponse._MasterErrorDetailLocation):"";cart.CreditAuthResponse._MasterResultAltReasonCode=response.CreditAuthResponse._MasterResultAltReasonCode?angular.copy(response.CreditAuthResponse._MasterResultAltReasonCode):"";cart.CreditAuthResponse._MasterResultCode=response.CreditAuthResponse._MasterResultCode?angular.copy(response.CreditAuthResponse._MasterResultCode):"";cart.CreditAuthResponse._MasterResultReasonCode=response.CreditAuthResponse._MasterResultReasonCode?angular.copy(response.CreditAuthResponse._MasterResultReasonCode):"";cart.CreditAuthResponse._MasterResultReasonText=response.CreditAuthResponse._MasterResultReasonText?angular.copy(response.CreditAuthResponse._MasterResultReasonText):"";cart.CreditAuthResponse._MasterResultText=response.CreditAuthResponse._MasterResultText?angular.copy(response.CreditAuthResponse._MasterResultText):"";}
defer.resolve();}}catch(exception){swal({title:"Alert!",text:$alertMessages.paymentMessages.FAILURE_DURING_ORDER_CREATE,showConfirmButton:true});$sendSMTPErrorEmail(angular.toJson(exception),$alertMessages.paymentMessages.FAILURE_DURING_ORDER_CREATE);defer.reject();}},function(response){var errorText='';if(angular.isString(response.data)){errorText=response.data;}else{errorText=angular.toJson(response.data);}
swal({title:"Authorization Error",text:errorText,showConfirmButton:true});defer.reject();});return defer.promise;};var tokenize=function(cardNumber,contractType,success,error){if(cardNumber&&contractType){var tokenizationContract={"TokenizationRequest":[{"_data":cardNumber,"_type":contractType}]};$http.post(tokenizeURL,tokenizationContract).success(function(data){var response=angular.fromJson(data);if(response.TokenizationResponse.Item._ReturnCode=='0')
success(response.TokenizationResponse.Item);else
error("Can't Create Token:"+response);}).error(function(data){$sendSMTPErrorEmail(data,tokenizeURL);error(data);});}}
var gcBalance=function(token,pin,success,error){var contract={"EGCBalanceReq":{"_OriginStoreNum":$POSService.getPOSParameters().storeNumber,"_FulfillmentStoreNum":$POSService.getPOSParameters().storeNumber,"_SourceApplication":"Sterling","GCList":[{"_Token":token,"_PIN":pin}]}};var url=serviceURL+"/CreditService/GCBalance";$http.post(url,contract).success(function(data){var response=angular.fromJson(data);success(angular.fromJson(response));}).error(function(data){$sendSMTPErrorEmail(data,url);error(data);});}
var cache=$cacheFactory('payments');var setPaymentData=function(paymentData){cache.put('paymentData',paymentData);}
var getPaymentData=function(){return cache.get('paymentData');}
var clearPaymentData=function(){cache.remove('paymentData');}
var setCreateOrderPaymentContract=function(card){if(card&&angular.isString(card.name)){card.name=card.name.replace(/[\u0000-\u001F]/g,"");}
if(card.cardType=='GIFTCARD'){card.exp=getExpDateCC();var contract={"_BillToKey":"","_ChargeSequence":"1","_CreditCardExpDate":createExpDateFormatForCC(card.exp),"_CreditCardName":"","_CreditCardNo":card.cardNumber.replace(/\*/g,''),"_CreditCardType":"GC","_DisplayCreditCardNo":card.cardNumber.replace(/\*/g,''),"_MaxChargeLimit":card.chargeAmount,"_PaymentReference1":(card.authInfo&&card.authInfo._ReferenceNum)?card.authInfo._ReferenceNum:"","_PaymentReference2":card.giftCardPin,"_PaymentReference3":card.AccountNumberIndicator.toString(),"_PaymentType":"GC","_SvcNo":card.token,"_UnlimitedCharges":"N","PaymentDetails":{"_AuthAvs":"","_AuthCode":"","_AuthorizationExpirationDate":"","_AuthorizationID":"","_AuthReturnCode":"APPROVED","_AuthReturnFlag":"Y","_AuthReturnMessage":(card.authInfo&&card.authInfo._ReferenceNum)?card.authInfo._ReferenceNum:"","_AuthTime":"","_ChargeType":"AUTHORIZATION","_InternalReturnCode":"","_InternalReturnFlag":"","_InternalReturnMessage":"","_ProcessedAmount":card.chargeAmount,"_Reference1":card.authInfo?card.authInfo._ReferenceNum:'',"_Reference2":card.giftCardPin,"_RequestAmount":card.chargeAmount,"_RequestId":"","_RequestProcessed":"Y","_TranReturnCode":"APPROVED","_TranReturnFlag":"SUCCESS","_TranReturnMessage":"","_TranType":"AUTHORIZATION"}}
card.createOrderContract=contract;}else{var contract={"_BillToKey":"","_ChargeSequence":"1","_CreditCardExpDate":createExpDateFormatForCC(card.exp),"_CreditCardName":card.name,"_CreditCardNo":card.token,"_CreditCardType":card.cardType,"_DisplayCreditCardNo":card.cardNumber.replace(/\*/g,''),"_FirstName":"","_LastName":"","_MiddleName":"","_PaymentType":"CREDIT_CARD","_UnlimitedCharges":"Y","_PaymentReference3":card.AccountNumberIndicator.toString(),"PaymentDetails":{"_AuthAvs":"","_AuthCode":card.authInfo?card.authInfo._AuthorizationCode:'',"_AuthorizationID":card.authInfo?card.authInfo._AuthorizationCode:'',"_AuthorizationExpirationDate":"","_AuthReturnCode":"APPROVED","_AuthReturnFlag":"Y","_AuthReturnMessage":(card.authInfo&&card.authInfo._ReferenceNum)?card.authInfo._ReferenceNum:"","_AuthTime":"","_ChargeType":"AUTHORIZATION","_InternalReturnCode":"","_InternalReturnFlag":"","_InternalReturnMessage":"","_ProcessedAmount":card.chargeAmount,"_Reference1":"","_Reference2":"","_RequestAmount":card.chargeAmount,"_RequestId":(card.authInfo&&card.authInfo._ReferenceNum)?card.authInfo._ReferenceNum:"","_RequestProcessed":"Y","_TranReturnCode":"APPROVED","_TranReturnFlag":"SUCCESS","_TranReturnMessage":"","_TranType":"AUTHORIZATION"}}
card.createOrderContract=contract;}}
var createOrderPaymentContract=function(cards){var PaymentMethod=[];cards.forEach(setCreateOrderPaymentContract);cards.forEach(function(card){PaymentMethod.push(card.createOrderContract);})
return PaymentMethod;}
var setRepriceCardContract=function(card){card.rePriceContract={_CreditCardNo:card.token,_CreditCardType:card.cardType=='PLCC'?'BS':card.cardType,_PaymentType:card.cardType=='GIFTCARD'?'GC':'CREDIT_CARD',}}
var createRepricePaymentContract=function(cards){var PaymentMethod=[];cards.forEach(setRepriceCardContract);cards.forEach(function(card){if(card.cardType!='GIFTCARD')
PaymentMethod.push(card.rePriceContract);})
return PaymentMethod;}
var getAvailablePaymentTypes=function(paymentData,isPaymentForCsr){var types=[paymentTypes.GIFTCARD,paymentTypes.CREDITCARD,paymentTypes.PLCC];if(isPaymentForCsr===true||(paymentData.accNumber&&paymentData.accNumber.length>0)){types.splice(1,2);}
if(paymentData.cards.length>0){var gcCount=0;angular.forEach(paymentData.cards,function(card){if(card.paymentType.authType==paymentTypes.PLCC.authType||card.paymentType.authType==paymentTypes.CREDITCARD.authType){types.splice(1,2);}else if(card.paymentType.authType==paymentTypes.GIFTCARD.authType){gcCount++;}});if(gcCount>=4){types.splice(0,1);}}
return types;}
var canAddCreditCardOrPlcc=function(paymentData){var availablePayments=getAvailablePaymentTypes(paymentData);if(angular.isArray(availablePayments)){for(var i=0;i<availablePayments.length;i++){if((availablePayments[i]==paymentTypes.CREDITCARD)||(availablePayments[i]==paymentTypes.PLCC)){return true;}}}
return false;};var canAddGiftcard=function(paymentData){var availablePayments=getAvailablePaymentTypes(paymentData);if(angular.isArray(availablePayments)){for(var i=0;i<availablePayments.length;i++){if(availablePayments[i]==paymentTypes.GIFTCARD){return true;}}}
return false;};var getInContactPaymentId=function(){var url=httpsServiceURL+"/OrderProcess/ConfirmOrder?Action=getPCRN";return $http.get(url).then(function(response){return response;},function(response){$sendSMTPErrorEmail("InContact Payment ID generation failed.",url,response);$q.reject(response);});;};var getInContactPayment=function(paymentId){if(paymentId===null||paymentId===undefined){$q.reject('No paymentId');}else{var url=httpsServiceURL+"/OrderProcess/ConfirmOrder?Action=getTender&PCRN="+paymentId;return $http.get(url).then(function(response){return response;},function(response){$sendSMTPErrorEmail("InContact Payment Call failed.",url,response);$q.reject(response);});}};$rootScope.$on('orderCartDeleted',function(event,paymentData){clearPaymentData();});$rootScope.$on('selectedCustomerCleared',function(event,paymentData){clearPaymentData();});return{tokenize:tokenize,gcBalance:gcBalance,paymentTypes:paymentTypes,authRequest:authRequest,clearPreviousAuthCache:clearPreviousAuthCache,setPaymentData:setPaymentData,getPaymentData:getPaymentData,clearPaymentData:clearPaymentData,cardTypes:cardTypes,createRepricePaymentContract:createRepricePaymentContract,createOrderPaymentContract:createOrderPaymentContract,getAvailablePaymentTypes:getAvailablePaymentTypes,canAddGiftcard:canAddGiftcard,canAddCreditCardOrPlcc:canAddCreditCardOrPlcc,testBankCardType:testBankCardType,translateCardType:translateCardType,getInContactPaymentId:getInContactPaymentId,getInContactPayment:getInContactPayment};}]);
﻿var appServices=angular.module('appUtilities',[]);appServices.service('numberKeyPressValidator',[function(){return function(keyEvent){var theEvent=keyEvent||window.event;var key=theEvent.keyCode||theEvent.which;if(key==13){return;}
key=String.fromCharCode(key);var regex=/[0-9]|\./;if(!regex.test(key)){theEvent.returnValue=false;if(theEvent.preventDefault)theEvent.preventDefault();}}}]);appServices.service('numberOnlyKeyPressValidator',[function(){return function(keyEvent){var theEvent=keyEvent||window.event;var key=theEvent.keyCode||theEvent.which;if(key==13){return;}
key=String.fromCharCode(key);var regex=/[0-9]/;if(!regex.test(key)){theEvent.returnValue=false;if(theEvent.preventDefault)theEvent.preventDefault();}}}]);appServices.service('customerKeyPressValidator',[function(){return function(keyEvent){var theEvent=keyEvent||window.event;var key=theEvent.keyCode||theEvent.which;if(key==13){return;}
key=String.fromCharCode(key);if(key=='&'){theEvent.returnValue=false;if(theEvent.preventDefault){theEvent.preventDefault();}
swal({title:"Input Error",text:"Ampersand (&) is not allowed in this field.",showConfirmButton:true});}}}]);appServices.service('currencyKeyPressValidator',[function(){return function(keyEvent,curValue){var theEvent=keyEvent||window.event;var key=theEvent.keyCode||theEvent.which;if(key==13){return;}
key=String.fromCharCode(key);if(curValue.indexOf('.')!==-1){if(key=='.'){theEvent.returnValue=false;if(theEvent.preventDefault){theEvent.preventDefault();}}else{if(curValue.length-curValue.indexOf('.')==3){theEvent.returnValue=false;if(theEvent.preventDefault){theEvent.preventDefault();}}}}}}]);appServices.service('serviceArrayFixByCount',[function(){var fix=function(obj){if(angular.isObject(obj)){for(key in obj){if(Object.keys(obj).length==2&&key.indexOf("Count")>1){for(tempKey in obj){if(tempKey!=key&&!angular.isArray(obj[tempKey])){obj[tempKey]=[obj[tempKey]];}}}
fix(obj[key]);}}}
return fix;}]);appServices.service('serviceArrayFix',[function(){var fix=function(obj){if(angular.isObject(obj)){if(obj.hasOwnProperty('_IsArray')&&obj['_IsArray'].toString().trim().toLowerCase()==="true"){delete obj['_IsArray'];for(key in obj){if(!angular.isArray(obj[key])){obj[key]=[obj[key]];}
fix(obj[key]);}}else{for(key in obj){fix(obj[key]);}}}}
return fix;}]);appServices.factory('POSService',['$cacheFactory','$rootScope','$q',function($cacheFactory,$rootScope,$q){var cache=$cacheFactory('POS');var previousParams={};var setPOSTParametersFromURL=function(locationURL){var associateId=getParameterByName('AssociateId',locationURL);var storeNumber=getParameterByName('StoreNumber',locationURL);var terminalNumber=getParameterByName('TerminalNumber',locationURL);var ldapId=getParameterByName('LdapId',locationURL);var ldapPassword=getParameterByName('LdapPassword',locationURL);if(storeNumber.length<3){storeNumber="000"+storeNumber;storeNumber=storeNumber.slice(-3);}
var parameters={associateId:associateId,storeNumber:storeNumber,terminalNumber:terminalNumber,ldapId:ldapId,ldapPassword:ldapPassword}
cache.put('parameters',parameters);}
var setPOSTParameters=function(associateId,storeNumber,terminalNumber,roles){var oldParms=cache.get('parameters');if(!oldParms){oldParms={associateId:'',storeNumber:'',terminalNumber:''};}
if(roles&&Object.keys(roles).length>0){previousParams=oldParms;}
var parameters={associateId:associateId?associateId.toString().trim():oldParms.associateId,storeNumber:storeNumber?storeNumber.toString().trim():oldParms.storeNumber,terminalNumber:terminalNumber?terminalNumber.toString().trim():oldParms.terminalNumber,roles:roles};if(parameters.storeNumber.length<3){parameters.storeNumber="000"+parameters.storeNumber;parameters.storeNumber=parameters.storeNumber.slice(-3);}
if((/^\d{1,5}$/).test(parameters.associateId)){parameters.associateId="000000"+parameters.associateId;parameters.associateId=parameters.associateId.slice(-6);}
cache.put('parameters',parameters);$rootScope.$broadcast('POSParmsSet',angular.copy(parameters));}
var managerLogout=function(){cache.put('parameters',previousParams);}
var getParameterByName=function(name,locationURL){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var regex=new RegExp("[\\?&]"+name+"=([^&#]*)"),results=regex.exec(locationURL);return results===null?"":decodeURIComponent(results[1].replace(/\+/g," "));}
var getPmmConfigAndStatus=function(refresh){refresh=refresh?true:false;var defer=$q.defer();var message=cache.get('configAndStatus');if(refresh===true||message===undefined){requestPmmConfig(defer);}else{defer.resolve(message);}
return defer.promise;};var arrayOfDefers=[];var deregister=$rootScope.$on('Config_Event',function(event,data){cache.put('configAndStatus',data);for(var i=0;i<arrayOfDefers.length;i++){arrayOfDefers[i].resolve(data);}
arrayOfDefers.length=0;});var deregisterError=$rootScope.$on('Config_Error',function(event,data){for(var i=0;i<arrayOfDefers.length;i++){arrayOfDefers[i].reject({Error:data,ErrorText:'Error reading Config from Websocket.'});}
arrayOfDefers.length=0;});var deregisterErrorOnWS=$rootScope.$on('WS_Config_Request_Error',function(event,data){for(var i=0;i<arrayOfDefers.length;i++){arrayOfDefers[i].reject({Error:data,ErrorText:'Error reading Config from Websocket.'});}
arrayOfDefers.length=0;});var getEnvironment=function(){var environmentString="";if((/internal.bonton.com/).test(window.location.hostname)){environmentString="PROD";}else{environmentString="QA";}
return environmentString;};var requestPmmConfig=function(defer){arrayOfDefers.push(defer);$rootScope.$broadcast('WS_Get_Config');};getPmmConfigAndStatus();return{setPOSTParametersFromURL:setPOSTParametersFromURL,setPOSTParameters:setPOSTParameters,managerLogout:managerLogout,getPOSParameters:function(){return cache.get('parameters')},getPmmConfigAndStatus:getPmmConfigAndStatus,getEnvironment:getEnvironment};}]);appServices.factory('authenticateUser',['$http',function($http){return function(userName,password){var contract={Authreq:{uid:userName,pwd:password}};return $http.post(authURL,angular.toJson(contract));}}]);appServices.factory('errorObj',function(){return{newError:function(name,message,details,code,level){var obj={};obj.name=name.toString();obj.message=message.toString();obj.details=details.toString();obj.code=code;if(level){obj.level=level;}else{obj.level='WARN';}
return obj;}};});appServices.factory('loggerService',['POSLogSocketService','$log',function($POSLogSocketService,$log){var _warn=function(message){$log.warn(message);};var _log=function(message){$log.info(message);};var _error=function(message){$log.error(message);$POSLogSocketService.logToPOS(message);};var _posLog=function(message){$POSLogSocketService.logToPOS(message);};var logFunctions={warn:_warn,log:_log,error:_error,posLog:_posLog};return logFunctions;}]);appServices.service('isPoBoxAddress',[function(){return function(personInfoAddress){if(angular.isObject(personInfoAddress)&&'_AddressLine1'in personInfoAddress){var PO_REG_EX=[/(?:p(?:ost)?)[ .\W_]*(?:o(?:ffice)?)[ .\W_]*b(?:ox)?([ 0-9]+[ a-z]*)*$/,/^(?:po|pob|pobox|pbox|box)(?:[ 0-9]+)/];var testString='';if('_AddressLine1'in personInfoAddress&&personInfoAddress._AddressLine1.toString().trim().length>0){testString=personInfoAddress._AddressLine1.toString().trim().toLowerCase();for(var i=0;i<PO_REG_EX.length;i++){if(PO_REG_EX[i].test(testString)){return true;}}}else{return null;}
if('_AddressLine2'in personInfoAddress&&personInfoAddress._AddressLine2.toString().trim().length>0){testString=personInfoAddress._AddressLine2.toString().trim().toLowerCase();for(var i=0;i<PO_REG_EX.length;i++){if(PO_REG_EX[i].test(testString)){return true;}}}
if('_AddressLine3'in personInfoAddress&&personInfoAddress._AddressLine3.toString().trim().length>0){testString=personInfoAddress._AddressLine3.toString().trim().toLowerCase();for(var i=0;i<PO_REG_EX.length;i++){if(PO_REG_EX[i].test(testString)){return true;}}}
return false;}else{return null;}}}]);appServices.factory('sendSMTPErrorEmail',['$http','POSService',function($http,$POSService){var url=serviceURL+"/Email/SendSMTPEmail";return function(data,failedServiceURL,httpInputObj,headerString,additionalEmailRecipients){var terminalNumber="";if(angular.isDefined($POSService.getPOSParameters().terminalNumber)&&$POSService.getPOSParameters().terminalNumber!=null){terminalNumber=$POSService.getPOSParameters().terminalNumber;}
var storeNumber="";if(angular.isDefined($POSService.getPOSParameters().storeNumber)&&$POSService.getPOSParameters().storeNumber!=null){storeNumber=$POSService.getPOSParameters().storeNumber}
var subjectLocation="";if(angular.isDefined(storeNumber)&&null!=storeNumber&&storeNumber.length>0){subjectLocation=" in the Store "+storeNumber;}
if(angular.isDefined(terminalNumber)&&null!=terminalNumber&&terminalNumber.length>0){subjectLocation=subjectLocation+" and terminal "+terminalNumber;}
var subject="LUFI-2 "+$POSService.getEnvironment()+" Failed while executing "+failedServiceURL+subjectLocation;var errorMessage="";var exceptionList="";if(angular.isDefined(data)&&(data!==null)&&angular.isDefined(data.Error)){errorMessage=data.Error.Message;exceptionList=data.Error.ExceptionList;}else{if(angular.isString(data)){errorMessage=data;exceptionList="";}else{errorMessage=angular.toJson(data,2);exceptionList="";}}
var inputData='';if(angular.isDefined(httpInputObj)&&(httpInputObj!==null)){if(angular.isString(httpInputObj)){inputData=httpInputObj;}else{inputData=angular.toJson(httpInputObj,2);}}
var headerText='';if(angular.isDefined(headerString)&&(headerString!==null)){if(angular.isString(headerString)){headerText=headerString;}else{headerText=angular.toJson(headerString);}}
var bodyText=" Error Message = "+errorMessage+"\n \n Exception List = "+exceptionList;if(inputData){bodyText=" Http Input Data = "+inputData+"\n \n"+bodyText;}
if(headerText){bodyText=headerText+"\n \n"+bodyText;}
bodyText="Reported on "+(new Date()).toString()+"\n \n"+bodyText;var recipientsString="OMSTeam@bonton.com";if(angular.isDefined(additionalEmailRecipients)&&(additionalEmailRecipients!==null)){if(angular.isString(additionalEmailRecipients)){recipientsString=recipientsString+";"+additionalEmailRecipients;}else if(angular.isArray(additionalEmailRecipients)){recipientsString=recipientsString+";"+additionalEmailRecipients.join(';');}}
var contract={Email:{To:recipientsString,From:"DoNotReply@bonton.com",Subject:subject,Body:bodyText}};$http.post(url,angular.toJson(contract));}}]);appServices.factory('sendPmmErrorEmail',['sendSMTPErrorEmail','POSService',function(sendSMTPErrorEmail,POSService){return function(data,emailSubject,jsonData){var envirParams=POSService.getPOSParameters();if(angular.isObject(envirParams)){if(angular.isString(envirParams.terminalNumber)&&(envirParams.terminalNumber.length>0)){sendSMTPErrorEmail(data,emailSubject,jsonData);}}}}]);appServices.factory('alertMessages',[function(){var messages={paymentMessages:{ACC_NOT_AUTHORIZED:"** This account could not be authorized. Please ask the customer for another form of tender. **",FAILURE_DURING_ORDER_CREATE:"Error occurred during payment Authorization and order creation.",FAILURE_ON_AUTH:"Authorization Returned Failed",MAX_ALLOWED_CC:"Max Allowed Credit/PLCC Cards 1",MAX_GC:"You can enter up to four gift cards.",CC_NOT_ALLOWED_WITH_ADC:"CC OR PLCC is not allowed for Associate Discount Card accounts.",NEGATIVE_AMOUNT_NOT_ALLOWED:"Entering Negative Amount is not allowed",REPRICE_ERROR:"Reprice Error",ADC_NOT_ALLOWED_WITH_CC:"Associate Discount Card is not allowed with Credit Cards.",INVALID_CARD_TYPE:"Invalid Card Type!",UNKNOWN_CARD_TYPE:"Unknown Card Type. Please ask customer for a different form of payment.",TOKENIZATION_ERROR:"Tokenization Error",GC_PIN_ERROR:"Gift Card pin validation error",GC_ALERT:"GC Alert!",GC_BALANCE_ERROR:"GC Balance Error",CARD_ERROR:"Card Error",SCAN_ERROR:"Scan Error",CC_DECLINED:"Credit Card was declined.",BANK_CARD_SYSTEM_OFFLINE_TITLE:"Bank Card System Offline",BANK_CARD_SYSTEM_OFFLINE_MESSAGE:"Please ask customer for a different form of tender to proceed with this order.",MSR_NOT_FUNCTIONAL:"MSR is currently busy.  Please select tender again.",INVALID_TEMP_PLCC_BARCODE:"The barcode scanned is invalid.",INVALID_TEMP_PLCC_EXPIRED:"The temporary charge card has expired.",INVALID_TEMP_PLCC_INVALID_STORE:"The temporary charge card was not issued at this store."}}
return messages;}]);appServices.service('loadingIconService',[function(){this.isLockedBusyIcon=false;this.lockIcon=function(){this.isLockedBusyIcon=true;};this.showBusyIcon=function(){$('#loadDIV').show();};this.hideBusyIcon=function(){if(!this.isLockedBusyIcon){$('#loadDIV').hide();}};this.resetIcon=function(){this.isLockedBusyIcon=false;this.hideBusyIcon();};}]);appServices.factory('securityService',['POSService',function($POSService){function canCancelOrder(){var returnVar=false;var params=$POSService.getPOSParameters();if(params&&params.roles){returnVar=params.roles.MODIFY_ORDER=='True';}
return returnVar;};function isCsr(){var returnVar=false;var params=$POSService.getPOSParameters();if(params&&params.roles){if(angular.isString(params.roles.CREATE_ORDER_CALLCENTER)&&(/^true$/i).test(params.roles.CREATE_ORDER_CALLCENTER)){returnVar=true;}}
return returnVar;};return{canCancelOrder:canCancelOrder,isCsr:isCsr};}]);
﻿var appServices=angular.module('appServicesWebSocket',[]);appServices.factory('webSocketService',['$rootScope','$interval','$log','sendPmmErrorEmail','$timeout',function($rootScope,$interval,$log,sendPmmErrorEmail,$timeout){var webSocketCheckInterval=20000;var ws;var webSocketErrorCount=0;var reportInterval=15;var firstFailure=null;var isResponseFromPmmInfoCall=false;function initWebSocket(){if(angular.isUndefined(ws)||ws.readyState>1){ws=new WebSocket(POSURL);ws.onerror=function(event){webSocketErrorCount+=1;$log.error(event);if((webSocketErrorCount-reportInterval)==0){reportInterval=parseInt(reportInterval*1.5);if(firstFailure===null){firstFailure=new Date();}
var currentDate=new Date();sendPmmErrorEmail("WebSocket will not connect to PMM. Failed "+webSocketErrorCount+" times. \n \n   First failure at: \n      "+firstFailure.toString()+"\n \n   This failure at: \n      "+currentDate.toString(),"Websocket Connection with PMM");}}
ws.onopen=function(event){webSocketErrorCount=0;$rootScope.$broadcast('WS_Open_Event',event.eventData);requestPosConfig();};ws.close=function(event){$rootScope.$broadcast('WS_Close_Event',event.eventData);};ws.onmessage=function(event){var eventData=angular.fromJson(event.data);if(eventData.BarcodeData){$rootScope.$broadcast('Scanner_Event',eventData.BarcodeData,eventData);}else if(eventData.MessageType=='Response'&&eventData.Device=='MSR'&&eventData.ResponseType=='Data'){$rootScope.$broadcast('MSR_Event',eventData);$rootScope.$broadcast('MSR_Event_Disabled',eventData);}else if(eventData.MessageType=='Response'&&eventData.Device=='Scanner'&&eventData.ResponseType=='Success'&&(/^SCN_SCS_CLAIMED$/i).test(eventData.StatusCode)){$rootScope.$broadcast('Scanner_Event_Claim_Success',eventData);}else if(eventData.MessageType=='Response'&&eventData.Device=='Scanner'&&eventData.ResponseType=='Error'&&(/^SCN_ERR_CLAIMED$/i).test(eventData.StatusCode)){$rootScope.$broadcast('Scanner_Event_Error_Already_Claimed',eventData);}else if(eventData.MessageType=='Response'&&eventData.Device=='Scanner'&&eventData.ResponseType=='Error'&&(/^SCN_ERR_NOT_CLAIMED$/i).test(eventData.StatusCode)){$rootScope.$broadcast('Scanner_Event_Error_Not_Claimed',eventData);}else if(eventData.MessageType=='Response'&&eventData.Device=='Scanner'&&eventData.ResponseType=='Error'&&(/^(SCN_ERR_INVALID_BARCODE|SCN_ERR_EXPIRED|SCN_ERR_INVALID_STORE)$/i).test(eventData.StatusCode)){$rootScope.$broadcast('Scanner_Event_Error_Temp_PLCC_Error',eventData);}else if(eventData.MessageType=='Response'&&eventData.Device=='MSR'&&eventData.ResponseType=='Success'&&(/^MSR_SCS_CLAIMED$/i).test(eventData.StatusCode)){$rootScope.$broadcast('MSR_Event_Claim_Success',eventData);}else if(eventData.MessageType=='Response'&&eventData.Device=='MSR'&&eventData.ResponseType=='Error'&&(/^MSR_ERR_CLAIMED$/i).test(eventData.StatusCode)){$rootScope.$broadcast('MSR_Event_Error_Already_Claimed',eventData);}else if(eventData.MessageType=='Response'&&eventData.Device=='MSR'&&eventData.ResponseType=='Error'&&(/^MSR_ERR_NOT_CLAIMED$/i).test(eventData.StatusCode)){$rootScope.$broadcast('MSR_Event_Error_Not_Claimed',eventData);}else if(eventData.MessageType=='Response'&&eventData.Device=='MSR'&&eventData.ResponseType=='Error'){$rootScope.$broadcast('MSR_Event_Error',eventData);$rootScope.$broadcast('MSR_Event_Disabled',eventData);}else if(eventData.MessageType=='Response'&&eventData.Device=='MSR'&&eventData.ResponseType=='Success'&&((/^MSR_SCS_DISABLED$/i).test(eventData.StatusCode)||(/MSR successfully disabled/i).test(eventData.StatusText))){$rootScope.$broadcast('MSR_Event_Disabled',eventData);}else if(eventData.MessageType=='Response'&&eventData.Device=='MSR'&&eventData.ResponseType=='Success'&&((/^MSR_SCS_ENABLED$/i).test(eventData.StatusCode)||(/.*(MSR successfully enabled|payment terminal successfully enabled).*/i).test(eventData.StatusText))){$rootScope.$broadcast('MSR_Event_Enabled',eventData);}
else if(eventData.MessageType=='Response'&&eventData.Device=='Printer'&&eventData.ResponseType=='Error'){$rootScope.$broadcast('Printer_Error',eventData);if(!(/.*Printer\s*error:\s*\(114\).*/i).test(eventData.StatusText)){sendPmmErrorEmail("PMM Printer Error.","PMM Printing Error",eventData);}}else if(eventData.MessageType=='Response'&&eventData.Device=='Printer'&&eventData.ResponseType=='Data'&&(/^PRT_SCS_PRINTED$/i).test(eventData.StatusCode)){}else if(eventData.MessageType=='Response'&&eventData.Device=='Server'&&eventData.ResponseType=='Data'){isResponseFromPmmInfoCall=true;$rootScope.$broadcast('Config_Event',eventData);}else if(eventData.MessageType=='Response'&&eventData.Device=='Server'&&eventData.ResponseType=='Error'){$rootScope.$broadcast('Config_Error',eventData);}else if(eventData.MessageType=='Response'&&eventData.Device=='PaymentTerminal'&&eventData.ResponseType=='Error'){$rootScope.$broadcast('PaymentTerminal_Event_Error',eventData);}
else if(eventData.MessageType=='Response'&&eventData.Device=='PaymentTerminal'&&eventData.ResponseType=='Success'&&((/^PMT_SCS_SIGNATURE$/i).test(eventData.StatusCode)||(/.*Signature captured successfully.*/i).test(eventData.StatusText))){$rootScope.$broadcast('PMT_SCS_SIGNATURE',eventData);}else if(eventData.MessageType=='Response'&&eventData.Device=='PaymentTerminal'&&eventData.ResponseType=='Success'&&((/^PMT_SCS_ENABLED$/i).test(eventData.StatusCode)||(/.*The payment terminal was successfully enabled.*/i).test(eventData.StatusText))){$rootScope.$broadcast('PMT_SCS_ENABLED',eventData);}else if(eventData.MessageType=='Response'&&eventData.Device=='PaymentTerminal'&&eventData.ResponseType=='Success'&&((/^PMT_SCS_CLAIMED$/i).test(eventData.StatusCode)||(/.*The payment terminal was successfully claimed.*/i).test(eventData.StatusText))){$rootScope.$broadcast('PMT_SCS_CLAIMED',eventData);}};}}
var requestPosConfig=function(){try{$timeout(function(){if(!isResponseFromPmmInfoCall){$rootScope.$broadcast('Config_Error',{});sendPmmErrorEmail("PMM information / configuration call did not return within 45 seconds.","Websocket Connection PMM Config Call Error");}},45000);ws.send(angular.toJson({"MessageType":"Request","Device":"Server","Command":"Configure","Info":"true"}));}catch(e){$rootScope.$broadcast('WS_Config_Request_Error');}};$rootScope.$on('WS_Get_Config',requestPosConfig);initWebSocket();$interval(function(){initWebSocket();},webSocketCheckInterval);return{send:function(message){try{ws.send(message);}catch(ex){console.log("WebSocket Send error:"+ex);}},readyState:function(){var value=3;try{value=ws.readyState;}catch(e){value=3;}
return value;}};}]).factory('scannerService',['$rootScope','$interval','$log','itemSearch','$location','webSocketService','orderCart','itemDetail','errorObj','loggerService',function($rootScope,$interval,$log,$itemSearch,$location,ws,orderCart,$itemDetail,errorObj,$loggerService){var isClaimed=false;var claimIntervalPromise=null;$rootScope.$on('Scanner_Event_Claim_Success',function(event,data){isClaimed=true;if(claimIntervalPromise!==null){$interval.cancel(claimIntervalPromise);claimIntervalPromise=null;}
scannerFunctions.enableScanner();});$rootScope.$on('Scanner_Event_Error_Already_Claimed',function(event,data){isClaimed=true;if(claimIntervalPromise!==null){$interval.cancel(claimIntervalPromise);claimIntervalPromise=null;}});$rootScope.$on('Scanner_Event_Error_Not_Claimed',function(event,data){isClaimed=false;startIntervalClaim();});var claimScanner={"MessageType":"Request","Device":"Scanner","Command":"Claim"};var releaseScanner={"MessageType":"Request","Device":"Scanner","Command":"Release"};var enableScanner={"MessageType":"Request","Device":"Scanner","Command":"Enable"};var disableScanner={"MessageType":"Request","Device":"Scanner","Command":"Disable"};var stopServer={"MessageType":"Request","Device":"Server","Command":"Configure","Stop":"true",};$rootScope.$on('$stateChangeSuccess',function(event,toState,toParams,fromState,fromParams){var controllers=['indexCtrl','homeCtrl','itemSearchCtrl','orderCartCtrl','paymentSummaryCtrl','couponCtrl','orderSearchCtrl','pickUpInStoreCtrl','packConfirmCtrl'];scannerEventUnregisterWrapper();try{scannerFunctions.disableScanner();if(toState.views!=null&&controllers.indexOf(toState.views['main@'].controller)!=-1){setEventHandlers(toState.views['main@'].controller);scannerFunctions.enableScanner();}}catch(err){$loggerService.log(err);}});var eventHandlersByController={'orderCartCtrl':{scannerEventHandler:function(event,upc,isBigTicketValidated){$itemSearch.searchUPC(upc,function(response){if(response.ngroups==0){jQuery('.not-found-alert').modal('show');}else if(response.isnGroup.length==1){var temp=[];for(var i=0;i<response.isnGroup[0].productList.length;i++){if(parseInt(response.isnGroup[0].productList[i].id)==parseInt(upc)){temp.push(angular.copy(response.isnGroup[0].productList[i]));break;}}
response.isnGroup[0].productList=temp;if(temp.length>0){$itemDetail(response.isnGroup[0],function(isnGroup){try{orderCart.orderLine.addOrderLine(isnGroup.productList[0],1,isBigTicketValidated);$rootScope.$broadcast('scannerAddUpcClearInput');}catch(error){error.itemObject=isnGroup.productList[0];$rootScope.$broadcast('scannerAddUpcClearInput');$rootScope.$broadcast('scannerAddUpcError',error);}});}else{$rootScope.$broadcast('scannerAddUpcError',errorObj.newError('Item Not Found',"UPC: "+upc+" could not be found.","UPC: "+upc+" could not be found.",'','WARN'));}}else{$location.path("/itemResults");}},function(err){alert(err);});}}};var scannerEventUnregisterWrapper=function(){scannerEventUnregister();scannerEventUnregister=function(){};};var currentScannerEventHandler=function(){};var scannerEventUnregister=function(){};var setEventHandlers=function(controllerName){if(angular.isDefined(eventHandlersByController[controllerName])){if(angular.isFunction(eventHandlersByController[controllerName].scannerEventHandler)){currentScannerEventHandler=eventHandlersByController[controllerName].scannerEventHandler;scannerEventUnregister=$rootScope.$on('Scanner_Event',currentScannerEventHandler);}}};$rootScope.$on('WS_Open_Event',function(event){scannerFunctions.claimScanner();scannerFunctions.enableScanner();});$rootScope.$on('WS_Close_Event',function(event){scannerFunctions.releaseScanner();});var scannerFunctions={claimScanner:function(){try{ws.send(angular.toJson(claimScanner));}catch(err){$log.error(err.message);}},releaseScanner:function(){try{ws.send(angular.toJson(releaseScanner));}catch(err){$log.error(err.message);}},enableScanner:function(){try{ws.send(angular.toJson(enableScanner));}catch(err){$log.error(err.message);}},disableScanner:function(){try{ws.send(angular.toJson(disableScanner));}catch(err){$log.error(err.message);}},stopServer:function(){try{ws.send(angular.toJson(stopServer));ws.close();}catch(err){$log.error(err.message);}}}
var startIntervalClaim=function(){if(claimIntervalPromise!==null){$interval.cancel(claimIntervalPromise);claimIntervalPromise=null;}
claimIntervalPromise=$interval(function(){if(ws.readyState()==1){scannerFunctions.claimScanner();}},10000,20);};startIntervalClaim();return scannerFunctions;}]).factory('msrService',['$rootScope','$interval','$log','$location','webSocketService','$q','$timeout',function($rootScope,$interval,$log,$location,ws,$q,$timeout){var isEnabled=false;var lastEnableDisableDateTime=new Date();var isClaimed=false;var claimIntervalPromise=null;var timeoutEnablePromise=null;var timeoutDisablePromise=null;$rootScope.$on('MSR_Event_Claim_Success',function(event,data){isClaimed=true;if(claimIntervalPromise!==null){$interval.cancel(claimIntervalPromise);claimIntervalPromise=null;}});$rootScope.$on('MSR_Event_Error_Already_Claimed',function(event,data){isClaimed=true;if(claimIntervalPromise!==null){$interval.cancel(claimIntervalPromise);claimIntervalPromise=null;}});$rootScope.$on('MSR_Event_Error_Not_Claimed',function(event,data){isClaimed=false;startIntervalClaim();});var setIsEnabled=function(enable,dateTimeString){var dateTime=null;if(enable===null||enable===undefined){return;}
if(angular.isString(dateTimeString)){dateTime=new Date(dateTimeString);}
if(dateTime&&(dateTime>=lastEnableDisableDateTime)){lastEnableDisableDateTime=dateTime;isEnabled=enable;}else if(dateTime===null){isEnabled=enable;}};var claimMSR={"MessageType":"Request","Device":"MSR","Command":"Claim"};var releaseMSR={"MessageType":"Request","Device":"MSR","Command":"Release"};var enableMSR=function(cardType){var tenderType=cardType?cardType:"BankCard";return{"MessageType":"Request","Device":"MSR","Command":"Enable","TenderType":tenderType}};var disableMSR={"MessageType":"Request","Device":"MSR","Command":"Disable"};$rootScope.$on('WS_Close_Event',function(event){MSRFunctions.releaseMSR();});var lastCard=undefined;var MSRFunctions={claimMSR:function(){try{ws.send(angular.toJson(claimMSR));}catch(err){$log.error(err.message);}},releaseMSR:function(){try{ws.send(angular.toJson(releaseMSR));}catch(err){$log.error(err.message);}},enableMSR:function(cardType){var defer=$q.defer();if(isEnabled){defer.reject();}else{var deregister=$rootScope.$on('MSR_Event_Enabled',function(event,data){if(timeoutEnablePromise!==null){$timeout.cancel(timeoutEnablePromise);timeoutEnablePromise=null;}
setIsEnabled(true,data.Timestamp);deregister();deregisterForErrors();defer.resolve(cardType);});var deregisterForErrors=$rootScope.$on('MSR_Event_Error',function(event,data){if((/^(MSR_ERR_NOT_FUNCTIONAL|MSR_ERR_NOT_CLAIMED|MSR_ERR_NOT_ENABLED|MSR_ERR_ENABLE|MSR_ERR_UNEXPECTED)$/i).test(data.StatusCode)){deregister();deregisterForErrors();setIsEnabled(false);MSRFunctions.disableMSR(true);defer.reject(data);}else if((/^MSR_ERR_ENABLED$/i).test(data.StatusCode)){setIsEnabled(true,data.Timestamp);deregister();deregisterForErrors();defer.resolve(cardType);}
if(timeoutEnablePromise!==null){$timeout.cancel(timeoutEnablePromise);timeoutEnablePromise=null;}});try{if(ws.readyState()==1){ws.send(angular.toJson(enableMSR(cardType)));timeoutEnablePromise=$timeout(function(){deregister();deregisterForErrors();setIsEnabled(false);$rootScope.$broadcast('MSR_Event_Error',{StatusText:"Timeout. Cannot enable MSR.",StatusCode:"LUFI_MSR_TIMEOUT"});defer.reject({StatusText:"Timeout. Cannot enable MSR.",StatusCode:"LUFI_MSR_TIMEOUT"});},11000);}
else{deregister();deregisterForErrors();setIsEnabled(false);$rootScope.$broadcast('MSR_Event_Error',{StatusText:"WebSocket to MSR communication is down.",StatusCode:"LUFI_MSR_WEBSOCKET_DOWN"});defer.reject({StatusText:"WebSocket to MSR communication is down.",StatusCode:"LUFI_MSR_WEBSOCKET_DOWN"});}}catch(err){deregister();deregisterForErrors();setIsEnabled(false);defer.reject(err);$log.error(err.message);}}
return defer.promise;},disableMSR:function(isIgnoreStateSendDisable){var defer=$q.defer();if(isEnabled||isIgnoreStateSendDisable){if(timeoutEnablePromise!==null){$timeout.cancel(timeoutEnablePromise);timeoutEnablePromise=null;}
var deregister=$rootScope.$on('MSR_Event_Disabled',function(event,data){var delayResolve=function(){if(timeoutDisablePromise!==null){$timeout.cancel(timeoutDisablePromise);timeoutDisablePromise=null;}
setIsEnabled(false,data.Timestamp);deregister();defer.resolve();};delayResolve();});try{if(ws.readyState()==1){ws.send(angular.toJson(disableMSR));timeoutDisablePromise=$timeout(function(){deregister();setIsEnabled(false);defer.reject({StatusText:"Timeout disable of MSR.",StatusCode:"LUFI_MSR_TIMEOUT"});},7000);}
else{deregister();setIsEnabled(false);defer.reject({StatusText:"WebSocket to MSR communication is down.",StatusCode:"LUFI_MSR_WEBSOCKET_DOWN"});}}catch(err){deregister();setIsEnabled(false);defer.reject(err);$log.error(err.message);}}else{defer.resolve();}
return defer.promise;},isEnabled:function(){return isEnabled;},lastCard:lastCard}
$rootScope.$on('MSR_Event_Disabled',function(event,data){setIsEnabled(false,data.Timestamp);});var startIntervalClaim=function(){if(claimIntervalPromise!==null){$interval.cancel(claimIntervalPromise);claimIntervalPromise=null;}
claimIntervalPromise=$interval(function()
{if(ws.readyState()==1){MSRFunctions.claimMSR();}},10000,20);if(ws.readyState()==1){MSRFunctions.claimMSR();}};startIntervalClaim();return MSRFunctions;}]).factory('printerService',['$rootScope','$interval','$log','$location','webSocketService','$q',function($rootScope,$interval,$log,$location,ws,$q){var claimPrinter={"MessageType":"Request","Device":"Printer","Command":"Claim"};var releasePrinter={"MessageType":"Request","Device":"Printer","Command":"Release"};var printOrder=function(orderNumber,retry,PrintType){return{"MessageType":"Request","Device":"Printer","Command":"Print","OrderNumber":orderNumber,"Retry":retry,"ReceiptType":PrintType}};$rootScope.$on('WS_Close_Event',function(event){MSRFunctions.releaseMSR();});var lastCard=undefined;var printerFunctions={claimPrinter:function(){var defer=$q.defer();try{if(ws.readyState()==1){ws.send(angular.toJson(claimPrinter));defer.resolve();}else{var eventData={MessageType:'Response',Device:'Printer',ResponseType:'Error',StatusText:'WebSocket communication is down. Claim of Printer failed.'};$rootScope.$broadcast('Printer_Error',eventData);defer.reject();}}catch(err){var eventData={MessageType:'Response',Device:'Printer',ResponseType:'Error',StatusText:'WebSocket communication is down. Claim of Printer failed.'};$rootScope.$broadcast('Printer_Error',eventData);$log.error(err.message);}
return defer.promise;},releasePrinter:function(){try{ws.send(angular.toJson(releasePrinter));}catch(err){$log.error(err.message);}},printOrder:function(orderNumber,retry,PrintType){try{if(ws.readyState()==1){ws.send(angular.toJson(printOrder(orderNumber,retry,PrintType)));}else{var eventData={MessageType:'Response',Device:'Printer',ResponseType:'Error',StatusText:'WebSocket communication is down. Claim of Printer failed.'};$rootScope.$broadcast('Printer_Error',eventData);}}catch(err){var eventData={MessageType:'Response',Device:'Printer',ResponseType:'Error',StatusText:'WebSocket communication is down. Printing of Printer failed.'};$rootScope.$broadcast('Printer_Error',eventData);$log.error(err.message);}}}
return printerFunctions;}]).factory('defaultUPCScanHandler',['itemSearch','$location',function($itemSearch,$location){return function(event,upc){$itemSearch.searchUPC(upc,function(response){if(response.ngroups==0){jQuery('.not-found-alert').modal('show');}else if(response.isnGroup.length==1){$itemSearch.setSelectedISNGroup(response.isnGroup[0]);$location.path('/itemDetail');}else{$location.path("/itemResults");}},function(err){alert(err);});};}]).factory('POSLogSocketService',['webSocketService',function(ws){var POSLogMessage=function(logText){return{"MessageType":"Request","Device":"Server","Command":"Configure","LogText":logText}};var POSLogFunctions={logToPOS:function(logText){try{ws.send(angular.toJson(POSLogMessage(logText)));}catch(err){console.error(err.message);}}};return POSLogFunctions;}]).factory('PaymentTerminalService',['webSocketService','$rootScope','$q','$timeout',function(ws,$rootScope,$q,$timeout){var claimPaymentTerminal={"MessageType":"Request","Device":"PaymentTerminal","Command":"Claim"};var releasePaymentTerminal={"MessageType":"Request","Device":"PaymentTerminal","Command":"Release"};var PaymentTerminalSigCapReq=function(OrderNo,AssociateID){return{"MessageType":"Request","Device":"PaymentTerminal","Command":"CollectSignature","AssociateID":AssociateID,"OrderNumber":OrderNo}};$rootScope.$on('WS_Close_Event',function(event){paymentTerminalFunctions.releasePaymentTerminal();});var timeoutPromise=null;var claimPayment=function(){var defer=$q.defer();var deregisterHandlers=function(){if(timeoutPromise!=null){$timeout.cancel(timeoutPromise);timeoutPromise=null;}
unregEventSucc();unregEventError();};var success=function(){deregisterHandlers();defer.resolve();};var failed=function(event,data){if((/^(PMT_ERR_CLAIMED|PMT_ERR_ENABLED)$/i).test(data.StatusCode)){success();}else{deregisterHandlers();defer.reject(data);}};var unregEventSucc=$rootScope.$on('PMT_SCS_CLAIMED',success);var unregEventError=$rootScope.$on('PaymentTerminal_Event_Error',failed);try{if(ws.readyState()==1){ws.send(angular.toJson(claimPaymentTerminal));timeoutPromise=$timeout(function(){failed(null,{"StatusText":"Timeout. Claim of Signature Capture failed.",StatusCode:"LUFI_BOPIS_TIMEOUT"});},22000);}else{failed(null,{"StatusText":"WebSocket communication is down. Claim of Signature Capture failed.",StatusCode:"LUFI_BOPIS_WEBSOCKET_DOWN"});}}catch(err){failed();$log.error(err.message);}
return defer.promise;};var sigCapTimeoutPromise=null;var getSignature=function(orderNumber,AssociateID){var defer=$q.defer();var deregisterHandlers=function(){if(sigCapTimeoutPromise!=null){$timeout.cancel(sigCapTimeoutPromise);sigCapTimeoutPromise=null;}
unregEventSucc();unregEventError();};var success=function(){deregisterHandlers();defer.resolve();};var failed=function(event,data){if(!(/^(PMT_ERR_CLAIMED|PMT_ERR_ENABLED|PMT_ERR_RELEASE)$/i).test(data.StatusCode)){deregisterHandlers();defer.reject(data);}};var unregEventSucc=function(){};var unregEventError=function(){};var sendRequest=function(){unregEventSucc=$rootScope.$on('PMT_SCS_SIGNATURE',success);unregEventError=$rootScope.$on('PaymentTerminal_Event_Error',failed);try{var cleanAssociateId=AssociateID?AssociateID:"0";if(orderNumber!==undefined&&orderNumber!==null){ws.send(angular.toJson(PaymentTerminalSigCapReq(orderNumber,cleanAssociateId)));sigCapTimeoutPromise=$timeout(function(){failed(null,{"StatusText":"Timeout. Signature was not captured after 3 minutes. If MSR is working, please Cancel out of Pick-up Confirm and retry. If MSR is not responding, complete Pick-up without signature.",StatusCode:"LUFI_BOPIS_TIMEOUT_ON_CAPTURE"});},180000);}else{failed(null,{"StatusText":"Invalid Order Number was received.",StatusCode:"LUFI_BOPIS_INVALID_INPUT"});}}catch(err){failed(null,{"StatusText":"Communication to PMM failed.",StatusCode:"LUFI_BOPIS_WEBSOCKET_DOWN"});$log.error(err.message);}};claimPayment().then(function(){sendRequest();},function(data){failed(null,data);});return defer.promise;};var paymentTerminalFunctions={releasePaymentTerminal:function(){if(timeoutPromise!=null){$timeout.cancel(timeoutPromise);timeoutPromise=null;}
if(sigCapTimeoutPromise!=null){$timeout.cancel(sigCapTimeoutPromise);sigCapTimeoutPromise=null;}
try{ws.send(angular.toJson(releasePaymentTerminal));}catch(err){$log.error(err.message);}},getSignature:getSignature};return paymentTerminalFunctions;}])
﻿var appServices=angular.module('appServicesAnnouncements',[]);appServices.factory('announcements',['$http','$cacheFactory','$filter','sendSMTPErrorEmail','$q',function($http,$cacheFactory,$filter,$sendSMTPErrorEmail,$q)
{var _allColumnsAreValid=false;var announcements=[];var currentDate=new Date()
var selectedNodes=[];var matchCnt=0;var requestArray=[];var request={"GetExceptionListReq":{"input":{"ComplexQuery":{"And":{"Or":[{"Exp":[{"_Name":"ShipnodeKey","_Value":"","_QryType":"EQ"},{"_Name":"OwnerKey","_Value":"BONTON","_QryType":"EQ"}]},{"Exp":[{"_Name":"ExceptionType","_Value":"YCD_ANNOUNCEMENT","_QryType":"EQ"},{"_Name":"ExceptionType","_Value":"RESTOCK","_QryType":"EQ"},{"_Name":"ExceptionType","_Value":"PICKUP","_QryType":"EQ"}]}]},"_Operator":"AND"},"_ActiveFlag":"Y","_DisplayLocalizedFieldInLocale":"en_US_EST","_MaximumRecords":"200","_Priority":"1","_ResolutionDate":"","_ResolutionDateQryType":"GT","_Status":"CLOSED","_StatusQryType":"NE","_SubscribedQueues":"N","_EnterpriseKey":"BONTON"}}}
var createRequest={"CreateExceptionReq":{"input":{"_AutoResolvedFlag":"Y","_Description":"","_DetailDescription":"","_DisplayLocalizedFieldInLocale":"en_US_EST","_EnterpriseKey":"DEFAULT","_ExceptionType":"YCD_ANNOUNCEMENT","_GeneratedOn":"","_ExpirationDays":"","_ListDescription":"","_Priority":"1","_QueueKey":"DEFAULT_Q12","_ResolutionDate":"","_ShipnodeKey":""}}}
var announcement={key:'',date:'',header:'',detail:'',expDate:'',locations:'',resolutionDate:""}
function formatDate(pDate)
{pDate=(pDate.getMonth()+1)+"-"+pDate.getDate()+"-"+pDate.getFullYear()+" "+pDate.getHours()+":"+pDate.getMinutes()+":"+pDate.getSeconds()+".0";return pDate;}
function addDays(theDate,myDays)
{currentdate=new Date(theDate.getTime()+myDays*24*60*60*1000);currentdate=formatDate(currentdate);return currentdate;}
var populateRequest=function(param)
{request.GetExceptionListReq.input.ComplexQuery.And.Or[0].Exp[0]._Value=param;}
var truncateAnnouncementReq=function()
{if(angular.isDefined(announcements&&announcements.length>0))
{for(var i=(announcements.length-1);i>=0;i--)
{announcements.splice(i,1);}}
announcement={key:"",date:"",header:"",detail:"",expDate:"",locations:"",resolutionDate:""};}
var foundMatch=function(locations,location)
{var match=false;for(var i=0;i<locations.length;i++)
{if(locations[i].toString().trim()===location.toString().trim())
{matchCnt=matchCnt+1;match=true;break;}}
return match}
var retrieve=function(param,caller,success,error)
{var tempParamArray=[];var emptyArray=[];if(angular.isArray(param))
{tempParamArray=param;}
else
{tempParamArray[0]=param;}
var localArray=[];populateRequest(param);var isSelectedAll=false;for(var i=0;i<tempParamArray.length;i++)
{if(tempParamArray[i].toString().trim()=="")
{isSelectedAll=true;break;}}
$http.post(getAnnouncementUrl,request).success(function(response)
{if(angular.isDefined(response.GetExceptionListRes.return)&&!angular.isArray(response.GetExceptionListRes.return)&&angular.isDefined(response.GetExceptionListRes.return.Inbox)){var singleObject=response.GetExceptionListRes.return.Inbox;response.GetExceptionListRes.return=[];response.GetExceptionListRes.return.push(singleObject);}
for(var i=0;i<response.GetExceptionListRes.return.length;i++)
{var tempKey=response.GetExceptionListRes.return[i]._InboxKey;var tempDate=new Date(response.GetExceptionListRes.return[i]._GeneratedOn)
var tempHeader=response.GetExceptionListRes.return[i]._Description;var tempDetail=response.GetExceptionListRes.return[i]._DetailDescription;var tempType=response.GetExceptionListRes.return[i]._ExceptionType;var tempOrder=response.GetExceptionListRes.return[i]._OrderNo;var tempExpDate=addDays(new Date(),response.GetExceptionListRes.return[i]._ExpirationDays);var tempLocations=response.GetExceptionListRes.return[i]._ShipnodeKey;var resolutionDate=new Date(response.GetExceptionListRes.return[i]._ResolutionDate)
if(tempHeader==""&&(tempType=="PICKUP"||tempType=="RESTOCK"))
{if(tempType=="PICKUP"){tempHeader="Order "+tempOrder+" - Open"}else if(tempType=="RESTOCK"){tempHeader="Order "+tempOrder+" - Restock"}}
if(tempLocations==""){tempLocations="All Stores";}
announcement={key:tempKey,date:tempDate,header:tempHeader,detail:tempDetail,expDate:tempExpDate,locations:tempLocations,resolutionDate:resolutionDate,exceptionType:tempType};localArray.push(announcement);announcement={key:"",date:"",header:"",detail:"",expDate:"",locations:"",resolutionDate:"",exceptionType:""};}
if(localArray.length>0)
{for(var p=0;p<localArray.length;p++)
{if(caller==="MANAGER")
{if(localArray[p].locations.toString().trim()=="")
{if(isSelectedAll)
{announcements.push(localArray[p]);}}
else
{announcements.push(localArray[p]);}}
else if(caller==="HOME")
{announcements.push(localArray[p]);}}}
success(announcements);truncateAnnouncementReq();localArray=emptyArray;response=null;},function(response)
{$sendSMTPErrorEmail(response,getUrl,request);error(response);});}
var addException=function(request,stores,success,error)
{if(!angular.isDefined(stores))
{stores=[];stores[0]="";}
var cntLoop=0;for(var p=0;p<stores.length;p++)
{var newReq={"CreateExceptionReq":{"input":{"_AutoResolvedFlag":"Y","_Description":"","_DetailDescription":"","_DisplayLocalizedFieldInLocale":"en_US_EST","_EnterpriseKey":"BONTON","_ExceptionType":"YCD_ANNOUNCEMENT","_GeneratedOn":"","_ExpirationDays":"","_ListDescription":"","_Priority":"1","_QueueKey":"DEFAULT_Q12","_ResolutionDate":"","_ShipnodeKey":"",}}}
if(stores[p]==="")
{newReq={"CreateExceptionReq":{"input":{"_AutoResolvedFlag":"Y","_Description":"","_DetailDescription":"","_DisplayLocalizedFieldInLocale":"en_US_EST","_EnterpriseKey":"BONTON","_ExceptionType":"YCD_ANNOUNCEMENT","_GeneratedOn":"","_ExpirationDays":"","_ListDescription":"","_Priority":"1","_QueueKey":"DEFAULT_Q12","_ResolutionDate":"","_OwnerKey":"BONTON",}}}}
else
{newReq.CreateExceptionReq.input._ShipnodeKey=stores[p];}
newReq.CreateExceptionReq.input._Description=angular.copy(request.CreateExceptionReq.input._Description);newReq.CreateExceptionReq.input._DetailDescription=angular.copy(request.CreateExceptionReq.input._DetailDescription);newReq.CreateExceptionReq.input._GeneratedOn=angular.copy(request.CreateExceptionReq.input._GeneratedOn);newReq.CreateExceptionReq.input._ExpirationDays=angular.copy(request.CreateExceptionReq.input._ExpirationDays);newReq.CreateExceptionReq.input._ResolutionDate=angular.copy(request.CreateExceptionReq.input._ResolutionDate);$http.post(createAnnouncementUrl,newReq).success(function(response)
{var tempKey=response.CreateExceptionRes.return._InboxKey;var tempDate=$filter('date')(new Date(response.CreateExceptionRes.return._GeneratedOn),'MM/dd/yyyy HH:mm:ss');var tempHeader=response.CreateExceptionRes.return._Description;var tempDetail=response.CreateExceptionRes.return._DetailDescription;var tempExpDays=addDays(new Date(),response.CreateExceptionRes.return._ExpirationDays);var tempLocations=response.CreateExceptionRes.return._ShipnodeKey;var tempResDate=response.CreateExceptionRes.return._ResolutionDate;if(angular.isDefined(tempResDate)){tempResDate=tempResDate.getFullYear()+"-"+(tempResDate.getMonth()+1)+"-"+tempResDate.getDate();}
announcement={key:tempKey,date:tempDate,header:tempHeader,detail:tempDetail,expDate:tempExpDays,locations:tempLocations,resolutionDate:tempResDate};announcements.push(announcement);announcement={key:"",date:"",header:"",detail:"",expDate:"",locations:"",resolutionDate:""};cntLoop=(cntLoop+1)
if(cntLoop===stores.length)
{success(announcements);truncateAnnouncementReq();}}).error(function(response)
{$sendSMTPErrorEmail(response,createUrl,newReq);error(response);})}}
var node={key:'',type:'',orgName:'',descrip:""}
var populateStoreList=function(param,success,error)
{var request={"getShipNodeList":{"input":{"_ShipnodeKey":""}}}
$http.post(getNodeListUrl,request).success(function(response)
{for(var i=0;i<response.GetShipNodeListResp.ShipNodeList.length;i++)
{var nodeKey=response.GetShipNodeListResp.ShipNodeList[i]._ShipnodeKey;var nodeType=response.GetShipNodeListResp.ShipNodeList[i]._NodeType;var nodeOrgName=response.GetShipNodeListResp.ShipNodeList[i].OwnerOrganization._OrganizationName;var nodeDescrip=response.GetShipNodeListResp.ShipNodeList[i]._Description;if(nodeType=='Store'||nodeType=='StoreFulfillment')
{node={key:nodeKey,type:nodeType,orgName:nodeOrgName,descrip:nodeDescrip};selectedNodes.push(node);}}
success(selectedNodes);var emptyArray=[];response=emptyArray;},function(response)
{$sendSMTPErrorEmail(response,nodeUrl,request);error(response);});}
var canManageAnnouncements=function()
{return $securityService.canManageAnnouncements();}
function isDate(myDate)
{return(myDate.constructor.toString().indexOf("Date")>-1);}
function isValidDate(value)
{var dateWrapper=new Date(value);return!isNaN(dateWrapper.getDate());}
var allValidated=function(data)
{var valid=true;var errorMessage={message:'Announcements '};var additionalMsg="";var expDays=data.createExceptionRequest.CreateExceptionReq.input._ExpirationDays;var header=data.createExceptionRequest.CreateExceptionReq.input._Description;var detail=data.createExceptionRequest.CreateExceptionReq.input._DetailDescription;var shipnode=data.createExceptionRequest.CreateExceptionReq.input._ShipnodeKey;if(!angular.isDefined(expDays)||isNaN(expDays))
{valid=false;additionalMsg=" Expiration Date is not valid.";return valid;}
if(!angular.isDefined(header)||header==null||header.toString().trim()=="")
{valid=false;additionalMsg=" header is not valid.";return valid;}
if(!angular.isDefined(detail)||detail==null||detail.toString().trim()=="")
{valid=false;additionalMsg=" detail is not valid.";return valid;}
errorMessage.message+=additionalMsg;return valid;}
var success=function(data)
{return data;};var error=function(errorData)
{};var save=function(data)
{if(angular.isDefined(data))
{if(allValidated(data))
{addException(data,success,error);}}};return{addDays:addDays,retrieve:retrieve,addException:addException,populateStoreList:populateStoreList,canManageAnnouncements:canManageAnnouncements,isDate:isDate,isValidDate:isValidDate,allValidated:allValidated,save:save}}]);
﻿angular.module('appFilters',['ui.bootstrap']).filter('structurefilter',function(){return function(items){var temp=[];if(items){items.forEach(function(item){if(item.visible){temp.push(item);}});}
return temp;};}).filter('phoneFormat',function(){return function(digits){if(angular.isString(digits)||(angular.isNumber(digits)&&isFinite(digits))){if(angular.isString(digits)){digits=digits.replace(/\D/g,'');}
if(angular.isNumber(digits)){digits=parseInt(digits);}
var temp=digits.toString().trim();var areacode=temp.slice(0,3);var first=temp.slice(3,6);var last=temp.slice(6,10);temp="";if(areacode.length>0){temp="("+areacode.slice(0,3);}
if(first.length>0){temp=temp+")"+first;}
if(last.length>0){temp=temp+"-"+last;}
return temp;}else{return digits;}};}).filter('phoneFormatRemove',function(){return function(digits){if(angular.isString(digits)){digits=digits.replace(/\D/g,'');return digits;}else{return digits;}};}).filter('oneLineAddress',['$filter',function($filter){return function(address,addressType,name,id){if(angular.isObject(address)&&!angular.isArray(address)){name=name?'name':'';id=id?'id':'';addressType=(addressType&&angular.isString(addressType))?addressType:'long';var addressesArray=[];if(name==='name'){var tempNameArr=[];if(address._FirstName&&address._FirstName.toString().trim()){tempNameArr.push(address._FirstName.toString().trim());}
if(address._MiddleName&&address._MiddleName.toString().trim()){tempNameArr.push(address._MiddleName.toString().trim());}
if(address._LastName&&address._LastName.toString().trim()){tempNameArr.push(address._LastName.toString().trim());}
if(tempNameArr.length>0){addressesArray.push(tempNameArr.join(" "));}}
if(addressType!=='none'){if(address._AddressLine1&&address._AddressLine1.toString().trim()){addressesArray.push(address._AddressLine1.toString().trim());}
if(address._AddressLine2&&address._AddressLine2.toString().trim()){addressesArray.push(address._AddressLine2.toString().trim());}
if(address._AddressLine3&&address._AddressLine3.toString().trim()){addressesArray.push(address._AddressLine3.toString().trim());}
if(address._AddressLine4&&address._AddressLine4.toString().trim()){addressesArray.push(address._AddressLine4.toString().trim());}
if(address._AddressLine5&&address._AddressLine5.toString().trim()){addressesArray.push(address._AddressLine5.toString().trim());}
if(address._AddressLine6&&address._AddressLine6.toString().trim()){addressesArray.push(address._AddressLine6.toString().trim());}
if(addressType==='long'){if(address._City&&address._City.toString().trim()){addressesArray.push($filter('titlecase')(address._City.toString().trim()));}
var tempStateZipArray=[];if(address._State&&address._State.toString().trim()){tempStateZipArray.push(address._State.toString().trim());}
if(address._ZipCode&&address._ZipCode.toString().trim()){tempStateZipArray.push(address._ZipCode.toString().trim());}
if(tempStateZipArray.length>0){addressesArray.push(tempStateZipArray.join(" "));}
if(address._Country&&address._Country.toString().trim()&&!(/us/).test(address._Country.toString().trim().toLowerCase())){addressesArray.push(address._Country.toString().trim());}}}
var resultString=addressesArray.join(", ");if(id==='id'){if(address._AddressID&&address._AddressID.toString().trim()){resultString='('+address._AddressID.toString().trim()+') '+resultString;}}
return resultString;}else{return address;}};}]).filter('titlecase',function(){return function(s){s=(s===undefined||s===null)?'':s;return s.toString().toLowerCase().replace(/\b([a-z])/g,function(ch){return ch.toUpperCase();});};}).filter('deliveryText',function(){return function(method){if(angular.isString(method)){switch(method.toLowerCase()){case'shp':method='Shipping';break;case'pick':method='Pick Up In Store';break;}
return method;}else{return method;}};});
﻿var appServices=angular.module('appServicesCommonCode',[]);appServices.factory('commonCode',['$http','$q',function($http,$q){var url="assets/misc/commonCode.min.json";var commonCodeMap={};var isCached=false;var _cacheCommonCode=function(orgFunctionCalled,searchCodeType,searchCodeValue){return $http.get(url).then(function(response){var data=response.data;for(var i=0;i<data.CommonCodeList.CommonCode.length;i++){var codeType=data.CommonCodeList.CommonCode[i]._CodeType;var codeValue=data.CommonCodeList.CommonCode[i]._CodeValue;if(!(codeType in commonCodeMap)){commonCodeMap[codeType]={};}
commonCodeMap[codeType][codeValue]=data.CommonCodeList.CommonCode[i];}
isCached=true;return orgFunctionCalled(searchCodeType,searchCodeValue);});};var _getCommonCode=function(codeType,codeValue){var returnValue=null;if(angular.isString(codeType)&&angular.isString(codeValue)){if(!isCached){return _cacheCommonCode(_getCommonCode,codeType,codeValue);}
if(commonCodeMap[codeType]){if(commonCodeMap[codeType][codeValue]){returnValue=commonCodeMap[codeType][codeValue]._CodeLongDescription;}}else{commonCodeMap[codeType]=null;returnValue=null;}}
var deferred=$q.defer();deferred.resolve(returnValue);return deferred.promise;};var _getCommonCodeObject=function(codeType,codeValue){var returnValue=null;if(angular.isString(codeType)&&angular.isString(codeValue)){if(!isCached){return _cacheCommonCode(_getCommonCodeObject,codeType,codeValue);}
if(commonCodeMap[codeType]){if(commonCodeMap[codeType][codeValue]){returnValue=angular.copy(commonCodeMap[codeType][codeValue]);}}else{commonCodeMap[codeType]=null;returnValue=null;}}
var deferred=$q.defer();deferred.resolve(returnValue);return deferred.promise;};var _getAllCommonCodeType=function(codeType){var returnValue=null;if(angular.isString(codeType)){if(!isCached){return _cacheCommonCode(_getAllCommonCodeType,codeType);}
if(commonCodeMap[codeType]){returnValue=[];for(var prop in commonCodeMap[codeType]){returnValue.push(angular.copy(commonCodeMap[codeType][prop]));}}else{commonCodeMap[codeType]=null;returnValue=null;}}
var deferred=$q.defer();deferred.resolve(returnValue);return deferred.promise;};return{getCommonCode:function(codeType,codeValue){return _getCommonCode(codeType,codeValue);},getCommonCodeObject:function(codeType,codeValue){return _getCommonCodeObject(codeType,codeValue);},getAllCommonCodeType:function(codeType){return _getAllCommonCodeType(codeType);}};}]);
﻿angular.module('appServicesGiftRegistry',[]).factory('giftRegistryService',['$http','loggerService','sendSMTPErrorEmail',function($http,$loggerService,$sendSMTPErrorEmail){var _preferredAddressPromise=function(registryNo){var input={"GiftRegistryInput":{"GetPreferredAddress":{"registryNumber":registryNo.toString()}}};var url=serviceURL.toString()+'/GiftRegistry/GetPreferredAddress';return $http.post(url,input);}
var _validateRegistryPromise=function(registryNo){var input={"IsRegistryValidInput":{"IsRegistryValid":{"registryNumber":registryNo.toString()}}};var url=serviceURL.toString()+'/GiftRegistry/IsRegistryValid';return $http.post(url,input);};var _constructRegistryAddress=function(registryValue,response){if(!angular.isDefined(registryValue)||!angular.isObject(response)){return null;}
var temp={"_IsShipTo":"Y","_IsDefaultSoldTo":"N","_IsDefaultBillTo":"N","_CustomerAdditionalAddressID":"","_AddressType":"S","_IsDefaultShipTo":"N","PersonInfo":{"_RegTitle":"","_EMailID":"","_PersonInfoKey":""+registryValue,"_VerificationStatus":"","_PreferredShipAddress":"","_DayPhone":"","_LastName":"","_EveningFaxNo":"","_OtherPhone":"","_DayFaxNo":"","_HttpUrl":"","_PersonID":"","_FirstName":"","_MobilePhone":"","_AlternateEmailID":"","_Suffix":"","_Country":"","_ZipCode":"","_Title":"","_City":"","_AddressID":"Registry Address","_MiddleName":"","_State":"","_AddressLine4":"","_AddressLine5":"","_AddressLine6":"","_EveningPhone":"","_AddressLine1":"","_AddressLine2":"","_AddressLine3":""}};if(angular.isDefined(response.Address1)&&angular.isString(response.Address1)){temp.PersonInfo._AddressLine1=response.Address1;}else{throw errorObj.newError('_constructRegistryAddress():GiftRegAddressError',"There is an error in the Gift Registry for Registry Number: "+registryValue+". Please contact Help Desk.","_constructRegistryAddress(): Registry Number: "+registryValue+" has bad Address1 data returned from Gift Registry Service.",'GiftRegAddressError','WARN');}
if(angular.isDefined(response.Address2)&&angular.isString(response.Address2)){temp.PersonInfo._AddressLine2=response.Address2;}
if(angular.isDefined(response.Address3)&&angular.isString(response.Address3)){temp.PersonInfo._AddressLine3=response.Address3;}
if(angular.isDefined(response.City)&&angular.isString(response.City)){temp.PersonInfo._City=response.City;}else{throw errorObj.newError('_constructRegistryAddress():GiftRegAddressError',"There is an error in the Gift Registry for Registry Number: "+registryValue+". Please contact Help Desk.","_constructRegistryAddress(): Registry Number: "+registryValue+" has bad City data returned from Gift Registry Service.",'GiftRegAddressError','WARN');}
if(angular.isDefined(response.Country)&&angular.isString(response.Country)){temp.PersonInfo._Country=response.Country;}else{throw errorObj.newError('_constructRegistryAddress():GiftRegAddressError',"There is an error in the Gift Registry for Registry Number: "+registryValue+". Please contact Help Desk.","_constructRegistryAddress(): Registry Number: "+registryValue+" has bad Country data returned from Gift Registry Service.",'GiftRegAddressError','WARN');}
if(angular.isDefined(response.Email1)&&angular.isString(response.Email1)&&(/.+@.+\..+/).test(response.Email1.toString().trim())){temp.PersonInfo._EMailID=response.Email1;}else{temp.PersonInfo._EMailID="bonton@bonton.com";$loggerService.log('Gift Registry had invalid email address of: "'+response.Email1+'". Replaced with: "'+temp.PersonInfo._EMailID+'"');}
if(angular.isDefined(response.FirstName)&&angular.isString(response.FirstName)){temp.PersonInfo._FirstName=response.FirstName;}
if(angular.isDefined(response.LastName)&&angular.isString(response.LastName)){temp.PersonInfo._LastName=response.LastName;}
if(angular.isDefined(response.Phone)&&angular.isString(response.Phone)){temp.PersonInfo._DayPhone=response.Phone;}
if(angular.isDefined(response.RegTitle)&&angular.isString(response.RegTitle)){temp.PersonInfo._RegTitle=response.RegTitle;}
if(angular.isDefined(response.State)&&angular.isString(response.State)){temp.PersonInfo._State=response.State;}else{throw errorObj.newError('_constructRegistryAddress():GiftRegAddressError',"There is an error in the Gift Registry for Registry Number: "+registryValue+". Please contact Help Desk.","_constructRegistryAddress(): Registry Number: "+registryValue+" has bad State data returned from Gift Registry Service.",'GiftRegAddressError','WARN');}
if(angular.isDefined(response.ZipCode)&&angular.isString(response.ZipCode)){var tempZipCode=response.ZipCode.trim().substring(0,5);temp.PersonInfo._ZipCode=tempZipCode;}else{throw errorObj.newError('_constructRegistryAddress():GiftRegAddressError',"There is an error in the Gift Registry for Registry Number: "+registryValue+". Please contact Help Desk.","_constructRegistryAddress(): Registry Number: "+registryValue+" has bad ZipCode data returned from Gift Registry Service.",'GiftRegAddressError','WARN');}
return temp;};return{preferredAddressPromise:_preferredAddressPromise,validateRegistryPromise:_validateRegistryPromise,constructRegistryAddress:_constructRegistryAddress};}]);
﻿angular.module('appServiceReprice',['appUtilities']).factory('repriceService',['$http','serviceArrayFix','$q','loggerService','sendSMTPErrorEmail',function($http,serviceArrayFix,$q,$loggerService,$sendSMTPErrorEmail){var count=0;var _addTempOrderLineKeys=function(orderCart){for(var i=0;i<orderCart.OrderLines.OrderLine.length;i++){var currentLine=orderCart.OrderLines.OrderLine[i];if(angular.isDefined(currentLine._OrderLineKey)){if(currentLine._OrderLineKey.toString().trim()===""||(/^RPQtemp/).test(currentLine._OrderLineKey.toString().trim())){currentLine._OrderLineKey="RPQtemp"+currentLine._PrimeLineNo.toString()+"_"+currentLine._SubLineNo.toString();}}else{currentLine._OrderLineKey="RPQtemp"+currentLine._PrimeLineNo.toString()+"_"+currentLine._SubLineNo.toString();}}
return orderCart;};var _cleanOrderCart=function(copyCart){for(var i=0;i<copyCart.OrderLines.OrderLine.length;i++){var currentLine=copyCart.OrderLines.OrderLine[i];delete currentLine.btDisplay;delete currentLine.btLogic;delete currentLine.CarrierServiceList;}
return copyCart;};var _copyAllAttributes=function(source,destination){var keyArr=Object.keys(source);for(var i=0;i<keyArr.length;i++){if((/^_/).test(keyArr[i])){destination[keyArr[i]]=source[keyArr[i]];}}};var _copyMissingAttributes=function(source,destination){var keyArr=Object.keys(source);for(var i=0;i<keyArr.length;i++){if((/^_/).test(keyArr[i])){if(!angular.isDefined(destination[keyArr[i]])){destination[keyArr[i]]=source[keyArr[i]];}}}};var _mergeCart=function(orderCart,responseCart,lCount){_copyAllAttributes(responseCart,orderCart);orderCart.Errors=responseCart.Errors;orderCart.Promotions=responseCart.Promotions;orderCart.btResponses=responseCart.btResponses;var keyToResOrderLineMap={};for(var i=0;i<responseCart.OrderLines.OrderLine.length;i++){var currentLine=responseCart.OrderLines.OrderLine[i];if(currentLine._OrderLineKey in keyToResOrderLineMap){keyToResOrderLineMap[currentLine._OrderLineKey].push(currentLine);}else{keyToResOrderLineMap[currentLine._OrderLineKey]=[currentLine];}}
for(var key in keyToResOrderLineMap){var currentOrderCartOrderline=null;for(var p=0;p<orderCart.OrderLines.OrderLine.length;p++){if(orderCart.OrderLines.OrderLine[p]._OrderLineKey.toString()===key){currentOrderCartOrderline=orderCart.OrderLines.OrderLine[p];break;}}
if(currentOrderCartOrderline!==null){for(var i=0;i<keyToResOrderLineMap[key].length;i++){var currentRespOrderline=keyToResOrderLineMap[key][i];currentRespOrderline.CarrierServiceList=angular.copy(currentOrderCartOrderline.CarrierServiceList);_copyMissingAttributes(currentOrderCartOrderline.Item,currentRespOrderline.Item);_copyMissingAttributes(currentOrderCartOrderline.ItemDetails.PrimaryInformation,currentRespOrderline.ItemDetails.PrimaryInformation);currentRespOrderline.Notes=angular.copy(currentOrderCartOrderline.Notes);currentRespOrderline.PersonInfoShipTo=angular.copy(currentOrderCartOrderline.PersonInfoShipTo);_copyMissingAttributes(currentOrderCartOrderline,currentRespOrderline);currentRespOrderline.btDisplay=angular.copy(currentOrderCartOrderline.btDisplay);currentRespOrderline.btLogic=angular.copy(currentOrderCartOrderline.btLogic);}}else{$loggerService.log('Cart_Pricing:_merge ERROR. OrderLine key not found in orginal order cart: '+key.toString()+' reprice: '+lCount);}}
orderCart.OrderLines.OrderLine=responseCart.OrderLines.OrderLine;return orderCart;};var _removeTempOrderLineKeys=function(orderCart){for(var i=0;i<orderCart.OrderLines.OrderLine.length;i++){var currentLine=orderCart.OrderLines.OrderLine[i];if((/^RPQtemp/).test(currentLine._OrderLineKey.toString().trim())){currentLine._OrderLineKey="";}
if('_ExtnGiftRegistryNumber'in currentLine.Extn){currentLine.Extn._ExtnGiftRegistryNo=currentLine.Extn._ExtnGiftRegistryNumber;}}
return orderCart;};var _sortOrderCartOrderlines=function(orderCart){orderCart.OrderLines.OrderLine.sort(function(a,b){var aPrimeLine=parseInt(a._PrimeLineNo);var aSubLine;if(a._SubLineNo&&isFinite(parseInt(a._SubLineNo))){aSubLine=parseInt(a._SubLineNo);}else{aSubLine=1;}
var bPrimeLine=parseInt(b._PrimeLineNo);var bSubLine;if(b._SubLineNo&&isFinite(parseInt(b._SubLineNo))){bSubLine=parseInt(b._SubLineNo);}else{bSubLine=1;}
if((aPrimeLine-bPrimeLine)===0){return aSubLine-bSubLine;}else{return aPrimeLine-bPrimeLine;}});};var _renumberOrderLines=function(orderCart){_sortOrderCartOrderlines(orderCart);var primeLineNoCount=1;var subLineNoCount=1;var currentLinePrimeNo=-1;var primeLineGroups=[];var currentPrimeGroup=[];for(var i=0;i<orderCart.OrderLines.OrderLine.length;i++){if((parseInt(orderCart.OrderLines.OrderLine[i]._PrimeLineNo)!==currentLinePrimeNo)){if(currentPrimeGroup.length>0){primeLineGroups.push(currentPrimeGroup);}
currentLinePrimeNo=parseInt(orderCart.OrderLines.OrderLine[i]._PrimeLineNo);currentPrimeGroup=[];}
currentPrimeGroup.push(orderCart.OrderLines.OrderLine[i]);if(i===(orderCart.OrderLines.OrderLine.length-1)){if(currentPrimeGroup.length>0){primeLineGroups.push(currentPrimeGroup);}}}
for(var i=0;i<primeLineGroups.length;i++){subLineNoCount=1;currentPrimeGroup=primeLineGroups[i];for(var q=0;q<currentPrimeGroup.length;q++){currentPrimeGroup[q]._PrimeLineNo=primeLineNoCount;currentPrimeGroup[q]._SubLineNo=subLineNoCount;++subLineNoCount;}
subLineNoCount=1;++primeLineNoCount;}};function toLocalISOString(){var d=new Date();var off=d.getTimezoneOffset();return new Date(d.getFullYear(),d.getMonth(),d.getDate(),d.getHours(),d.getMinutes()-off,d.getSeconds(),d.getMilliseconds()).toISOString();}
var _reprice=function(orderCart){if(angular.isDefined(orderCart.OrderLines)&&angular.isDefined(orderCart.OrderLines.OrderLine)&&orderCart.OrderLines.OrderLine.length>0){var localCount=++count;$loggerService.log('reprice: '+localCount);var copyCart=angular.copy(orderCart);_addTempOrderLineKeys(copyCart);var inputCart=angular.copy(copyCart);_cleanOrderCart(inputCart);var input={"GetOrderCartPriceIn":inputCart};input.GetOrderCartPriceIn._OrderDate=toLocalISOString();var validPrice=function(price){if(!(angular.isString(price)||angular.isNumber(price)))
{return false;}
var numericValue;if(angular.isString(price)){if(price.trim().length>0)
{numericValue=Number(price);}else
{return false;}}else{numericValue=price;}
if(isFinite(numericValue)&&(numericValue>=0))
{return true;}
return false;};var resetLineUnitPrice=function(line)
{if(line.LinePriceInfo._RetailPrice&&validPrice(line.LinePriceInfo._RetailPrice))
{line.LinePriceInfo._UnitPrice=angular.copy(line.LinePriceInfo._RetailPrice);}else if(line.LinePriceInfo._ListPrice&&validPrice(line.LinePriceInfo._ListPrice))
{line.LinePriceInfo._UnitPrice=angular.copy(line.LinePriceInfo._ListPrice);}else
{line.LinePriceInfo._UnitPrice="0.00";}};if(input.GetOrderCartPriceIn.OrderLines&&input.GetOrderCartPriceIn.OrderLines.OrderLine){for(var i=0;i<input.GetOrderCartPriceIn.OrderLines.OrderLine.length;i++){var line=input.GetOrderCartPriceIn.OrderLines.OrderLine[i];if(!validPrice(line.LinePriceInfo._UnitPrice))
{resetLineUnitPrice(line);}}}
var url=serviceURL.toString()+'/Price/GetOrderCartPrice';return $http.post(url,input).then(function(response){serviceArrayFix(response.data);_mergeCart(copyCart,response.data.GetOrderCartPriceOut,localCount);_removeTempOrderLineKeys(copyCart);_sortOrderCartOrderlines(copyCart);response.data=copyCart;$loggerService.log('reprice: '+localCount);return response;},function(response){$sendSMTPErrorEmail(response,url,input);return $q.reject(response);});}else{var response={data:angular.copy(orderCart)};response.data.Errors={ErrorList:{Error:[{"_ErrorCode":"-1","_ErrorDescription":"No OrderLines found on input orderCart.","_ErrorRelatedMoreInfo":"","Attribute":{"_Name":"","_Value":""},"Stack":[]}]}};var defer=$q.defer();defer.reject(response);return defer.promise;}};return{reprice:_reprice,copyAllAttributes:_copyAllAttributes,copyMissingAttributes:_copyMissingAttributes};}]);
﻿angular.module('addModifyAddress',['ui.bootstrap']).controller('addModifyAddressCtrl',['$scope','$stateParams','customer','$state','appState','orderCart','$modal','$q','$filter','loggerService','isPoBoxAddress','customerKeyPressValidator',function($scope,$stateParams,$customer,$state,$appState,$orderCart,$modal,$q,$filter,$loggerService,$isPoBoxAddress,$customerKeyPressValidator){$scope.title='Add Address';$scope.address={};$scope.addressResponse=false;$scope.emailResponse=false;$scope.emailValidated=false;$scope.addressValidated=false;$scope.AllEntriesValid=true;$scope.EnterAddress=false;$scope.EnterCity=false;$scope.EnterState=false;$scope.EnterZip=false;$scope.EnterFirstName=false;$scope.EnterLastName=false;$scope.EnterPhone=false;$scope.EnterEmail=false;$scope.international=false;$scope.disableShipTo=false;$scope.disableBillTo=false;$scope.disableCountry=false;$scope.avsOverride=false;$scope.keyPressValidator=$customerKeyPressValidator;var additionalAddressModel={"_AddressType":"SB","_CustomerAdditionalAddressID":"","_IsBillTo":"Y","_IsDefaultBillTo":"N","_IsDefaultShipTo":"N","_IsShipTo":"Y","PersonInfo":{"_AddressID":"","_AddressLine1":"","_AddressLine2":"","_AddressLine3":"","_AddressLine4":"","_AddressLine5":"","_AddressLine6":"","_City":"","_Country":"US","_DayPhone":"","_EMailID":"","_EveningPhone":"","_FirstName":"","_IsCommercialAddress":"N","_LastName":"","_MiddleName":"","_MobilePhone":"","_OtherPhone":"","_State":"","_Suffix":"","_Title":"","_ZipCode":""}};var contactID=$stateParams.customerContactID.toString().trim();var addressID=$stateParams.customerAdditionalAddressID.toString().trim();var customer=$customer.getSelectedCustomer();var isNewCustomer=false;var realAdditionalAddress={};var _locateContact=function(){for(var i=0;i<customer.CustomerContactList.CustomerContact.length;i++){if(customer.CustomerContactList.CustomerContact[i]._CustomerContactID.toString().trim()==contactID){return customer.CustomerContactList.CustomerContact[i];}}
throw{name:"No contact found! "};};var _locateAddress=function(){var contact=_locateContact();for(var i=0;i<contact.CustomerAdditionalAddressList.CustomerAdditionalAddress.length;i++){if(contact.CustomerAdditionalAddressList.CustomerAdditionalAddress[i]._CustomerAdditionalAddressID.toString().trim()===addressID){realAdditionalAddress=angular.copy(contact.CustomerAdditionalAddressList.CustomerAdditionalAddress[i]);$scope.address=angular.copy(contact.CustomerAdditionalAddressList.CustomerAdditionalAddress[i]);$scope.formatPhone('_DayPhone');$scope.formatPhone('_EveningPhone');}}};var _setNewCustomerAddress=function(){var parms=$customer.getCachedQueryParam();if(angular.isDefined(parms)&&parms!==null&&angular.isDefined(parms.Customer)&&parms.Customer!==null){if(angular.isString(parms.Customer.FirstName)){$scope.address.PersonInfo._FirstName=$filter('titlecase')(parms.Customer.FirstName.trim());}
if(angular.isString(parms.Customer.LastName)){$scope.address.PersonInfo._LastName=$filter('titlecase')(parms.Customer.LastName.trim());}
if(angular.isString(parms.Customer.EmailAddress)){$scope.address.PersonInfo._EMailID=parms.Customer.EmailAddress.trim();}
if(angular.isString(parms.Customer.PhoneNumber)){$scope.address.PersonInfo._DayPhone=$filter('phoneFormat')(parms.Customer.PhoneNumber.trim());}}
$scope.address._IsDefaultBillTo='Y';$scope.address._IsDefaultShipTo='Y';isNewCustomer=true;};var _initializeData=function(){if(contactID.length>0&&addressID.length>0){$scope.title='Modify Address';_locateAddress();}else if(contactID.length>0){$scope.title='Add Address';$scope.address=angular.copy(additionalAddressModel);}else{$scope.title='New Customer';$scope.address=angular.copy(additionalAddressModel);_setNewCustomerAddress();}
$scope.setCheckBoxFromFlag();};var _copyAllAttributes=function(source,destination){var keyArr=Object.keys(source);for(var i=0;i<keyArr.length;i++){if((/^_/).test(keyArr[i])){destination[keyArr[i]]=source[keyArr[i]];}}};$scope.formatPhone=function(addressAttrName){$scope.address.PersonInfo[addressAttrName]=$filter('phoneFormat')($scope.address.PersonInfo[addressAttrName]);};$scope.cancel=function(){if(addressChangeObj.previousStateName){$state.go(addressChangeObj.previousStateName.toString().trim());}else if(isNewCustomer){$state.go('customerSearch');}else{$state.go('customerDetail');}};$scope.reset=function(){if(addressID){$scope.address=angular.copy(realAdditionalAddress);$scope.formatPhone('_DayPhone');$scope.formatPhone('_EveningPhone');$scope.setCheckBoxFromFlag();}else{$scope.address=angular.copy(additionalAddressModel);if(isNewCustomer){_setNewCustomerAddress();}
$scope.setCheckBoxFromFlag();}};$scope.setCheckBoxFromFlag=function(){if($scope.address._IsDefaultBillTo=='Y'){$scope.defaultBilling=true;$scope.disableBillTo=true;}else{$scope.defaultBilling=false;}
if($scope.address._IsDefaultShipTo=='Y'){$scope.defaultShipping=true;$scope.disableShipTo=true;}else{$scope.defaultShipping=false;}}
$scope.setFlagFromCheckBox=function(){if($scope.defaultBilling){$scope.address._IsDefaultBillTo='Y';}else{$scope.address._IsDefaultBillTo='N';}
if($scope.defaultShipping){$scope.address._IsDefaultShipTo='Y';}else{$scope.address._IsDefaultShipTo='N';}};var addressChangeObj=$appState.getAddressChange();if(addressChangeObj.customerKey!==null&&addressChangeObj.customerKey.toString().trim().length>0){if(customer._CustomerKey!=addressChangeObj.customerKey.toString().trim()){$customer.retrieveCustomerDetail("",addressChangeObj.customerKey.toString(),function(){_initializeData();},function(){});}else{_initializeData();}}else{_initializeData();};if($scope.address.PersonInfo._Country!="US"){$scope.international=true;}
$scope.save=function(){$scope.setFlagFromCheckBox();$scope.address.PersonInfo._Country=$scope.address.PersonInfo._Country.toUpperCase();if($scope.address.PersonInfo._Country.trim()!="US"&&$scope.address.PersonInfo._Country.trim()!="UNITED STATES OF AMERICA"){$scope.international=true;}else{$scope.international=false;}
if($scope.international==true){$scope.validateInternational();if($scope.AllEntriesValid==true){if($scope.defaultBilling==true){$scope.address._IsDefaultBillTo=='Y';}else{$scope.address._IsDefaultBillTo=='N';}
$scope.updateCustomer();}}else if($scope.avsOverride==true){$scope.validateFields();if($scope.AllEntriesValid==false){}
else{$scope.updateCustomer();}}else{$scope.validateFields();if($scope.AllEntriesValid==false){}
else{$scope.addressResponse=true;$scope.emailResponse=true;$scope.emailValidated=false;$scope.addressValidated=false;addressToVerify=[];addressToVerify.line1=$scope.address.PersonInfo._AddressLine1;addressToVerify.line2=$scope.address.PersonInfo._AddressLine2;addressToVerify.line3=$scope.address.PersonInfo._AddressLine3;addressToVerify.city=$scope.address.PersonInfo._City;addressToVerify.state=$scope.address.PersonInfo._State;addressToVerify.zip=$scope.address.PersonInfo._ZipCode;addressToVerify.country=$scope.address.PersonInfo._Country;var emailToVerify=$scope.address.PersonInfo._EMailID;if(addressToVerify.line2===null){addressToVerify.line2="";}
if(addressToVerify.line3===null){addressToVerify.line3="";}
address=addressToVerify.line1+"|"+addressToVerify.line2+"|"+addressToVerify.line3+"|"+addressToVerify.city+"|"+addressToVerify.state+"|"+addressToVerify.zip;$customer.verifyCustomerAddress(address).success(function(response){$scope.addressResponse=false;if(response.QASearchResult._VerifyLevel=="Verified"){$scope.address.PersonInfo._AddressLine1=response.QASearchResult.QAAddress.AddressLine[0].Line;$scope.address.PersonInfo._AddressLine2=response.QASearchResult.QAAddress.AddressLine[1].Line;$scope.address.PersonInfo._AddressLine3=response.QASearchResult.QAAddress.AddressLine[2].Line;$scope.address.PersonInfo._City=response.QASearchResult.QAAddress.AddressLine[3].Line;$scope.address.PersonInfo._State=response.QASearchResult.QAAddress.AddressLine[4].Line;$scope.address.PersonInfo._ZipCode=response.QASearchResult.QAAddress.AddressLine[5].Line.substring(0,5);if(response.QASearchResult.QAAddress.AddressLine[6].Line="UNITED STATES OF AMERICA"){$scope.address.PersonInfo._Country="US";}
if($scope.address.PersonInfo._AddressLine2===null){$scope.address.PersonInfo._AddressLine2="";}
if($scope.address.PersonInfo._AddressLine3===null){$scope.address.PersonInfo._AddressLine3="";}
$scope.addressValidated=true;if($scope.addressValidated==true&&$scope.emailValidated==true&&$scope.AllEntriesValid==true){$scope.updateCustomer();}}else if((response.QASearchResult._VerifyLevel=="PremisesPartial")||(response.QASearchResult._VerifyLevel=="StreetPartial")||(response.QASearchResult._VerifyLevel=="Multiple")){$scope.openAddressSelection(response);}else{swal({title:"Error!",text:"Please enter a valid address",showConfirmButton:true});}
$loggerService.log(response);}).error(function(data){$scope.addressValidated=true;if($scope.addressValidated==true&&$scope.emailValidated==true&&$scope.AllEntriesValid==true){$scope.updateCustomer();}});$customer.verifyEmail(emailToVerify).success(function(response){$scope.emailResponse=false;if(response.Certainty!="undeliverable"){$scope.address.PersonInfo._EMailID=emailToVerify;$loggerService.log(response);$scope.EnterEmail=false;$scope.emailValidated=true;if($scope.addressValidated==true&&$scope.emailValidated==true&&$scope.AllEntriesValid==true){$scope.updateCustomer();}}else{$loggerService.log(response);$scope.EnterEmail=true;}}).error(function(data){$scope.emailValidated=true;if($scope.addressValidated==true&&$scope.emailValidated==true&&$scope.AllEntriesValid==true){$scope.updateCustomer();}});}}};$scope.updateCustomer=function(){$scope.address.PersonInfo._DayPhone=$filter('phoneFormatRemove')($scope.address.PersonInfo._DayPhone);$scope.address.PersonInfo._EveningPhone=$filter('phoneFormatRemove')($scope.address.PersonInfo._EveningPhone);var stateName='customerDetail';if(addressChangeObj.previousStateName){stateName=addressChangeObj.previousStateName.toString().trim();}
if(isNewCustomer){$customer.createCustomerByAddress($scope.address,function(response){$state.go(stateName);},function(response){$loggerService.log(response);});}
else{$customer.addModifyAddress(customer._CustomerID,contactID,$scope.address,function(){if(angular.isDefined(addressChangeObj.setShipToOrderLinePrimeSubLineObjArray)&&addressChangeObj.setShipToOrderLinePrimeSubLineObjArray.length>0){try{$orderCart.address.setOrderLineShipToAddresses(addressChangeObj.setShipToOrderLinePrimeSubLineObjArray,$scope.address,false);}catch(e){$loggerService.log(e);}}else if(addressChangeObj.setBillTo){$orderCart.address.setBillingAddress($scope.address)}
$state.go(stateName);});}}
$scope.countryInfoMessage=function(){country=$scope.address.PersonInfo._Country;if(country!="US"){swal({title:"",text:"International address can only be used as a billing address",showConfirmButton:true});$scope.defaultShipping=false;$scope.disableShipTo=true;$scope.international=true;}else{$scope.international=false;if($scope.address._IsDefaultShipTo=='Y'){$scope.disableShipTo=true;}else{$scope.disableShipTo=false;}}
if($scope.defaultShipping==true){$scope.address._IsDefaultShipTo=='Y';}else{$scope.address._IsDefaultShipTo=='N';}}
$scope.validateFields=function(){if($scope.address._IsDefaultShipTo=='Y'){if($isPoBoxAddress($scope.address.PersonInfo)){swal({title:"",text:"Ship to address can not be a PO Box",showConfirmButton:true});var isPoBox=true;}else{isPoBox=false;}}
if($scope.address.PersonInfo._AddressLine1==""){$scope.EnterAddress=true;}else{$scope.EnterAddress=false;};if($scope.address.PersonInfo._City==""){$scope.EnterCity=true;}else{$scope.EnterCity=false;};if($scope.address.PersonInfo._State==""){$scope.EnterState=true;}else{$scope.EnterState=false;};if($scope.address.PersonInfo._ZipCode==""){$scope.EnterZip=true;}else{$scope.EnterZip=false;};if($scope.address.PersonInfo._FirstName==""){$scope.EnterFirstName=true;}else{$scope.EnterFirstName=false;};if($scope.address.PersonInfo._LastName==""){$scope.EnterLastName=true;}else{$scope.EnterLastName=false;};if(($scope.address.PersonInfo._EMailID=="")||($scope.address.PersonInfo._EMailID.indexOf('@')===-1)||($scope.address.PersonInfo._EMailID.indexOf('.')===-1)){$scope.EnterEmail=true;}else{$scope.EnterEmail=false;};if($scope.address.PersonInfo._DayPhone==""){$scope.EnterPhone=true;}else{$scope.EnterPhone=false;};if($scope.EnterAddress||$scope.EnterCity||$scope.EnterState||$scope.EnterZip||$scope.EnterFirstName||$scope.EnterLastName||$scope.EnterEmail||$scope.EnterPhone||isPoBox){$scope.AllEntriesValid=false;}else{$scope.AllEntriesValid=true;};};$scope.validateInternational=function(){if($scope.address.PersonInfo._AddressLine1==""){$scope.EnterAddress=true;}else{$scope.EnterAddress=false;};if($scope.address.PersonInfo._FirstName==""){$scope.EnterFirstName=true;}else{$scope.EnterFirstName=false;};if($scope.address.PersonInfo._LastName==""){$scope.EnterLastName=true;}else{$scope.EnterLastName=false;};if(($scope.address.PersonInfo._EMailID=="")||($scope.address.PersonInfo._EMailID.indexOf('@')===-1)||($scope.address.PersonInfo._EMailID.indexOf('.')===-1)){$scope.EnterEmail=true;}else{$scope.EnterEmail=false;};if($scope.address.PersonInfo._DayPhone==""){$scope.EnterPhone=true;}else{$scope.EnterPhone=false;};if($scope.EnterAddress==true||$scope.EnterFirstName==true||$scope.EnterLastName==true||$scope.EnterEmail==true||$scope.EnterPhone==true){$scope.AllEntriesValid=false;}else{$scope.AllEntriesValid=true;};}
$scope.CountryOptions=[{id:'AC',country:'Ascension Island'},{id:'AD',country:'Andorra'},{id:'AE',country:'United Arab Emirates'},{id:'AF',country:'Afghanistan'},{id:'AG',country:'Antigua and Barbuda'},{id:'AI',country:'Anguilla'},{id:'AL',country:'Albania'},{id:'AM',country:'Armenia'},{id:'AN',country:'Netherlands Antilles'},{id:'AO',country:'Angola'},{id:'AQ',country:'Antarctica'},{id:'AR',country:'Argentina'},{id:' AS',country:'American Samoa'},{id:'AT',country:'Austria'},{id:'AU',country:'Australia'},{id:'AW',country:'Aruba'},{id:'AX',country:'Aland Islands'},{id:'AZ',country:'Azerbaijan'},{id:'BA',country:'Bosnia and Herzegovina'},{id:'BB',country:'Barbados'},{id:'BD',country:'Bangladesh'},{id:'BE',country:'Belgium'},{id:'BF',country:'Burkina Faso'},{id:'BG',country:'Bulgaria'},{id:'BH',country:'Bahrain'},{id:'BI',country:'Burundi'},{id:'BJ',country:'Benin'},{id:' BM',country:'Bermuda'},{id:'BN',country:'Brunei Darussalam'},{id:'BO',country:'Bolivia'},{id:'BR',country:'Brazil'},{id:'BS',country:'Bahamas'},{id:'BT',country:'Bhutan'},{id:'BV',country:'Bouvet Island'},{id:'BW',country:'Botswana'},{id:'BY',country:'Belarus'},{id:'BZ',country:'Belize'},{id:'CA',country:'Canada'},{id:'CC',country:'Cocos (Keeling) Islands'},{id:'CD',country:'Congo, Democratic Republic'},{id:'CF',country:'Central African Republic'},{id:'CG',country:'Congo'},{id:'CH',country:'Switzerland'},{id:'CI',country:'Cote DIvoire (Ivory Coast)'},{id:'CK',country:'Cook Islands'},{id:'CL',country:'Chile'},{id:'CM',country:'Cameroon'},{id:'CN',country:'China'},{id:'CO',country:'Colombia'},{id:'CR',country:'Costa Rica'},{id:'CS',country:'Czechoslovakia (former)'},{id:'CU',country:'Cuba'},{id:'CV',country:'Cape Verde'},{id:'CX',country:'Christmas Island'},{id:'CY',country:'Cyprus'},{id:'CZ',country:'Czech Republic'},{id:'DE',country:'Germany'},{id:'DJ',country:'Djibouti'},{id:'DK',country:'Denmark'},{id:'DM',country:'Dominica'},{id:'DO',country:'Dominican Republic'},{id:'DZ',country:'Algeria'},{id:'EC',country:'Ecuador'},{id:'EE',country:'Estonia'},{id:'EG',country:'Egypt'},{id:'EH',country:'Western Sahara'},{id:'ER',country:'Eritrea'},{id:'ES',country:'Spain'},{id:'ET',country:'Ethiopia'},{id:'EU',country:'European Union'},{id:'FI',country:'Finland'},{id:'FJ',country:'Fiji'},{id:'FK',country:'Falkland Islands (Malvinas)'},{id:'FM',country:'Micronesia'},{id:'FO',country:'Faroe Islands'},{id:'FR',country:'France'},{id:'FX',country:'France, Metropolitan'},{id:'GA',country:'Gabon'},{id:'GB',country:'Great Britain (UK)'},{id:'GD',country:'Grenada'},{id:'GE',country:'Georgia'},{id:'GF',country:'French Guiana'},{id:'GG',country:'Guernsey'},{id:'GH',country:'Ghana'},{id:'GI',country:'Gibraltar'},{id:'GL',country:'Greenland'},{id:'GM',country:'Gambia'},{id:'GN',country:'Guinea'},{id:'GP',country:'Guadeloupe'},{id:'GQ',country:'Equatorial Guinea'},{id:'GR',country:'Greece'},{id:'GS',country:'S. Georgia and S. Sandwich Isls.'},{id:'GT',country:'Guatemala'},{id:'GU',country:'Guam'},{id:'GW',country:'Guinea-Bissau'},{id:'GY',country:'Guyana'},{id:'HK',country:'Hong Kong'},{id:'HM',country:'Heard and McDonald Islands'},{id:'HN',country:'Honduras'},{id:'HR',country:'Croatia (Hrvatska)'},{id:'HT',country:'Haiti'},{id:'HU',country:'Hungary'},{id:'ID',country:'Indonesia'},{id:'IE',country:'Ireland'},{id:'IL',country:'Israel'},{id:'IM',country:'Isle of Man'},{id:'IN',country:'India'},{id:'IO',country:'British Indian Ocean Territory'},{id:'IQ',country:'Iraq'},{id:'IR',country:'Iran'},{id:'IS',country:'Iceland'},{id:'IT',country:'Italy'},{id:'JE',country:'Jersey'},{id:'JM',country:'Jamaica'},{id:'JO',country:'Jordan'},{id:'JP',country:'Japan'},{id:'KE',country:'Kenya'},{id:'KG',country:'Kyrgyzstan'},{id:'KH',country:'Cambodia'},{id:'KI',country:'Kiribati'},{id:'KM',country:'Comoros'},{id:'KN',country:'Saint Kitts and Nevis'},{id:'KP',country:'Korea (North)'},{id:'KR',country:'Korea (South)'},{id:'KW',country:'Kuwait'},{id:'KY',country:'Cayman Islands'},{id:'KZ',country:'Kazakhstan'},{id:'LA',country:'Laos'},{id:'LB',country:'Lebanon'},{id:'LC',country:'Saint Lucia'},{id:'LI',country:'Liechtenstein'},{id:'LK',country:'Sri Lanka'},{id:'LR',country:'Liberia'},{id:'LS',country:'Lesotho'},{id:'LT',country:'Lithuania '},{id:'LU',country:'Luxembourg'},{id:'LV',country:'Latvia'},{id:'LY',country:'Libya'},{id:'MA',country:'Morocco'},{id:'MC',country:'Monaco'},{id:'MD',country:'Moldova'},{id:'ME',country:'Montenegro'},{id:'MG',country:'Madagascar'},{id:'MH',country:'Marshall Islands'},{id:'MK',country:'F.Y.R.O.M. (Macedonia)'},{id:'ML',country:'Mali'},{id:'MM',country:'Myanmar'},{id:'MN',country:'Mongolia'},{id:'MO',country:'Macau'},{id:'MP',country:'Northern Mariana Islands'},{id:'MQ',country:'Martinique'},{id:'MR',country:'Mauritania'},{id:'MS',country:'Montserrat'},{id:'MT',country:'Malta'},{id:'MU',country:'Mauritius'},{id:'MV',country:'Maldives'},{id:'MW',country:'Malawi'},{id:'MX',country:'Mexico'},{id:'MY',country:'Malaysia'},{id:'MZ',country:'Mozambique'},{id:'NA',country:'Namibia'},{id:'NC',country:'New Caledonia'},{id:'NE',country:'Niger'},{id:'NF',country:'Norfolk Island'},{id:'NG',country:'Nigeria'},{id:'NI',country:'Nicaragua'},{id:'NL',country:'Netherlands'},{id:'NO',country:'Norway'},{id:'NP',country:'Nepal'},{id:'NR',country:'Nauru'},{id:'NT',country:'Neutral Zone'},{id:'NU',country:'Niue'},{id:'NZ',country:'New Zealand (Aotearoa)'},{id:'OM',country:'Oman'},{id:'PA',country:'Panama'},{id:'PE',country:'Peru'},{id:'PF',country:'French Polynesia'},{id:'PG',country:'Papua New Guinea'},{id:'PH',country:'Philippines'},{id:'PK',country:'Pakistan'},{id:'PL',country:'Poland'},{id:'PM',country:'St. Pierre and Miquelon'},{id:'PN',country:'Pitcairn'},{id:'PR',country:'Puerto Rico'},{id:'PS',country:'Palestinian Territory, Occupied'},{id:'PT',country:'Portugal'},{id:'PW',country:'Palau'},{id:'PY',country:'Paraguay'},{id:'QA',country:'Qatar'},{id:'RE',country:'Reunion'},{id:'RS',country:'Serbia'},{id:'RO',country:'Romania'},{id:'RU',country:'Russian Federation'},{id:'RW',country:'Rwanda'},{id:'SA',country:'Saudi Arabia'},{id:'SB',country:'Solomon Islands'},{id:'SC',country:'Seychelles'},{id:'SD',country:'Sudan'},{id:'SE',country:'Sweden'},{id:'SG',country:'Singapore'},{id:'SH',country:'St. Helena'},{id:'SI',country:'Slovenia'},{id:'SJ',country:'Svalbard & Jan Mayen Islands'},{id:'SK',country:'Slovak Republic'},{id:'SL',country:'Sierra Leone'},{id:'SM',country:'San Marino'},{id:'SN',country:'Senegal'},{id:'SO',country:'Somalia'},{id:'SR',country:'Suriname'},{id:'ST',country:'Sao Tome and Principe'},{id:'SU',country:'USSR (former)'},{id:'SV',country:'El Salvador'},{id:'SY',country:'Syria'},{id:'SZ',country:'Swaziland'},{id:'TC',country:'Turks and Caicos Islands'},{id:'TD',country:'Chad'},{id:'TF',country:'French Southern Territories'},{id:'TG',country:'Togo'},{id:'TH',country:'Thailand'},{id:'TJ',country:'Tajikistan'},{id:'TK',country:'Tokelau'},{id:'TM',country:'Turkmenistan'},{id:'TN',country:'Tunisia'},{id:'TO',country:'Tonga'},{id:'TP',country:'East Timor'},{id:'TR',country:'Turkey'},{id:'TT',country:'Trinidad and Tobago'},{id:'TV',country:'Tuvalu'},{id:'TW',country:'Taiwan'},{id:'TZ',country:'Tanzania'},{id:'UA',country:'Ukraine'},{id:'UG',country:'Uganda'},{id:'UK',country:'United Kingdom'},{id:'UM',country:'US Minor Outlying Islands'},{id:'US',country:'United States'},{id:'UY',country:'Uruguay'},{id:'UZ',country:'Uzbekistan'},{id:'VA',country:'Vatican City State'},{id:'VC',country:'Saint Vincent & the Grenadines'},{id:'VE',country:'Venezuela'},{id:'VG',country:'British Virgin Islands'},{id:'VI',country:'Virgin Islands (U.S.)'},{id:'VN',country:'Viet Nam'},{id:'VU',country:'Vanuatu'},{id:'WF',country:'Wallis and Futuna Islands'},{id:'WS',country:'Samoa'},{id:'YE',country:'Yemen'},{id:'YT',country:'Mayotte'},{id:'YU',country:'Serbia and Montenegro'},{id:'ZA',country:'South Africa'},{id:'ZM',country:'Zambia'},{id:'ZR',country:'CD Congo, Democratic Republic'},{id:'ZW',country:'Zimbabwe'},];$scope.stateOptions=[{name:'',state:''},{name:'Alabama',state:'AL'},{name:'Alaska',state:'AK'},{name:'Arizona',state:'AZ'},{name:'Arkansas',state:'AR'},{name:'California',state:'CA'},{name:'Colorado',state:'CO'},{name:'Connecticut',state:'CT'},{name:'Delaware',state:'DE'},{name:'District of Columbia',state:'DC'},{name:'Florida',state:'FL'},{name:'Georgia',state:'GA'},{name:'Hawaii',state:'HI'},{name:'Idaho',state:'ID'},{name:'Illinois',state:'IL'},{name:'Indiana',state:'IN'},{name:'Iowa',state:'IA'},{name:'Kansas',state:'KS'},{name:'Kentucky',state:'KY'},{name:'Louisiana',state:'LA'},{name:'Maine',state:'ME'},{name:'Maryland',state:'MD'},{name:'Massachusetts',state:'MA'},{name:'Michigan',state:'MI'},{name:'Minnesota',state:'MN'},{name:'Mississippi',state:'MS'},{name:'Missouri',state:'MO'},{name:'Montana',state:'MT'},{name:'Nebraska',state:'NE'},{name:'Nevada',state:'NV'},{name:'New Hampshire',state:'NH'},{name:'New Jersey',state:'NJ'},{name:'New Mexico',state:'NM'},{name:'New York',state:'NY'},{name:'North Carolina',state:'NC'},{name:'North Dakota',state:'ND'},{name:'Ohio',state:'OH'},{name:'Oklahoma',state:'OK'},{name:'Oregon',state:'OR'},{name:'Pennsylvania',state:'PA'},{name:'Rhode Island',state:'RI'},{name:'South Carolina',state:'SC'},{name:'South Dakota',state:'SD'},{name:'Tennessee',state:'TN'},{name:'Texas',state:'TX'},{name:'Utah',state:'UT'},{name:'Vermont',state:'VT'},{name:'Virginia',state:'VA'},{name:'Washington',state:'WA'},{name:'West Virginia',state:'WV'},{name:'Wisconsin',state:'WI'},{name:'Wyoming',state:'WY'}];$scope.openAddressSelection=function(addressPickList){$scope.addressPickList=addressPickList;var modalInstance=$modal.open({templateUrl:'html/customer/addressSelection.html',controller:'addressSelectionCtrl',resolve:{addressPickList:function(){return $scope.addressPickList;}}});modalInstance.result.then(function(selectedAddress){$scope.address.PersonInfo._AddressLine1=selectedAddress.Line1;$scope.address.PersonInfo._AddressLine2=selectedAddress.Line2;$scope.address.PersonInfo._AddressLine3=selectedAddress.Line3;$scope.address.PersonInfo._City=selectedAddress.City;$scope.address.PersonInfo._State=selectedAddress.State;$scope.address.PersonInfo._ZipCode=selectedAddress.Zip;$scope.address.PersonInfo._Country="US";$scope.addressValidated=true;if(selectedAddress.Line2===null){$scope.address.PersonInfo._AddressLine2="";}
if(selectedAddress.Line3===null){$scope.address.PersonInfo._AddressLine3="";}
if($scope.addressValidated==true&&$scope.emailValidated==true&&$scope.AllEntriesValid==true){$scope.updateCustomer();}});};}]).controller('addressSelectionCtrl',['$scope','customer','$state','addressPickList','$modalInstance',function($scope,$customer,$state,addressPickList,$modalInstance){$scope.selectedRow=0;$scope.addressPickList=addressPickList.QASearchResult.QAPicklist;selectedAddress=[];$scope.selectableAddress=[];$scope.suggestedAddress=[];$scope.disableUpdateButton=false;if($scope.addressPickList.PicklistEntry.length==undefined){if($scope.addressPickList.PicklistEntry._FullAddress=='true'){selectlength=$scope.selectableAddress.length;$scope.selectableAddress[selectlength]=angular.copy($scope.addressPickList.PicklistEntry);}else{suggestlength=$scope.suggestedAddress.length;$scope.suggestedAddress[suggestlength]=angular.copy($scope.addressPickList.PicklistEntry);}}else{for(var i=0,len=$scope.addressPickList.PicklistEntry.length;i<len;i++){if($scope.addressPickList.PicklistEntry[i]._FullAddress=='true'){selectlength=$scope.selectableAddress.length;$scope.selectableAddress[selectlength]=angular.copy($scope.addressPickList.PicklistEntry[i]);}else{suggestlength=$scope.suggestedAddress.length;$scope.suggestedAddress[suggestlength]=angular.copy($scope.addressPickList.PicklistEntry[i]);}}}
if($scope.selectableAddress.length==0){$scope.selectAddressLabel=false;$scope.disableUpdateButton=true;}else{$scope.selectAddressLabel=true;$scope.disableUpdateButton=false;}
if($scope.suggestedAddress.length==0){$scope.suggestAddressLabel=false;}else{$scope.suggestAddressLabel=true;}
$scope.close=function(){$modalInstance.dismiss('closed');}
$scope.setClickedRow=function(index){$scope.selectedRow=index;}
$scope.refreshIScroll=function(){var myScroll=new IScroll('#ItemDetailWrapper',{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip'});setTimeout(function(){myScroll.refresh();},500);};$scope.formatSelectedAddress=function(){$scope.moniker=$scope.selectableAddress[$scope.selectedRow].Moniker;$customer.verifySelectedAddress($scope.moniker).success(function(response){if(response.Address.QAAddress.AddressLine.length===7){selectedAddress.Line1=response.Address.QAAddress.AddressLine[0].Line;selectedAddress.Line2=response.Address.QAAddress.AddressLine[1].Line;selectedAddress.Line3=response.Address.QAAddress.AddressLine[2].Line;selectedAddress.City=response.Address.QAAddress.AddressLine[3].Line;selectedAddress.State=response.Address.QAAddress.AddressLine[4].Line;selectedAddress.Zip=response.Address.QAAddress.AddressLine[5].Line.substring(0,5);selectedAddress.Country=response.Address.QAAddress.AddressLine[6].Line;if(response.Address.QAAddress.AddressLine[6].Line="UNITED STATES OF AMERICA"){selectedAddress.Country="US";}
if(selectedAddress.Line2===null){addressToVerify.line2="";}
if(selectedAddress.Line3===null){addressToVerify.line3="";}
$modalInstance.close(selectedAddress);}else{}}).error(function(data){swal({title:"Error!",text:data,showConfirmButton:true});});}}])
﻿var appServices=angular.module('appServicespickUpInStore',[]);appServices.factory('pickUpInStore',['$http','$cacheFactory','$filter','sendSMTPErrorEmail','$q','POSService','serviceArrayFix',function($http,$cacheFactory,$filter,$sendSMTPErrorEmail,$q,$POSService,serviceArrayFix){var printReceiptShipmentArray=[]
var batchprintrequest={"GetRestockShipmentListReq":{"input":{"_ShipNode":"438","_ShipmentType":"BOPIS","_StatusDate":"2016-02-01T10:24:16-05:00","Extn":{"_ExtnBatchPackSlipPrinted":"N"}}}}
var packListrequest={"GetRestockShipmentListReq":{"input":{"_ShipNode":"438","_ShipmentType":"BOPIS","_StatusDate":"2016-02-01T10:24:16-05:00"}}}
var restockListrequest={"GetRestockShipmentListReq":{"input":{"_ShipNode":"552","_ShipmentType":"BOPIS","_RequestType":"RESTOCK","_RequestedDeliveryDate":"2016-09-08T00:00:00-05:00"}}};var shipmentsreadyforcustomerpickuprequest={"GetRestockShipmentListReq":{"input":{"_ShipNode":"438","_Status":"","_RequestType":"SHIPMENTS","_StatusDate":"2016-02-01T10:24:16-05:00",},"Extn":{"_ExtnIsPicked":"Y"}}}
var changeShipmentStatusrequest={"GetChangeShipmentStatusReq":{"input":{"_ShipmentKey":"100064754","_IDType":"SSN","_CustomerName":"Renuka Prasad","_OrderNo":"980001196"}}}
var changeShipmentrequest={"ChangeShipmentReq":{"input":{"_Action":"Modify","_ShipNode":"438","_ShipmentKey":"100064719","Extn":{"_ExtnBatchPackSlipPrinted":"Y"}}}}
var changeShipment=function(shipmentKey,shipNode){changeShipmentrequest.ChangeShipmentReq.input._ShipNode=shipNode;changeShipmentrequest.ChangeShipmentReq.input._ShipmentKey=shipmentKey;console.debug(angular.toJson(changeShipmentrequest));var url=serviceURL+"/Fulfillment/changeShipment";return $http.post(url,angular.toJson(changeShipmentrequest)).then(function(data){var response=angular.fromJson(data.data);},function(data){$sendSMTPErrorEmail(data,url,changeShipmentrequest);});}
var changeShipmentStatus=function(orderNo,shipmentKey,designee,IDtype,shipNode){var url=serviceURL+"/Fulfillment/updateShipmentStatus";changeShipmentStatusrequest.GetChangeShipmentStatusReq.input._ShipmentKey=shipmentKey;changeShipmentStatusrequest.GetChangeShipmentStatusReq.input._IDType=IDtype;changeShipmentStatusrequest.GetChangeShipmentStatusReq.input._CustomerName=designee;changeShipmentStatusrequest.GetChangeShipmentStatusReq.input._OrderNo=orderNo;return $http.post(url,angular.toJson(changeShipmentStatusrequest)).then(function(data){var response=angular.fromJson(data.data);},function(data){$sendSMTPErrorEmail(data,url,changeShipmentStatusrequest);return $q.reject(data);});}
Date.prototype.formattedDate=function(){var yyyy=this.getFullYear();var mm=this.getMonth()<9?"0"+(this.getMonth()+1):(this.getMonth()+1);var dd=this.getDate()<10?"0"+this.getDate():this.getDate();var hh=this.getHours()<10?"0"+this.getHours():this.getHours();var min=this.getMinutes()<10?"0"+this.getMinutes():this.getMinutes();var ss=this.getSeconds()<10?"0"+this.getSeconds():this.getSeconds();return"".concat(yyyy).concat("-").concat(mm).concat("-").concat(dd).concat("T").concat(hh).concat(":").concat(min).concat(":").concat(ss);};function timezone(){var offset=new Date().getTimezoneOffset();var minutes=Math.abs(offset);var hours=Math.floor(minutes/60);var prefix=offset<0?"+":"-";return prefix+hours;}
Date.prototype.formattedTimeStamp=function(){var yyyy=this.getFullYear();var mm=this.getMonth()<9?"0"+(this.getMonth()+1):(this.getMonth()+1);var dd=this.getDate()<10?"0"+this.getDate():this.getDate();var hh=this.getHours()<10?"0"+this.getHours():this.getHours();var min=this.getMinutes()<10?"0"+this.getMinutes():this.getMinutes();var ss=this.getSeconds()<10?"0"+this.getSeconds():this.getSeconds();return"".concat(yyyy).concat("-").concat(mm).concat("-").concat(dd).concat(" ").concat(hh).concat("-").concat(min).concat("-").concat(ss);};var ExtnIsPicked=function(shipmentLines){if(!angular.isDefined(shipmentLines)){return;}
shipmentLines.shipmentLine.forEach(function(shipmentLine){if(shipmentLine.Extn._ExtnIsPicked=='N'){return false;}});return true;};var getReadyforCustomerShipmentListArray=function(shipNode){var url=serviceURL+"/Fulfillment/getRestockShipmentList";shipmentsreadyforcustomerpickuprequest.GetRestockShipmentListReq.input._ShipNode=shipNode;var statusDate=new Date();var date=statusDate.formattedDate();shipmentsreadyforcustomerpickuprequest.GetRestockShipmentListReq.input._StatusDate=date;console.debug(angular.toJson(shipmentsreadyforcustomerpickuprequest));return $http.post(url,angular.toJson(shipmentsreadyforcustomerpickuprequest)).then(function(data){var response=angular.fromJson(data.data);if(!angular.isArray(response.GetRestockShipmentListRes.Shipments.Shipment)){response.GetRestockShipmentListRes.Shipments.Shipment=[response.GetRestockShipmentListRes.Shipments.Shipment];}
var shipmentListArray=[];for(var i=0;i<response.GetRestockShipmentListRes.Shipments.Shipment.length;i++){var currentShipment=response.GetRestockShipmentListRes.Shipments.Shipment[i];if(angular.isDefined(currentShipment)&&angular.isDefined(currentShipment.ShipmentLines)&&!angular.isArray(currentShipment.ShipmentLines.ShipmentLine)){currentShipment.ShipmentLines.ShipmentLine=[currentShipment.ShipmentLines.ShipmentLine];}
var totalQuantity=0;if(angular.isDefined(currentShipment)){for(var j=0;j<currentShipment.ShipmentLines.ShipmentLine.length;j++){var shipmentLine=currentShipment.ShipmentLines.ShipmentLine[j];totalQuantity+=parseInt(shipmentLine._Quantity);currentShipment._totalQuantity=parseInt(totalQuantity);}
var customerName=currentShipment.BillToAddress._FirstName+" "+currentShipment.BillToAddress._LastName;currentShipment._customerName=customerName;if(angular.isDefined(currentShipment.Instructions.Instruction)&&angular.isArray(currentShipment.Instructions.Instruction)){for(var k=0;k<currentShipment.Instructions.Instruction.length;k++){var instruction=currentShipment.Instructions.Instruction[k];if(angular.isDefined(instruction)&&instruction._InstructionType==='Designee'){if(instruction._InstructionText.toString().length>0){currentShipment._customerName=instruction._InstructionText;}
break;}}}
currentShipment._orderNumber=0;if(currentShipment.ShipmentLines.ShipmentLine.length>0&&currentShipment.ShipmentLines.ShipmentLine[0]._OrderNo){currentShipment._orderNumber=parseInt(currentShipment.ShipmentLines.ShipmentLine[0]._OrderNo);}
shipmentListArray.push(currentShipment);}}
return shipmentListArray;},function(data){$sendSMTPErrorEmail(data,url,shipmentsreadyforcustomerpickuprequest);});};var getBatchPrintShipmentListArray=function(shipNode){var url=serviceURL+"/Fulfillment/getRestockShipmentList";batchprintrequest.GetRestockShipmentListReq.input._ShipNode=shipNode;var statusDate=new Date();var date=statusDate.formattedDate();batchprintrequest.GetRestockShipmentListReq.input._StatusDate=date;batchprintrequest.GetRestockShipmentListReq.Extn={"_ExtnBatchPackSlipPrinted":"N"};if(!(/^\d{3}$/).test(shipNode)){$sendSMTPErrorEmail(null,url,batchprintrequest,"-- Request To Get Unprinted Batch Bopis Receipt Shipments has faulty store number. --");}
console.debug(angular.toJson(batchprintrequest));return $http.post(url,angular.toJson(batchprintrequest)).then(function(data){var response=angular.fromJson(data.data);var shipmentListArray=[];if(!angular.isDefined(response.GetRestockShipmentListRes.Shipments.Shipment)){response.GetRestockShipmentListRes.Shipments.Shipment=[];}
if(!angular.isArray(response.GetRestockShipmentListRes.Shipments.Shipment)){response.GetRestockShipmentListRes.Shipments.Shipment=[response.GetRestockShipmentListRes.Shipments.Shipment];}
var shipmentListMap={};for(var i=0;i<response.GetRestockShipmentListRes.Shipments.Shipment.length;i++){var currentShipment=response.GetRestockShipmentListRes.Shipments.Shipment[i];serviceArrayFix(currentShipment);if(angular.isDefined(currentShipment.ShipmentLines)&&!angular.isArray(currentShipment.ShipmentLines.ShipmentLine)){currentShipment.ShipmentLines.ShipmentLine=[currentShipment.ShipmentLines.ShipmentLine];}
var totalQuantity=0;for(var j=0;j<currentShipment.ShipmentLines.ShipmentLine.length;j++){var shipmentLine=currentShipment.ShipmentLines.ShipmentLine[j];if(angular.isDefined(shipmentLine.Extn)&&shipmentLine.Extn._ExtnIsPicked=='N'){delete shipmentListMap[currentShipment._ShipmentNo];break;}
totalQuantity+=parseInt(shipmentLine._Quantity);currentShipment._totalQuantity=parseInt(totalQuantity);shipmentListMap[currentShipment._ShipmentNo]=currentShipment;}}
return shipmentListMap;},function(data){$sendSMTPErrorEmail(data,url,batchprintrequest);});};var getUnConfirmedShipmentArray=function(shipNode){var url=serviceURL+"/Fulfillment/getRestockShipmentList";packListrequest.GetRestockShipmentListReq.input._ShipNode=shipNode;var statusDate=new Date();var date=statusDate.formattedDate();packListrequest.GetRestockShipmentListReq.input._StatusDate=date;return $http.post(url,angular.toJson(packListrequest)).then(function(data){var response=angular.fromJson(data.data);if(!angular.isDefined(response)||!angular.isDefined(response.GetRestockShipmentListRes)){return $q.reject();}
if(!angular.isDefined(response.GetRestockShipmentListRes.Shipments)||!angular.isDefined(response.GetRestockShipmentListRes.Shipments.Shipment)){return{};}
if(!angular.isArray(response.GetRestockShipmentListRes.Shipments.Shipment)){response.GetRestockShipmentListRes.Shipments.Shipment=[response.GetRestockShipmentListRes.Shipments.Shipment];}
var shipmentListMap={};for(var i=0;i<response.GetRestockShipmentListRes.Shipments.Shipment.length;i++){var currentShipment=response.GetRestockShipmentListRes.Shipments.Shipment[i];serviceArrayFix(currentShipment);if(angular.isDefined(currentShipment.ShipmentLines)&&!angular.isArray(currentShipment.ShipmentLines.ShipmentLine)){currentShipment.ShipmentLines.ShipmentLine=[currentShipment.ShipmentLines.ShipmentLine];}
var totalQuantity=0;for(var j=0;j<currentShipment.ShipmentLines.ShipmentLine.length;j++){var shipmentLine=currentShipment.ShipmentLines.ShipmentLine[j];if(angular.isDefined(shipmentLine.Extn)&&shipmentLine.Extn._ExtnIsPicked=='N'){delete shipmentListMap[currentShipment._ShipmentNo];break;}
totalQuantity+=parseInt(shipmentLine._Quantity);currentShipment._totalQuantity=parseInt(totalQuantity);shipmentListMap[currentShipment._ShipmentNo]=currentShipment;}}
return shipmentListMap;},function(data){$sendSMTPErrorEmail(data,url,packListrequest);});};var _getListOfShipmentToRestock=function(shipNode){var url=serviceURL+"/Fulfillment/getRestockShipmentList";restockListrequest.GetRestockShipmentListReq.input._ShipNode=shipNode;var statusDate=new Date();var date=statusDate.formattedDate();restockListrequest.GetRestockShipmentListReq.input._RequestedDeliveryDate=date;return $http.post(url,angular.toJson(restockListrequest)).then(function(response){var result=[];var data=response.data;if(angular.isObject(data.GetRestockShipmentListRes)&&angular.isObject(data.GetRestockShipmentListRes.Shipments)&&data.GetRestockShipmentListRes.Shipments.Shipment!==undefined){if(!angular.isArray(data.GetRestockShipmentListRes.Shipments.Shipment)){data.GetRestockShipmentListRes.Shipments.Shipment=[data.GetRestockShipmentListRes.Shipments.Shipment];}
result=data.GetRestockShipmentListRes.Shipments.Shipment;serviceArrayFix(result);}
return result;});};return{getBatchPrintShipmentListArray:function(shipNode){return getBatchPrintShipmentListArray(shipNode);},getUnConfirmedShipmentList:function(shipNode){return getUnConfirmedShipmentArray(shipNode);},getReadyforCustomerShipmentListArray:getReadyforCustomerShipmentListArray,changeShipmentStatus:changeShipmentStatus,changeShipment:changeShipment,getListOfShipmentToRestock:function(shipNode){return _getListOfShipmentToRestock(shipNode);}}}]);appServices.factory('pickConfirmService',['$http','$q','serviceArrayFix','itemSearch','itemInventory','sendSMTPErrorEmail','$filter','pickUpInStore',function($http,$q,serviceArrayFix,$itemSearch,$itemInventory,$sendSMTPErrorEmail,$filter,$pickUpInStore){var _getUpickedShipmentLines=function(shipNode){if(!((angular.isString(shipNode)&&(/^\d+$/i).test(shipNode.trim()))||(Number.isInteger(shipNode)&&(shipNode>-1))))
{var defer=$q.defer();defer.reject('invalid shipNode value.');return defer.promise;}
if(angular.isNumber(shipNode)){shipNode=shipNode.toString();}
shipNode=shipNode.trim();while(shipNode.length<3){shipNode="0"+shipNode;}
shipNode=shipNode.substring(0,3);var request={"GetShipmentLineListReq":{"input":{"Shipment":{"_ShipNode":shipNode,"_Status":"1100.100"},"Extn":{"_ExtnIsPicked":"N"}}}};var url=serviceURL+"/Fulfillment/getShipmentLineList";return $http.post(url,angular.toJson(request)).then(function(response){serviceArrayFix(response.data);if(response.data.GetShipmentLineListResp.ShipmentLines.ShipmentLine){return response.data.GetShipmentLineListResp.ShipmentLines.ShipmentLine;}else{return[];}},function(data){$sendSMTPErrorEmail(data,url,request);});}
var _createDisplayDataObject=function(shipmentLine){return{"Fob":"","Brand":"","Upc":"","Description":shipmentLine._ItemDesc.trim(),"QtyInStore":0,"QtyToPick":parseInt(shipmentLine._Quantity),"QtyPicked":"","ImageURL":"","OrderNo":shipmentLine._OrderNo,"_skuInt":parseInt(shipmentLine._ItemID),"_shipmentLine":shipmentLine,"_solrData":{},"_sorting":{"isFirstOfUpc":false,"isEvenFob":false}};};var _retrievePickingDisplayDetails=function(shipNode,shipmentLineArr,isGetStoreNodeOnhandInventory){if(!angular.isArray(shipmentLineArr)){var defer1=$q.defer();defer1.resolve([]);return defer1.promise;}
if(!((angular.isString(shipNode)&&(/^\d+$/i).test(shipNode.trim()))||(Number.isInteger(shipNode)&&(shipNode>-1)))){var defer2=$q.defer();defer2.resolve([]);return defer2.promise;}
if(angular.isNumber(shipNode)){shipNode=shipNode.toString();}
shipNode=shipNode.trim();while(shipNode.length<3){shipNode="0"+shipNode;}
shipNode=shipNode.substring(0,3);var defer=$q.defer();var setOfSkus={};for(var i=0;i<shipmentLineArr.length;i++){var line=shipmentLineArr[i];setOfSkus[line._ItemID]=line._ItemID;}
var setOfSkusArray=[];angular.forEach(setOfSkus,function(value){setOfSkusArray.push(value);});var arrayOfPromises=[];var displayDataArray=[];angular.forEach(shipmentLineArr,function(value){var currentDataDisplayObj=_createDisplayDataObject(value);if(currentDataDisplayObj.QtyToPick>0){displayDataArray.push(currentDataDisplayObj);}});arrayOfPromises.push($itemSearch.searchItemBySKUArray(angular.copy(setOfSkusArray)).then(function(skuDict){angular.forEach(displayDataArray,function(displayDataObject){var solrData=skuDict[displayDataObject._skuInt];var fob=solrData.fob;if((/\s*\d+\s*-.*/).test(fob)){var index=fob.indexOf("-");if(index>-1&&(index!=fob.length-1)){fob=fob.substring(index+1).trim();}}
displayDataObject.Fob=fob;displayDataObject.Brand=solrData.brandlongdesc;displayDataObject.Upc=solrData.id;var webCatDescript="";if(angular.isString(solrData.productname)){webCatDescript=solrData.productname.trim();var sizeDesc=angular.isString(solrData.sizedc)?solrData.sizedc.trim():"";var color=angular.isString(solrData.colorlongdesc)?solrData.colorlongdesc.trim():"";if(webCatDescript.length>0){webCatDescript+=color.length>0?" ("+$filter('titlecase')(color)+")":"";webCatDescript+=sizeDesc.length>0?" Size: "+sizeDesc:"";}}
displayDataObject.Description=webCatDescript.length>0?webCatDescript:displayDataObject.Description;displayDataObject._solrData=solrData;if(angular.isString(solrData.colorimageid)&&(solrData.colorimageid.trim()!=="")){displayDataObject.ImageURL=serviceURL.toString()+"/image/BonTon/"+solrData.colorimageid.trim();}else if(angular.isDefined(solrData.imageid)&&(solrData.imageid.toString().trim()!=="")){displayDataObject.ImageURL=serviceURL.toString()+"/image/BonTon/"+solrData.imageid.toString().trim();}else{displayDataObject.ImageURL="/assets/images/NotAvailable.jpg";}});}));if(isGetStoreNodeOnhandInventory===true){arrayOfPromises.push($itemInventory.getOnHandInventoryFromShipnodeAndSkuArray(shipNode,angular.copy(setOfSkusArray)).then(function(skuDict){angular.forEach(displayDataArray,function(displayDataObject){displayDataObject.QtyInStore=skuDict[displayDataObject._shipmentLine._ItemID]?skuDict[displayDataObject._shipmentLine._ItemID]:0;});}));}
$q.all(arrayOfPromises).then(function(){defer.resolve(displayDataArray);});return defer.promise;}
var _getPickingShipmentSummaryDisplay=function(shipmentLineArr){if(!angular.isArray(shipmentLineArr)){return[];}
var dicOfOrders={};for(var i=0;i<shipmentLineArr.length;i++){if(angular.isObject(shipmentLineArr[i].Extn)&&shipmentLineArr[i].Extn._ExtnIsPicked==='N'){var curOrderNo=shipmentLineArr[i]._OrderNo;if(dicOfOrders[curOrderNo]){dicOfOrders[curOrderNo]._totalQuantity=dicOfOrders[curOrderNo]._totalQuantity+Number(shipmentLineArr[i]._Quantity);}else{dicOfOrders[curOrderNo]={};dicOfOrders[curOrderNo]._totalQuantity=Number(shipmentLineArr[i]._Quantity);if(!isFinite(dicOfOrders[curOrderNo]._totalQuantity)){dicOfOrders[curOrderNo]._totalQuantity=1;}}}}
var arrayReturn=[];angular.forEach(dicOfOrders,function(value,key){arrayReturn.push({_orderNo:""+key,_totalQuantity:""+value._totalQuantity});});return arrayReturn;}
var _fobSortShipmentLines=function(shipmentLineArrWithSolr){var sortedList=$filter('orderBy')(shipmentLineArrWithSolr,["Fob","Brand","Upc","OrderNo","_shipmentLine._ShipmentLineKey"]);var currentFob="";var fobIsEven=false;var currentSku=0;for(var i=0;i<sortedList.length;i++){var item=sortedList[i];item._sorting.isEvenFob=fobIsEven;item._sorting.isFirstOfUpc=false;if(item.Fob!==currentFob){currentFob=item.Fob;fobIsEven=!fobIsEven;item._sorting.isEvenFob=fobIsEven;}
if(item._skuInt!==currentSku){currentSku=item._skuInt;item._sorting.isFirstOfUpc=true;}}
return sortedList;};var _constructGetMultipleShipmentListsReqInputObject=function(shipmentLineKeyStr){var input={"Input":{"ShipmentLine":{"_ShipmentLineKey":shipmentLineKeyStr}},"Template":{"ShipmentLines":{"ShipmentLine":{"Extn":""}}},"_Name":"getShipmentLineList"};return input;};var _validateShipmentLinesForPicking=function(shipmentLineKeysArray){var newGetMultipleShipmentListsReq={"GetMultipleShipmentListsReq":{"input":{"API":[]}}};angular.forEach(shipmentLineKeysArray,function(value){if(angular.isString(value)&&value.length>0){newGetMultipleShipmentListsReq.GetMultipleShipmentListsReq.input.API.push(_constructGetMultipleShipmentListsReqInputObject(value));}});var url=serviceURL+"/Fulfillment/getMultipleShipmentLists";return $http.post(url,angular.toJson(newGetMultipleShipmentListsReq)).then(function(response){serviceArrayFix(response.data);var resultDict={};if(!response.data.GetMultipleShipmentListsRes||!response.data.GetMultipleShipmentListsRes.Output){return resultDict;}
if(!angular.isArray(response.data.GetMultipleShipmentListsRes.Output)){var arrayFix=[];if(response.data.GetMultipleShipmentListsRes.Output.ShipmentLines){arrayFix.push(response.data.GetMultipleShipmentListsRes.Output);}
response.data.GetMultipleShipmentListsRes.Output=arrayFix;}
for(var i=0;i<response.data.GetMultipleShipmentListsRes.Output.length;i++){var shipment=response.data.GetMultipleShipmentListsRes.Output[i];if(shipment.ShipmentLines&&angular.isArray(shipment.ShipmentLines.ShipmentLine)){for(var k=0;k<shipment.ShipmentLines.ShipmentLine.length;k++){var shipmentLine=shipment.ShipmentLines.ShipmentLine[k];if(angular.isString(shipmentLine._ShipmentLineKey)&&angular.isString(shipmentLine.Extn._ExtnIsPicked)){resultDict[shipmentLine._ShipmentLineKey]=shipmentLine.Extn._ExtnIsPicked;}}}}
return resultDict;},function(data){$sendSMTPErrorEmail(data,url,newGetMultipleShipmentListsReq);});};var _constructChangeMultipleShipmentsReqInputObject=function(shipmentLineTuple){var pickedQty=Number.NaN;var originalPickQty=Number.NaN;var shortQty=0;pickedQty=parseInt(shipmentLineTuple.QtyPicked);if(angular.isObject(shipmentLineTuple._shipmentLine)&&shipmentLineTuple._shipmentLine._Quantity!==null&&shipmentLineTuple._shipmentLine._Quantity!==undefined){originalPickQty=parseInt(shipmentLineTuple._shipmentLine._Quantity);}
if(!isFinite(pickedQty)||!isFinite(originalPickQty)||pickedQty<0||pickedQty>originalPickQty||originalPickQty<0){return null;}
shortQty=originalPickQty-pickedQty;var result={"Input":{"Shipment":{"ShipmentLines":{"ShipmentLine":{"Extn":{"_ExtnIsPicked":"Y"},"_BackroomPickedQuantity":pickedQty.toString(),"_Quantity":pickedQty.toString(),"_ShipmentLineKey":shipmentLineTuple._shipmentLine._ShipmentLineKey,"_ShortageQty":shortQty.toString()}},"_CancelRemovedQuantity":"Y","_CancelShipmentOnZeroTotalQuantity":"Y","_OverrideModificationRules":"Y","_ShipmentKey":shipmentLineTuple._shipmentLine._ShipmentKey}},"Template":{"Shipment":""},"_Name":"changeShipment"};return result;};var _confirmPicks=function(arrayOfShipmentLinesWithPickedQty){var defer=$q.defer();if(!angular.isArray(arrayOfShipmentLinesWithPickedQty)||arrayOfShipmentLinesWithPickedQty.length<1){defer.resolve("OK");return defer.promise;}
var newChangeMultipleShipmentsReq={"ChangeMultipleShipmentsReq":{"input":{"API":[]}}};angular.forEach(arrayOfShipmentLinesWithPickedQty,function(value){var newChangeObj=_constructChangeMultipleShipmentsReqInputObject(value);if(newChangeObj===null){$sendSMTPErrorEmail("Error in Lufi PickList Confirm for ShipmentLine","",value);defer.reject('Invalid Input');return defer.promise;}else{newChangeMultipleShipmentsReq.ChangeMultipleShipmentsReq.input.API.push(newChangeObj);}});var url=serviceURL+"/Fulfillment/changeMultipleShipments";$http.post(url,angular.toJson(newChangeMultipleShipmentsReq)).then(function(response){var data=response.data;if(angular.isObject(data)&&angular.isObject(data.ChangeMultipleShipmentsRes)&&angular.isString(data.ChangeMultipleShipmentsRes._Name)&&angular.isObject(data.ChangeMultipleShipmentsRes.Output)){defer.resolve("OK");}else{$sendSMTPErrorEmail(data,url,newChangeMultipleShipmentsReq);defer.reject('Confirm failed');}},function(data){$sendSMTPErrorEmail(data,url,newChangeMultipleShipmentsReq);defer.reject('Confirm failed');});return defer.promise;};var _getUpickedShipmentLines=function(shipNode){if(!((angular.isString(shipNode)&&(/^\d+$/i).test(shipNode.trim()))||(Number.isInteger(shipNode)&&(shipNode>-1)))){var defer=$q.defer();defer.reject('invalid shipNode value.');return defer.promise;}
if(angular.isNumber(shipNode)){shipNode=shipNode.toString();}
shipNode=shipNode.trim();while(shipNode.length<3){shipNode="0"+shipNode;}
shipNode=shipNode.substring(0,3);var request={"GetShipmentLineListReq":{"input":{"Shipment":{"_ShipNode":shipNode,"_Status":"1100.100"},"Extn":{"_ExtnIsPicked":"N"}}}};var url=serviceURL+"/Fulfillment/getShipmentLineList";return $http.post(url,angular.toJson(request)).then(function(response){serviceArrayFix(response.data);if(response.data.GetShipmentLineListResp.ShipmentLines.ShipmentLine){return response.data.GetShipmentLineListResp.ShipmentLines.ShipmentLine;}else{return[];}},function(data){$sendSMTPErrorEmail(data,url,request);});}
var _confirmShipmentPacking=function(shipment){var defer=$q.defer();var shipmentKey=null;if(shipment&&shipment._ShipmentKey){shipmentKey=shipment._ShipmentKey.toString().trim();}
if(shipmentKey===null||shipmentKey.length<1){defer.reject();return defer.promise;}
var newConfirmShipmentReq={"ConfirmShipmentReq":{"input":{"_Action":"Modify","_ShipmentKey":shipmentKey}}};var url=serviceURL+"/Fulfillment/confirmShipment";$http.post(url,angular.toJson(newConfirmShipmentReq)).then(function(response){var data=response.data;if(angular.isObject(data)&&angular.isObject(data.ConfirmShipmentResp)&&angular.isObject(data.ConfirmShipmentResp.Shipment)&&angular.isString(data.ConfirmShipmentResp.Shipment._ShipmentKey)&&data.ConfirmShipmentResp.Shipment._ShipmentKey.trim()===shipmentKey){defer.resolve("OK");}else{$sendSMTPErrorEmail(data,url,newConfirmShipmentReq);defer.reject('Confirm failed');}},function(data){$sendSMTPErrorEmail(data,url,newConfirmShipmentReq);defer.reject('Confirm failed');});return defer.promise;}
return{getUnpickedShipmentLines:function(shipNode){return _getUpickedShipmentLines(shipNode);},retrievePickingDisplayDetails:function(shipNode,shipmentLineArr){return _retrievePickingDisplayDetails(shipNode,shipmentLineArr,true);},retrievePackDisplayDetails:function(shipmentLineArr){return _retrievePickingDisplayDetails("001",shipmentLineArr,false);},getPickingShipmentSummaryDisplay:function(shipmentLineArr){return _getPickingShipmentSummaryDisplay(shipmentLineArr);},fobSortShipmentLines:function(shipmentLineArrWithSolr){return _fobSortShipmentLines(shipmentLineArrWithSolr);},validateShipmentLinesForPicking:function(shipmentLineKeysArray){return _validateShipmentLinesForPicking(shipmentLineKeysArray);},confirmPicks:function(arrayOfShipmentLinesWithPickedQty){return _confirmPicks(arrayOfShipmentLinesWithPickedQty);},getUnConfirmedShipmentList:function(shipNode){return $pickUpInStore.getUnConfirmedShipmentList(shipNode);},confirmShipmentPacking:function(currentShipment){return _confirmShipmentPacking(currentShipment);}};}]);
﻿angular.module('appServiceAppState',[]).factory('appState',[function(){var state={};state.model={addressChange:{previousStateName:null,customerKey:null,setShipToOrderLinePrimeSubLineObjArray:[]}};state.addressChange={previousStateName:null,customerKey:null,setShipToOrderLinePrimeSubLineObjArray:[]};var _getAddressChange=function(){var copy=angular.copy(state.addressChange);state.addressChange=angular.copy(state.model.addressChange);return copy;};var _setAddressChange=function(addressChange){state.addressChange=addressChange;};return{getAddressChange:_getAddressChange,setAddressChange:_setAddressChange};}]);
﻿angular.module('orderNote',['ui.bootstrap']).controller('orderNoteCtrl',['$scope','$stateParams','$state','order','loggerService',function($scope,$stateParams,$state,$order,$loggerService){var orderline=$stateParams.orderLineNo.toString().trim();var primeSubLineArr=[];$scope.notes=[];$scope.goToDetails=function(){$state.go('orderDetail');};var _order=$order.getCurrentOrderDetails();var myScroll=new IScroll('#NotesDetailWrapper',{mouseWheel:true,scrollbars:true,shrinkScrollbars:'clip'});$scope.refreshIScroll=function(){setTimeout(function(){myScroll.refresh();},500);};var _filterInternalNotes=function(){for(var i=0;i<$scope.notes.length;i++){var currentNote=$scope.notes[i];if(angular.isString(currentNote._VisibleToAll)&&(/^N$/i).test(currentNote._VisibleToAll)){$scope.notes.splice(i,1);i--;}}};if(orderline.length>0){primeSubLineArr=orderline.split('_');}
if(primeSubLineArr.length>0){for(var i=0;i<_order.OrderLines.OrderLine.length;i++){var currentLine=_order.OrderLines.OrderLine[i];if(currentLine._PrimeLineNo.toString().trim()===primeSubLineArr[0]&&currentLine._SubLineNo.toString().trim()===primeSubLineArr[1]){if(currentLine.Notes&&currentLine.Notes.Note){$scope.notes=currentLine.Notes.Note;_filterInternalNotes();$scope.refreshIScroll();break;}}}}else{if(_order.Notes&&_order.Notes.Note){$scope.notes=_order.Notes.Note;_filterInternalNotes();$scope.refreshIScroll();}}
var _sortNotes=function(){$loggerService.log($scope.notes);$scope.notes=$scope.notes.sort(function(a,b){if(angular.isDefined(b._SequenceNo)){if(angular.isDefined(a._SequenceNo)){return Number(b._SequenceNo)-Number(a._SequenceNo);}else{return-1;}}else{return 1;}});$loggerService.log($scope.notes);$scope.refreshIScroll();};_sortNotes();}]);